<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Enhanced Mobile Redirect Script v2.0 -->
    <script src="/trader/mobile-redirect-enhanced.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2: Enhanced Real-Time Charts | FinClash Trading</title>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899"
     crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            color: #e8e8e8;
            font-family: 'Inter', sans-serif;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-badge {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .subtitle {
            color: #b0b0b0;
            font-size: 18px;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .feature-highlight {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .feature-highlight h3 {
            color: #10b981;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            list-style: none;
        }

        .feature-list li {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            font-size: 14px;
            color: #d0d0d0;
        }

        .feature-list li::before {
            content: "‚úì ";
            color: #10b981;
            font-weight: 700;
            margin-right: 8px;
        }

        .chart-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .chart-title {
            font-size: 24px;
            font-weight: 700;
            color: #f5f5f5;
            margin-bottom: 16px;
        }

        .chart-desc {
            color: #b0b0b0;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .chart-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            min-height: 450px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 32px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #10b981;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .controls {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .code-block {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #10b981;
            overflow-x: auto;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="version-badge">PHASE 2 - ENHANCED</span>
        <h1>üöÄ Advanced Real-Time Charts</h1>
        <p class="subtitle">
            Multi-level caching, API fallback chain, market hours detection, and automatic refresh.
            <br>Version 2.0.0 with localStorage persistence and Alpha Vantage backup.
        </p>

        <!-- Feature Highlight -->
        <div class="feature-highlight">
            <h3>üéØ Phase 2 Features (Just Implemented)</h3>
            <ul class="feature-list">
                <li><strong>Multi-Level Caching:</strong> Memory (5min) + localStorage (24hr)</li>
                <li><strong>API Fallback Chain:</strong> Finnhub ‚Üí Alpha Vantage ‚Üí Sample</li>
                <li><strong>Market Hours Detection:</strong> 9:30 AM - 4:00 PM ET tracking</li>
                <li><strong>Auto-Refresh:</strong> Updates every 15min during market hours</li>
                <li><strong>Market Status Badge:</strong> Real-time open/closed indicator</li>
                <li><strong>Data Source Tracking:</strong> Shows which API provided data</li>
            </ul>
        </div>

        <!-- Live Statistics -->
        <div class="stats-grid" id="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="market-status">---</div>
                <div class="stat-label">Market Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cache-entries">0</div>
                <div class="stat-label">Cached Symbols</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cache-size">0 KB</div>
                <div class="stat-label">Cache Size</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="api-calls">0</div>
                <div class="stat-label">API Calls Made</div>
            </div>
        </div>

        <!-- Demo Chart with Auto-Refresh -->
        <div class="chart-section">
            <h2 class="chart-title">üìä Live Demo: Auto-Refreshing Chart</h2>
            <p class="chart-desc">
                This chart demonstrates Phase 2 features: multi-level caching, API fallback, market status,
                and automatic refresh every 15 minutes during market hours. Try different symbols and watch
                the data source badges change as it falls back through the API chain.
            </p>

            <div id="toggle-container"></div>

            <div class="controls">
                <button class="btn" onclick="testFallbackChain()">üîÑ Test Fallback Chain</button>
                <button class="btn btn-secondary" onclick="clearAllCache()">üóëÔ∏è Clear Cache</button>
                <button class="btn btn-secondary" onclick="showCacheStats()">üìä Cache Stats</button>
            </div>

            <div class="chart-container">
                <div id="demo-chart"></div>
            </div>
        </div>

        <!-- API Comparison -->
        <div class="chart-section">
            <h2 class="chart-title">‚ö° API Comparison Test</h2>
            <p class="chart-desc">
                Load the same symbol from different sources to see fallback in action.
                Watch console for detailed logging of cache hits and API calls.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div>
                    <h3 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">Primary: Finnhub</h3>
                    <div id="chart-finnhub" style="height: 300px;"></div>
                </div>
                <div>
                    <h3 style="color: #3b82f6; font-size: 16px; margin-bottom: 12px;">Backup: Alpha Vantage</h3>
                    <div id="chart-alphavantage" style="height: 300px;"></div>
                </div>
                <div>
                    <h3 style="color: #888; font-size: 16px; margin-bottom: 12px;">Fallback: Sample Data</h3>
                    <div id="chart-sample" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Usage Examples -->
        <div class="chart-section">
            <h2 class="chart-title">üíª Code Examples</h2>

            <h3 style="color: #f5f5f5; font-size: 18px; margin: 20px 0 12px;">Create Chart with Auto-Refresh:</h3>
            <div class="code-block">const chart = await window.TradingViewCharts.createChartWithData('chart-id', 'AAPL', {
    useRealData: true,
    days: 60,
    autoRefresh: true  // Refreshes every 15min during market hours
});

// Stop auto-refresh
chart.stopRefresh();</div>

            <h3 style="color: #f5f5f5; font-size: 18px; margin: 20px 0 12px;">Check Market Status:</h3>
            <div class="code-block">const status = window.TradingViewCharts.getMarketStatus();
console.log(status.isOpen);      // true/false
console.log(status.message);     // "üü¢ Market Open" or "üî¥ Market Closed"
console.log(status.nextOpen);    // "Tomorrow 9:30 AM ET"</div>

            <h3 style="color: #f5f5f5; font-size: 18px; margin: 20px 0 12px;">Manage Cache:</h3>
            <div class="code-block">// Get cache statistics
const stats = window.TradingViewCharts.LocalStorageCache.getStats();
console.log(`${stats.entries} symbols cached, ${stats.sizeKB} KB`);

// Clear specific symbol
window.TradingViewCharts.LocalStorageCache.remove('AAPL_D_30');

// Clear all cache
window.TradingViewCharts.LocalStorageCache.clearAll();</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/tradingview-charts.js"></script>

    <script>
        let currentChart = null;
        let apiCallCount = 0;

        // Update live stats
        function updateStats() {
            const marketStatus = window.TradingViewCharts.getMarketStatus();
            document.getElementById('market-status').textContent = marketStatus.isOpen ? 'OPEN' : 'CLOSED';
            document.getElementById('market-status').style.color = marketStatus.isOpen ? '#10b981' : '#ef4444';

            const cacheStats = window.TradingViewCharts.LocalStorageCache.getStats();
            document.getElementById('cache-entries').textContent = cacheStats.entries;
            document.getElementById('cache-size').textContent = cacheStats.sizeKB + ' KB';
        }

        // Track API calls
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (url.includes('finnhub.io') || url.includes('alphavantage.co')) {
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
                console.log(`üì° API Call #${apiCallCount}: ${url.includes('finnhub') ? 'Finnhub' : 'Alpha Vantage'}`);
            }
            return originalFetch.apply(this, args);
        };

        // Load main demo chart
        async function loadDemoChart(useRealData = true, symbol = 'AAPL') {
            if (currentChart) {
                window.TradingViewCharts.destroyChart(currentChart);
            }

            currentChart = await window.TradingViewCharts.createChartWithData(
                'demo-chart',
                symbol,
                {
                    useRealData: useRealData,
                    days: 60,
                    height: 400,
                    autoRefresh: true
                }
            );

            updateStats();
        }

        // Test fallback chain
        async function testFallbackChain() {
            console.log('üîÑ Testing API fallback chain...');

            // Test with a symbol that should work
            console.log('1Ô∏è‚É£ Testing with AAPL (should use Finnhub)...');
            await window.TradingViewCharts.createChartWithData('chart-finnhub', 'AAPL', {
                useRealData: true,
                days: 30,
                height: 300
            });

            // Test with Alpha Vantage
            console.log('2Ô∏è‚É£ Loading from Alpha Vantage...');
            const avData = await window.TradingViewCharts.fetchAlphaVantageData('MSFT', 30);
            if (avData) {
                await window.TradingViewCharts.createInteractiveCandlestickChart('chart-alphavantage', avData, { height: 300 });
            }

            // Test with sample data
            console.log('3Ô∏è‚É£ Loading sample data...');
            const sampleData = window.TradingViewCharts.generateSampleChartData('bullFlag', 30);
            await window.TradingViewCharts.createInteractiveCandlestickChart('chart-sample', sampleData, { height: 300 });

            updateStats();
            alert('‚úì Fallback chain tested! Check console for details.');
        }

        // Clear all cache
        function clearAllCache() {
            window.TradingViewCharts.LocalStorageCache.clearAll();
            window.TradingViewCharts.clearOldCache();
            updateStats();
            alert('‚úì All cache cleared!');
        }

        // Show cache stats
        function showCacheStats() {
            const stats = window.TradingViewCharts.LocalStorageCache.getStats();
            const msg = `üìä Cache Statistics:\n\n` +
                       `Entries: ${stats.entries}\n` +
                       `Size: ${stats.sizeKB} KB\n` +
                       `Symbols: ${stats.keys.join(', ') || 'None'}`;
            alert(msg);
        }

        // Initialize
        const toggle = window.TradingViewCharts.createDataSourceToggle({
            containerId: 'demo-chart',
            symbol: 'AAPL',
            onToggle: async (useRealData, symbol) => {
                await loadDemoChart(useRealData, symbol || 'AAPL');
            }
        });
        document.getElementById('toggle-container').appendChild(toggle);

        // Load initial chart
        loadDemoChart(true, 'AAPL');

        // Update stats every 10 seconds
        setInterval(updateStats, 10000);
        updateStats();

        // Log version info
        console.log('%cüìä TradingView Charts v' + window.TradingViewCharts.version, 'color: #10b981; font-size: 16px; font-weight: bold');
        console.log('Features:', window.TradingViewCharts.features);
        console.log('Market Status:', window.TradingViewCharts.getMarketStatus());
    </script>
</body>
</html>
