<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWars - Stock Trading Simulator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* Dark theme with messy white lines background */
        html, body {
            background: #1a1a1a !important;
            position: relative;
            min-height: 100vh;
        }

        /* Messy white lines background - Layer 1 - ALWAYS ON TOP */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(135deg, transparent 0%, transparent 48%, rgba(255,255,255,0.12) 48%, rgba(255,255,255,0.12) 52%, transparent 52%, transparent 100%),
                linear-gradient(45deg, transparent 0%, transparent 48%, rgba(255,255,255,0.1) 48%, rgba(255,255,255,0.1) 52%, transparent 52%, transparent 100%),
                linear-gradient(90deg, transparent 0%, transparent 48%, rgba(255,255,255,0.08) 48%, rgba(255,255,255,0.08) 50%, transparent 50%, transparent 100%);
            background-size: 100px 100px, 140px 140px, 70px 70px;
            background-position: 0 0, 50px 50px, 25px 25px;
            z-index: 9999;
            pointer-events: none;
        }

        /* Messy white lines background - Layer 2 - ALWAYS ON TOP */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(
                    42deg,
                    transparent,
                    transparent 38px,
                    rgba(255,255,255,0.08) 38px,
                    rgba(255,255,255,0.08) 40px
                ),
                repeating-linear-gradient(
                    -48deg,
                    transparent,
                    transparent 28px,
                    rgba(255,255,255,0.1) 28px,
                    rgba(255,255,255,0.1) 30px
                ),
                repeating-linear-gradient(
                    88deg,
                    transparent,
                    transparent 55px,
                    rgba(255,255,255,0.07) 55px,
                    rgba(255,255,255,0.07) 57px
                );
            z-index: 9999;
            pointer-events: none;
        }

        /* Ensure content is below background lines but still visible */
        #root {
            position: relative;
            z-index: 1;
        }

        /* Override Tailwind colors for dark theme */
        .bg-gradient-to-br.from-blue-900 {
            background: linear-gradient(to bottom right, #1e293b 0%, #0f172a 100%) !important;
        }

        .bg-gradient-to-r.from-blue-800 {
            background: linear-gradient(to right, #1e3a5f 0%, #1a2332 100%) !important;
        }

        .bg-blue-800, .from-blue-800 {
            background-color: #1e3a5f !important;
        }

        .bg-blue-900, .to-blue-900 {
            background-color: #1a2332 !important;
        }

        .bg-blue-700 {
            background-color: #2d4a6f !important;
        }

        .border-blue-600 {
            border-color: #3d5a80 !important;
        }

        .border-blue-500 {
            border-color: #4a6fa5 !important;
        }

        .text-blue-100 {
            color: #d4e4ff !important;
        }

        .text-blue-200 {
            color: #b8d4ff !important;
        }

        .text-blue-300 {
            color: #9cc4ff !important;
        }

        .placeholder-blue-300::placeholder {
            color: #9cc4ff !important;
        }

        /* Card backgrounds with subtle patterns */
        .bg-gradient-to-br.from-blue-800.to-blue-900 {
            background: linear-gradient(to bottom right, #1e3a5f 0%, #1a2332 100%) !important;
            position: relative;
        }

        /* Add subtle texture to cards */
        .bg-gradient-to-br.from-blue-800.to-blue-900::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255,255,255,0.01) 10px,
                    rgba(255,255,255,0.01) 11px
                );
            border-radius: inherit;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Initialize Supabase
        const SUPABASE_URL = 'https://qaanvcxzdjekeabrdrqlu.supabase.co';
        const SUPABASE_ANON_KEY = 'sbp_a644e14bab987209277b3e6747743fc6a311af06';

        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase initialized successfully');
                console.log('Project URL:', SUPABASE_URL);
            } else {
                console.error('âŒ Supabase library not loaded');
            }
        } catch (error) {
            console.error('âŒ Error initializing Supabase:', error);
        }

        const TradingSimulator = () => {
            const [view, setView] = useState('plan-select');
            const [plan, setPlan] = useState(null);
            const [userName, setUserName] = useState('');
            const [currentUserId, setCurrentUserId] = useState(null);
            const [contribution, setContribution] = useState('');

            const [competitionCode, setCompetitionCode] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [competition, setCompetition] = useState(null);

            const [watchlist, setWatchlist] = useState([]);
            const [stocks, setStocks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);

            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [showSearchResults, setShowSearchResults] = useState(false);

            const [selectedStock, setSelectedStock] = useState(null);
            const [quantity, setQuantity] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('market');
            const [quantityError, setQuantityError] = useState('');

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const COMMISSION_RATE = 0.03;

            const POPULAR_STOCKS = [
                'AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA',
                'NVDA', 'META', 'NFLX', 'AMD', 'DIS'
            ];

            // Finnhub API for real-time stock data (free tier: 60 calls/minute)
            const FINNHUB_API_KEY = 'd3sop19r01qpdd5kkpsgd3sop19r01qpdd5kkpt0';
            const FINNHUB_API_BASE = 'https://finnhub.io/api/v1';

            useEffect(() => {
                const saved = localStorage.getItem('stockWatchlist');
                if (saved) {
                    setWatchlist(JSON.parse(saved));
                } else {
                    setWatchlist(POPULAR_STOCKS);
                }
            }, []);

            useEffect(() => {
                if (watchlist.length > 0) {
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                }
            }, [watchlist]);

            // Popular stocks database for search
            const STOCK_DATABASE = [
                { symbol: 'AAPL', name: 'Apple Inc.' },
                { symbol: 'GOOGL', name: 'Alphabet Inc.' },
                { symbol: 'MSFT', name: 'Microsoft Corporation' },
                { symbol: 'AMZN', name: 'Amazon.com Inc.' },
                { symbol: 'TSLA', name: 'Tesla Inc.' },
                { symbol: 'NVDA', name: 'NVIDIA Corporation' },
                { symbol: 'META', name: 'Meta Platforms Inc.' },
                { symbol: 'NFLX', name: 'Netflix Inc.' },
                { symbol: 'AMD', name: 'Advanced Micro Devices' },
                { symbol: 'DIS', name: 'Walt Disney Company' },
                { symbol: 'COIN', name: 'Coinbase Global Inc.' },
                { symbol: 'BA', name: 'Boeing Company' },
                { symbol: 'BABA', name: 'Alibaba Group' },
                { symbol: 'NKE', name: 'Nike Inc.' },
                { symbol: 'INTC', name: 'Intel Corporation' },
                { symbol: 'V', name: 'Visa Inc.' },
                { symbol: 'JPM', name: 'JPMorgan Chase' },
                { symbol: 'WMT', name: 'Walmart Inc.' },
                { symbol: 'PFE', name: 'Pfizer Inc.' },
                { symbol: 'KO', name: 'Coca-Cola Company' },
                { symbol: 'PEP', name: 'PepsiCo Inc.' },
                { symbol: 'PYPL', name: 'PayPal Holdings' },
                { symbol: 'ADBE', name: 'Adobe Inc.' },
                { symbol: 'CRM', name: 'Salesforce Inc.' },
                { symbol: 'CSCO', name: 'Cisco Systems' },
                { symbol: 'ORCL', name: 'Oracle Corporation' },
                { symbol: 'T', name: 'AT&T Inc.' },
                { symbol: 'VZ', name: 'Verizon Communications' },
                { symbol: 'GM', name: 'General Motors' },
                { symbol: 'F', name: 'Ford Motor Company' },
                { symbol: 'UBER', name: 'Uber Technologies' },
                { symbol: 'LYFT', name: 'Lyft Inc.' },
                { symbol: 'SQ', name: 'Block Inc.' },
                { symbol: 'SHOP', name: 'Shopify Inc.' },
                { symbol: 'SPOT', name: 'Spotify Technology' },
                { symbol: 'SNAP', name: 'Snap Inc.' },
                { symbol: 'TWTR', name: 'Twitter Inc.' },
                { symbol: 'ZM', name: 'Zoom Video Communications' },
                { symbol: 'ROKU', name: 'Roku Inc.' },
                { symbol: 'PINS', name: 'Pinterest Inc.' }
            ];

            const searchStocks = async (query) => {
                if (!query || query.length < 1) {
                    setSearchResults([]);
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                setSearching(true);
                setShowSearchResults(true);
                setError(null);

                try {
                    const searchTerm = query.toLowerCase();

                    // Search in stock database
                    const results = STOCK_DATABASE
                        .filter(stock =>
                            stock.symbol.toLowerCase().includes(searchTerm) ||
                            stock.name.toLowerCase().includes(searchTerm)
                        )
                        .slice(0, 10)
                        .map(stock => ({
                            symbol: stock.symbol,
                            name: stock.name,
                            type: 'EQUITY',
                            region: 'US',
                            currency: 'USD'
                        }));

                    console.log('Search Results:', results);

                    if (results.length > 0) {
                        setSearchResults(results);
                    } else {
                        // If no match in database, validate with API before showing
                        const upperQuery = query.toUpperCase();

                        // Only show if it looks like a valid ticker (2-5 letters)
                        if (/^[A-Z]{1,5}$/.test(upperQuery)) {
                            // Try to validate with Finnhub API
                            try {
                                const response = await fetch(
                                    `${FINNHUB_API_BASE}/quote?symbol=${upperQuery}&token=${FINNHUB_API_KEY}`
                                );
                                const data = await response.json();

                                // Only show if we get valid price data back
                                if (data.c && data.c > 0) {
                                    setSearchResults([{
                                        symbol: upperQuery,
                                        name: `${upperQuery}`,
                                        type: 'EQUITY',
                                        region: 'US',
                                        currency: 'USD'
                                    }]);
                                } else {
                                    // Not a valid stock
                                    setSearchResults([]);
                                }
                            } catch (error) {
                                console.error('Error validating stock:', error);
                                setSearchResults([]);
                            }
                        } else {
                            // Invalid format - don't show anything
                            setSearchResults([]);
                        }
                    }
                } catch (error) {
                    console.error('Error searching stocks:', error);
                    setSearchResults([]);
                }
                setSearching(false);
            };

            useEffect(() => {
                const timer = setTimeout(() => {
                    if (searchQuery) {
                        searchStocks(searchQuery);
                    } else {
                        setSearchResults([]);
                        setShowSearchResults(false);
                        setError(null);
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, [searchQuery]);

            const fetchStockData = async () => {
                if (watchlist.length === 0) return;

                try {
                    setLoading(true);
                    setError(null);

                    // Fetch all stocks in parallel using Finnhub
                    const promises = watchlist.map(async (symbol) => {
                        try {
                            // Get current quote
                            const quoteResponse = await fetch(
                                `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                            );
                            const quoteData = await quoteResponse.json();

                            console.log(`Finnhub ${symbol}:`, quoteData);

                            const currentPrice = quoteData.c; // Current price
                            const previousClose = quoteData.pc; // Previous close
                            const priceChange = quoteData.d; // Change
                            const changePercent = quoteData.dp; // Change percent
                            const high = quoteData.h; // High
                            const low = quoteData.l; // Low
                            const open = quoteData.o; // Open

                            return {
                                symbol: symbol,
                                name: getStockName(symbol),
                                price: parseFloat((currentPrice || 0).toFixed(2)),
                                change: parseFloat((changePercent || 0).toFixed(2)),
                                volume: 'N/A',
                                previousClose: previousClose || 0,
                                high: high || currentPrice,
                                low: low || currentPrice,
                                open: open || currentPrice
                            };
                        } catch (error) {
                            console.error(`Error fetching ${symbol}:`, error);
                            return getFallbackStockData(symbol);
                        }
                    });

                    const stocksData = await Promise.all(promises);

                    if (stocksData.length > 0) {
                        setStocks(stocksData);
                        setLastUpdate(new Date());
                        console.log('âœ… All stocks loaded with Finnhub real-time prices:', stocksData);
                    }

                    setLoading(false);
                } catch (error) {
                    console.error('Error fetching stock data:', error);
                    setError('Failed to load stock data. Using fallback prices.');

                    const fallbackData = watchlist.map(symbol => getFallbackStockData(symbol));
                    setStocks(fallbackData);
                    setLastUpdate(new Date());
                    setLoading(false);
                }
            };

            const getStockName = (symbol) => {
                const names = {
                    'AAPL': 'Apple Inc.',
                    'GOOGL': 'Alphabet Inc.',
                    'MSFT': 'Microsoft Corp.',
                    'AMZN': 'Amazon.com Inc.',
                    'TSLA': 'Tesla Inc.',
                    'NVDA': 'NVIDIA Corp.',
                    'META': 'Meta Platforms',
                    'NFLX': 'Netflix Inc.',
                    'AMD': 'Advanced Micro Devices',
                    'DIS': 'Walt Disney Co.'
                };
                return names[symbol] || symbol;
            };

            const formatVolume = (volume) => {
                if (!volume) return 'N/A';
                if (volume >= 1000000000) return `${(volume / 1000000000).toFixed(1)}B`;
                if (volume >= 1000000) return `${(volume / 1000000).toFixed(1)}M`;
                if (volume >= 1000) return `${(volume / 1000).toFixed(1)}K`;
                return volume.toString();
            };

            const getFallbackStockData = (symbol) => {
                const fallbackData = {
                    'AAPL': { price: 178.50, change: 1.2 },
                    'GOOGL': { price: 142.30, change: -0.8 },
                    'MSFT': { price: 378.90, change: 0.9 },
                    'AMZN': { price: 145.60, change: 1.5 },
                    'TSLA': { price: 242.80, change: -2.3 },
                    'NVDA': { price: 495.20, change: 3.2 },
                    'META': { price: 325.40, change: 0.7 },
                    'NFLX': { price: 445.30, change: -1.1 },
                    'AMD': { price: 143.20, change: 2.1 },
                    'DIS': { price: 91.30, change: -0.5 }
                };

                return {
                    symbol,
                    name: getStockName(symbol),
                    price: fallbackData[symbol]?.price || Math.random() * 200 + 50,
                    change: fallbackData[symbol]?.change || (Math.random() - 0.5) * 10,
                    volume: '10.5M'
                };
            };

            // Fetch live data for a single stock using Finnhub API
            const fetchSingleStock = async (symbol, stockName = null) => {
                try {
                    const response = await fetch(
                        `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                    );
                    const data = await response.json();

                    console.log(`Fetching single stock ${symbol}:`, data);

                    if (data.c) {
                        const currentPrice = data.c; // Current price
                        const previousClose = data.pc; // Previous close
                        const changePercent = data.dp; // Change percent
                        const high = data.h; // High
                        const low = data.l; // Low
                        const open = data.o; // Open

                        console.log(`âœ… Finnhub ${symbol}:`, {
                            price: currentPrice,
                            change: changePercent,
                            previousClose: previousClose
                        });

                        return {
                            symbol: symbol,
                            name: stockName || getStockName(symbol),
                            price: parseFloat((currentPrice || 0).toFixed(2)),
                            change: parseFloat((changePercent || 0).toFixed(2)),
                            volume: 'N/A',
                            previousClose: previousClose || 0,
                            high: high || currentPrice,
                            low: low || currentPrice,
                            open: open || currentPrice
                        };
                    } else {
                        // Fallback if API fails
                        console.warn(`No data for ${symbol}, using fallback`);
                        const fallbackData = getFallbackStockData(symbol);
                        if (stockName) fallbackData.name = stockName;
                        return fallbackData;
                    }
                } catch (error) {
                    console.error(`Error fetching ${symbol}:`, error);
                    const fallbackData = getFallbackStockData(symbol);
                    if (stockName) fallbackData.name = stockName;
                    return fallbackData;
                }
            };

            const addToWatchlist = async (symbol, stockName = null) => {
                if (watchlist.includes(symbol)) {
                    // Already in watchlist, just select it
                    setSelectedStock(symbol);
                    setSearchQuery('');
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                // Show loading state
                setSearching(true);
                setError(null);

                // Fetch live data for this stock
                const stockData = await fetchSingleStock(symbol, stockName);

                // Add to watchlist
                setWatchlist([...watchlist, symbol]);

                // Add to stocks array or update if exists
                const existingIndex = stocks.findIndex(s => s.symbol === symbol);
                if (existingIndex >= 0) {
                    const updatedStocks = [...stocks];
                    updatedStocks[existingIndex] = stockData;
                    setStocks(updatedStocks);
                } else {
                    setStocks([...stocks, stockData]);
                }

                // Select the stock
                setSelectedStock(symbol);

                // Clear search
                setSearchQuery('');
                setShowSearchResults(false);
                setSearching(false);
            };

            const removeFromWatchlist = (symbol) => {
                setWatchlist(watchlist.filter(s => s !== symbol));
                setStocks(stocks.filter(s => s.symbol !== symbol));
            };

            useEffect(() => {
                if (view === 'trading' && watchlist.length > 0) {
                    fetchStockData();

                    // Auto-refresh stock prices every 30 seconds to update portfolio value
                    const refreshInterval = setInterval(() => {
                        console.log('ðŸ”„ Auto-refreshing stock prices...');
                        fetchStockData();
                    }, 30000); // 30 seconds

                    return () => clearInterval(refreshInterval);
                }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [view, watchlist]);

            // Clear error when selected stock changes
            useEffect(() => {
                setQuantityError('');
                setQuantity(1);
            }, [selectedStock]);

            const getCurrentPortfolio = () => {
                if (plan === 'personal') {
                    return competition?.members[0]?.portfolio || { cash: 100000, positions: {}, history: [], lastBuyTime: {} };
                }
                const member = competition?.members.find(m => m.id === currentUserId);
                return member?.portfolio || { cash: 100000, positions: {}, history: [], lastBuyTime: {} };
            };

            const calculatePortfolioValue = (portfolio) => {
                if (!portfolio || typeof portfolio.cash !== 'number') {
                    return 100000; // Default starting value
                }

                let positionsValue = 0;
                if (portfolio.positions && stocks.length > 0) {
                    Object.entries(portfolio.positions).forEach(([symbol, qty]) => {
                        const stock = stocks.find(s => s.symbol === symbol);
                        if (stock && typeof stock.price === 'number' && typeof qty === 'number') {
                            positionsValue += stock.price * qty;
                        }
                    });
                }

                const totalValue = portfolio.cash + positionsValue;
                return isNaN(totalValue) ? 100000 : totalValue;
            };

            const generateCompetitionCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const createCompetition = async (memberName, contributionAmount) => {
                const code = generateCompetitionCode();
                const memberId = Date.now().toString();
                const isPersonalPlan = parseFloat(contributionAmount || 0) === 0;

                try {
                    // Personal plans now also use Supabase for cloud storage
                    if (isPersonalPlan) {
                        if (!supabase) {
                            alert('Database connection required. Please check your internet connection and try again.');
                            return;
                        }

                        console.log('Creating personal account with code:', code);

                        // Save personal account to Supabase
                        const { data: accountData, error: accountError } = await supabase
                            .from('personal_accounts')
                            .insert([{
                                account_code: code,
                                user_name: memberName,
                                portfolio: {
                                    cash: 100000,
                                    positions: {},
                                    history: [],
                                    lastBuyTime: {}
                                }
                            }])
                            .select()
                            .single();

                        if (accountError) {
                            console.error('Supabase error creating personal account:', accountError);
                            alert(`Failed to create account: ${accountError.message}\n\nPlease check browser console for details.`);
                            return;
                        }

                        console.log('Personal account created in Supabase:', accountData);

                        const newCompetition = {
                            code: code,
                            totalPool: 0,
                            startTime: accountData.created_at,
                            members: [{
                                id: memberId,
                                name: memberName,
                                contribution: 0,
                                portfolio: {
                                    cash: 100000,
                                    positions: {},
                                    history: [],
                                    lastBuyTime: {}
                                },
                                joinedAt: accountData.created_at
                            }]
                        };

                        setCompetition(newCompetition);
                        setCompetitionCode(code);
                        setCurrentUserId(memberId);
                        setView('code-display');
                        console.log('âœ… Personal account created successfully:', code);
                        return;
                    }

                    // Family plans save to Supabase
                    if (!supabase) {
                        alert('Supabase is not configured. Please update the SUPABASE_URL and SUPABASE_ANON_KEY in index.html.\n\nGet these values from: https://supabase.com/dashboard â†’ Your Project â†’ Settings â†’ API');
                        return;
                    }

                    console.log('Creating competition with code:', code);
                    const { data: compData, error: compError } = await supabase
                        .from('competitions')
                        .insert([{
                            code: code,
                            total_pool: parseFloat(contributionAmount)
                        }])
                        .select()
                        .single();

                    if (compError) {
                        console.error('Supabase error creating competition:', compError);
                        alert(`Failed to create competition: ${compError.message}\n\nPlease check browser console for details.`);
                        return;
                    }

                    console.log('Competition created in Supabase:', compData);

                    // Save member to Supabase
                    console.log('Creating member with ID:', memberId);
                    const { data: memberData, error: memberError } = await supabase
                        .from('members')
                        .insert([{
                            competition_code: code,
                            member_id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {}
                            }
                        }])
                        .select()
                        .single();

                    if (memberError) {
                        console.error('Supabase error creating member:', memberError);
                        alert(`Failed to create member: ${memberError.message}\n\nPlease check browser console for details.`);
                        return;
                    }

                    console.log('Member created in Supabase:', memberData);

                    const newCompetition = {
                        code,
                        totalPool: parseFloat(contributionAmount),
                        startTime: compData.start_time,
                        members: [{
                            id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {}
                            },
                            joinedAt: memberData.joined_at
                        }]
                    };

                    setCompetition(newCompetition);
                    setCompetitionCode(code);
                    setCurrentUserId(memberId);
                    setView('code-display');
                    console.log('âœ… Competition created successfully:', code);
                } catch (error) {
                    console.error('Error creating competition:', error);
                    alert('Failed to create competition. Please try again.');
                }
            };

            const joinCompetition = async (code, memberName, contributionAmount) => {
                const memberId = Date.now().toString();

                try {
                    if (!supabase) {
                        alert('Supabase is not configured. Please update the SUPABASE_URL and SUPABASE_ANON_KEY in index.html.\n\nGet these values from: https://supabase.com/dashboard â†’ Your Project â†’ Settings â†’ API');
                        return;
                    }

                    // Check if competition exists
                    const { data: compData, error: compError } = await supabase
                        .from('competitions')
                        .select('*')
                        .eq('code', code)
                        .single();

                    if (compError || !compData) {
                        alert('Competition not found! Please check the code and try again.');
                        console.error('Competition not found:', compError);
                        return;
                    }

                    // Get existing members
                    const { data: existingMembers, error: membersError } = await supabase
                        .from('members')
                        .select('*')
                        .eq('competition_code', code);

                    if (membersError) {
                        console.error('Error fetching members:', membersError);
                        alert('Failed to load competition members. Please try again.');
                        return;
                    }

                    // Add new member
                    const { data: newMemberData, error: newMemberError } = await supabase
                        .from('members')
                        .insert([{
                            competition_code: code,
                            member_id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount || 0),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {}
                            }
                        }])
                        .select()
                        .single();

                    if (newMemberError) {
                        console.error('Error joining competition:', newMemberError);
                        alert('Failed to join competition. Please try again.');
                        return;
                    }

                    // Update total pool
                    const newTotalPool = compData.total_pool + parseFloat(contributionAmount || 0);
                    const { error: updateError } = await supabase
                        .from('competitions')
                        .update({ total_pool: newTotalPool })
                        .eq('code', code);

                    if (updateError) {
                        console.error('Error updating pool:', updateError);
                    }

                    // Build competition object with all members
                    const allMembers = [...existingMembers, newMemberData].map(m => ({
                        id: m.member_id,
                        name: m.name,
                        contribution: m.contribution,
                        portfolio: m.portfolio,
                        joinedAt: m.joined_at
                    }));

                    const joinedCompetition = {
                        code: code,
                        totalPool: newTotalPool,
                        startTime: compData.start_time,
                        members: allMembers
                    };

                    setCompetition(joinedCompetition);
                    setCompetitionCode(code);
                    setCurrentUserId(memberId);
                    setView('trading');

                    console.log('âœ… Joined competition successfully:', code);
                } catch (error) {
                    console.error('Error joining competition:', error);
                    alert('Failed to join competition. Please try again.');
                }
            };

            const signInToPersonalAccount = async (accountCode) => {
                try {
                    if (!supabase) {
                        alert('Database connection required. Please check your internet connection and try again.');
                        return;
                    }

                    console.log('Signing in to personal account:', accountCode);

                    // Load account from Supabase
                    const { data: accountData, error: accountError } = await supabase
                        .from('personal_accounts')
                        .select('*')
                        .eq('account_code', accountCode)
                        .single();

                    if (accountError || !accountData) {
                        alert('Account not found! Please check your account code and try again.');
                        console.error('Account not found:', accountError);
                        return;
                    }

                    console.log('Personal account loaded:', accountData);

                    const memberId = Date.now().toString();
                    const loadedCompetition = {
                        code: accountData.account_code,
                        totalPool: 0,
                        startTime: accountData.created_at,
                        members: [{
                            id: memberId,
                            name: accountData.user_name,
                            contribution: 0,
                            portfolio: accountData.portfolio,
                            joinedAt: accountData.created_at
                        }]
                    };

                    setCompetition(loadedCompetition);
                    setCompetitionCode(accountData.account_code);
                    setCurrentUserId(memberId);
                    setUserName(accountData.user_name);
                    setPlan('personal');
                    setView('trading');

                    console.log('âœ… Signed in to personal account successfully');
                } catch (error) {
                    console.error('Error signing in to personal account:', error);
                    alert('Failed to sign in. Please try again.');
                }
            };

            // Helper to calculate max shares you can buy
            const getMaxBuyQuantity = (stockSymbol) => {
                const stock = stocks.find(s => s.symbol === stockSymbol);
                if (!stock) return 0;
                const portfolio = getCurrentPortfolio();
                return Math.floor(portfolio.cash / stock.price);
            };

            // Helper to get current position
            const getCurrentPosition = (stockSymbol) => {
                const portfolio = getCurrentPortfolio();
                return portfolio.positions[stockSymbol] || 0;
            };

            // Helper to validate and set quantity
            const handleQuantityChange = (newQuantity, isBuy = true) => {
                const num = parseInt(newQuantity) || 0;

                if (num < 0) {
                    setQuantityError('Quantity cannot be negative');
                    return;
                }

                if (!selectedStock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const portfolio = getCurrentPortfolio();
                const maxBuy = getMaxBuyQuantity(selectedStock);
                const maxSell = getCurrentPosition(selectedStock);

                // If manually typing, check limits
                if (num > maxBuy) {
                    const totalCost = stock.price * num;
                    setQuantityError(`âš ï¸ Insufficient funds! You need $${totalCost.toFixed(2)} but only have $${portfolio.cash.toFixed(2)}. Max: ${maxBuy} shares`);
                    setQuantity(num); // Still set it so they can see what they typed
                } else if (num > maxSell && !isBuy) {
                    setQuantityError(`âš ï¸ You only own ${maxSell} shares of ${selectedStock}`);
                    setQuantity(num);
                } else {
                    setQuantityError('');
                    setQuantity(Math.max(1, num));
                }
            };

            // Buy max shares
            const buyMax = () => {
                if (!selectedStock) return;
                const maxShares = getMaxBuyQuantity(selectedStock);
                if (maxShares === 0) {
                    setQuantityError('âš ï¸ Insufficient funds to buy any shares');
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            // Sell max shares
            const sellMax = () => {
                if (!selectedStock) return;
                const maxShares = getCurrentPosition(selectedStock);
                if (maxShares === 0) {
                    setQuantityError(`âš ï¸ You don't own any shares of ${selectedStock}`);
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            const executeTrade = async (type) => {
                if (!selectedStock || quantity <= 0) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    alert('Stock data not available. Please add to watchlist and refresh.');
                    return;
                }

                const totalCost = stock.price * quantity;
                const portfolio = getCurrentPortfolio();
                const COOLDOWN_MINUTES = 15;
                const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;

                if (type === 'buy') {
                    const maxBuy = getMaxBuyQuantity(selectedStock);
                    if (quantity > maxBuy) {
                        alert(`Insufficient funds! You can only buy ${maxBuy} shares with $${portfolio.cash.toFixed(2)}`);
                        return;
                    }
                    if (totalCost > portfolio.cash) {
                        alert('Insufficient funds!');
                        return;
                    }
                } else {
                    // SELL - Check position
                    const currentPosition = portfolio.positions[selectedStock] || 0;
                    if (quantity > currentPosition) {
                        alert(`Insufficient shares! You only own ${currentPosition} shares of ${selectedStock}`);
                        return;
                    }

                    // Check 15-minute cooldown
                    const lastBuyTime = portfolio.lastBuyTime?.[selectedStock];
                    if (lastBuyTime) {
                        const timeSinceBuy = Date.now() - new Date(lastBuyTime).getTime();
                        const minutesSinceBuy = Math.floor(timeSinceBuy / 60000);

                        if (timeSinceBuy < COOLDOWN_MS) {
                            const minutesRemaining = COOLDOWN_MINUTES - minutesSinceBuy;
                            const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceBuy) / 1000) % 60;
                            alert(`â³ Trading Cooldown Active!\n\nYou must wait ${minutesRemaining} minute(s) and ${secondsRemaining} second(s) before selling ${selectedStock}.\n\nThis prevents rapid trading and encourages strategic decisions.`);
                            return;
                        }
                    }
                }

                const updatedPortfolio = {
                    ...portfolio,
                    cash: type === 'buy' ? portfolio.cash - totalCost : portfolio.cash + totalCost,
                    positions: {
                        ...portfolio.positions,
                        [selectedStock]: type === 'buy'
                            ? (portfolio.positions[selectedStock] || 0) + quantity
                            : (portfolio.positions[selectedStock] || 0) - quantity
                    },
                    history: [...portfolio.history, {
                        type,
                        symbol: selectedStock,
                        quantity,
                        price: stock.price,
                        total: totalCost,
                        timestamp: new Date().toISOString()
                    }],
                    lastBuyTime: type === 'buy'
                        ? { ...portfolio.lastBuyTime, [selectedStock]: new Date().toISOString() }
                        : portfolio.lastBuyTime
                };

                // Update local state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to Supabase for both personal and family plans
                if (competition?.code) {
                    try {
                        if (plan === 'personal') {
                            // Sync personal account
                            const { error } = await supabase
                                .from('personal_accounts')
                                .update({ portfolio: updatedPortfolio })
                                .eq('account_code', competition.code);

                            if (error) {
                                console.error('Error syncing personal account to Supabase:', error);
                            } else {
                                console.log('âœ… Personal account synced to Supabase');
                            }
                        } else if (plan === 'family') {
                            // Sync family competition member
                            const { error } = await supabase
                                .from('members')
                                .update({ portfolio: updatedPortfolio })
                                .eq('competition_code', competition.code)
                                .eq('member_id', currentUserId);

                            if (error) {
                                console.error('Error syncing trade to Supabase:', error);
                            } else {
                                console.log('âœ… Trade synced to Supabase');
                            }
                        }
                    } catch (error) {
                        console.error('Error syncing to Supabase:', error);
                    }
                }

                setQuantity(1);
                setQuantityError('');
            };

            // Fetch real historical price data from Finnhub
            const fetchHistoricalData = async (symbol) => {
                try {
                    // Get data for last 30 days
                    const toDate = Math.floor(Date.now() / 1000);
                    const fromDate = toDate - (30 * 24 * 60 * 60); // 30 days ago

                    const response = await fetch(
                        `${FINNHUB_API_BASE}/stock/candle?symbol=${symbol}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                    );
                    const data = await response.json();

                    if (data.s === 'ok' && data.c && data.c.length > 0) {
                        // data.c = closing prices, data.t = timestamps
                        const labels = data.t.map(timestamp => {
                            const date = new Date(timestamp * 1000);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        });
                        const prices = data.c.map(price => price.toFixed(2));

                        console.log(`âœ… Loaded real historical data for ${symbol}:`, {
                            dataPoints: prices.length,
                            firstPrice: prices[0],
                            lastPrice: prices[prices.length - 1]
                        });

                        return { labels, data: prices };
                    } else {
                        console.warn(`No historical data available for ${symbol}, using fallback`);
                        return null;
                    }
                } catch (error) {
                    console.error(`Error fetching historical data for ${symbol}:`, error);
                    return null;
                }
            };

            // Generate fallback historical data if API fails
            const generateFallbackHistoricalData = (currentPrice, days = 30) => {
                const data = [];
                const labels = [];
                let price = currentPrice;

                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                    const change = (Math.random() - 0.5) * (currentPrice * 0.03);
                    price = Math.max(currentPrice * 0.8, Math.min(currentPrice * 1.2, price + change));
                    data.push(price.toFixed(2));
                }

                data[data.length - 1] = currentPrice.toFixed(2);
                return { labels, data };
            };

            // Chart effect - create/update chart when stock is selected
            useEffect(() => {
                if (!selectedStock || !chartRef.current || !stocks.length) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) return;

                // Destroy existing chart
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                // Fetch and render real historical data
                const loadChart = async () => {
                    // Try to fetch real data from Finnhub
                    let historicalData = await fetchHistoricalData(selectedStock);

                    // Fallback to generated data if API fails
                    if (!historicalData) {
                        historicalData = generateFallbackHistoricalData(stock.price);
                    }

                    const { labels, data } = historicalData;

                    // Create new chart
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${stock.symbol} Price`,
                            data: data,
                            borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            backgroundColor: stock.change >= 0 ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return '$' + parseFloat(context.parsed.y).toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    maxTicksLimit: 6
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                    });
                };

                // Call async function
                loadChart();

                // Cleanup on unmount
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [selectedStock, stocks]);

            // Plan Selection Screen
            if (view === 'plan-select') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                        <div className="max-w-7xl mx-auto">
                            <div className="text-center mb-12 pt-8">
                                <div className="flex items-center justify-center mb-6">
                                    <div className="bg-gradient-to-r from-cyan-400 to-blue-400 p-4 rounded-2xl shadow-2xl">
                                        <span className="text-6xl">ðŸ“ˆ</span>
                                    </div>
                                </div>
                                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-4">
                                    TradeWars
                                </h1>
                                <p className="text-xl text-blue-100">Master the markets. Compete with family. Win real money.</p>
                                <div className="mt-4 inline-flex items-center gap-2 bg-purple-900/50 border border-purple-500 rounded-xl px-6 py-3">
                                    <span className="text-purple-200 font-semibold">Powered by</span>
                                    <span className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">Shop Pay</span>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
                                {/* Personal Plan - FREE */}
                                <div className="group relative bg-gradient-to-br from-blue-800 to-blue-900 rounded-3xl p-6 border-2 border-blue-600 hover:border-cyan-400 transition-all duration-300">
                                    <div className="flex items-center justify-center mb-4">
                                        <div className="bg-gradient-to-br from-cyan-400 to-blue-500 p-3 rounded-2xl">
                                            <span className="text-4xl">ðŸ‘¤</span>
                                        </div>
                                    </div>

                                    <h2 className="text-2xl font-bold text-white text-center mb-3">Personal</h2>

                                    <div className="text-center mb-4">
                                        <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">FREE</span>
                                        <div className="text-sm text-green-300 font-semibold mt-1">No Trading Fees</div>
                                    </div>

                                    <ul className="space-y-2 mb-6 text-blue-100 text-sm">
                                        <li>âœ… $100K virtual capital</li>
                                        <li>âœ… Trade any stock globally</li>
                                        <li>âœ… Custom watchlists</li>
                                        <li>âœ… Risk-free practice</li>
                                        <li>âœ… No fees whatsoever</li>
                                    </ul>

                                    <button
                                        onClick={() => {
                                            setPlan('personal');
                                            setView('setup-family');
                                        }}
                                        className="w-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white py-3 rounded-xl font-bold hover:from-cyan-300 hover:to-blue-400 transition-all duration-300"
                                    >
                                        Start Free
                                    </button>
                                </div>

                                {/* Family Public Plan - 1% Fee */}
                                <div className="group relative bg-gradient-to-br from-green-800 to-emerald-900 rounded-3xl p-6 border-2 border-green-600 hover:border-green-400 transition-all duration-300">
                                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                        <span className="bg-green-500 text-white text-xs font-black px-4 py-1 rounded-full">POPULAR</span>
                                    </div>

                                    <div className="flex items-center justify-center mb-4">
                                        <div className="bg-gradient-to-br from-green-400 to-emerald-500 p-3 rounded-2xl">
                                            <span className="text-4xl">ðŸ‘¥</span>
                                        </div>
                                    </div>

                                    <h2 className="text-2xl font-bold text-white text-center mb-3">Family Public</h2>

                                    <div className="text-center mb-4">
                                        <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">1%</span>
                                        <div className="text-sm text-green-300 font-semibold mt-1">Fee Per Trade</div>
                                    </div>

                                    <ul className="space-y-2 mb-6 text-green-100 text-sm">
                                        <li>ðŸ† Private competitions</li>
                                        <li>ðŸ’° Real money prizes</li>
                                        <li>ðŸ“Š Live leaderboards</li>
                                        <li>ðŸŽ¯ Winner takes all</li>
                                        <li>ðŸ’³ 1% trading expense</li>
                                    </ul>

                                    <div className="grid grid-cols-2 gap-2">
                                        <button
                                            onClick={() => {
                                                setPlan('family-public');
                                                setView('setup-family');
                                            }}
                                            className="bg-gradient-to-r from-green-400 to-emerald-500 text-white py-3 rounded-xl font-bold text-sm hover:from-green-300 hover:to-emerald-400 transition-all duration-300"
                                        >
                                            Create
                                        </button>
                                        <button
                                            onClick={() => {
                                                setPlan('family-public');
                                                setView('join-family');
                                            }}
                                            className="bg-green-700 text-white py-3 rounded-xl font-bold text-sm hover:bg-green-600 transition-all duration-300"
                                        >
                                            Join
                                        </button>
                                    </div>
                                </div>

                                {/* Family Private Plan - $0.05 Fee */}
                                <div className="group relative bg-gradient-to-br from-purple-800 to-indigo-900 rounded-3xl p-6 border-2 border-purple-600 hover:border-purple-400 transition-all duration-300">
                                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                        <span className="bg-purple-500 text-white text-xs font-black px-4 py-1 rounded-full">PREMIUM</span>
                                    </div>

                                    <div className="flex items-center justify-center mb-4">
                                        <div className="bg-gradient-to-br from-purple-400 to-pink-500 p-3 rounded-2xl">
                                            <span className="text-4xl">ðŸ‘‘</span>
                                        </div>
                                    </div>

                                    <h2 className="text-2xl font-bold text-white text-center mb-3">Family Private</h2>

                                    <div className="text-center mb-4">
                                        <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">$0.05</span>
                                        <div className="text-sm text-purple-300 font-semibold mt-1">Flat Fee Per Trade</div>
                                    </div>

                                    <ul className="space-y-2 mb-6 text-purple-100 text-sm">
                                        <li>ðŸ† Private competitions</li>
                                        <li>ðŸ’° Real money prizes</li>
                                        <li>ðŸ“Š Live leaderboards</li>
                                        <li>ðŸŽ¯ Winner takes all</li>
                                        <li>ðŸ’Ž Low fixed fee</li>
                                    </ul>

                                    <div className="grid grid-cols-2 gap-2">
                                        <button
                                            onClick={() => {
                                                setPlan('family-private');
                                                setView('setup-family');
                                            }}
                                            className="bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-xl font-bold text-sm hover:from-purple-300 hover:to-pink-400 transition-all duration-300"
                                        >
                                            Create
                                        </button>
                                        <button
                                            onClick={() => {
                                                setPlan('family-private');
                                                setView('join-family');
                                            }}
                                            className="bg-purple-700 text-white py-3 rounded-xl font-bold text-sm hover:bg-purple-600 transition-all duration-300"
                                        >
                                            Join
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Shop Pay Integration Notice */}
                            <div className="mt-8 max-w-2xl mx-auto bg-gradient-to-r from-purple-900/50 to-pink-900/50 border border-purple-500 rounded-2xl p-6">
                                <div className="flex items-center gap-4">
                                    <div className="text-5xl">ðŸ›¡ï¸</div>
                                    <div>
                                        <h3 className="text-white font-bold text-lg mb-1">Secure Payments with Shop Pay</h3>
                                        <p className="text-purple-200 text-sm">All Family plan payments are processed securely through Shop Pay. Fast, secure, and trusted by millions.</p>
                                    </div>
                                </div>
                            </div>

                            {/* Sign In to Existing Account */}
                            <div className="mt-6 max-w-md mx-auto text-center">
                                <p className="text-blue-200 mb-3">Already have an account?</p>
                                <button
                                    onClick={() => setView('signin')}
                                    className="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white px-8 py-3 rounded-xl font-bold transition-all duration-300 shadow-lg"
                                >
                                    ðŸ” Sign In to Your Account
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Code Display Screen (after creating competition)
            if (view === 'code-display') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8 flex items-center justify-center">
                        <div className="max-w-2xl w-full">
                            <div className="bg-gradient-to-br from-purple-800 to-indigo-900 rounded-3xl p-8 border-4 border-purple-500 shadow-2xl">
                                {/* Success Icon */}
                                <div className="text-center mb-6">
                                    <div className="inline-block bg-green-500 rounded-full p-6 mb-4">
                                        <span className="text-7xl">âœ…</span>
                                    </div>
                                    <h1 className="text-4xl font-black text-white mb-2">{plan === 'personal' ? 'Account Created!' : 'Competition Created!'}</h1>
                                    <p className="text-purple-200 text-lg">{plan === 'personal' ? 'Save this code to sign in from any device' : 'Share this code with your family members'}</p>
                                </div>

                                {/* Competition Code Display */}
                                <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-8 mb-6 border-2 border-white/30">
                                    <div className="text-center">
                                        <p className="text-purple-200 text-sm font-semibold mb-3">{plan === 'personal' ? 'YOUR ACCOUNT CODE' : 'YOUR COMPETITION CODE'}</p>
                                        <div className="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-6 mb-4">
                                            <div className="text-6xl font-black text-gray-900 tracking-widest font-mono">
                                                {competitionCode}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                navigator.clipboard.writeText(competitionCode);
                                                setCopySuccess(true);
                                                setTimeout(() => setCopySuccess(false), 2000);
                                            }}
                                            className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2 mx-auto"
                                        >
                                            {copySuccess ? 'âœ“ Copied!' : 'ðŸ“‹ Copy Code'}
                                        </button>
                                    </div>
                                </div>

                                {/* Instructions */}
                                <div className="bg-blue-900/50 rounded-xl p-6 mb-6 border border-blue-500">
                                    <h3 className="text-white font-bold mb-3 text-lg">{plan === 'personal' ? 'ðŸ” Important - Save Your Code!' : 'ðŸ“± How to Share:'}</h3>
                                    {plan === 'personal' ? (
                                        <ul className="text-purple-200 space-y-2 list-disc list-inside">
                                            <li>This code is your only way to access your account</li>
                                            <li>Save it in a safe place (password manager, notes app, etc.)</li>
                                            <li>Use it to sign in from any device</li>
                                            <li>Your portfolio and trades are saved to the cloud</li>
                                            <li className="text-green-300 font-semibold">You start with $100,000 virtual cash - Happy trading! ðŸ“ˆ</li>
                                        </ul>
                                    ) : (
                                        <ol className="text-purple-200 space-y-2 list-decimal list-inside">
                                            <li>Copy the code above</li>
                                            <li>Share it with your family members via text, email, or in person</li>
                                            <li>They click "Join Pool" and enter this code</li>
                                            <li>Everyone trades with $100,000 virtual cash</li>
                                            <li>Winner takes the prize pool: <span className="text-green-300 font-bold">${competition?.totalPool || 0}</span></li>
                                        </ol>
                                    )}
                                </div>

                                {/* Competition Info */}
                                <div className="bg-purple-900/50 rounded-xl p-4 mb-6 border border-purple-500">
                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div>
                                            <div className="text-purple-300 text-sm">Your Name</div>
                                            <div className="text-white font-bold text-lg">{userName}</div>
                                        </div>
                                        <div>
                                            <div className="text-purple-300 text-sm">Your Entry</div>
                                            <div className="text-green-300 font-bold text-lg">${contribution}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div className="grid grid-cols-1 gap-4">
                                    <button
                                        onClick={() => setView('trading')}
                                        className="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-300 hover:to-emerald-400 text-white py-5 rounded-xl font-black text-xl transition-all duration-300 shadow-lg"
                                    >
                                        ðŸš€ Start Trading
                                    </button>
                                    <button
                                        onClick={() => setView('plan-select')}
                                        className="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition-all duration-300"
                                    >
                                        â† Back to Home
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Sign In Screen
            if (view === 'signin') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8 flex items-center justify-center">
                        <div className="max-w-md w-full">
                            <button
                                onClick={() => setView('plan-select')}
                                className="mb-6 text-cyan-300 hover:text-cyan-200 font-semibold"
                            >
                                â† Back to Plans
                            </button>

                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-3xl p-8 border-2 border-cyan-500 shadow-2xl">
                                <div className="text-center mb-8">
                                    <div className="inline-block bg-cyan-500/20 rounded-full p-4 mb-4">
                                        <span className="text-6xl">ðŸ”</span>
                                    </div>
                                    <h1 className="text-4xl font-black text-white mb-2">Sign In</h1>
                                    <p className="text-blue-200">Enter your account code to continue trading</p>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Your Account Code</label>
                                        <input
                                            type="text"
                                            value={joinCode}
                                            onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                            placeholder="XXXXXX"
                                            maxLength="6"
                                            className="w-full bg-blue-700/50 border-2 border-cyan-500/50 rounded-xl px-4 py-4 text-white text-3xl font-black placeholder-blue-300 text-center tracking-widest uppercase focus:border-cyan-400 focus:outline-none transition-all"
                                        />
                                        <p className="text-xs text-blue-300 mt-2 text-center">This is the 6-character code you received when you created your account</p>
                                    </div>

                                    <button
                                        onClick={() => {
                                            if (!joinCode || joinCode.length !== 6) {
                                                alert('Please enter your 6-character account code');
                                                return;
                                            }
                                            signInToPersonalAccount(joinCode);
                                        }}
                                        className="w-full bg-gradient-to-r from-cyan-400 to-blue-500 hover:from-cyan-300 hover:to-blue-400 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 shadow-lg hover:shadow-xl"
                                    >
                                        ðŸš€ Sign In
                                    </button>
                                </div>

                                <div className="mt-6 p-4 bg-blue-900/50 border border-blue-600 rounded-xl">
                                    <p className="text-xs text-blue-200 text-center">
                                        ðŸ’¡ <span className="font-semibold">Tip:</span> Your account code works for both personal and family accounts. Make sure to save it somewhere safe!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Setup/Join screens
            if (view === 'setup-family' || view === 'join-family') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto">
                            <button
                                onClick={() => setView('plan-select')}
                                className="mb-6 text-cyan-300 hover:text-cyan-200 font-semibold"
                            >
                                â† Back to Plans
                            </button>

                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-3xl p-8 border border-blue-600">
                                <h2 className="text-4xl font-bold text-white mb-8 text-center">
                                    {view === 'setup-family' ? (plan === 'personal' ? 'Setup Personal Trading' : 'Create Competition') : 'Join Competition'}
                                </h2>

                                <div className="space-y-6">
                                    {view === 'join-family' && (
                                        <div>
                                            <label className="block text-blue-100 font-semibold mb-2">Competition Code</label>
                                            <input
                                                type="text"
                                                value={joinCode}
                                                onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                                placeholder="Enter 6-character code"
                                                maxLength="6"
                                                className="w-full bg-blue-700/50 border border-blue-500 rounded-xl px-4 py-3 text-white text-2xl font-bold placeholder-blue-300 text-center tracking-widest uppercase"
                                            />
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-blue-100 font-semibold mb-2">Your Name</label>
                                        <input
                                            type="text"
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                            placeholder="Enter your name"
                                            className="w-full bg-blue-700/50 border border-blue-500 rounded-xl px-4 py-3 text-white placeholder-blue-300"
                                        />
                                    </div>

                                    {plan === 'family' && (
                                        <div>
                                            <label className="block text-blue-100 font-semibold mb-2">Entry Amount ($)</label>
                                            <input
                                                type="number"
                                                value={contribution}
                                                onChange={(e) => setContribution(e.target.value)}
                                                placeholder="0.00"
                                                className="w-full bg-blue-700/50 border border-blue-500 rounded-xl px-4 py-3 text-white text-2xl font-bold placeholder-blue-300"
                                            />
                                        </div>
                                    )}

                                    <button
                                        onClick={() => {
                                            if (!userName) {
                                                alert('Please enter your name');
                                                return;
                                            }

                                            if (view === 'join-family') {
                                                // Join existing competition
                                                if (!joinCode || joinCode.length !== 6) {
                                                    alert('Please enter a valid 6-character competition code');
                                                    return;
                                                }
                                                if (!contribution || parseFloat(contribution) <= 0) {
                                                    alert('Please enter a valid contribution amount');
                                                    return;
                                                }
                                                joinCompetition(joinCode, userName, contribution);
                                            } else if (plan === 'personal') {
                                                createCompetition(userName, 0);
                                            } else if (!contribution || parseFloat(contribution) <= 0) {
                                                alert('Please enter a valid contribution amount');
                                                return;
                                            } else {
                                                createCompetition(userName, contribution);
                                            }
                                        }}
                                        className="w-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white py-4 rounded-xl font-bold text-lg"
                                    >
                                        {view === 'setup-family' ? (plan === 'personal' ? 'Start Trading' : 'Create Competition') : 'Join Competition'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Trading Interface
            const portfolio = getCurrentPortfolio();
            const portfolioValue = calculatePortfolioValue(portfolio);
            const portfolioReturn = ((portfolioValue - 100000) / 100000) * 100;

            const filteredStocks = stocks.filter(stock =>
                stock.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                stock.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Navigation Bar */}
                        <div className="mb-4 flex gap-3">
                            <button
                                onClick={() => setView('plan-select')}
                                className="bg-gradient-to-r from-cyan-400 to-blue-500 hover:from-cyan-300 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                            >
                                ðŸ  Home
                            </button>
                            <button
                                onClick={() => window.history.back()}
                                className="bg-blue-700 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                            >
                                â† Back
                            </button>
                        </div>

                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold text-white flex items-center gap-2">
                                        ðŸ“Š {plan === 'personal' ? 'Personal Trading' : 'Family Competition'}
                                    </h1>
                                    <p className="text-blue-200">{userName}</p>
                                </div>
                                {competition?.code && (
                                    <div className="bg-blue-700/50 rounded-xl px-6 py-3 border border-blue-500">
                                        <div className="text-xs text-blue-200">Competition Code</div>
                                        <div className="text-2xl font-bold text-white tracking-wider">{competition.code}</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600">
                                <div className="text-blue-200 text-sm font-semibold mb-2">ðŸ’µ Cash</div>
                                <div className="text-3xl font-bold text-white">${portfolio.cash.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            </div>

                            <div className="bg-gradient-to-br from-green-900/30 to-emerald-900/30 rounded-2xl p-6 border-2 border-green-500/50 relative overflow-hidden">
                                <div className="absolute inset-0 bg-gradient-to-r from-green-500/5 to-emerald-500/5 animate-pulse"></div>
                                <div className="relative">
                                    <div className="text-green-200 text-sm font-semibold mb-2 flex items-center gap-2">
                                        ðŸ“ˆ Portfolio Value
                                        {lastUpdate && <span className="text-xs text-green-400">(Live)</span>}
                                    </div>
                                    <div className="text-3xl font-bold text-white">${portfolioValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                    {lastUpdate && (
                                        <div className="text-xs text-green-300 mt-1">
                                            Updated: {lastUpdate.toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600">
                                <div className="text-blue-200 text-sm font-semibold mb-2">ðŸ“Š Return</div>
                                <div className={`text-3xl font-bold ${portfolioReturn >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                    {portfolioReturn >= 0 ? '+' : ''}{portfolioReturn.toFixed(2)}%
                                </div>
                                <div className={`text-sm font-semibold mt-1 ${portfolioReturn >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {portfolioReturn >= 0 ? '+' : ''}${(portfolioValue - 100000).toLocaleString(undefined, {maximumFractionDigits: 0})}
                                </div>
                            </div>

                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600">
                                <div className="text-blue-200 text-sm font-semibold mb-2">â­ Watchlist</div>
                                <div className="text-3xl font-bold text-white">{watchlist.length}</div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Market View */}
                            <div className="lg:col-span-2 bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600">
                                <h2 className="text-2xl font-bold text-white mb-4">ðŸ” Stock Search</h2>

                                <div className="relative mb-6">
                                    <input
                                        type="text"
                                        placeholder="Search stocks (e.g., AAPL, TSLA, NVDA)..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full bg-blue-700/50 border border-blue-500 rounded-xl px-4 py-3 text-white placeholder-blue-300"
                                    />
                                    {searching && (
                                        <div className="absolute right-4 top-4">
                                            <div className="text-cyan-300 animate-pulse">ðŸ”</div>
                                        </div>
                                    )}
                                </div>

                                {/* Search Results */}
                                {searchQuery && showSearchResults && (
                                    <div className="mb-6 bg-blue-800 border border-blue-600 rounded-xl overflow-hidden">
                                        {searching ? (
                                            <div className="p-6 text-center">
                                                <div className="text-blue-200">Searching...</div>
                                            </div>
                                        ) : searchResults.length > 0 ? (
                                            <div className="max-h-60 overflow-y-auto">
                                                {searchResults.map((result) => (
                                                    <div
                                                        key={result.symbol}
                                                        onClick={() => addToWatchlist(result.symbol, result.name)}
                                                        className="p-4 hover:bg-blue-700 cursor-pointer border-b border-blue-700 last:border-b-0 transition-colors"
                                                    >
                                                        <div className="font-bold text-white">{result.symbol}</div>
                                                        <div className="text-sm text-blue-200">{result.name}</div>
                                                        <div className="text-xs text-blue-400 mt-1">
                                                            {result.region} â€¢ {result.currency}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : error ? (
                                            <div className="p-6 text-center">
                                                <div className="text-yellow-300 mb-2">âš ï¸</div>
                                                <div className="text-yellow-200 text-sm">{error}</div>
                                            </div>
                                        ) : (
                                            <div className="p-6 text-center">
                                                <div className="text-blue-300 mb-2">ðŸ”</div>
                                                <div className="text-blue-200">No results found for "{searchQuery}"</div>
                                                <div className="text-xs text-blue-400 mt-2">Try: AAPL, GOOGL, MSFT, TSLA, NVDA</div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <h3 className="text-lg font-bold text-white mb-4">â­ My Watchlist</h3>

                                {loading && stocks.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="text-blue-200">Loading stocks...</div>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {filteredStocks.map(stock => (
                                            <div
                                                key={stock.symbol}
                                                onClick={() => setSelectedStock(stock.symbol)}
                                                className={`p-4 rounded-xl cursor-pointer transition-all ${
                                                    selectedStock === stock.symbol
                                                        ? 'bg-cyan-400/20 border-2 border-cyan-400'
                                                        : 'bg-blue-700/30 border border-blue-500 hover:bg-blue-700/50'
                                                }`}
                                            >
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="font-bold text-xl text-white">{stock.symbol}</div>
                                                        <div className="text-sm text-blue-200">{stock.name}</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-2xl text-white">${stock.price.toFixed(2)}</div>
                                                        <div className={`text-sm font-bold ${stock.change >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                            {stock.change >= 0 ? 'â†—' : 'â†˜'} {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Trading Panel */}
                            <div className="space-y-6">
                                {selectedStock ? (
                                    <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border-2 border-cyan-500 shadow-xl">
                                        {/* Stock Header */}
                                        <div className="mb-6 pb-6 border-b border-blue-600">
                                            <div className="flex items-center justify-between mb-3">
                                                <h2 className="text-4xl font-black text-white">{selectedStock}</h2>
                                                <div className={`px-4 py-2 rounded-lg font-bold text-sm ${
                                                    (stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0
                                                        ? 'bg-green-500/20 text-green-300 border border-green-500'
                                                        : 'bg-red-500/20 text-red-300 border border-red-500'
                                                }`}>
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? 'â†—' : 'â†˜'}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? '+' : ''}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0).toFixed(2)}%
                                                </div>
                                            </div>
                                            <p className="text-blue-200 text-lg">{stocks.find(s => s.symbol === selectedStock)?.name || selectedStock}</p>
                                        </div>

                                        {/* Price Display */}
                                        <div className="mb-6 text-center bg-gradient-to-r from-cyan-500/10 to-blue-500/10 rounded-xl p-6 border border-cyan-500/30">
                                            <div className="text-sm text-cyan-300 font-semibold mb-2">Current Price</div>
                                            <div className="text-6xl font-black text-white mb-1">
                                                ${(stocks.find(s => s.symbol === selectedStock)?.price || 0).toFixed(2)}
                                            </div>
                                            <div className="text-sm text-blue-300">Per Share</div>
                                        </div>

                                        {/* Price Chart */}
                                        <div className="mb-6 bg-blue-700/20 rounded-xl p-4 border border-blue-600">
                                            <h3 className="text-sm font-semibold text-blue-200 mb-3">ðŸ“ˆ 30-Day Price Chart</h3>
                                            <div className="h-48">
                                                <canvas ref={chartRef}></canvas>
                                            </div>
                                        </div>

                                        {/* Quantity Selector */}
                                        <div className="mb-6">
                                            <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Select Quantity</label>
                                            <div className="flex gap-3 mb-3">
                                                <button
                                                    onClick={() => handleQuantityChange(quantity - 1)}
                                                    className="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-14 rounded-xl font-bold text-2xl transition-all duration-200 shadow-lg hover:shadow-xl"
                                                >
                                                    âˆ’
                                                </button>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    value={quantity}
                                                    onChange={(e) => handleQuantityChange(e.target.value)}
                                                    className="flex-1 bg-blue-700/50 border-2 border-cyan-500/50 rounded-xl px-4 py-3 text-white text-center text-2xl font-black focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                                <button
                                                    onClick={() => handleQuantityChange(quantity + 1)}
                                                    className="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-14 rounded-xl font-bold text-2xl transition-all duration-200 shadow-lg hover:shadow-xl"
                                                >
                                                    +
                                                </button>
                                            </div>

                                            {/* Quick Actions */}
                                            <div className="flex gap-2 mb-3">
                                                <button
                                                    onClick={buyMax}
                                                    className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl"
                                                >
                                                    ðŸ’° Buy Max ({getMaxBuyQuantity(selectedStock)})
                                                </button>
                                                <button
                                                    onClick={sellMax}
                                                    className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl"
                                                >
                                                    ðŸ“Š Sell Max ({getCurrentPosition(selectedStock)})
                                                </button>
                                            </div>

                                            {/* Error message */}
                                            {quantityError && (
                                                <div className="bg-red-900/40 border-2 border-red-500 rounded-xl p-4 text-red-200 text-sm font-semibold animate-pulse">
                                                    âš ï¸ {quantityError}
                                                </div>
                                            )}
                                        </div>

                                        {/* Total Cost Summary */}
                                        <div className="mb-6 p-5 bg-gradient-to-r from-purple-900/40 to-blue-900/40 border-2 border-purple-500/50 rounded-xl">
                                            <div className="flex justify-between items-center text-white">
                                                <span className="text-purple-200 font-semibold">Total Cost:</span>
                                                <span className="text-3xl font-black">${((stocks.find(s => s.symbol === selectedStock)?.price || 0) * quantity).toFixed(2)}</span>
                                            </div>
                                        </div>

                                        {/* Trade Actions */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <button
                                                onClick={() => executeTrade('buy')}
                                                className="group relative bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white py-5 rounded-xl font-black text-xl shadow-2xl hover:shadow-green-500/50 transition-all duration-300 hover:scale-105"
                                            >
                                                <span className="flex items-center justify-center gap-2">
                                                    <span className="text-2xl group-hover:animate-bounce">ðŸš€</span>
                                                    <span>BUY</span>
                                                </span>
                                            </button>
                                            <button
                                                onClick={() => executeTrade('sell')}
                                                className="group relative bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-400 hover:to-pink-500 text-white py-5 rounded-xl font-black text-xl shadow-2xl hover:shadow-red-500/50 transition-all duration-300 hover:scale-105"
                                            >
                                                <span className="flex items-center justify-center gap-2">
                                                    <span className="text-2xl group-hover:animate-bounce">ðŸ’¸</span>
                                                    <span>SELL</span>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-8 border-2 border-blue-500/50">
                                        <div className="text-center py-16">
                                            <div className="text-8xl mb-6 animate-pulse">ðŸ“Š</div>
                                            <h3 className="text-2xl font-bold text-white mb-3">Ready to Trade?</h3>
                                            <p className="text-blue-200 text-lg mb-6">Select a stock from your watchlist to get started</p>
                                            <div className="inline-flex items-center gap-2 bg-cyan-500/20 border border-cyan-500 rounded-xl px-6 py-3 text-cyan-300 font-semibold">
                                                <span>ðŸ‘ˆ</span>
                                                <span>Choose a stock on the left</span>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Portfolio Positions */}
                                <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600">
                                    <h3 className="text-xl font-bold text-white mb-4">ðŸ’¼ Your Positions</h3>
                                    <div className="space-y-2">
                                        {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length === 0 ? (
                                            <div className="text-center py-6 text-blue-300">No positions yet</div>
                                        ) : (
                                            Object.entries(portfolio.positions)
                                                .filter(([_, qty]) => qty > 0)
                                                .map(([symbol, qty]) => {
                                                    const stock = stocks.find(s => s.symbol === symbol);
                                                    if (!stock) return null;
                                                    const value = stock.price * qty;
                                                    return (
                                                        <div key={symbol} className="bg-blue-700/30 border border-blue-500 rounded-xl p-3">
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <div className="font-bold text-white">{symbol}</div>
                                                                    <div className="text-sm text-blue-200">{qty} shares</div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="font-bold text-white">${value.toFixed(2)}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingSimulator />);
    </script>
</body>
</html>
