<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinClash - Stock Trading Simulator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <!-- External CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="root"></div>

    <!-- External JavaScript modules -->
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/crypto-utils.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/news-feed.js"></script>
    <script src="js/short-selling.js"></script>
    <script src="js/security.js"></script>

    <!-- Initialize database on page load -->
    <script>
        // Initialize database when page loads
        initDatabase();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Database and config are loaded from external JS files
        // Available: db, dbReady, SQLiteDB, initDatabase(), saveDatabase()
        // Available: FINNHUB_API_KEY, FINNHUB_API_BASE, STOCK_DATABASE, etc.

        const TradingSimulator = () => {
            const [view, setView] = useState('plan-select');
            const [plan, setPlan] = useState(null);
            const [userName, setUserName] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [userPasscode, setUserPasscode] = useState('');
            const [generatedPasscode, setGeneratedPasscode] = useState('');
            const [userPassword, setUserPassword] = useState('');
            const [passwordStrength, setPasswordStrength] = useState(null);
            const [currentUserId, setCurrentUserId] = useState(null);
            const [contribution, setContribution] = useState('');
            const [resetEmail, setResetEmail] = useState('');
            const [resetCode, setResetCode] = useState('');
            const [newPasscode, setNewPasscode] = useState('');
            const [resetStep, setResetStep] = useState(1); // 1: enter email, 2: enter code + new passcode
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [accountMode, setAccountMode] = useState('create'); // 'create' or 'login'

            const [competitionCode, setCompetitionCode] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [competition, setCompetition] = useState(null);

            const [watchlist, setWatchlist] = useState([]);
            const [stocks, setStocks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);

            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [showSearchResults, setShowSearchResults] = useState(false);

            const [selectedStock, setSelectedStock] = useState(null);
            const [quantity, setQuantity] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('market');
            const [quantityError, setQuantityError] = useState('');
            const [mainTab, setMainTab] = useState('portfolio');
            const [chartPeriod, setChartPeriod] = useState('1M');
            const [topStocks, setTopStocks] = useState([]);
            const [isRealChartData, setIsRealChartData] = useState(false);
            const [stockNews, setStockNews] = useState([]);
            const [loadingNews, setLoadingNews] = useState(false);
            const [tradeType, setTradeType] = useState('long'); // 'long' or 'short'
            const [marketNews, setMarketNews] = useState([]);
            const [loadingMarketNews, setLoadingMarketNews] = useState(false);
            const [lastNewsUpdate, setLastNewsUpdate] = useState(null);
            const [lastStockNewsUpdate, setLastStockNewsUpdate] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [loadingAnalysis, setLoadingAnalysis] = useState(false);
            const [analysisExpanded, setAnalysisExpanded] = useState(true);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const performanceChartRef = useRef(null);
            const performanceChartInstance = useRef(null);

            // Constants are now loaded from config.js:
            // COMMISSION_RATE, COOLDOWN_MINUTES, COOLDOWN_MS
            // STRIPE_FAMILY_PUBLIC_LINK, STRIPE_FAMILY_PRIVATE_LINK
            // POPULAR_STOCKS, TOP_12_STOCKS
            // FINNHUB_API_KEY, FINNHUB_API_BASE, STOCK_DATABASE, FALLBACK_STOCK_DATA

            // Load watchlist from portfolio when competition/account changes
            useEffect(() => {
                if (competition?.members) {
                    const currentMember = competition.members.find(m => m.id === currentUserId);
                    if (currentMember?.portfolio?.watchlist) {
                        setWatchlist(currentMember.portfolio.watchlist);
                    } else {
                        setWatchlist([]);
                    }
                }
            }, [competition, currentUserId]);

            const searchStocks = async (query) => {
                if (!query || query.length < 1) {
                    setSearchResults([]);
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                setSearching(true);
                setShowSearchResults(true);
                setError(null);

                try {
                    const searchTerm = query.toLowerCase();

                    // Search in stock database
                    const results = STOCK_DATABASE
                        .filter(stock =>
                            stock.symbol.toLowerCase().includes(searchTerm) ||
                            stock.name.toLowerCase().includes(searchTerm)
                        )
                        .slice(0, 10)
                        .map(stock => ({
                            symbol: stock.symbol,
                            name: stock.name,
                            type: 'EQUITY',
                            region: 'US',
                            currency: 'USD'
                        }));

                    console.log('Search Results:', results);

                    if (results.length > 0) {
                        setSearchResults(results);
                    } else {
                        // If no match in database, validate with API before showing
                        const upperQuery = query.toUpperCase();

                        // Only show if it looks like a valid ticker (2-5 letters)
                        if (/^[A-Z]{1,5}$/.test(upperQuery)) {
                            // Try to validate with Finnhub API
                            try {
                                const response = await fetch(
                                    `${FINNHUB_API_BASE}/quote?symbol=${upperQuery}&token=${FINNHUB_API_KEY}`
                                );
                                const data = await response.json();

                                // Only show if we get valid price data back
                                if (data.c && data.c > 0) {
                                    setSearchResults([{
                                        symbol: upperQuery,
                                        name: `${upperQuery}`,
                                        type: 'EQUITY',
                                        region: 'US',
                                        currency: 'USD'
                                    }]);
                                } else {
                                    // Not a valid stock
                                    setSearchResults([]);
                                }
                            } catch (error) {
                                console.error('Error validating stock:', error);
                                setSearchResults([]);
                            }
                        } else {
                            // Invalid format - don't show anything
                            setSearchResults([]);
                        }
                    }
                } catch (error) {
                    console.error('Error searching stocks:', error);
                    setSearchResults([]);
                }
                setSearching(false);
            };

            useEffect(() => {
                const timer = setTimeout(() => {
                    if (searchQuery) {
                        searchStocks(searchQuery);
                    } else {
                        setSearchResults([]);
                        setShowSearchResults(false);
                        setError(null);
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, [searchQuery]);

            const fetchStockData = async () => {
                if (watchlist.length === 0) return;

                try {
                    setLoading(true);
                    setError(null);

                    // Fetch all stocks in parallel using Finnhub
                    const promises = watchlist.map(async (symbol) => {
                        try {
                            // Get current quote
                            const quoteResponse = await fetch(
                                `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                            );
                            const quoteData = await quoteResponse.json();

                            console.log(`Finnhub ${symbol}:`, quoteData);

                            const currentPrice = quoteData.c; // Current price
                            const previousClose = quoteData.pc; // Previous close
                            const priceChange = quoteData.d; // Change
                            const changePercent = quoteData.dp; // Change percent
                            const high = quoteData.h; // High
                            const low = quoteData.l; // Low
                            const open = quoteData.o; // Open

                            return {
                                symbol: symbol,
                                name: getStockName(symbol),
                                price: parseFloat((currentPrice || 0).toFixed(2)),
                                change: parseFloat((changePercent || 0).toFixed(2)),
                                volume: 'N/A',
                                previousClose: previousClose || 0,
                                high: high || currentPrice,
                                low: low || currentPrice,
                                open: open || currentPrice
                            };
                        } catch (error) {
                            console.error(`Error fetching ${symbol}:`, error);
                            return getFallbackStockData(symbol);
                        }
                    });

                    const stocksData = await Promise.all(promises);

                    if (stocksData.length > 0) {
                        setStocks(stocksData);
                        setLastUpdate(new Date());
                        console.log('âœ… All stocks loaded with Finnhub real-time prices:', stocksData);
                    }

                    setLoading(false);
                } catch (error) {
                    console.error('Error fetching stock data:', error);
                    setError('Failed to load stock data. Using fallback prices.');

                    const fallbackData = watchlist.map(symbol => getFallbackStockData(symbol));
                    setStocks(fallbackData);
                    setLastUpdate(new Date());
                    setLoading(false);
                }
            };

            const getStockName = (symbol) => {
                const names = {
                    'AAPL': 'Apple Inc.',
                    'GOOGL': 'Alphabet Inc.',
                    'MSFT': 'Microsoft Corp.',
                    'AMZN': 'Amazon.com Inc.',
                    'TSLA': 'Tesla Inc.',
                    'NVDA': 'NVIDIA Corp.',
                    'META': 'Meta Platforms',
                    'NFLX': 'Netflix Inc.',
                    'AMD': 'Advanced Micro Devices',
                    'DIS': 'Walt Disney Co.'
                };
                return names[symbol] || symbol;
            };

            const formatVolume = (volume) => {
                if (!volume) return 'N/A';
                if (volume >= 1000000000) return `${(volume / 1000000000).toFixed(1)}B`;
                if (volume >= 1000000) return `${(volume / 1000000).toFixed(1)}M`;
                if (volume >= 1000) return `${(volume / 1000).toFixed(1)}K`;
                return volume.toString();
            };

            const getFallbackStockData = (symbol) => {
                // Use FALLBACK_STOCK_DATA from config.js
                return {
                    symbol,
                    name: getStockName(symbol),
                    price: FALLBACK_STOCK_DATA[symbol]?.price || Math.random() * 200 + 50,
                    change: FALLBACK_STOCK_DATA[symbol]?.change || (Math.random() - 0.5) * 10,
                    volume: '10.5M'
                };
            };

            // Fetch live data for a single stock using Finnhub API
            const fetchSingleStock = async (symbol, stockName = null) => {
                try {
                    const response = await fetch(
                        `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                    );
                    const data = await response.json();

                    console.log(`Fetching single stock ${symbol}:`, data);

                    if (data.c) {
                        const currentPrice = data.c; // Current price
                        const previousClose = data.pc; // Previous close
                        const changePercent = data.dp; // Change percent
                        const high = data.h; // High
                        const low = data.l; // Low
                        const open = data.o; // Open

                        console.log(`âœ… Finnhub ${symbol}:`, {
                            price: currentPrice,
                            change: changePercent,
                            previousClose: previousClose
                        });

                        return {
                            symbol: symbol,
                            name: stockName || getStockName(symbol),
                            price: parseFloat((currentPrice || 0).toFixed(2)),
                            change: parseFloat((changePercent || 0).toFixed(2)),
                            volume: 'N/A',
                            previousClose: previousClose || 0,
                            high: high || currentPrice,
                            low: low || currentPrice,
                            open: open || currentPrice
                        };
                    } else {
                        // Fallback if API fails
                        console.warn(`No data for ${symbol}, using fallback`);
                        const fallbackData = getFallbackStockData(symbol);
                        if (stockName) fallbackData.name = stockName;
                        return fallbackData;
                    }
                } catch (error) {
                    console.error(`Error fetching ${symbol}:`, error);
                    const fallbackData = getFallbackStockData(symbol);
                    if (stockName) fallbackData.name = stockName;
                    return fallbackData;
                }
            };

            const addToWatchlist = async (symbol, stockName = null) => {
                if (watchlist.includes(symbol)) {
                    // Already in watchlist, just select it
                    setSelectedStock(symbol);
                    setSearchQuery('');
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                // Show loading state
                setSearching(true);
                setError(null);

                // Fetch live data for this stock
                const stockData = await fetchSingleStock(symbol, stockName);

                // Add to watchlist
                const newWatchlist = [...watchlist, symbol];
                setWatchlist(newWatchlist);

                // Update portfolio with new watchlist
                const portfolio = getCurrentPortfolio();
                const updatedPortfolio = {
                    ...portfolio,
                    watchlist: newWatchlist
                };

                // Update local state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to SQLite database
                if (competition?.code && plan === 'personal' && dbReady) {
                    try {
                        SQLiteDB.updateAccount(competition.code, updatedPortfolio);
                    } catch (error) {
                        console.error('Error syncing watchlist to SQLite:', error);
                    }
                }

                // Add to stocks array or update if exists
                const existingIndex = stocks.findIndex(s => s.symbol === symbol);
                if (existingIndex >= 0) {
                    const updatedStocks = [...stocks];
                    updatedStocks[existingIndex] = stockData;
                    setStocks(updatedStocks);
                } else {
                    setStocks([...stocks, stockData]);
                }

                // Select the stock
                setSelectedStock(symbol);

                // Clear search
                setSearchQuery('');
                setShowSearchResults(false);
                setSearching(false);
            };

            const removeFromWatchlist = (symbol) => {
                const newWatchlist = watchlist.filter(s => s !== symbol);
                setWatchlist(newWatchlist);
                setStocks(stocks.filter(s => s.symbol !== symbol));

                // Update portfolio with new watchlist
                const portfolio = getCurrentPortfolio();
                const updatedPortfolio = {
                    ...portfolio,
                    watchlist: newWatchlist
                };

                // Update local state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to SQLite database
                if (competition?.code && plan === 'personal' && dbReady) {
                    try {
                        SQLiteDB.updateAccount(competition.code, updatedPortfolio);
                    } catch (error) {
                        console.error('Error syncing watchlist to SQLite:', error);
                    }
                }
            };

            useEffect(() => {
                if (view === 'trading' && watchlist.length > 0) {
                    fetchStockData();

                    // Auto-refresh stock prices every 30 seconds to update portfolio value
                    const refreshInterval = setInterval(() => {
                        console.log('ðŸ”„ Auto-refreshing stock prices...');
                        fetchStockData();
                    }, 30000); // 30 seconds

                    return () => clearInterval(refreshInterval);
                }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [view, watchlist]);

            // Clear error when selected stock changes
            useEffect(() => {
                setQuantityError('');
                setQuantity(1);
            }, [selectedStock]);

            const getCurrentPortfolio = () => {
                const defaultPortfolio = {
                    cash: 100000,
                    positions: {},
                    shortPositions: {},
                    history: [],
                    lastBuyTime: {},
                    watchlist: [],
                    performanceHistory: [] // Track daily portfolio values for analytics
                };

                if (plan === 'personal') {
                    return competition?.members[0]?.portfolio || defaultPortfolio;
                }
                const member = competition?.members.find(m => m.id === currentUserId);
                return member?.portfolio || defaultPortfolio;
            };

            const calculatePortfolioValue = (portfolio) => {
                if (!portfolio || typeof portfolio.cash !== 'number') {
                    return 100000; // Default starting value
                }

                let positionsValue = 0;
                if (portfolio.positions && stocks.length > 0) {
                    Object.entries(portfolio.positions).forEach(([symbol, qty]) => {
                        const stock = stocks.find(s => s.symbol === symbol);
                        if (stock && typeof stock.price === 'number' && typeof qty === 'number') {
                            positionsValue += stock.price * qty;
                        }
                    });
                }

                const totalValue = portfolio.cash + positionsValue;
                return isNaN(totalValue) ? 100000 : totalValue;
            };

            // Fetch top 12 stocks with live prices
            const fetchTopStocks = async () => {
                try {
                    const stockPromises = TOP_12_STOCKS.map(async (symbol) => {
                        try {
                            const response = await fetch(
                                `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                            );
                            const data = await response.json();

                            if (data.c) {
                                return {
                                    symbol,
                                    price: data.c,
                                    change: data.dp || 0,
                                    high: data.h,
                                    low: data.l
                                };
                            }
                            return null;
                        } catch (error) {
                            console.error(`Error fetching ${symbol}:`, error);
                            return null;
                        }
                    });

                    const results = await Promise.all(stockPromises);
                    const validStocks = results.filter(stock => stock !== null);
                    setTopStocks(validStocks);
                } catch (error) {
                    console.error('Error fetching top stocks:', error);
                }
            };

            // Load top stocks on mount and refresh every 30 seconds
            useEffect(() => {
                fetchTopStocks();
                const interval = setInterval(fetchTopStocks, 30000);
                return () => clearInterval(interval);
            }, []);

            // Handle Google OAuth callback
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const googleAuth = urlParams.get('googleAuth');
                const email = urlParams.get('email');
                const accountCode = urlParams.get('accountCode');

                if (googleAuth === 'success' && email && accountCode) {
                    // Fetch user data from backend
                    fetch('http://localhost:3001/api/auth/user', {
                        credentials: 'include'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.user) {
                            const account = data.user;
                            const newCompetition = {
                                code: account.accountCode,
                                totalPool: 0,
                                startTime: account.createdAt,
                                members: [{
                                    id: Date.now().toString(),
                                    name: account.userName,
                                    contribution: 0,
                                    portfolio: account.portfolio,
                                    joinedAt: account.createdAt
                                }]
                            };

                            setCompetition(newCompetition);
                            setCompetitionCode(account.accountCode);
                            setCurrentUserId(newCompetition.members[0].id);
                            setUserName(account.userName);
                            setUserEmail(account.email);
                            setView('app');

                            // Clean up URL
                            window.history.replaceState({}, document.title, '/');
                            console.log('âœ… Signed in with Google successfully');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching Google user data:', error);
                        alert('Failed to complete Google sign in. Please try again.');
                    });
                }
            }, []);

            const generateCompetitionCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const generatePasscode = () => {
                // Generate 6-digit passcode
                return Math.floor(100000 + Math.random() * 900000).toString();
            };

            const createCompetition = async (memberName, contributionAmount, password = null) => {
                const code = generateCompetitionCode();
                const memberId = Date.now().toString();
                const isPersonalPlan = parseFloat(contributionAmount || 0) === 0;

                try {
                    // Personal plans use backend server
                    if (isPersonalPlan) {
                        console.log('Creating personal account with backend server');

                        const initialPortfolio = {
                            cash: 100000,
                            positions: {},
                            history: [],
                            lastBuyTime: {},
                            watchlist: []
                        };

                        const passcode = generatePasscode();

                        // Create account on backend server
                        const response = await fetch('http://localhost:3001/api/accounts/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                userName: memberName,
                                password: password,
                                accountCode: code,
                                portfolio: initialPortfolio
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            alert(data.error || 'Failed to create account');
                            return;
                        }

                        setGeneratedPasscode(passcode);

                        const newCompetition = {
                            code: code,
                            totalPool: 0,
                            startTime: new Date().toISOString(),
                            members: [{
                                id: memberId,
                                name: memberName,
                                contribution: 0,
                                portfolio: initialPortfolio,
                                joinedAt: new Date().toISOString()
                            }]
                        };

                        setCompetition(newCompetition);
                        setCompetitionCode(code);
                        setCurrentUserId(memberId);
                        setView('code-display');
                        console.log('âœ… Personal account created successfully:', code);
                        return;
                    }

                    // Family plans save to Supabase
                    if (!supabase) {
                        alert('Supabase is not configured. Please update the SUPABASE_URL and SUPABASE_ANON_KEY in index.html.\n\nGet these values from: https://supabase.com/dashboard â†’ Your Project â†’ Settings â†’ API');
                        return;
                    }

                    console.log('Creating competition with code:', code, 'plan:', plan);
                    const { data: compData, error: compError } = await supabase
                        .from('competitions')
                        .insert([{
                            code: code,
                            plan_type: plan, // Save 'family-public' or 'family-private'
                            total_pool: parseFloat(contributionAmount)
                        }])
                        .select()
                        .single();

                    if (compError) {
                        console.error('Supabase error creating competition:', compError);
                        alert(`Failed to create competition: ${compError.message}\n\nPlease check browser console for details.`);
                        return;
                    }

                    console.log('Competition created in Supabase:', compData);

                    // Save member to Supabase
                    console.log('Creating member with ID:', memberId);
                    const { data: memberData, error: memberError } = await supabase
                        .from('members')
                        .insert([{
                            competition_code: code,
                            member_id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {},
                                watchlist: []
                            }
                        }])
                        .select()
                        .single();

                    if (memberError) {
                        console.error('Supabase error creating member:', memberError);
                        alert(`Failed to create member: ${memberError.message}\n\nPlease check browser console for details.`);
                        return;
                    }

                    console.log('Member created in Supabase:', memberData);

                    const newCompetition = {
                        code,
                        totalPool: parseFloat(contributionAmount),
                        startTime: compData.start_time,
                        members: [{
                            id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {},
                                watchlist: []
                            },
                            joinedAt: memberData.joined_at
                        }]
                    };

                    setCompetition(newCompetition);
                    setCompetitionCode(code);
                    setCurrentUserId(memberId);
                    setView('code-display');
                    console.log('âœ… Competition created successfully:', code);
                } catch (error) {
                    console.error('Error creating competition:', error);
                    alert('Failed to create competition. Please try again.');
                }
            };

            const joinCompetition = async (code, memberName, contributionAmount) => {
                const memberId = Date.now().toString();

                try {
                    if (!supabase) {
                        alert('Supabase is not configured. Please update the SUPABASE_URL and SUPABASE_ANON_KEY in index.html.\n\nGet these values from: https://supabase.com/dashboard â†’ Your Project â†’ Settings â†’ API');
                        return;
                    }

                    // Check if competition exists
                    const { data: compData, error: compError } = await supabase
                        .from('competitions')
                        .select('*')
                        .eq('code', code)
                        .single();

                    if (compError || !compData) {
                        alert('Competition not found! Please check the code and try again.');
                        console.error('Competition not found:', compError);
                        return;
                    }

                    // Get existing members
                    const { data: existingMembers, error: membersError } = await supabase
                        .from('members')
                        .select('*')
                        .eq('competition_code', code);

                    if (membersError) {
                        console.error('Error fetching members:', membersError);
                        alert('Failed to load competition members. Please try again.');
                        return;
                    }

                    // Add new member
                    const { data: newMemberData, error: newMemberError } = await supabase
                        .from('members')
                        .insert([{
                            competition_code: code,
                            member_id: memberId,
                            name: memberName,
                            contribution: parseFloat(contributionAmount || 0),
                            portfolio: {
                                cash: 100000,
                                positions: {},
                                history: [],
                                lastBuyTime: {},
                                watchlist: []
                            }
                        }])
                        .select()
                        .single();

                    if (newMemberError) {
                        console.error('Error joining competition:', newMemberError);
                        alert('Failed to join competition. Please try again.');
                        return;
                    }

                    // Update total pool
                    const newTotalPool = compData.total_pool + parseFloat(contributionAmount || 0);
                    const { error: updateError } = await supabase
                        .from('competitions')
                        .update({ total_pool: newTotalPool })
                        .eq('code', code);

                    if (updateError) {
                        console.error('Error updating pool:', updateError);
                    }

                    // Build competition object with all members
                    const allMembers = [...existingMembers, newMemberData].map(m => ({
                        id: m.member_id,
                        name: m.name,
                        contribution: m.contribution,
                        portfolio: m.portfolio,
                        joinedAt: m.joined_at
                    }));

                    const joinedCompetition = {
                        code: code,
                        totalPool: newTotalPool,
                        startTime: compData.start_time,
                        members: allMembers
                    };

                    setCompetition(joinedCompetition);
                    setCompetitionCode(code);
                    setCurrentUserId(memberId);
                    setPlan(compData.plan_type || 'family-public'); // Set plan type from competition
                    setView('trading');

                    console.log('âœ… Joined competition successfully:', code, 'plan:', compData.plan_type);
                } catch (error) {
                    console.error('Error joining competition:', error);
                    alert('Failed to join competition. Please try again.');
                }
            };

            const signInWithEmailAndPasscode = async (email, passcode) => {
                try {
                    console.log('Signing in with email and passcode:', email);

                    // Use SQLite database
                    if (!dbReady) {
                        alert('Database is still loading. Please wait a moment and try again.');
                        return;
                    }

                    const accountData = SQLiteDB.getAccountByEmailAndPasscode(email, passcode);

                    if (!accountData) {
                        alert('Invalid email or passcode! Please check your credentials and try again.');
                        console.error('Account not found for email:', email);
                        return;
                    }

                    console.log('âœ… Personal account loaded:', accountData);

                    const memberId = Date.now().toString();
                    const loadedCompetition = {
                        code: accountData.account_code,
                        totalPool: 0,
                        startTime: accountData.created_at,
                        members: [{
                            id: memberId,
                            name: accountData.user_name,
                            contribution: 0,
                            portfolio: accountData.portfolio,
                            joinedAt: accountData.created_at
                        }]
                    };

                    setCompetition(loadedCompetition);
                    setCompetitionCode(accountData.account_code);
                    setCurrentUserId(memberId);
                    setUserName(accountData.user_name);
                    setUserEmail(email);
                    setPlan('personal');
                    setView('trading');

                    console.log('âœ… Signed in to personal account successfully');
                } catch (error) {
                    console.error('Error signing in to personal account:', error);
                    alert('Failed to sign in. Please try again.');
                }
            };

            const signInToPersonalAccount = async (accountCode) => {
                try {
                    console.log('Signing in to personal account:', accountCode);

                    let accountData = null;

                    // Use SQLite database
                    if (!dbReady) {
                        alert('Database is still loading. Please wait a moment and try again.');
                        return;
                    }

                    accountData = SQLiteDB.getAccount(accountCode);

                    if (!accountData) {
                        alert('Account not found! Please check your account code and try again.');
                        console.error('Account not found for code:', accountCode);
                        return;
                    }

                    console.log('âœ… Personal account loaded:', accountData);

                    const memberId = Date.now().toString();
                    const loadedCompetition = {
                        code: accountData.account_code,
                        totalPool: 0,
                        startTime: accountData.created_at,
                        members: [{
                            id: memberId,
                            name: accountData.user_name,
                            contribution: 0,
                            portfolio: accountData.portfolio,
                            joinedAt: accountData.created_at
                        }]
                    };

                    setCompetition(loadedCompetition);
                    setCompetitionCode(accountData.account_code);
                    setCurrentUserId(memberId);
                    setUserName(accountData.user_name);
                    setPlan('personal');
                    setView('trading');

                    console.log('âœ… Signed in to personal account successfully');
                } catch (error) {
                    console.error('Error signing in to personal account:', error);
                    alert('Failed to sign in. Please try again.');
                }
            };

            // Helper to calculate max shares you can buy
            const getMaxBuyQuantity = (stockSymbol) => {
                const stock = stocks.find(s => s.symbol === stockSymbol);
                if (!stock) return 0;
                const portfolio = getCurrentPortfolio();
                return Math.floor(portfolio.cash / stock.price);
            };

            // Helper to get current position
            const getCurrentPosition = (stockSymbol) => {
                const portfolio = getCurrentPortfolio();
                return portfolio.positions[stockSymbol] || 0;
            };

            // Helper to validate and set quantity
            const handleQuantityChange = (newQuantity, isBuy = true) => {
                const num = parseInt(newQuantity) || 0;

                if (num < 0) {
                    setQuantityError('Quantity cannot be negative');
                    return;
                }

                if (!selectedStock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const portfolio = getCurrentPortfolio();
                const maxBuy = getMaxBuyQuantity(selectedStock);
                const maxSell = getCurrentPosition(selectedStock);

                // If manually typing, check limits
                if (num > maxBuy) {
                    const totalCost = stock.price * num;
                    setQuantityError(`âš ï¸ Insufficient funds! You need $${totalCost.toFixed(2)} but only have $${portfolio.cash.toFixed(2)}. Max: ${maxBuy} shares`);
                    setQuantity(num); // Still set it so they can see what they typed
                } else if (num > maxSell && !isBuy) {
                    setQuantityError(`âš ï¸ You only own ${maxSell} shares of ${selectedStock}`);
                    setQuantity(num);
                } else {
                    setQuantityError('');
                    setQuantity(Math.max(1, num));
                }
            };

            // Buy max shares
            const buyMax = () => {
                if (!selectedStock) return;
                const maxShares = getMaxBuyQuantity(selectedStock);
                if (maxShares === 0) {
                    setQuantityError('âš ï¸ Insufficient funds to buy any shares');
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            // Sell max shares
            const sellMax = () => {
                if (!selectedStock) return;
                const maxShares = getCurrentPosition(selectedStock);
                if (maxShares === 0) {
                    setQuantityError(`âš ï¸ You don't own any shares of ${selectedStock}`);
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            // Execute short sell
            const executeShortSell = async () => {
                if (!selectedStock || quantity <= 0) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    alert('Stock data not available. Please add to watchlist and refresh.');
                    return;
                }

                const portfolio = getCurrentPortfolio();
                const validation = window.shortSelling.validateShort(portfolio, selectedStock, stock.price, quantity);

                if (!validation.isValid) {
                    alert('âŒ Cannot short:\n' + validation.errors.join('\n'));
                    return;
                }

                const updatedPortfolio = window.shortSelling.executeShort(
                    {...portfolio},
                    selectedStock,
                    stock.price,
                    quantity
                );

                // Update state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server for personal accounts
                if (plan === 'personal' && userEmail) {
                    try {
                        await fetch('http://localhost:3001/api/accounts/update-portfolio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                portfolio: updatedPortfolio
                            })
                        });
                        console.log('âœ… Portfolio synced to backend');
                    } catch (error) {
                        console.error('Error syncing portfolio to backend:', error);
                    }
                }

                alert(`âœ… Shorted ${quantity} shares of ${selectedStock} @ $${stock.price.toFixed(2)}`);
                setQuantity(1);
                setQuantityError('');
            };

            // Execute cover short
            const executeCoverShort = async () => {
                if (!selectedStock || quantity <= 0) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) return;

                const portfolio = getCurrentPortfolio();
                const validation = window.shortSelling.validateCover(portfolio, selectedStock, stock.price, quantity);

                if (!validation.isValid) {
                    alert('âŒ Cannot cover:\n' + validation.errors.join('\n'));
                    return;
                }

                const { portfolio: updatedPortfolio, profitLoss } = window.shortSelling.executeCover(
                    {...portfolio},
                    selectedStock,
                    stock.price,
                    quantity,
                    stocks
                );

                // Update state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server for personal accounts
                if (plan === 'personal' && userEmail) {
                    try {
                        await fetch('http://localhost:3001/api/accounts/update-portfolio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                portfolio: updatedPortfolio
                            })
                        });
                        console.log('âœ… Portfolio synced to backend');
                    } catch (error) {
                        console.error('Error syncing portfolio to backend:', error);
                    }
                }

                alert(`âœ… Covered ${quantity} shares of ${selectedStock}\nP/L: ${profitLoss >= 0 ? '+' : ''}$${profitLoss.toFixed(2)}`);
                setQuantity(1);
                setQuantityError('');
            };

            // Load news for selected stock (with live updates)
            const loadStockNews = async () => {
                if (!selectedStock) return;
                setLoadingNews(true);
                try {
                    console.log(`ðŸ“° Loading news for ${selectedStock}...`);
                    const news = await window.newsFeed.fetchStockNews(selectedStock, FINNHUB_API_KEY);
                    setStockNews(news);
                    setLastStockNewsUpdate(new Date()); // Track when news was updated
                } catch (error) {
                    console.error('Error loading news:', error);
                    setStockNews([]);
                }
                setLoadingNews(false);
            };

            // Load general market news
            const loadMarketNews = async () => {
                setLoadingMarketNews(true);
                try {
                    const news = await window.newsFeed.fetchMarketNews(FINNHUB_API_KEY);
                    setMarketNews(news);
                    setLastNewsUpdate(new Date()); // Track when news was updated
                } catch (error) {
                    console.error('Error loading market news:', error);
                    setMarketNews([]);
                }
                setLoadingMarketNews(false);
            };

            // AI Trade Analysis with "UltraThink" deep reasoning - REAL DATA DRIVEN
            const generateAIAnalysis = async () => {
                if (!selectedStock) return;

                setLoadingAnalysis(true);
                setAnalysisExpanded(true);

                // Simulate AI analysis with deep thinking
                await new Promise(resolve => setTimeout(resolve, 2000));

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    setLoadingAnalysis(false);
                    return;
                }

                console.log('ðŸ§  Generating AI analysis with REAL data for:', stock);

                // REAL DATA: Extract all stock metrics
                const price = stock.price || 0;
                const high = stock.high || price;
                const low = stock.low || price;
                const open = stock.open || price;
                const previousClose = stock.previousClose || price;
                const priceChange = stock.change || 0;

                // REAL CALCULATION: RSI (Relative Strength Index) from price momentum
                const calculateRSI = () => {
                    // Use daily price change as momentum indicator
                    const priceChangeAmount = price - previousClose;
                    const gain = Math.max(0, priceChangeAmount);
                    const loss = Math.max(0, -priceChangeAmount);

                    // If no change, return neutral RSI of 50
                    if (gain === 0 && loss === 0) {
                        return 50;
                    }

                    // Simplified RSI calculation based on single-day momentum
                    // Normalize by price for percentage-based calculation
                    const avgGain = (gain / previousClose) * 100;
                    const avgLoss = (loss / previousClose) * 100 + 0.01; // Prevent division by zero
                    const rs = avgGain / avgLoss;
                    const rsi = 100 - (100 / (1 + rs));

                    return Math.max(0, Math.min(100, rsi));
                };

                const rsi = calculateRSI();
                console.log('ðŸ“Š Real RSI calculated:', rsi.toFixed(1));

                // REAL CALCULATION: Intraday Volatility from high/low range
                const intradayVolatility = ((high - low) / low * 100);
                console.log('ðŸ“ˆ Real intraday volatility:', intradayVolatility.toFixed(2) + '%');

                // REAL CALCULATION: Price momentum
                const momentum = ((price - open) / open * 100);
                console.log('âš¡ Real price momentum:', momentum.toFixed(2) + '%');

                // REAL CALCULATION: Support and Resistance from actual price action
                const support = (low * 0.98).toFixed(2); // 2% below daily low
                const resistance = (high * 1.02).toFixed(2); // 2% above daily high

                // TECHNICAL ANALYSIS based on real RSI and momentum
                const isOverbought = rsi > 70;
                const isOversold = rsi < 30;
                const technicalSignal = isOverbought ? 'Overbought - Consider Selling' :
                                       isOversold ? 'Oversold - Consider Buying' :
                                       rsi > 60 ? 'Strong Bullish' :
                                       rsi > 50 ? 'Bullish' :
                                       rsi < 40 ? 'Bearish' :
                                       rsi < 30 ? 'Strong Bearish' : 'Neutral';

                // REAL NEWS SENTIMENT ANALYSIS with weighted scoring
                let sentimentScore = 0;
                let positiveCount = 0;
                let negativeCount = 0;
                let neutralCount = 0;

                if (stockNews.length > 0) {
                    // Weight recent news more heavily (time decay factor)
                    stockNews.forEach((article, index) => {
                        const recencyWeight = 1 - (index / stockNews.length) * 0.3; // 30% decay

                        if (article.sentiment === 'positive') {
                            sentimentScore += 1 * recencyWeight;
                            positiveCount++;
                        } else if (article.sentiment === 'negative') {
                            sentimentScore -= 1 * recencyWeight;
                            negativeCount++;
                        } else {
                            neutralCount++;
                        }
                    });

                    // Normalize to -100 to +100 scale
                    sentimentScore = (sentimentScore / stockNews.length) * 100;
                }

                console.log('ðŸ“° Real sentiment score:', sentimentScore, 'from', stockNews.length, 'articles');

                const newsSignal = sentimentScore > 50 ? 'Very Positive' :
                                  sentimentScore > 20 ? 'Positive' :
                                  sentimentScore < -50 ? 'Very Negative' :
                                  sentimentScore < -20 ? 'Negative' : 'Neutral';

                // REAL RISK ASSESSMENT
                const volatilityRisk = intradayVolatility > 5 ? 3 : intradayVolatility > 2 ? 2 : 1;
                const sentimentRisk = Math.abs(sentimentScore) > 70 ? 2 : Math.abs(sentimentScore) > 40 ? 1 : 0;
                const liquidityRisk = stockNews.length < 3 ? 2 : stockNews.length < 5 ? 1 : 0;
                const rsiRisk = (isOverbought || isOversold) ? 2 : 1;

                const totalRiskScore = volatilityRisk + sentimentRisk + liquidityRisk + rsiRisk;
                const riskLevel = totalRiskScore >= 7 ? 'High' : totalRiskScore >= 4 ? 'Moderate' : 'Low';
                const riskRating = totalRiskScore;

                console.log('âš ï¸ Real risk assessment:', riskLevel, '| Score:', riskRating);

                // COMPREHENSIVE RECOMMENDATION based on multiple real factors
                const technicalScore = rsi > 50 ? (rsi - 50) / 10 : -(50 - rsi) / 10;
                const sentimentScoreNormalized = sentimentScore / 25; // Scale to similar range
                const momentumScore = momentum / 2;

                // Adjust for overbought/oversold
                let adjustedTechnicalScore = technicalScore;
                if (isOverbought) adjustedTechnicalScore -= 3;
                if (isOversold) adjustedTechnicalScore += 3;

                // Weighted composite score: Technical (40%), Sentiment (35%), Momentum (25%)
                const compositeScore = (adjustedTechnicalScore * 0.4) + (sentimentScoreNormalized * 0.35) + (momentumScore * 0.25);

                // Risk-adjusted confidence
                const riskAdjustment = riskLevel === 'High' ? -15 : riskLevel === 'Moderate' ? -5 : 0;

                const overallRecommendation = (() => {
                    if (compositeScore > 3) return { action: 'Strong Buy', confidence: Math.min(95, 80 + compositeScore + riskAdjustment), color: 'green' };
                    if (compositeScore > 1) return { action: 'Buy', confidence: Math.min(85, 70 + compositeScore + riskAdjustment), color: 'green' };
                    if (compositeScore < -3) return { action: 'Strong Sell', confidence: Math.min(90, 75 - compositeScore + riskAdjustment), color: 'red' };
                    if (compositeScore < -1) return { action: 'Sell', confidence: Math.min(80, 65 - compositeScore + riskAdjustment), color: 'red' };
                    return { action: 'Hold', confidence: Math.min(75, 55 + Math.abs(compositeScore) + riskAdjustment), color: 'yellow' };
                })();

                console.log('ðŸ’¡ Final recommendation:', overallRecommendation.action, 'at', overallRecommendation.confidence.toFixed(1) + '% confidence');

                // Calculate realistic stop loss and take profit using ATR concept
                const atr = high - low; // Average True Range (simplified)
                const stopLossDistance = atr * 1.5;
                const takeProfitDistance = atr * 3; // 2:1 reward/risk ratio

                const analysis = {
                    symbol: selectedStock,
                    name: stock.name,
                    timestamp: new Date().toLocaleString(),

                    technical: {
                        signal: technicalSignal,
                        priceChange: priceChange.toFixed(2),
                        currentPrice: price.toFixed(2),
                        support: support,
                        resistance: resistance,
                        rsi: rsi.toFixed(1),
                        momentum: momentum.toFixed(2),
                        volatility: intradayVolatility.toFixed(2),
                        open: open.toFixed(2),
                        high: high.toFixed(2),
                        low: low.toFixed(2),
                        previousClose: previousClose.toFixed(2)
                    },

                    sentiment: {
                        signal: newsSignal,
                        score: sentimentScore.toFixed(0),
                        articlesAnalyzed: stockNews.length,
                        positiveCount,
                        negativeCount,
                        neutralCount,
                        trending: stockNews.length > 10 ? 'Very High Interest' :
                                 stockNews.length > 5 ? 'High Interest' :
                                 stockNews.length > 2 ? 'Moderate Interest' : 'Low Interest'
                    },

                    risk: {
                        level: riskLevel,
                        rating: riskRating,
                        volatilityRisk,
                        sentimentRisk,
                        liquidityRisk,
                        factors: [
                            `Volatility: ${intradayVolatility.toFixed(2)}% intraday range (${volatilityRisk === 3 ? 'High' : volatilityRisk === 2 ? 'Moderate' : 'Low'} risk)`,
                            `Sentiment: ${Math.abs(sentimentScore).toFixed(0)} intensity (${sentimentRisk === 2 ? 'High' : sentimentRisk === 1 ? 'Moderate' : 'Low'} risk)`,
                            `Liquidity: ${stockNews.length} news articles (${liquidityRisk === 2 ? 'High' : liquidityRisk === 1 ? 'Moderate' : 'Low'} risk)`,
                            `RSI: ${rsi.toFixed(1)} ${isOverbought ? '(Overbought)' : isOversold ? '(Oversold)' : '(Normal)'}`
                        ]
                    },

                    recommendation: {
                        action: overallRecommendation.action,
                        confidence: overallRecommendation.confidence.toFixed(1),
                        color: overallRecommendation.color,
                        reasoning: [
                            `ðŸ“Š Real RSI at ${rsi.toFixed(1)} shows ${technicalSignal.toLowerCase()} conditions with ${momentum >= 0 ? 'positive' : 'negative'} momentum (${momentum >= 0 ? '+' : ''}${momentum.toFixed(2)}% from open)`,
                            `ðŸ“° Sentiment analysis of ${stockNews.length} articles: ${positiveCount} positive, ${negativeCount} negative, ${neutralCount} neutral (Score: ${sentimentScore.toFixed(0)}/100)`,
                            `âš¡ Intraday volatility at ${intradayVolatility.toFixed(2)}% with ${riskLevel.toLowerCase()} risk profile (Risk score: ${riskRating}/10)`,
                            `ðŸ’¡ ${overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Buy' ?
                                `Technical and sentiment align for bullish entry. Consider ${momentum > 0 ? 'buying on strength' : 'buying on dips near support at $${support}'}` :
                                overallRecommendation.action === 'Strong Sell' || overallRecommendation.action === 'Sell' ?
                                `Indicators suggest caution. ${isOverbought ? 'RSI overbought suggests profit-taking' : 'Consider protective stops or exit strategies'}` :
                                `Mixed signals warrant patience. Wait for ${rsi < 50 ? 'upward momentum' : 'clearer direction'} before committing capital`}`
                        ],
                        strategy: overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Buy' ?
                                'Long position with tight stops' :
                                overallRecommendation.action === 'Strong Sell' || overallRecommendation.action === 'Sell' ?
                                'Exit or short with defined risk' : 'Cash or wait for setup',
                        targets: {
                            entry: price.toFixed(2),
                            stopLoss: Math.max(0, price - stopLossDistance).toFixed(2),
                            takeProfit: (price + takeProfitDistance).toFixed(2),
                            riskRewardRatio: '2:1'
                        }
                    }
                };

                console.log('âœ… AI Analysis complete with REAL data:', analysis);
                setAiAnalysis(analysis);
                setLoadingAnalysis(false);
            };

            const executeTrade = async (type) => {
                if (!selectedStock || quantity <= 0) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    alert('Stock data not available. Please add to watchlist and refresh.');
                    return;
                }

                const totalCost = stock.price * quantity;
                const portfolio = getCurrentPortfolio();
                const COOLDOWN_MINUTES = 15;
                const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;

                // Calculate trading fee based on plan
                let tradingFee = 0;
                if (plan === 'family-public') {
                    tradingFee = totalCost * 0.01; // 1% fee
                } else if (plan === 'family-private') {
                    tradingFee = 0.05; // $0.05 flat fee
                }

                if (type === 'buy') {
                    const totalWithFee = totalCost + tradingFee;
                    if (totalWithFee > portfolio.cash) {
                        alert(`Insufficient funds!\n\nCost: $${totalCost.toFixed(2)}\nFee: $${tradingFee.toFixed(2)}\nTotal: $${totalWithFee.toFixed(2)}\n\nYou only have $${portfolio.cash.toFixed(2)} available.`);
                        return;
                    }
                } else {
                    // SELL - Check position
                    const currentPosition = portfolio.positions[selectedStock] || 0;
                    if (quantity > currentPosition) {
                        alert(`Insufficient shares! You only own ${currentPosition} shares of ${selectedStock}`);
                        return;
                    }

                    // Check 15-minute cooldown
                    const lastBuyTime = portfolio.lastBuyTime?.[selectedStock];
                    if (lastBuyTime) {
                        const timeSinceBuy = Date.now() - new Date(lastBuyTime).getTime();
                        const minutesSinceBuy = Math.floor(timeSinceBuy / 60000);

                        if (timeSinceBuy < COOLDOWN_MS) {
                            const minutesRemaining = COOLDOWN_MINUTES - minutesSinceBuy;
                            const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceBuy) / 1000) % 60;
                            alert(`â³ Trading Cooldown Active!\n\nYou must wait ${minutesRemaining} minute(s) and ${secondsRemaining} second(s) before selling ${selectedStock}.\n\nThis prevents rapid trading and encourages strategic decisions.`);
                            return;
                        }
                    }
                }

                // Show fee notification for family plans
                if (tradingFee > 0) {
                    const proceed = confirm(
                        `ðŸ’° Trading Fee Notice\n\n` +
                        `${type === 'buy' ? 'Buying' : 'Selling'} ${quantity} shares of ${selectedStock}\n` +
                        `Trade Value: $${totalCost.toFixed(2)}\n` +
                        `Trading Fee: $${tradingFee.toFixed(2)} ${plan === 'family-public' ? '(1%)' : '(flat)'}\n` +
                        `Total ${type === 'buy' ? 'Cost' : 'Net Proceeds'}: $${(type === 'buy' ? totalCost + tradingFee : totalCost - tradingFee).toFixed(2)}\n\n` +
                        `Continue with trade?`
                    );
                    if (!proceed) return;
                }

                const updatedPortfolio = {
                    ...portfolio,
                    cash: type === 'buy'
                        ? portfolio.cash - totalCost - tradingFee
                        : portfolio.cash + totalCost - tradingFee,
                    positions: {
                        ...portfolio.positions,
                        [selectedStock]: type === 'buy'
                            ? (portfolio.positions[selectedStock] || 0) + quantity
                            : (portfolio.positions[selectedStock] || 0) - quantity
                    },
                    history: [...portfolio.history, {
                        type,
                        symbol: selectedStock,
                        quantity,
                        price: stock.price,
                        total: totalCost,
                        fee: tradingFee,
                        timestamp: new Date().toISOString()
                    }],
                    lastBuyTime: type === 'buy'
                        ? { ...portfolio.lastBuyTime, [selectedStock]: new Date().toISOString() }
                        : portfolio.lastBuyTime
                };

                // Update local state
                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server for personal accounts
                if (plan === 'personal' && userEmail) {
                    try {
                        await fetch('http://localhost:3001/api/accounts/update-portfolio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                portfolio: updatedPortfolio
                            })
                        });
                        console.log('âœ… Portfolio synced to backend');
                    } catch (error) {
                        console.error('Error syncing portfolio to backend:', error);
                    }
                }

                setQuantity(1);
                setQuantityError('');
            };

            // Try alternative API (Polygon.io free tier - no key required for delayed data)
            const fetchFromPolygonIO = async (symbol, period) => {
                try {
                    // Polygon.io provides free delayed data without API key
                    const days = period === '1D' ? 2 : period === '1W' ? 7 : period === '1M' ? 30 : period === '3M' ? 90 : 365;
                    const toDate = new Date();
                    const fromDate = new Date(toDate.getTime() - (days * 24 * 60 * 60 * 1000));

                    const from = fromDate.toISOString().split('T')[0];
                    const to = toDate.toISOString().split('T')[0];

                    // Use public aggregates endpoint (delayed data, no key needed)
                    const url = `https://api.polygon.io/v2/aggs/ticker/${symbol}/range/1/day/${from}/${to}?adjusted=true&sort=asc&limit=120`;

                    console.log(`ðŸ“Š Trying Polygon.io for ${symbol}...`);

                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        const labels = data.results.map(bar => {
                            const date = new Date(bar.t);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        });
                        const prices = data.results.map(bar => bar.c.toFixed(2));

                        console.log(`âœ… Polygon.io data loaded for ${symbol}:`, prices.length, 'points');
                        return { labels, data: prices };
                    }

                    console.warn(`Polygon.io: No data for ${symbol}`);
                    return null;
                } catch (error) {
                    console.error('Polygon.io error:', error.message);
                    return null;
                }
            };

            // Fetch real historical price data - tries multiple APIs
            const fetchHistoricalData = async (symbol, period = '1M') => {
                try {
                    // Calculate date range based on period
                    const toDate = new Date();
                    let fromDate;
                    let range, interval;

                    switch (period) {
                        case '1D':
                            fromDate = new Date(toDate.getTime() - (2 * 24 * 60 * 60 * 1000)); // 2 days for intraday
                            range = '1d';
                            interval = '5m';
                            break;
                        case '1W':
                            fromDate = new Date(toDate.getTime() - (7 * 24 * 60 * 60 * 1000));
                            range = '5d';
                            interval = '15m';
                            break;
                        case '1M':
                            fromDate = new Date(toDate.getTime() - (30 * 24 * 60 * 60 * 1000));
                            range = '1mo';
                            interval = '1d';
                            break;
                        case '3M':
                            fromDate = new Date(toDate.getTime() - (90 * 24 * 60 * 60 * 1000));
                            range = '3mo';
                            interval = '1d';
                            break;
                        case 'ALL':
                            fromDate = new Date(toDate.getTime() - (365 * 24 * 60 * 60 * 1000));
                            range = '1y';
                            interval = '1d';
                            break;
                        default:
                            fromDate = new Date(toDate.getTime() - (30 * 24 * 60 * 60 * 1000));
                            range = '1mo';
                            interval = '1d';
                    }

                    // TRY 1: Yahoo Finance API (no API key required)
                    const period1 = Math.floor(fromDate.getTime() / 1000);
                    const period2 = Math.floor(toDate.getTime() / 1000);

                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}&includePrePost=false`;

                    console.log(`ðŸ“Š [1/2] Trying Yahoo Finance for ${symbol} (${period})...`);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        console.warn(`Yahoo Finance failed: ${response.status} ${response.statusText}`);
                        // Try alternative API
                        console.log(`ðŸ“Š [2/2] Yahoo Finance blocked, trying Polygon.io...`);
                        return await fetchFromPolygonIO(symbol, period);
                    }

                    const data = await response.json();

                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const timestamps = result.timestamp;
                        const prices = result.indicators.quote[0].close;

                        if (timestamps && prices && timestamps.length > 0) {
                            const labels = timestamps.map(timestamp => {
                                const date = new Date(timestamp * 1000);
                                if (period === '1D') {
                                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                                } else if (period === '1W') {
                                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric' });
                                } else {
                                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                }
                            });

                            // Filter out null prices and format
                            const validData = [];
                            const validLabels = [];
                            for (let i = 0; i < prices.length; i++) {
                                if (prices[i] !== null && prices[i] !== undefined) {
                                    validData.push(prices[i].toFixed(2));
                                    validLabels.push(labels[i]);
                                }
                            }

                            console.log(`âœ… Loaded Yahoo Finance data for ${symbol} (${period}):`, {
                                dataPoints: validData.length,
                                firstPrice: validData[0],
                                lastPrice: validData[validData.length - 1]
                            });

                            return { labels: validLabels, data: validData };
                        }
                    }

                    console.warn(`No historical data available for ${symbol} from Yahoo Finance, using fallback`);
                    return null;
                } catch (error) {
                    console.error(`âŒ Error fetching historical data for ${symbol}:`, error);
                    console.error('Error details:', {
                        message: error.message,
                        type: error.name,
                        stack: error.stack?.split('\n')[0]
                    });
                    return null;
                }
            };

            // Generate fallback historical data if API fails
            const generateFallbackHistoricalData = (currentPrice, days = 30) => {
                const data = [];
                const labels = [];
                let price = currentPrice;

                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                    const change = (Math.random() - 0.5) * (currentPrice * 0.03);
                    price = Math.max(currentPrice * 0.8, Math.min(currentPrice * 1.2, price + change));
                    data.push(price.toFixed(2));
                }

                data[data.length - 1] = currentPrice.toFixed(2);
                return { labels, data };
            };

            // Chart effect - create/update chart when stock is selected
            useEffect(() => {
                if (!selectedStock || !chartRef.current || !stocks.length) return;

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) return;

                // Destroy existing chart
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                // Fetch and render real historical data
                const loadChart = async () => {
                    console.log(`ðŸ”„ Loading chart for ${selectedStock} (${chartPeriod})...`);

                    // Try to fetch real data from Yahoo Finance
                    let historicalData = await fetchHistoricalData(selectedStock, chartPeriod);

                    // Fallback to generated data if API fails
                    if (!historicalData) {
                        console.warn(`âš ï¸ Yahoo Finance unavailable - using simulated data for ${selectedStock}`);
                        console.warn('This could be due to CORS restrictions or API rate limiting');
                        historicalData = generateFallbackHistoricalData(stock.price);
                        setIsRealChartData(false);
                    } else {
                        console.log(`âœ… Real chart data loaded successfully for ${selectedStock}`);
                        setIsRealChartData(true);
                    }

                    const { labels, data } = historicalData;

                    // Create new chart
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${stock.symbol} Price`,
                            data: data,
                            borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            backgroundColor: stock.change >= 0 ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return '$' + parseFloat(context.parsed.y).toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    maxTicksLimit: 6
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                    });
                };

                // Call async function
                loadChart();

                // Cleanup on unmount
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [selectedStock, stocks, chartPeriod]);

            // Load news when stock is selected
            useEffect(() => {
                if (selectedStock) {
                    loadStockNews();
                }
            }, [selectedStock]);

            // Auto-load and auto-refresh stock news when selected stock changes
            useEffect(() => {
                if (!selectedStock) return;

                // Load news immediately when stock is selected
                loadStockNews();

                // Set up auto-refresh every 3 minutes (180000 ms) for live updates
                const stockNewsInterval = setInterval(() => {
                    console.log(`ðŸ“° Auto-refreshing news for ${selectedStock} (LIVE MODE)...`);
                    loadStockNews();
                }, 180000); // 3 minutes

                // Cleanup interval when stock changes or component unmounts
                return () => clearInterval(stockNewsInterval);
            }, [selectedStock]);

            // Load market news on mount and auto-refresh every 2 minutes for truly LIVE updates
            useEffect(() => {
                // Load immediately on mount
                loadMarketNews();

                // Set up auto-refresh every 2 minutes (120000 ms) for live updates
                const newsRefreshInterval = setInterval(() => {
                    console.log('ðŸ“° Auto-refreshing market news (LIVE MODE)...');
                    loadMarketNews();
                }, 120000); // 2 minutes for truly live updates

                // Cleanup interval on unmount
                return () => clearInterval(newsRefreshInterval);
            }, []);

            // Plan Selection Screen
            if (view === 'plan-select') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                        <div className="max-w-7xl mx-auto">
                            {/* Hero Section with Navy Blue Theme */}
                            <div className="text-center mb-16 pt-8">
                                {/* Enhanced Logo with Premium Animations */}
                                <div className="flex items-center justify-center mb-8">
                                    <div className="relative group animate-float">
                                        <div className="absolute inset-0 bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-500 rounded-3xl blur-xl opacity-75 group-hover:opacity-100 transition duration-300 animate-pulse-glow"></div>
                                        <div className="relative bg-gradient-to-br from-blue-500 via-indigo-600 to-blue-700 p-3 rounded-3xl shadow-2xl rotating-border">
                                            <div className="bg-gradient-to-br from-slate-900 via-blue-950 to-slate-900 rounded-2xl p-6 border-2 border-blue-400/40 gpu-accelerated">
                                                <img
                                                    src="finclash.png"
                                                    alt="FinClash Logo"
                                                    className="w-36 h-36 md:w-48 md:h-48 object-contain drop-shadow-2xl filter brightness-110 group-hover:scale-110 transition-transform duration-500"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                        e.target.nextElementSibling.style.display = 'block';
                                                    }}
                                                />
                                                <span className="text-8xl hidden">ðŸ“ˆ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Main Title */}
                                <h1 className="text-7xl md:text-8xl font-black mb-6 relative inline-block">
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-300 via-cyan-300 to-blue-400 drop-shadow-2xl">
                                        FinClash
                                    </span>
                                </h1>

                                {/* UltraThink AI Badge */}
                                <div className="flex justify-center mb-6">
                                    <div className="inline-flex items-center gap-3 bg-gradient-to-r from-indigo-900/80 to-purple-900/80 backdrop-blur-xl border-2 border-indigo-400/50 rounded-2xl px-8 py-4 shadow-2xl hover:scale-105 transition-transform duration-300">
                                        <span className="text-3xl animate-pulse">ðŸ§ </span>
                                        <div className="text-left">
                                            <div className="text-xs text-indigo-200 font-semibold uppercase tracking-wider">Powered by</div>
                                            <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-300 to-purple-300">UltraThink AI</div>
                                        </div>
                                        <div className="relative flex h-3 w-3">
                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                            <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                        </div>
                                    </div>
                                </div>

                                {/* Tagline */}
                                <p className="text-2xl md:text-3xl text-blue-100 font-semibold mb-4 max-w-3xl mx-auto leading-relaxed">
                                    Master the markets. Compete with family. <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400 font-black">Win real money.</span>
                                </p>

                                {/* Creators */}
                                <div className="mt-6 inline-flex items-center gap-2 bg-blue-900/40 backdrop-blur-sm border border-blue-400/30 rounded-xl px-6 py-3">
                                    <span className="text-blue-200">Created by</span>
                                    <span className="font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300">Reid Coleman</span>
                                    <span className="text-blue-200">&</span>
                                    <span className="font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300">Cameron Dietzel</span>
                                </div>

                                {/* Stripe Badge */}
                                <div className="mt-4 inline-flex items-center gap-3 bg-blue-900/40 backdrop-blur-sm border border-blue-400/30 rounded-xl px-6 py-3">
                                    <span className="text-blue-200 font-semibold">Secure Payments by</span>
                                    <span className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-cyan-300">Stripe</span>
                                    <span className="text-lg">âœ“</span>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                                {/* Personal Plan - FREE */}
                                <div className="group relative bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 border-2 border-blue-500/50 hover:border-cyan-400 hover:shadow-2xl hover:shadow-cyan-500/30 transition-all duration-500 hover:-translate-y-2 hover-glow will-change-transform gpu-accelerated animate-fade-in">
                                    {/* Glow Effect */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-3xl opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6">
                                            <div className="bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 p-4 rounded-2xl shadow-xl">
                                                <span className="text-5xl">ðŸ‘¤</span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h2 className="text-3xl font-black text-center mb-2">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400">Personal</span>
                                        </h2>
                                        <p className="text-center text-blue-300 text-sm mb-6">Perfect for solo traders</p>

                                        {/* Price */}
                                        <div className="text-center mb-8 py-4 bg-blue-900/40 rounded-xl border border-blue-500/30">
                                            <span className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">FREE</span>
                                            <div className="text-sm text-green-300 font-bold mt-2">Zero Trading Fees Forever</div>
                                        </div>

                                        {/* Features */}
                                        <ul className="space-y-3 mb-8 text-blue-100">
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">$100K</span> virtual capital</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base">Trade <span className="font-bold">any stock</span> globally</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">UltraThink AI</span> analysis</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Live</span> market news</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Risk-free</span> practice</span>
                                            </li>
                                        </ul>

                                        {/* Buttons */}
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    setPlan('personal');
                                                    setAccountMode('create');
                                                    setView('setup-family');
                                                }}
                                                className="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-black text-lg shadow-xl hover:shadow-2xl hover:shadow-cyan-500/50 transition-all duration-300 transform hover:scale-105 active-press hover-glow will-change-transform"
                                            >
                                                âœ¨ Create Free Account
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setPlan('personal');
                                                    setAccountMode('login');
                                                    setView('setup-family');
                                                }}
                                                className="w-full bg-blue-800/60 hover:bg-blue-700/80 backdrop-blur-sm border-2 border-blue-500/50 hover:border-blue-400 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 hover:scale-105 active-press"
                                            >
                                                ðŸ” Sign In
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Public Plan - 1% Fee */}
                                <div className="group relative bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 border-2 border-blue-500/50 hover:border-green-400 hover:shadow-2xl hover:shadow-green-500/30 transition-all duration-500 hover:-translate-y-2 hover-glow-green will-change-transform gpu-accelerated animate-fade-in stagger-1">
                                    {/* Glow Effect */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-3xl opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                        <span className="bg-green-500 text-white text-xs font-black px-4 py-1 rounded-full animate-pulse-glow-green shadow-xl">POPULAR</span>
                                    </div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6">
                                            <div className="bg-gradient-to-br from-green-400 via-emerald-500 to-green-600 p-4 rounded-2xl shadow-xl">
                                                <span className="text-5xl">ðŸ‘¥</span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h2 className="text-3xl font-black text-center mb-2">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">Public</span>
                                        </h2>
                                        <p className="text-center text-blue-300 text-sm mb-6">Compete with family & friends</p>

                                        {/* Price */}
                                        <div className="text-center mb-8 py-4 bg-blue-900/40 rounded-xl border border-blue-500/30">
                                            <span className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">1%</span>
                                            <div className="text-sm text-green-300 font-bold mt-2">Fee Per Trade</div>
                                        </div>

                                        {/* Features */}
                                        <ul className="space-y-3 mb-8 text-blue-100">
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Private</span> competitions</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Real money</span> prizes</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Live</span> leaderboards</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Winner</span> takes all</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">1%</span> trading expense</span>
                                            </li>
                                        </ul>

                                        {/* Buttons */}
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    // Redirect to Stripe payment for Public plan
                                                    if (STRIPE_FAMILY_PUBLIC_LINK.includes('REPLACE_WITH_YOUR_LINK')) {
                                                        alert('âš ï¸ Stripe payment link not configured yet!\n\nPlease follow the instructions in STRIPE_SETUP_GUIDE.md to set up your Stripe payment links.');
                                                        return;
                                                    }
                                                    window.location.href = STRIPE_FAMILY_PUBLIC_LINK;
                                                }}
                                                className="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white py-4 rounded-xl font-black text-lg shadow-xl hover:shadow-2xl hover:shadow-green-500/50 transition-all duration-300 transform hover:scale-105 active-press hover-glow-green will-change-transform"
                                            >
                                                ðŸ’³ Pay & Create Pool
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setPlan('family-public');
                                                    setView('join-family');
                                                }}
                                                className="w-full bg-blue-800/60 hover:bg-blue-700/80 backdrop-blur-sm border-2 border-blue-500/50 hover:border-green-400 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 hover:scale-105 active-press"
                                            >
                                                ðŸ† Join Pool
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Private Plan - $0.05 Fee */}
                                <div className="group relative bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 border-2 border-blue-500/50 hover:border-purple-400 hover:shadow-2xl hover:shadow-purple-500/30 transition-all duration-500 hover:-translate-y-2 will-change-transform gpu-accelerated animate-fade-in stagger-2">
                                    {/* Glow Effect */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-pink-600/10 rounded-3xl opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                        <span className="rotating-border-premium text-white text-xs font-black px-4 py-1 rounded-full shadow-xl">PREMIUM</span>
                                    </div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6">
                                            <div className="bg-gradient-to-br from-purple-400 via-pink-500 to-purple-600 p-4 rounded-2xl shadow-xl">
                                                <span className="text-5xl">ðŸ‘‘</span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h2 className="text-3xl font-black text-center mb-2">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-400">Private</span>
                                        </h2>
                                        <p className="text-center text-blue-300 text-sm mb-6">Premium competition</p>

                                        {/* Price */}
                                        <div className="text-center mb-8 py-4 bg-blue-900/40 rounded-xl border border-blue-500/30">
                                            <span className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">$0.05</span>
                                            <div className="text-sm text-purple-300 font-bold mt-2">Flat Fee Per Trade</div>
                                        </div>

                                        {/* Features */}
                                        <ul className="space-y-3 mb-8 text-blue-100">
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Private</span> competitions</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Real money</span> prizes</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Live</span> leaderboards</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Winner</span> takes all</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl flex-shrink-0">âœ“</span>
                                                <span className="text-base"><span className="font-bold">Low</span> fixed fee</span>
                                            </li>
                                        </ul>

                                        {/* Buttons */}
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    // Redirect to Stripe payment for Private plan
                                                    if (STRIPE_FAMILY_PRIVATE_LINK.includes('REPLACE_WITH_YOUR_LINK')) {
                                                        alert('âš ï¸ Stripe payment link not configured yet!\n\nPlease follow the instructions in STRIPE_SETUP_GUIDE.md to set up your Stripe payment links.');
                                                        return;
                                                    }
                                                    window.location.href = STRIPE_FAMILY_PRIVATE_LINK;
                                                }}
                                                className="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 text-white py-4 rounded-xl font-black text-lg shadow-xl hover:shadow-2xl hover:shadow-purple-500/50 transition-all duration-300 transform hover:scale-105 active-press hover-glow-amber will-change-transform"
                                            >
                                                ðŸ’³ Pay & Create Pool
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setPlan('family-private');
                                                    setView('join-family');
                                                }}
                                                className="w-full bg-blue-800/60 hover:bg-blue-700/80 backdrop-blur-sm border-2 border-blue-500/50 hover:border-purple-400 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 hover:scale-105 active-press"
                                            >
                                                ðŸ‘‘ Join Pool
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Stripe Integration Notice */}
                            <div className="mt-8 max-w-2xl mx-auto bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500 rounded-2xl p-6">
                                <div className="flex items-center gap-4">
                                    <div className="text-5xl">ðŸ’³</div>
                                    <div>
                                        <h3 className="text-white font-bold text-lg mb-1">Secure Payments with Stripe</h3>
                                        <p className="text-purple-200 text-sm">All plan payments are processed securely through Stripe. Trusted by millions of businesses worldwide with bank-level security.</p>
                                    </div>
                                </div>
                            </div>

                            {/* Live Stock Ticker - At the bottom */}
                            {topStocks.length > 0 && (
                                <div className="mt-12 bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 rounded-3xl p-6 border border-cyan-500/30 shadow-2xl overflow-hidden backdrop-blur-sm">
                                    <div className="flex items-center justify-between mb-6 pb-4 border-b border-cyan-500/20">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-gradient-to-br from-cyan-400 to-blue-500 p-2 rounded-xl shadow-lg">
                                                <span className="text-3xl">ðŸ“Š</span>
                                            </div>
                                            <div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300">
                                                    Live Market Data
                                                </h3>
                                                <p className="text-xs text-blue-300 font-semibold">Real-time prices â€¢ Updated every 30s</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-green-500/10 border border-green-500/30 rounded-full px-4 py-2">
                                            <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                            <span className="text-green-300 text-sm font-bold">LIVE</span>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                        {topStocks.map(stock => (
                                            <div
                                                key={stock.symbol}
                                                className="group bg-gradient-to-br from-blue-800/40 to-blue-900/40 backdrop-blur-sm rounded-xl p-4 border border-cyan-500/20 hover:border-cyan-400/50 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-cyan-500/10"
                                            >
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="font-black text-white text-base tracking-wide">{stock.symbol}</div>
                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                                                        stock.change >= 0 ? 'bg-green-500/20' : 'bg-red-500/20'
                                                    }`}>
                                                        <span className={`text-xs ${stock.change >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                            {stock.change >= 0 ? 'â†—' : 'â†˜'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="text-2xl font-black text-white mb-1 tracking-tight">
                                                    ${stock.price.toFixed(2)}
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <div className={`text-sm font-bold ${stock.change >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                    </div>
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-cyan-500/10">
                                                    <div className="flex justify-between text-xs text-blue-300/70">
                                                        <span>H: ${stock.high.toFixed(2)}</span>
                                                        <span>L: ${stock.low.toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* UltraThink Premium Footer */}
                            <footer className="mt-20 border-t border-cyan-500/30 pt-12 bg-gradient-to-b from-transparent via-blue-950/30 to-purple-950/50">
                                <div className="max-w-7xl mx-auto px-4">
                                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                                        {/* About Section */}
                                        <div className="bg-gradient-to-br from-cyan-900/40 to-blue-900/40 backdrop-blur-xl rounded-2xl p-6 border border-cyan-500/40 hover:border-cyan-400/60 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-cyan-500/20">
                                            <h3 className="text-xl font-black text-cyan-300 mb-4 flex items-center gap-2">
                                                <span className="text-2xl">ðŸ‘¨â€ðŸ’»</span> About Us
                                            </h3>
                                            <div className="space-y-2">
                                                <a
                                                    href="about.html"
                                                    className="text-cyan-200 hover:text-cyan-100 transition-all duration-300 font-bold block group"
                                                >
                                                    <span className="group-hover:translate-x-1 inline-block transition-transform duration-300">Meet Reid â†’</span>
                                                </a>
                                                <a
                                                    href="about-cameron.html"
                                                    className="text-purple-200 hover:text-purple-100 transition-all duration-300 font-bold block group"
                                                >
                                                    <span className="group-hover:translate-x-1 inline-block transition-transform duration-300">Meet Cameron â†’</span>
                                                </a>
                                            </div>
                                            <p className="text-blue-300 text-sm leading-relaxed mt-3">The minds behind FinClash</p>
                                        </div>

                                        {/* Contact Section */}
                                        <div className="bg-gradient-to-br from-blue-900/40 to-indigo-900/40 backdrop-blur-xl rounded-2xl p-6 border border-blue-500/40 hover:border-blue-400/60 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-blue-500/20">
                                            <h3 className="text-xl font-black text-blue-300 mb-4 flex items-center gap-2">
                                                <span className="text-2xl">ðŸ“§</span> Contact
                                            </h3>
                                            <a
                                                href="mailto:finclash101@gmail.com"
                                                className="text-blue-200 hover:text-blue-100 transition-all duration-300 font-bold block mb-3 text-sm break-all"
                                            >
                                                finclash101@gmail.com
                                            </a>
                                            <p className="text-blue-400 text-sm leading-relaxed">Questions? We'd love to hear from you!</p>
                                        </div>

                                        {/* Security Section */}
                                        <div className="bg-gradient-to-br from-orange-900/30 to-red-900/30 backdrop-blur-xl rounded-2xl p-6 border border-orange-500/40 hover:border-orange-400/60 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-orange-500/20">
                                            <h3 className="text-xl font-black text-orange-300 mb-4 flex items-center gap-2">
                                                <span className="text-2xl">ðŸ”’</span> Security
                                            </h3>
                                            <a
                                                href="mailto:finclash101@gmail.com?subject=Security%20Issue%20Report"
                                                className="text-orange-200 hover:text-orange-100 transition-all duration-300 font-bold block mb-3"
                                            >
                                                Report Issues
                                            </a>
                                            <p className="text-orange-400 text-sm leading-relaxed">Help us keep FinClash secure & safe</p>
                                        </div>

                                        {/* Feedback Section */}
                                        <div className="bg-gradient-to-br from-purple-900/40 to-pink-900/30 backdrop-blur-xl rounded-2xl p-6 border border-purple-500/40 hover:border-purple-400/60 transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/20">
                                            <h3 className="text-xl font-black text-purple-300 mb-4 flex items-center gap-2">
                                                <span className="text-2xl">ðŸ’¡</span> Feedback
                                            </h3>
                                            <a
                                                href="mailto:finclash101@gmail.com?subject=FinClash%20Feedback"
                                                className="text-purple-200 hover:text-purple-100 transition-all duration-300 font-bold block mb-3"
                                            >
                                                Share Ideas
                                            </a>
                                            <p className="text-purple-400 text-sm leading-relaxed">Help us improve your experience</p>
                                        </div>
                                    </div>

                                    {/* UltraThink AI Badge */}
                                    <div className="flex justify-center mb-8">
                                        <div className="bg-gradient-to-r from-purple-900/60 to-blue-900/60 backdrop-blur-xl rounded-full px-6 py-3 border border-purple-500/50 flex items-center gap-3 shadow-xl">
                                            <span className="text-2xl">ðŸ§ </span>
                                            <span className="text-purple-200 font-bold text-sm">Powered by</span>
                                            <span className="text-transparent bg-gradient-to-r from-cyan-300 via-blue-400 to-purple-400 bg-clip-text font-black text-lg">UltraThink AI</span>
                                            <span className="relative flex h-2 w-2">
                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                            </span>
                                        </div>
                                    </div>

                                    {/* Bottom Bar with Enhanced Typography */}
                                    <div className="text-center py-8 border-t border-cyan-500/20">
                                        <div className="flex flex-wrap justify-center items-center gap-2 mb-3">
                                            <span className="text-blue-300 text-sm">Â© 2025</span>
                                            <span className="text-transparent bg-gradient-to-r from-cyan-300 to-blue-400 bg-clip-text font-black text-lg">FinClash</span>
                                        </div>
                                        <p className="text-blue-300 text-sm mb-2">
                                            Created by <span className="font-bold text-cyan-300 hover:text-cyan-200 transition-colors duration-300">Reid Coleman</span> and <span className="font-bold text-cyan-300 hover:text-cyan-200 transition-colors duration-300">Cameron Dietzel</span>
                                        </p>
                                        <p className="text-blue-400 text-xs max-w-2xl mx-auto leading-relaxed">
                                            Virtual trading simulator for educational purposes only â€¢ Not financial advice â€¢ Trade responsibly
                                        </p>
                                    </div>
                                </div>
                            </footer>
                        </div>
                    </div>
                );
            }

            // Code Display Screen (after creating competition)
            if (view === 'code-display') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8 flex items-center justify-center">
                        <div className="max-w-2xl w-full">
                            <div className="bg-gradient-to-br from-purple-800 to-indigo-900 rounded-3xl p-8 border-4 border-purple-500 shadow-2xl">
                                {/* Success Icon */}
                                <div className="text-center mb-6">
                                    <div className="inline-block bg-green-500 rounded-full p-6 mb-4">
                                        <span className="text-7xl">âœ…</span>
                                    </div>
                                    <h1 className="text-4xl font-black text-white mb-2">{plan === 'personal' ? 'Account Created!' : 'Competition Created!'}</h1>
                                    <p className="text-purple-200 text-lg">{plan === 'personal' ? 'Save this code to sign in from any device' : 'Share this code with your family members'}</p>
                                </div>

                                {/* Login Credentials Display */}
                                {plan === 'personal' ? (
                                    <div className="space-y-4 mb-6">
                                        <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/30">
                                            <div className="text-center">
                                                <p className="text-purple-200 text-sm font-semibold mb-2">YOUR ACCOUNT CODE</p>
                                                <div className="bg-gradient-to-r from-green-400 to-emerald-400 rounded-xl p-4">
                                                    <div className="text-3xl font-black text-gray-900 tracking-widest font-mono">
                                                        {competitionCode}
                                                    </div>
                                                </div>
                                                <p className="text-purple-200 text-xs mt-2">Use this code to sign in quickly</p>
                                            </div>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/30">
                                            <div className="text-center">
                                                <p className="text-purple-200 text-sm font-semibold mb-2">YOUR EMAIL</p>
                                                <div className="bg-gradient-to-r from-blue-400 to-cyan-400 rounded-xl p-4">
                                                    <div className="text-2xl font-bold text-gray-900">
                                                        {userEmail}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border-2 border-white/30">
                                            <div className="text-center">
                                                <p className="text-purple-200 text-sm font-semibold mb-2">YOUR PASSCODE</p>
                                                <div className="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-6">
                                                    <div className="text-5xl font-black text-gray-900 tracking-widest font-mono">
                                                        {generatedPasscode}
                                                    </div>
                                                </div>
                                                <p className="text-purple-200 text-xs mt-2">Legacy 6-digit code (optional)</p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                navigator.clipboard.writeText(`Account Code: ${competitionCode}\nEmail: ${userEmail}\nPasscode: ${generatedPasscode}`);
                                                setCopySuccess(true);
                                                setTimeout(() => setCopySuccess(false), 2000);
                                            }}
                                            className="w-full bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-xl font-bold transition-all duration-300 flex items-center justify-center gap-2"
                                        >
                                            {copySuccess ? 'âœ“ Copied!' : 'ðŸ“‹ Copy All Login Info'}
                                        </button>
                                    </div>
                                ) : (
                                    <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-8 mb-6 border-2 border-white/30">
                                        <div className="text-center">
                                            <p className="text-purple-200 text-sm font-semibold mb-3">YOUR COMPETITION CODE</p>
                                            <div className="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-6 mb-4">
                                                <div className="text-6xl font-black text-gray-900 tracking-widest font-mono">
                                                    {competitionCode}
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    navigator.clipboard.writeText(competitionCode);
                                                    setCopySuccess(true);
                                                    setTimeout(() => setCopySuccess(false), 2000);
                                                }}
                                                className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2 mx-auto"
                                            >
                                                {copySuccess ? 'âœ“ Copied!' : 'ðŸ“‹ Copy Code'}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Instructions */}
                                <div className="bg-blue-900/50 rounded-xl p-6 mb-6 border border-blue-500">
                                    <h3 className="text-white font-bold mb-3 text-lg">{plan === 'personal' ? 'ðŸ” Important - Save Your Login Info!' : 'ðŸ“± How to Share:'}</h3>
                                    {plan === 'personal' ? (
                                        <ul className="text-purple-200 space-y-2 list-disc list-inside">
                                            <li><strong>Email + Password:</strong> Sign in with your email and password</li>
                                            <li>Save your account code and passcode for reference</li>
                                            <li>Your portfolio and trades are saved automatically</li>
                                            <li className="text-green-300 font-semibold">You start with $100,000 virtual cash - Happy trading! ðŸ“ˆ</li>
                                        </ul>
                                    ) : (
                                        <ol className="text-purple-200 space-y-2 list-decimal list-inside">
                                            <li>Copy the code above</li>
                                            <li>Share it with your family members via text, email, or in person</li>
                                            <li>They click "Join Pool" and enter this code</li>
                                            <li>Everyone trades with $100,000 virtual cash</li>
                                            <li>Winner takes the prize pool: <span className="text-green-300 font-bold">${competition?.totalPool || 0}</span></li>
                                        </ol>
                                    )}
                                </div>

                                {/* Competition Info */}
                                <div className="bg-purple-900/50 rounded-xl p-4 mb-6 border border-purple-500">
                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div>
                                            <div className="text-purple-300 text-sm">Your Name</div>
                                            <div className="text-white font-bold text-lg">{userName}</div>
                                        </div>
                                        <div>
                                            <div className="text-purple-300 text-sm">Your Entry</div>
                                            <div className="text-green-300 font-bold text-lg">${contribution}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div className="grid grid-cols-1 gap-4">
                                    <button
                                        onClick={() => setView('trading')}
                                        className="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-300 hover:to-emerald-400 text-white py-5 rounded-xl font-black text-xl transition-all duration-300 shadow-lg"
                                    >
                                        ðŸš€ Start Trading
                                    </button>
                                    <button
                                        onClick={() => setView('plan-select')}
                                        className="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition-all duration-300"
                                    >
                                        â† Back to Home
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }


            // Setup/Join screens
            if (view === 'setup-family' || view === 'join-family') {
                // Personal Account - Show Create/Login Tabs
                if (plan === 'personal' && view === 'setup-family') {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                            <div className="max-w-2xl mx-auto">
                                <button
                                    onClick={() => {
                                        setView('plan-select');
                                        setAccountMode('create');
                                        setShowPasswordReset(false);
                                    }}
                                    className="mb-6 text-cyan-300 hover:text-cyan-200 font-semibold"
                                >
                                    â† Back to Plans
                                </button>

                                <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 border-2 border-blue-500/50 shadow-2xl">
                                    {/* Create Account Form */}
                                    {accountMode === 'create' && (
                                        <div className="space-y-6">
                                            <div className="text-center mb-6">
                                                <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-2">Create Personal Account</h2>
                                                <p className="text-blue-200">Start trading with $100,000 virtual cash</p>
                                            </div>

                                            <div>
                                                <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Your Name</label>
                                                <input
                                                    type="text"
                                                    value={userName}
                                                    onChange={(e) => setUserName(e.target.value)}
                                                    placeholder="Enter your name"
                                                    className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Email Address</label>
                                                <input
                                                    type="email"
                                                    value={userEmail}
                                                    onChange={(e) => setUserEmail(e.target.value)}
                                                    placeholder="your@email.com"
                                                    className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Password</label>
                                                <input
                                                    type="password"
                                                    value={userPassword}
                                                    onChange={(e) => setUserPassword(e.target.value)}
                                                    placeholder="Create a password"
                                                    className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <button
                                                onClick={async () => {
                                                    if (!userName || userName.trim().length === 0) {
                                                        alert('Please enter your name');
                                                        return;
                                                    }
                                                    if (!userEmail || !userEmail.includes('@')) {
                                                        alert('Please enter a valid email address');
                                                        return;
                                                    }
                                                    if (!userPassword || userPassword.length < 6) {
                                                        alert('Password must be at least 6 characters long');
                                                        return;
                                                    }

                                                    setLoading(true);
                                                    try {
                                                        await createCompetition(userName.trim(), 0, userPassword);
                                                    } catch (error) {
                                                        console.error('Account creation error:', error);
                                                        alert('Failed to create account. Please try again.');
                                                    } finally {
                                                        setLoading(false);
                                                    }
                                                }}
                                                disabled={loading}
                                                className={`w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                {loading ? 'â³ Creating Account...' : 'âœ¨ Create Account & Start Trading'}
                                            </button>

                                            <div className="relative my-6">
                                                <div className="absolute inset-0 flex items-center">
                                                    <div className="w-full border-t border-blue-500/30"></div>
                                                </div>
                                                <div className="relative flex justify-center text-sm">
                                                    <span className="px-4 bg-gradient-to-br from-blue-800 to-blue-900 text-blue-300">OR</span>
                                                </div>
                                            </div>

                                            <button
                                                onClick={() => {
                                                    window.location.href = 'http://localhost:3001/auth/google';
                                                }}
                                                className="w-full bg-white hover:bg-gray-100 text-gray-800 py-4 rounded-xl font-bold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl flex items-center justify-center gap-3 border-2 border-gray-200"
                                            >
                                                <svg className="w-6 h-6" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                                </svg>
                                                Continue with Google
                                            </button>
                                        </div>
                                    )}

                                    {/* Login Form */}
                                    {accountMode === 'login' && (
                                        <div className="space-y-6">
                                            <div className="text-center mb-6">
                                                <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-2">Welcome Back!</h2>
                                                <p className="text-blue-200">Sign in to continue trading</p>
                                            </div>

                                            <div>
                                                <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Email Address</label>
                                                <input
                                                    type="email"
                                                    value={userEmail}
                                                    onChange={(e) => setUserEmail(e.target.value)}
                                                    placeholder="your@email.com"
                                                    className="w-full bg-blue-700/50 border-2 border-cyan-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Password</label>
                                                <input
                                                    type="password"
                                                    value={userPassword}
                                                    onChange={(e) => setUserPassword(e.target.value)}
                                                    placeholder="Enter your password"
                                                    className="w-full bg-blue-700/50 border-2 border-cyan-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <button
                                                onClick={async () => {
                                                    if (!userEmail || !userEmail.includes('@')) {
                                                        alert('Please enter a valid email address');
                                                        return;
                                                    }
                                                    if (!userPassword) {
                                                        alert('Please enter your password');
                                                        return;
                                                    }

                                                    setLoading(true);
                                                    try {
                                                        // Login via backend server
                                                        const response = await fetch('http://localhost:3001/api/accounts/login', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({
                                                                email: userEmail.trim().toLowerCase(),
                                                                password: userPassword
                                                            })
                                                        });

                                                        const data = await response.json();

                                                        if (!response.ok) {
                                                            alert(data.error || 'Invalid email or password');
                                                            return;
                                                        }

                                                        // Sign in with account data from backend
                                                        const account = data.account;
                                                        const code = account.accountCode;
                                                        const newCompetition = {
                                                            code: code,
                                                            totalPool: 0,
                                                            startTime: account.createdAt,
                                                            members: [{
                                                                id: Date.now().toString(),
                                                                name: account.userName,
                                                                contribution: 0,
                                                                portfolio: account.portfolio,
                                                                joinedAt: account.createdAt
                                                            }]
                                                        };

                                                        setCompetition(newCompetition);
                                                        setCompetitionCode(code);
                                                        setCurrentUserId(newCompetition.members[0].id);
                                                        setUserName(account.userName);
                                                        setUserEmail(account.email);
                                                        setView('app');
                                                        setUserPassword('');
                                                        console.log('âœ… Signed in successfully');
                                                    } catch (error) {
                                                        console.error('Sign in error:', error);
                                                        alert('Failed to sign in. Please check that the server is running (npm start).');
                                                    } finally {
                                                        setLoading(false);
                                                    }
                                                }}
                                                disabled={loading}
                                                className={`w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 shadow-xl hover:shadow-2xl ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                {loading ? 'â³ Signing In...' : 'ðŸš€ Sign In'}
                                            </button>

                                            <div className="relative my-6">
                                                <div className="absolute inset-0 flex items-center">
                                                    <div className="w-full border-t border-cyan-500/30"></div>
                                                </div>
                                                <div className="relative flex justify-center text-sm">
                                                    <span className="px-4 bg-gradient-to-br from-blue-800 to-blue-900 text-cyan-300">OR</span>
                                                </div>
                                            </div>

                                            <button
                                                onClick={() => {
                                                    window.location.href = 'http://localhost:3001/auth/google';
                                                }}
                                                className="w-full bg-white hover:bg-gray-100 text-gray-800 py-4 rounded-xl font-bold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl flex items-center justify-center gap-3 border-2 border-gray-200"
                                            >
                                                <svg className="w-6 h-6" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                                </svg>
                                                Continue with Google
                                            </button>
                                        </div>
                                    )}

                                </div>
                            </div>
                        </div>
                    );
                }

                // Family/Competition screens
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto">
                            <button
                                onClick={() => setView('plan-select')}
                                className="mb-6 text-cyan-300 hover:text-cyan-200 font-semibold"
                            >
                                â† Back to Plans
                            </button>

                            <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 border-2 border-blue-500/50 shadow-2xl">
                                <h2 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-8 text-center">
                                    {view === 'setup-family' ? 'Create Competition' : 'Join Competition'}
                                </h2>

                                <div className="space-y-6">
                                    {view === 'join-family' && (
                                        <div>
                                            <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Competition Code</label>
                                            <input
                                                type="text"
                                                value={joinCode}
                                                onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                                placeholder="Enter 6-character code"
                                                maxLength="6"
                                                className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-2xl font-bold placeholder-blue-300 text-center tracking-widest uppercase focus:border-cyan-400 focus:outline-none transition-all"
                                            />
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Your Name</label>
                                        <input
                                            type="text"
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                            placeholder="Enter your name"
                                            className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-blue-300 font-bold mb-3 text-sm uppercase tracking-wide">Entry Amount ($)</label>
                                        <input
                                            type="number"
                                            value={contribution}
                                            onChange={(e) => setContribution(e.target.value)}
                                            placeholder="0.00"
                                            className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-2xl font-bold placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                        />
                                    </div>

                                    <button
                                        onClick={() => {
                                            if (!userName) {
                                                alert('Please enter your name');
                                                return;
                                            }

                                            if (view === 'join-family') {
                                                if (!joinCode || joinCode.length !== 6) {
                                                    alert('Please enter a valid 6-character competition code');
                                                    return;
                                                }
                                                if (!contribution || parseFloat(contribution) <= 0) {
                                                    alert('Please enter a valid contribution amount');
                                                    return;
                                                }
                                                joinCompetition(joinCode, userName, contribution);
                                            } else if (!contribution || parseFloat(contribution) <= 0) {
                                                alert('Please enter a valid contribution amount');
                                                return;
                                            } else {
                                                createCompetition(userName, contribution);
                                            }
                                        }}
                                        className="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all"
                                    >
                                        {view === 'setup-family' ? 'Create Competition' : 'Join Competition'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Trading Interface
            const portfolio = getCurrentPortfolio();
            const portfolioValue = calculatePortfolioValue(portfolio);
            const portfolioReturn = ((portfolioValue - 100000) / 100000) * 100;

            const filteredStocks = stocks.filter(stock =>
                stock.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                stock.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Navigation Bar */}
                        <div className="mb-4 flex gap-3">
                            <button
                                onClick={() => setView('plan-select')}
                                className="bg-gradient-to-r from-cyan-400 to-blue-500 hover:from-cyan-300 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                            >
                                ðŸ  Home
                            </button>
                            <button
                                onClick={() => window.history.back()}
                                className="bg-blue-700 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                            >
                                â† Back
                            </button>
                        </div>

                        {/* Live Stock Ticker */}
                        {topStocks.length > 0 && (
                            <div className="mb-6 bg-gradient-to-r from-indigo-900 to-purple-900 rounded-2xl p-4 border-2 border-purple-500 shadow-xl overflow-hidden">
                                <div className="flex items-center gap-2 mb-3">
                                    <span className="text-2xl">ðŸ“Š</span>
                                    <h3 className="text-lg font-black text-white">Live Market Ticker</h3>
                                    <span className="ml-auto text-xs text-purple-300 animate-pulse">â— LIVE</span>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                    {topStocks.map(stock => (
                                        <div
                                            key={stock.symbol}
                                            className="bg-blue-900/40 rounded-lg p-3 border border-purple-400/30 hover:border-purple-400 transition-all cursor-pointer hover:scale-105"
                                            onClick={() => {
                                                addToWatchlist(stock.symbol);
                                                setMainTab('trading');
                                            }}
                                        >
                                            <div className="font-bold text-white text-sm">{stock.symbol}</div>
                                            <div className="text-xl font-black text-white mt-1">${stock.price.toFixed(2)}</div>
                                            <div className={`text-xs font-bold mt-1 ${stock.change >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                {stock.change >= 0 ? 'â†—' : 'â†˜'} {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Main Tab Navigation */}
                        <div className="mb-6 bg-gradient-to-r from-blue-800 to-blue-900 rounded-2xl p-2 border-2 border-blue-500">
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setMainTab('portfolio')}
                                    className={`flex-1 py-4 rounded-xl font-black text-lg transition-all duration-300 ${
                                        mainTab === 'portfolio'
                                            ? 'bg-gradient-to-r from-cyan-400 to-blue-500 text-white shadow-xl'
                                            : 'text-blue-300 hover:text-white hover:bg-blue-700/50'
                                    }`}
                                >
                                    ðŸ’¼ Portfolio
                                </button>
                                <button
                                    onClick={() => setMainTab('trading')}
                                    className={`flex-1 py-4 rounded-xl font-black text-lg transition-all duration-300 ${
                                        mainTab === 'trading'
                                            ? 'bg-gradient-to-r from-cyan-400 to-blue-500 text-white shadow-xl'
                                            : 'text-blue-300 hover:text-white hover:bg-blue-700/50'
                                    }`}
                                >
                                    ðŸ“ˆ Trading
                                </button>
                                <button
                                    onClick={() => setMainTab('watchlist')}
                                    className={`flex-1 py-4 rounded-xl font-black text-lg transition-all duration-300 ${
                                        mainTab === 'watchlist'
                                            ? 'bg-gradient-to-r from-cyan-400 to-blue-500 text-white shadow-xl'
                                            : 'text-blue-300 hover:text-white hover:bg-blue-700/50'
                                    }`}
                                >
                                    â­ Watchlist
                                </button>
                                <button
                                    onClick={() => setMainTab('news')}
                                    className={`flex-1 py-4 rounded-xl font-black text-lg transition-all duration-300 ${
                                        mainTab === 'news'
                                            ? 'bg-gradient-to-r from-cyan-400 to-blue-500 text-white shadow-xl'
                                            : 'text-blue-300 hover:text-white hover:bg-blue-700/50'
                                    }`}
                                >
                                    ðŸ“° News
                                </button>
                                <button
                                    onClick={() => setMainTab('ai-analysis')}
                                    className={`flex-1 py-4 rounded-xl font-black text-lg transition-all duration-300 ${
                                        mainTab === 'ai-analysis'
                                            ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl'
                                            : 'text-blue-300 hover:text-white hover:bg-blue-700/50'
                                    }`}
                                >
                                    ðŸ§  AI Analysis
                                </button>
                            </div>
                        </div>

                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-800 to-blue-900 rounded-2xl p-6 border border-blue-600 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold text-white flex items-center gap-2">
                                        ðŸ“Š {plan === 'personal' ? 'Personal Trading' : 'Family Competition'}
                                    </h1>
                                    <p className="text-blue-200">{userName}</p>
                                </div>
                                {competition?.code && (
                                    <div className="bg-blue-700/50 rounded-xl px-6 py-3 border border-blue-500">
                                        <div className="text-xs text-blue-200">Competition Code</div>
                                        <div className="text-2xl font-bold text-white tracking-wider">{competition.code}</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 border-2 border-blue-500 shadow-xl">
                                <div className="text-blue-200 text-sm font-bold mb-3 uppercase tracking-wide flex items-center gap-2">
                                    ðŸ’µ <span>Available Cash</span>
                                </div>
                                <div className="text-4xl font-black text-white">${portfolio.cash.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                <div className="text-xs text-blue-400 mt-2 font-semibold">Ready to trade</div>
                            </div>

                            <div className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 rounded-2xl p-6 border-2 border-green-400 relative overflow-hidden shadow-2xl shadow-green-500/20">
                                <div className="absolute inset-0 bg-gradient-to-r from-green-500/10 to-emerald-500/10 animate-pulse"></div>
                                <div className="relative">
                                    <div className="text-green-200 text-sm font-bold mb-3 uppercase tracking-wide flex items-center gap-2">
                                        ðŸ“ˆ <span>Total Value</span>
                                        {lastUpdate && <span className="text-xs text-green-400 normal-case tracking-normal">(Live)</span>}
                                    </div>
                                    <div className="text-4xl font-black text-white">${portfolioValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                    {lastUpdate && (
                                        <div className="text-xs text-green-300 mt-2 font-semibold">
                                            ðŸ”„ Updated: {lastUpdate.toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className={`bg-gradient-to-br ${
                                portfolioReturn >= 0
                                    ? 'from-green-900/40 to-emerald-900/40 border-green-400 shadow-green-500/20'
                                    : 'from-red-900/40 to-pink-900/40 border-red-400 shadow-red-500/20'
                            } rounded-2xl p-6 border-2 shadow-2xl`}>
                                <div className={`text-sm font-bold mb-3 uppercase tracking-wide flex items-center gap-2 ${
                                    portfolioReturn >= 0 ? 'text-green-200' : 'text-red-200'
                                }`}>
                                    {portfolioReturn >= 0 ? 'ðŸš€' : 'ðŸ“‰'} <span>Return</span>
                                </div>
                                <div className={`text-4xl font-black mb-2 ${portfolioReturn >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                    {portfolioReturn >= 0 ? '+' : ''}{portfolioReturn.toFixed(2)}%
                                </div>
                                <div className={`text-lg font-black ${portfolioReturn >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {portfolioReturn >= 0 ? '+' : ''}${(portfolioValue - 100000).toLocaleString(undefined, {maximumFractionDigits: 0})}
                                </div>
                            </div>

                            <div className="bg-gradient-to-br from-purple-800/40 to-indigo-900/40 rounded-2xl p-6 border-2 border-purple-400 shadow-xl shadow-purple-500/20">
                                <div className="text-purple-200 text-sm font-bold mb-3 uppercase tracking-wide flex items-center gap-2">
                                    â­ <span>Watchlist</span>
                                </div>
                                <div className="text-4xl font-black text-white">{watchlist.length}</div>
                                <div className="text-xs text-purple-400 mt-2 font-semibold">
                                    {watchlist.length === 0 ? 'Search for stocks' : `${watchlist.length} stock${watchlist.length !== 1 ? 's' : ''} tracked`}
                                </div>
                            </div>
                        </div>

                        {/* Portfolio View */}
                        {mainTab === 'portfolio' && (
                            <>
                        {/* Portfolio Breakdown */}
                        <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 mb-6 shadow-2xl">
                            <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-6 flex items-center gap-2">
                                ðŸŽ¯ Portfolio Breakdown
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Visual Allocation Bar */}
                                <div>
                                    <div className="mb-4">
                                        <div className="flex justify-between text-sm text-blue-200 mb-2 font-semibold">
                                            <span>Asset Allocation</span>
                                            <span>Total: ${portfolioValue.toLocaleString()}</span>
                                        </div>
                                        <div className="h-8 bg-blue-900/50 rounded-xl overflow-hidden flex border-2 border-blue-600">
                                            <div
                                                className="bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold transition-all duration-500"
                                                style={{ width: `${(portfolio.cash / portfolioValue * 100)}%` }}
                                            >
                                                {(portfolio.cash / portfolioValue * 100) > 10 && 'Cash'}
                                            </div>
                                            {Object.entries(portfolio.positions)
                                                .filter(([_, qty]) => qty > 0)
                                                .map(([symbol, qty]) => {
                                                    const stock = stocks.find(s => s.symbol === symbol);
                                                    if (!stock) return null;
                                                    const value = stock.price * qty;
                                                    const percentage = (value / portfolioValue * 100);

                                                    // Generate a color based on symbol
                                                    const colors = [
                                                        'from-green-500 to-emerald-600',
                                                        'from-purple-500 to-indigo-600',
                                                        'from-orange-500 to-red-600',
                                                        'from-pink-500 to-rose-600',
                                                        'from-yellow-500 to-amber-600'
                                                    ];
                                                    const colorIndex = symbol.charCodeAt(0) % colors.length;

                                                    return (
                                                        <div
                                                            key={symbol}
                                                            className={`bg-gradient-to-r ${colors[colorIndex]} flex items-center justify-center text-white text-xs font-bold transition-all duration-500 hover:opacity-80`}
                                                            style={{ width: `${percentage}%` }}
                                                            title={`${symbol}: ${percentage.toFixed(1)}%`}
                                                        >
                                                            {percentage > 10 && symbol}
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>

                                    {/* Allocation List */}
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-between bg-blue-700/30 rounded-lg p-3 border border-cyan-500/50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-4 h-4 bg-gradient-to-r from-cyan-400 to-blue-500 rounded"></div>
                                                <span className="font-bold text-white">Cash</span>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-black text-white">${portfolio.cash.toLocaleString()}</div>
                                                <div className="text-xs text-cyan-300 font-semibold">
                                                    {(portfolio.cash / portfolioValue * 100).toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                        {Object.entries(portfolio.positions)
                                            .filter(([_, qty]) => qty > 0)
                                            .map(([symbol, qty]) => {
                                                const stock = stocks.find(s => s.symbol === symbol);
                                                if (!stock) return null;
                                                const value = stock.price * qty;
                                                const percentage = (value / portfolioValue * 100);

                                                const colors = [
                                                    { bg: 'from-green-500 to-emerald-600', border: 'border-green-500/50' },
                                                    { bg: 'from-purple-500 to-indigo-600', border: 'border-purple-500/50' },
                                                    { bg: 'from-orange-500 to-red-600', border: 'border-orange-500/50' },
                                                    { bg: 'from-pink-500 to-rose-600', border: 'border-pink-500/50' },
                                                    { bg: 'from-yellow-500 to-amber-600', border: 'border-yellow-500/50' }
                                                ];
                                                const colorSet = colors[symbol.charCodeAt(0) % colors.length];

                                                return (
                                                    <div key={symbol} className={`flex items-center justify-between bg-blue-700/30 rounded-lg p-3 border ${colorSet.border}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-4 h-4 bg-gradient-to-r ${colorSet.bg} rounded`}></div>
                                                            <span className="font-bold text-white">{symbol}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-black text-white">${value.toLocaleString()}</div>
                                                            <div className="text-xs text-blue-300 font-semibold">
                                                                {percentage.toFixed(1)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>

                                {/* Stats Summary */}
                                <div className="bg-blue-900/40 backdrop-blur-sm rounded-xl p-6 border-2 border-blue-500/50">
                                    <h3 className="text-lg font-black text-blue-100 mb-4 flex items-center gap-2">
                                        ðŸ“Š Quick Stats
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="border-b border-blue-700 pb-3">
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Total Assets</div>
                                            <div className="text-2xl font-black text-white">{Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length + 1}</div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length} stocks + cash
                                            </div>
                                        </div>
                                        <div className="border-b border-blue-700 pb-3">
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Stocks Value</div>
                                            <div className="text-2xl font-black text-white">
                                                ${(portfolioValue - portfolio.cash).toLocaleString()}
                                            </div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {((portfolioValue - portfolio.cash) / portfolioValue * 100).toFixed(1)}% invested
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Cash Reserve</div>
                                            <div className="text-2xl font-black text-white">${portfolio.cash.toLocaleString()}</div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {(portfolio.cash / portfolioValue * 100).toFixed(1)}% available
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Portfolio Positions */}
                        <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 shadow-2xl">
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 flex items-center gap-2">
                                    ðŸ’¼ Your Holdings
                                </h3>
                                <div className="text-sm text-blue-300 font-semibold bg-blue-700/50 px-3 py-1 rounded-full">
                                    {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length} stocks
                                </div>
                            </div>
                            <div className="space-y-3">
                                {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length === 0 ? (
                                    <div className="text-center py-12 bg-blue-700/20 rounded-xl border-2 border-dashed border-blue-600 animate-fade-in">
                                        <div className="text-6xl mb-3 opacity-50 animate-bounce">ðŸ“Š</div>
                                        <div className="text-blue-200 font-semibold">No positions yet</div>
                                        <div className="text-sm text-blue-400 mt-2">Buy your first stock to get started!</div>
                                    </div>
                                ) : (
                                    Object.entries(portfolio.positions)
                                        .filter(([_, qty]) => qty > 0)
                                        .map(([symbol, qty]) => {
                                            const stock = stocks.find(s => s.symbol === symbol);
                                            if (!stock) return null;

                                            // Calculate average buy price from history
                                            const buyTransactions = portfolio.history.filter(t =>
                                                t.symbol === symbol && t.type === 'buy'
                                            );
                                            const totalCost = buyTransactions.reduce((sum, t) => sum + (t.price * t.quantity), 0);
                                            const totalShares = buyTransactions.reduce((sum, t) => sum + t.quantity, 0);
                                            const avgBuyPrice = totalShares > 0 ? totalCost / totalShares : 0;

                                            const currentValue = stock.price * qty;
                                            const costBasis = avgBuyPrice * qty;
                                            const gainLoss = currentValue - costBasis;
                                            const gainLossPercent = costBasis > 0 ? (gainLoss / costBasis) * 100 : 0;

                                            const isPositive = gainLoss >= 0;

                                            return (
                                                <div
                                                    key={symbol}
                                                    className={`transition-all duration-300 bg-gradient-to-r ${
                                                        isPositive
                                                            ? 'from-green-900/30 to-emerald-900/30 border-2 border-green-500/50 hover-glow-green'
                                                            : 'from-red-900/30 to-pink-900/30 border-2 border-red-500/50 hover-glow-red'
                                                    } rounded-xl p-4 shadow-lg hover:-translate-y-1 hover:shadow-2xl will-change-transform gpu-accelerated animate-fade-in`}
                                                >
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <div className="font-black text-white text-xl">{symbol}</div>
                                                            <div className="text-sm text-gray-300 font-semibold">{qty} shares</div>
                                                        </div>
                                                        <div className={`px-3 py-1 rounded-full font-bold text-sm transition-all ${
                                                            isPositive
                                                                ? 'bg-green-500/20 text-green-300 border border-green-500 animate-pulse-glow-green'
                                                                : 'bg-red-500/20 text-red-300 border border-red-500 animate-pulse-glow-red'
                                                        }`}>
                                                            {isPositive ? 'â†—' : 'â†˜'} {isPositive ? '+' : ''}{gainLossPercent.toFixed(2)}%
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-3 mb-3 text-sm">
                                                        <div className="bg-blue-800/50 rounded-lg p-2">
                                                            <div className="text-blue-300 text-xs font-semibold mb-1">Avg Price</div>
                                                            <div className="text-white font-bold">${avgBuyPrice.toFixed(2)}</div>
                                                        </div>
                                                        <div className="bg-blue-800/50 rounded-lg p-2">
                                                            <div className="text-blue-300 text-xs font-semibold mb-1">Current</div>
                                                            <div className="text-white font-bold">${stock.price.toFixed(2)}</div>
                                                        </div>
                                                    </div>

                                                    <div className="flex justify-between items-end pt-3 border-t border-gray-600/50">
                                                        <div>
                                                            <div className="text-xs text-gray-400 font-semibold">Total Value</div>
                                                            <div className="text-white font-black text-lg">${currentValue.toFixed(2)}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-xs text-gray-400 font-semibold">Gain/Loss</div>
                                                            <div className={`font-black text-lg ${isPositive ? 'text-green-300' : 'text-red-300'}`}>
                                                                {isPositive ? '+' : ''}${gainLoss.toFixed(2)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                )}
                            </div>
                        </div>
                            </>
                        )}

                        {/* Trading View */}
                        {mainTab === 'trading' && (
                            <>
                        {/* Leaderboard for Family Competitions */}
                        {(plan === 'family-public' || plan === 'family-private') && competition?.members && competition.members.length > 1 && (
                            <div className="bg-gradient-to-br from-purple-800/40 to-indigo-900/40 rounded-2xl p-6 border-2 border-purple-500 mb-6 shadow-xl">
                                <h2 className="text-2xl font-black text-white mb-6 flex items-center gap-2">
                                    ðŸ† Leaderboard
                                    <span className="text-sm font-normal text-purple-300 ml-2">
                                        ({competition.members.length} players)
                                    </span>
                                </h2>
                                <div className="space-y-3">
                                    {competition.members
                                        .map(member => ({
                                            ...member,
                                            portfolioValue: calculatePortfolioValue(member.portfolio)
                                        }))
                                        .sort((a, b) => b.portfolioValue - a.portfolioValue)
                                        .map((member, index) => {
                                            const isCurrentUser = member.id === currentUserId;
                                            const returnPercent = ((member.portfolioValue - 100000) / 100000) * 100;
                                            const isPositive = returnPercent >= 0;

                                            return (
                                                <div
                                                    key={member.id}
                                                    className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all ${
                                                        isCurrentUser
                                                            ? 'bg-gradient-to-r from-cyan-900/50 to-blue-900/50 border-cyan-400 shadow-lg shadow-cyan-500/20'
                                                            : index === 0
                                                                ? 'bg-gradient-to-r from-yellow-900/30 to-amber-900/30 border-yellow-500'
                                                                : 'bg-blue-900/30 border-purple-600/50'
                                                    }`}
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <div className={`text-3xl font-black ${
                                                            index === 0 ? 'text-yellow-300' :
                                                            index === 1 ? 'text-gray-300' :
                                                            index === 2 ? 'text-orange-400' :
                                                            'text-purple-400'
                                                        }`}>
                                                            {index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `#${index + 1}`}
                                                        </div>
                                                        <div>
                                                            <div className="font-black text-white text-lg flex items-center gap-2">
                                                                {member.name}
                                                                {isCurrentUser && (
                                                                    <span className="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full">YOU</span>
                                                                )}
                                                            </div>
                                                            <div className="text-sm text-gray-300">
                                                                Portfolio: ${member.portfolioValue.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-2xl font-black ${isPositive ? 'text-green-300' : 'text-red-300'}`}>
                                                            {isPositive ? '+' : ''}{returnPercent.toFixed(2)}%
                                                        </div>
                                                        <div className={`text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                                            {isPositive ? '+' : ''}${(member.portfolioValue - 100000).toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                </div>
                                <div className="mt-6 p-4 bg-purple-900/30 border border-purple-600/50 rounded-xl">
                                    <div className="flex items-center justify-between text-sm">
                                        <span className="text-purple-200 font-semibold">ðŸ’° Total Prize Pool:</span>
                                        <span className="text-white font-black text-lg">${competition.totalPool?.toFixed(2) || '0.00'}</span>
                                    </div>
                                    {plan === 'family-public' && (
                                        <div className="text-xs text-purple-300 mt-2">1% fee per trade â€¢ Winner takes all</div>
                                    )}
                                    {plan === 'family-private' && (
                                        <div className="text-xs text-purple-300 mt-2">$0.05 flat fee per trade â€¢ Winner takes all</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Main Content */}
                        <div className="w-full">
                            {/* Market View */}
                            <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 shadow-2xl">
                                <h2 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-4">ðŸ” Stock Search</h2>

                                <div className="relative mb-6">
                                    <input
                                        type="text"
                                        placeholder="Search stocks (e.g., AAPL, TSLA, NVDA)..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-4 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all focus:shadow-lg focus:shadow-cyan-500/30 focus:scale-[1.02]"
                                    />
                                    {searching && (
                                        <div className="absolute right-4 top-4">
                                            <div className="text-cyan-300 animate-spin">ðŸ”</div>
                                        </div>
                                    )}
                                </div>

                                {/* Search Results */}
                                {searchQuery && showSearchResults && (
                                    <div className="mb-6 bg-blue-900/40 backdrop-blur-sm border-2 border-blue-500/50 rounded-xl overflow-hidden shadow-xl">
                                        {searching ? (
                                            <div className="p-6 text-center">
                                                <div className="text-blue-200">Searching...</div>
                                            </div>
                                        ) : searchResults.length > 0 ? (
                                            <div className="max-h-60 overflow-y-auto">
                                                {searchResults.map((result) => (
                                                    <div
                                                        key={result.symbol}
                                                        onClick={async () => {
                                                            setSearching(true);
                                                            setError(null);
                                                            const stockData = await fetchSingleStock(result.symbol, result.name);
                                                            const existingIndex = stocks.findIndex(s => s.symbol === result.symbol);
                                                            if (existingIndex >= 0) {
                                                                const updatedStocks = [...stocks];
                                                                updatedStocks[existingIndex] = stockData;
                                                                setStocks(updatedStocks);
                                                            } else {
                                                                setStocks([...stocks, stockData]);
                                                            }
                                                            setSelectedStock(result.symbol);
                                                            setSearchQuery('');
                                                            setShowSearchResults(false);
                                                            setSearching(false);
                                                        }}
                                                        className="p-4 border-b border-blue-700 last:border-b-0 hover:bg-blue-700 cursor-pointer transition-all hover:scale-[1.02] hover-glow active-press"
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-white text-lg">{result.symbol}</div>
                                                                <div className="text-sm text-blue-200">{result.name}</div>
                                                                <div className="text-xs text-blue-400 mt-1">
                                                                    {result.region} â€¢ {result.currency}
                                                                </div>
                                                            </div>
                                                            <div className="text-blue-300 text-2xl">â†’</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : error ? (
                                            <div className="p-6 text-center">
                                                <div className="text-yellow-300 mb-2">âš ï¸</div>
                                                <div className="text-yellow-200 text-sm">{error}</div>
                                            </div>
                                        ) : (
                                            <div className="p-6 text-center">
                                                <div className="text-blue-300 mb-2">ðŸ”</div>
                                                <div className="text-blue-200">No results found for "{searchQuery}"</div>
                                                <div className="text-xs text-blue-400 mt-2">Try: AAPL, GOOGL, MSFT, TSLA, NVDA</div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <h3 className="text-lg font-bold text-white mb-4 mt-8">ðŸ“Š Select a Stock to Trade</h3>
                                {loading && stocks.length === 0 ? (
                                    <div className="text-center py-12 bg-blue-700/20 rounded-xl">
                                        <div className="text-blue-200">Loading stocks...</div>
                                    </div>
                                ) : !selectedStock ? (
                                    <div className="text-center py-12 bg-blue-700/20 rounded-xl border-2 border-dashed border-blue-600">
                                        <div className="text-6xl mb-3 opacity-50">ðŸ“Š</div>
                                        <div className="text-blue-200 font-semibold">No stock selected</div>
                                        <div className="text-sm text-blue-400 mt-2">Search and add stocks to your watchlist, then select one to trade</div>
                                    </div>
                                ) : null}

                            {/* Trading Panel - Now in main left column */}
                            {selectedStock && (
                                    <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-cyan-500/50 shadow-2xl mt-6">
                                        {/* Stock Header */}
                                        <div className="mb-6 pb-6 border-b border-blue-600">
                                            <div className="flex items-center justify-between mb-3">
                                                <h2 className="text-4xl font-black text-white">{selectedStock}</h2>
                                                <div className={`px-4 py-2 rounded-lg font-bold text-sm ${
                                                    (stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0
                                                        ? 'bg-green-500/20 text-green-300 border border-green-500'
                                                        : 'bg-red-500/20 text-red-300 border border-red-500'
                                                }`}>
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? 'â†—' : 'â†˜'}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? '+' : ''}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0).toFixed(2)}%
                                                </div>
                                            </div>
                                            <p className="text-blue-200 text-lg">{stocks.find(s => s.symbol === selectedStock)?.name || selectedStock}</p>

                                            {/* Add to Watchlist Button */}
                                            {!watchlist.includes(selectedStock) ? (
                                                <button
                                                    onClick={() => {
                                                        const newWatchlist = [...watchlist, selectedStock];
                                                        setWatchlist(newWatchlist);
                                                        const portfolio = getCurrentPortfolio();
                                                        const updatedPortfolio = {
                                                            ...portfolio,
                                                            watchlist: newWatchlist
                                                        };
                                                        setCompetition(prev => ({
                                                            ...prev,
                                                            members: prev.members.map(m =>
                                                                m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                                                            )
                                                        }));
                                                        if (competition?.code && plan === 'personal' && dbReady) {
                                                            try {
                                                                SQLiteDB.updateAccount(competition.code, updatedPortfolio);
                                                            } catch (error) {
                                                                console.error('Error syncing watchlist to SQLite:', error);
                                                            }
                                                        }
                                                    }}
                                                    className="mt-4 w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white py-3 rounded-xl font-bold text-lg transition-all shadow-xl hover:shadow-2xl flex items-center justify-center gap-2"
                                                >
                                                    <span>â­</span>
                                                    <span>Add to Watchlist</span>
                                                </button>
                                            ) : (
                                                <div className="mt-4 w-full bg-green-900/40 border-2 border-green-500 text-green-300 py-3 rounded-xl font-bold text-lg flex items-center justify-center gap-2">
                                                    <span>âœ“</span>
                                                    <span>In Watchlist</span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Price Display */}
                                        <div className="mb-6 text-center bg-gradient-to-r from-cyan-500/10 to-blue-500/10 rounded-xl p-6 border border-cyan-500/30">
                                            <div className="text-sm text-cyan-300 font-semibold mb-2">Current Price</div>
                                            <div className="text-6xl font-black text-white mb-1">
                                                ${(stocks.find(s => s.symbol === selectedStock)?.price || 0).toFixed(2)}
                                            </div>
                                            <div className="text-sm text-blue-300">Per Share</div>
                                        </div>

                                        {/* Price Chart */}
                                        <div className="mb-6 bg-blue-700/20 rounded-xl p-4 border border-blue-600">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-sm font-semibold text-blue-200">ðŸ“ˆ Price Chart</h3>
                                                    {isRealChartData ? (
                                                        <div className="flex items-center gap-1 bg-green-500/20 border border-green-500 rounded-full px-2 py-1">
                                                            <span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                                            <span className="text-green-300 text-[10px] font-black uppercase tracking-wide">Live Data</span>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center gap-1 bg-yellow-500/20 border border-yellow-500 rounded-full px-2 py-1">
                                                            <span className="text-yellow-300 text-[10px] font-black uppercase tracking-wide">Simulated</span>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex gap-1 bg-blue-900/50 rounded-lg p-1">
                                                    {['1D', '1W', '1M', '3M', 'ALL'].map(period => (
                                                        <button
                                                            key={period}
                                                            onClick={() => setChartPeriod(period)}
                                                            className={`px-3 py-1 rounded font-bold text-xs transition-all ${
                                                                chartPeriod === period
                                                                    ? 'bg-cyan-500 text-white shadow-lg'
                                                                    : 'text-blue-300 hover:text-white hover:bg-blue-700'
                                                            }`}
                                                        >
                                                            {period}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="h-48">
                                                <canvas ref={chartRef}></canvas>
                                            </div>
                                            {!isRealChartData && (
                                                <div className="mt-3 text-xs text-yellow-300/70 italic text-center">
                                                    âš ï¸ Using simulated historical data - real data temporarily unavailable
                                                </div>
                                            )}
                                        </div>

                                        {/* AI Trade Analysis - UltraThink */}
                                        <div className="mt-6 bg-gradient-to-br from-purple-900/60 via-indigo-900/60 to-blue-900/60 rounded-2xl border-2 border-purple-500/50 shadow-2xl overflow-hidden">
                                            {/* Header */}
                                            <div className="bg-gradient-to-r from-purple-700/40 to-indigo-700/40 p-6 border-b-2 border-purple-500/50">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
                                                            <span className="text-2xl">ðŸ§ </span>
                                                        </div>
                                                        <div>
                                                            <h3 className="text-2xl font-black text-white flex items-center gap-2">
                                                                AI Trade Analysis
                                                                <span className="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-1 rounded-full font-bold">ULTRATHINK</span>
                                                            </h3>
                                                            <p className="text-sm text-purple-200">Deep neural reasoning for {selectedStock}</p>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={generateAIAnalysis}
                                                        disabled={loadingAnalysis}
                                                        className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 disabled:from-gray-600 disabled:to-gray-700 text-white px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg hover:shadow-xl disabled:opacity-50 flex items-center gap-2"
                                                    >
                                                        {loadingAnalysis ? (
                                                            <>
                                                                <span className="inline-block animate-spin">âš¡</span>
                                                                <span>Analyzing...</span>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span>ðŸ”®</span>
                                                                <span>Analyze</span>
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Loading Animation */}
                                            {loadingAnalysis && (
                                                <div className="p-8">
                                                    <div className="text-center space-y-4">
                                                        <div className="inline-block">
                                                            <div className="w-16 h-16 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
                                                        </div>
                                                        <div className="space-y-2">
                                                            <p className="text-purple-200 font-semibold animate-pulse">ðŸ§  Initializing neural networks...</p>
                                                            <p className="text-purple-300 text-sm animate-pulse delay-100">ðŸ“Š Analyzing technical indicators...</p>
                                                            <p className="text-purple-300 text-sm animate-pulse delay-200">ðŸ“° Processing news sentiment...</p>
                                                            <p className="text-purple-300 text-sm animate-pulse delay-300">âš¡ Calculating risk factors...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Analysis Results */}
                                            {!loadingAnalysis && aiAnalysis && (
                                                <div className="p-6 space-y-6">
                                                    {/* Timestamp */}
                                                    <div className="text-center text-xs text-purple-300">
                                                        Analysis generated: {aiAnalysis.timestamp}
                                                    </div>

                                                    {/* Main Recommendation */}
                                                    <div className={`bg-gradient-to-br ${
                                                        aiAnalysis.recommendation.color === 'green' ? 'from-green-900/40 to-emerald-900/40 border-green-500' :
                                                        aiAnalysis.recommendation.color === 'red' ? 'from-red-900/40 to-rose-900/40 border-red-500' :
                                                        'from-yellow-900/40 to-amber-900/40 border-yellow-500'
                                                    } border-2 rounded-xl p-6 shadow-xl`}>
                                                        <div className="text-center mb-4">
                                                            <div className={`inline-block px-4 py-2 rounded-full font-black text-lg mb-2 ${
                                                                aiAnalysis.recommendation.color === 'green' ? 'bg-green-500 text-white' :
                                                                aiAnalysis.recommendation.color === 'red' ? 'bg-red-500 text-white' :
                                                                'bg-yellow-500 text-gray-900'
                                                            }`}>
                                                                {aiAnalysis.recommendation.action}
                                                            </div>
                                                            <div className="text-sm text-white mt-2">
                                                                Confidence: <span className="font-black">{aiAnalysis.recommendation.confidence}%</span>
                                                            </div>
                                                        </div>

                                                        {/* Reasoning */}
                                                        <div className="space-y-3 mb-4">
                                                            {aiAnalysis.recommendation.reasoning.map((reason, idx) => (
                                                                <div key={idx} className="bg-black/20 rounded-lg p-3 text-sm text-white">
                                                                    {reason}
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Trade Targets */}
                                                        <div className="grid grid-cols-3 gap-3">
                                                            <div className="bg-blue-900/50 rounded-lg p-3 text-center border border-blue-500/30">
                                                                <div className="text-xs text-blue-300 mb-1">Entry</div>
                                                                <div className="text-white font-bold">${aiAnalysis.recommendation.targets.entry}</div>
                                                            </div>
                                                            <div className="bg-red-900/50 rounded-lg p-3 text-center border border-red-500/30">
                                                                <div className="text-xs text-red-300 mb-1">Stop Loss</div>
                                                                <div className="text-white font-bold">${aiAnalysis.recommendation.targets.stopLoss}</div>
                                                            </div>
                                                            <div className="bg-green-900/50 rounded-lg p-3 text-center border border-green-500/30">
                                                                <div className="text-xs text-green-300 mb-1">Take Profit</div>
                                                                <div className="text-white font-bold">${aiAnalysis.recommendation.targets.takeProfit}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Technical Analysis */}
                                                    <div className="bg-blue-900/30 border-2 border-blue-600/50 rounded-xl p-5">
                                                        <h4 className="text-lg font-black text-cyan-300 mb-4 flex items-center gap-2">
                                                            ðŸ“Š Technical Analysis
                                                        </h4>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <div className="text-xs text-blue-300 mb-1">Signal</div>
                                                                <div className={`text-lg font-bold ${
                                                                    aiAnalysis.technical.signal.includes('Bullish') ? 'text-green-300' :
                                                                    aiAnalysis.technical.signal.includes('Bearish') ? 'text-red-300' :
                                                                    'text-yellow-300'
                                                                }`}>{aiAnalysis.technical.signal}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-blue-300 mb-1">Price Change</div>
                                                                <div className={`text-lg font-bold ${parseFloat(aiAnalysis.technical.priceChange) >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                    {parseFloat(aiAnalysis.technical.priceChange) >= 0 ? '+' : ''}{aiAnalysis.technical.priceChange}%
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-blue-300 mb-1">Support Level</div>
                                                                <div className="text-white font-bold">${aiAnalysis.technical.support}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-blue-300 mb-1">Resistance Level</div>
                                                                <div className="text-white font-bold">${aiAnalysis.technical.resistance}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Sentiment Analysis */}
                                                    <div className="bg-indigo-900/30 border-2 border-indigo-600/50 rounded-xl p-5">
                                                        <h4 className="text-lg font-black text-indigo-300 mb-4 flex items-center gap-2">
                                                            ðŸ“° News Sentiment
                                                        </h4>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <div className="text-xs text-indigo-300 mb-1">Signal</div>
                                                                <div className={`text-lg font-bold ${
                                                                    aiAnalysis.sentiment.signal === 'Positive' ? 'text-green-300' :
                                                                    aiAnalysis.sentiment.signal === 'Negative' ? 'text-red-300' :
                                                                    'text-yellow-300'
                                                                }`}>{aiAnalysis.sentiment.signal}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-indigo-300 mb-1">Sentiment Score</div>
                                                                <div className={`text-lg font-bold ${
                                                                    parseFloat(aiAnalysis.sentiment.score) > 30 ? 'text-green-300' :
                                                                    parseFloat(aiAnalysis.sentiment.score) < -30 ? 'text-red-300' :
                                                                    'text-yellow-300'
                                                                }`}>{aiAnalysis.sentiment.score}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-indigo-300 mb-1">Articles Analyzed</div>
                                                                <div className="text-white font-bold">{aiAnalysis.sentiment.articlesAnalyzed}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-xs text-indigo-300 mb-1">Market Interest</div>
                                                                <div className="text-white font-bold">{aiAnalysis.sentiment.trending}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Risk Assessment */}
                                                    <div className="bg-purple-900/30 border-2 border-purple-600/50 rounded-xl p-5">
                                                        <h4 className="text-lg font-black text-purple-300 mb-4 flex items-center gap-2">
                                                            âš ï¸ Risk Assessment
                                                        </h4>
                                                        <div className="mb-4">
                                                            <div className="flex items-center justify-between mb-2">
                                                                <span className="text-sm text-purple-200">Risk Level: <span className={`font-bold ${
                                                                    aiAnalysis.risk.level === 'High' ? 'text-red-300' :
                                                                    aiAnalysis.risk.level === 'Moderate' ? 'text-yellow-300' :
                                                                    'text-green-300'
                                                                }`}>{aiAnalysis.risk.level}</span></span>
                                                                <span className="text-sm text-purple-200">Rating: <span className="font-bold text-white">{aiAnalysis.risk.rating}/10</span></span>
                                                            </div>
                                                            <div className="w-full bg-purple-950/50 rounded-full h-3 overflow-hidden border border-purple-600/30">
                                                                <div
                                                                    className={`h-full rounded-full transition-all ${
                                                                        aiAnalysis.risk.rating >= 7 ? 'bg-gradient-to-r from-red-500 to-red-600' :
                                                                        aiAnalysis.risk.rating >= 4 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                                                                        'bg-gradient-to-r from-green-500 to-green-600'
                                                                    }`}
                                                                    style={{ width: `${aiAnalysis.risk.rating * 10}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-2">
                                                            {aiAnalysis.risk.factors.map((factor, idx) => (
                                                                <div key={idx} className="text-sm text-purple-100 bg-purple-950/30 rounded-lg p-2">
                                                                    {factor}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Empty State */}
                                            {!loadingAnalysis && !aiAnalysis && (
                                                <div className="p-12 text-center">
                                                    <div className="text-6xl mb-4">ðŸ§ </div>
                                                    <h4 className="text-xl font-bold text-purple-200 mb-2">Ready to Analyze</h4>
                                                    <p className="text-purple-300 text-sm">Click "Analyze" to generate AI-powered trade insights for {selectedStock}</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* Real-Time News Feed with Live Updates */}
                                        <div className="mt-6 bg-gradient-to-br from-indigo-900/40 to-purple-900/40 rounded-2xl p-6 border-2 border-indigo-500 shadow-xl">
                                            <div className="flex items-center justify-between mb-4 flex-wrap gap-3">
                                                <div>
                                                    <h3 className="text-xl font-black text-white flex items-center gap-2 flex-wrap">
                                                        <span>ðŸ“°</span> Latest News - {selectedStock}
                                                        <span className="px-3 py-1 bg-green-500/20 text-green-300 border border-green-500 rounded-full text-xs font-bold animate-pulse">
                                                            â— LIVE
                                                        </span>
                                                    </h3>
                                                    {lastStockNewsUpdate && (
                                                        <div className="text-xs text-indigo-300 mt-1 font-semibold">
                                                            ðŸ”„ Last updated: {lastStockNewsUpdate.toLocaleTimeString()} â€¢ Auto-refreshes every 3 min
                                                        </div>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={loadStockNews}
                                                    disabled={loadingNews}
                                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 disabled:from-gray-600 disabled:to-gray-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 shadow-lg hover:shadow-xl"
                                                >
                                                    {loadingNews ? 'â³ Loading...' : 'ðŸ”„ Refresh Now'}
                                                </button>
                                            </div>

                                            {stockNews.length === 0 && !loadingNews && (
                                                <div className="text-center py-12 bg-indigo-700/20 rounded-xl border-2 border-dashed border-indigo-600">
                                                    <div className="text-6xl mb-3 opacity-50">ðŸ“°</div>
                                                    <h4 className="text-lg font-bold text-white mb-2">Loading News...</h4>
                                                    <p className="text-indigo-200 text-sm">Live news will appear here automatically</p>
                                                </div>
                                            )}

                                            {loadingNews && (
                                                <div className="text-center py-8">
                                                    <div className="inline-block animate-spin text-4xl">â³</div>
                                                    <div className="text-indigo-200 mt-2">Loading news...</div>
                                                </div>
                                            )}

                                            {stockNews.length > 0 && !loadingNews && (
                                                <>
                                                    <div className="mb-4 p-3 bg-indigo-800/20 rounded-lg border border-indigo-600/30">
                                                        <div className="flex items-center justify-between text-sm">
                                                            <span className="text-indigo-200 font-semibold">
                                                                ðŸ“Š {stockNews.length} {stockNews.length === 1 ? 'Article' : 'Articles'} Found
                                                            </span>
                                                            <span className="text-indigo-300 text-xs">
                                                                Sorted by recency
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                                                        {stockNews.map((article, idx) => (
                                                            <a
                                                                key={idx}
                                                                href={article.url}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="block bg-gradient-to-br from-indigo-800/40 to-purple-800/30 hover:from-indigo-800/60 hover:to-purple-800/50 rounded-xl p-4 transition-all duration-300 border border-indigo-600/50 hover:border-indigo-400 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
                                                            >
                                                                <div className="flex gap-3">
                                                                    {article.image && (
                                                                        <img
                                                                            src={article.image}
                                                                            alt=""
                                                                            className="w-24 h-24 rounded-lg object-cover flex-shrink-0 border-2 border-indigo-500/30"
                                                                            onError={(e) => e.target.style.display = 'none'}
                                                                        />
                                                                    )}
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                                            <span className={`px-2.5 py-1 rounded-full text-xs font-black shadow-md ${
                                                                                article.sentiment === 'positive' ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' :
                                                                                article.sentiment === 'negative' ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white' :
                                                                                'bg-gradient-to-r from-gray-500 to-slate-500 text-white'
                                                                            }`}>
                                                                                {article.sentiment === 'positive' ? 'ðŸ“ˆ BULLISH' :
                                                                                 article.sentiment === 'negative' ? 'ðŸ“‰ BEARISH' :
                                                                                 'âž– NEUTRAL'}
                                                                            </span>
                                                                            <span className="text-xs text-indigo-300 font-semibold">
                                                                                {window.newsFeed.formatNewsDate(article.datetime)}
                                                                            </span>
                                                                        </div>
                                                                        <h4 className="text-white font-bold mb-2 line-clamp-2 hover:text-cyan-200 transition-colors text-base leading-snug">
                                                                            {article.headline}
                                                                        </h4>
                                                                        <p className="text-sm text-indigo-100 line-clamp-2 mb-3 leading-relaxed">
                                                                            {article.summary}
                                                                        </p>
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="text-xs text-indigo-300 font-semibold flex items-center gap-1">
                                                                                <span>ðŸ”–</span> {article.source}
                                                                            </div>
                                                                            <div className="text-xs text-cyan-300 font-bold flex items-center gap-1 hover:gap-2 transition-all">
                                                                                Read Full Story <span>â†’</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>

                                        {/* Trade Type Selector */}
                                        <div className="mb-6">
                                            <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Trade Type</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button
                                                    onClick={() => setTradeType('long')}
                                                    className={`py-3 rounded-xl font-bold transition-all duration-300 ${
                                                        tradeType === 'long'
                                                            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg'
                                                            : 'bg-blue-700/50 text-blue-300 hover:bg-blue-700'
                                                    }`}
                                                >
                                                    ðŸ“ˆ Long (Buy)
                                                </button>
                                                <button
                                                    onClick={() => setTradeType('short')}
                                                    className={`py-3 rounded-xl font-bold transition-all duration-300 ${
                                                        tradeType === 'short'
                                                            ? 'bg-gradient-to-r from-red-500 to-pink-600 text-white shadow-lg'
                                                            : 'bg-blue-700/50 text-blue-300 hover:bg-blue-700'
                                                    }`}
                                                >
                                                    ðŸ“‰ Short (Sell)
                                                </button>
                                            </div>
                                            <div className="mt-2 text-xs text-blue-300 text-center">
                                                {tradeType === 'long' ? 'ðŸ’¡ Buy stock expecting price to rise' : 'ðŸ’¡ Bet against stock expecting price to fall'}
                                            </div>
                                        </div>

                                        {/* Quantity Selector */}
                                        <div className="mb-6">
                                            <label className="block text-cyan-300 font-bold mb-3 text-sm uppercase tracking-wide">Select Quantity</label>
                                            <div className="flex gap-3 mb-3">
                                                <button
                                                    onClick={() => handleQuantityChange(quantity - 1)}
                                                    className="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-14 rounded-xl font-bold text-2xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-110 active-press hover-glow"
                                                >
                                                    âˆ’
                                                </button>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    value={quantity}
                                                    onChange={(e) => handleQuantityChange(e.target.value)}
                                                    className="flex-1 bg-blue-700/50 border-2 border-cyan-500/50 rounded-xl px-4 py-3 text-white text-center text-2xl font-black focus:border-cyan-400 focus:outline-none transition-all focus:shadow-lg focus:shadow-cyan-500/30"
                                                />
                                                <button
                                                    onClick={() => handleQuantityChange(quantity + 1)}
                                                    className="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-14 rounded-xl font-bold text-2xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-110 active-press hover-glow"
                                                >
                                                    +
                                                </button>
                                            </div>

                                            {/* Quick Actions */}
                                            <div className="flex gap-2 mb-3">
                                                <button
                                                    onClick={buyMax}
                                                    className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 active-press hover-glow-green"
                                                >
                                                    ðŸ’° Buy Max ({getMaxBuyQuantity(selectedStock)})
                                                </button>
                                                <button
                                                    onClick={sellMax}
                                                    className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 active-press hover-glow-red"
                                                >
                                                    ðŸ“Š Sell Max ({getCurrentPosition(selectedStock)})
                                                </button>
                                            </div>

                                            {/* Error message */}
                                            {quantityError && (
                                                <div className="bg-red-900/40 border-2 border-red-500 rounded-xl p-4 text-red-200 text-sm font-semibold animate-shake animate-pulse-glow-red">
                                                    âš ï¸ {quantityError}
                                                </div>
                                            )}
                                        </div>

                                        {/* Total Cost Summary */}
                                        <div className="mb-6 p-5 bg-gradient-to-r from-purple-900/40 to-blue-900/40 border-2 border-purple-500/50 rounded-xl">
                                            <div className="flex justify-between items-center text-white">
                                                <span className="text-purple-200 font-semibold">Total Cost:</span>
                                                <span className="text-3xl font-black">${((stocks.find(s => s.symbol === selectedStock)?.price || 0) * quantity).toFixed(2)}</span>
                                            </div>
                                        </div>

                                        {/* Trade Actions */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <button
                                                onClick={() => {
                                                    if (tradeType === 'long') {
                                                        executeTrade('buy');
                                                    } else {
                                                        executeShortSell();
                                                    }
                                                }}
                                                className="group relative bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white py-5 rounded-xl font-black text-xl shadow-2xl hover:shadow-green-500/50 transition-all duration-300 hover:scale-105 active-press hover-glow-green will-change-transform gpu-accelerated"
                                            >
                                                <span className="flex items-center justify-center gap-2">
                                                    <span className="text-2xl group-hover:animate-bounce">{tradeType === 'long' ? 'ðŸš€' : 'ðŸ“‰'}</span>
                                                    <span>{tradeType === 'long' ? 'BUY' : 'SHORT'}</span>
                                                </span>
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const shortPos = window.shortSelling.getShortPosition(portfolio, selectedStock);
                                                    if (shortPos.quantity > 0) {
                                                        executeCoverShort();
                                                    } else {
                                                        executeTrade('sell');
                                                    }
                                                }}
                                                className="group relative bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-400 hover:to-pink-500 text-white py-5 rounded-xl font-black text-xl shadow-2xl hover:shadow-red-500/50 transition-all duration-300 hover:scale-105 active-press hover-glow-red will-change-transform gpu-accelerated"
                                            >
                                                <span className="flex items-center justify-center gap-2">
                                                    <span className="text-2xl group-hover:animate-bounce">ðŸ’¸</span>
                                                    <span>{(() => {
                                                        const shortPos = window.shortSelling.getShortPosition(portfolio, selectedStock);
                                                        return shortPos.quantity > 0 ? 'COVER' : 'SELL';
                                                    })()}</span>
                                                </span>
                                            </button>
                                        </div>

                                        {/* Short Position Display */}
                                        {(() => {
                                            const shortPos = window.shortSelling.getShortPosition(portfolio, selectedStock);
                                            if (shortPos.quantity > 0) {
                                                const stock = stocks.find(s => s.symbol === selectedStock);
                                                const pnl = stock ? window.shortSelling.calculateShortPnL(portfolio, selectedStock, stock.price) : 0;
                                                return (
                                                    <div className="mt-4 bg-red-900/30 border border-red-500 rounded-xl p-4">
                                                        <div className="text-red-300 text-sm font-bold mb-2">ðŸ“‰ SHORT POSITION</div>
                                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                                            <div>
                                                                <div className="text-red-400/70">Shares Shorted:</div>
                                                                <div className="text-white font-bold">{shortPos.quantity}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-red-400/70">Entry Price:</div>
                                                                <div className="text-white font-bold">${shortPos.entryPrice.toFixed(2)}</div>
                                                            </div>
                                                            <div className="col-span-2 mt-2 pt-2 border-t border-red-500/30">
                                                                <div className="text-red-400/70">Unrealized P/L:</div>
                                                                <div className={`text-2xl font-black ${pnl >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                    {pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </div>
                            )}
                            </div>
                        </div>
                            </>
                        )}

                        {/* Watchlist View */}
                        {mainTab === 'watchlist' && (
                            <>
                                <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 mb-6 shadow-2xl">
                                    <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-6 flex items-center gap-2">
                                        â­ My Watchlist
                                        <span className="text-sm font-normal text-blue-300 ml-2">
                                            ({watchlist.length} stocks)
                                        </span>
                                    </h2>

                                    {loading && stocks.length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="text-purple-200">Loading stocks...</div>
                                        </div>
                                    ) : watchlist.length === 0 ? (
                                        <div className="text-center py-16 bg-blue-900/30 rounded-xl border-2 border-dashed border-blue-500/50 animate-fade-in">
                                            <div className="text-8xl mb-4 opacity-50 animate-bounce">â­</div>
                                            <h3 className="text-2xl font-bold text-white mb-3">No Stocks in Watchlist</h3>
                                            <p className="text-blue-200 text-lg mb-6">Add stocks to your watchlist to track them here</p>
                                            <div className="inline-flex items-center gap-2 bg-blue-500/20 border-2 border-blue-500/50 rounded-xl px-6 py-3 text-blue-300 font-semibold animate-pulse hover:scale-105 transition-transform">
                                                <span>ðŸ’¡</span>
                                                <span>Go to Trading tab to search and add stocks</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {filteredStocks.map((stock, index) => (
                                                <div
                                                    key={stock.symbol}
                                                    onClick={() => {
                                                        setSelectedStock(stock.symbol);
                                                        setMainTab('trading');
                                                    }}
                                                    className={`p-6 rounded-xl cursor-pointer transition-all bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl border-2 border-blue-500/50 hover:border-cyan-400 hover:-translate-y-2 shadow-xl hover:shadow-2xl hover-glow will-change-transform gpu-accelerated animate-fade-in stagger-${Math.min(index + 1, 6)}`}
                                                >
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <div className="font-bold text-2xl text-white">{stock.symbol}</div>
                                                            <div className="text-sm text-blue-200 mt-1">{stock.name}</div>
                                                        </div>
                                                        <div className={`px-3 py-1 rounded-full font-bold text-sm transition-all ${
                                                            stock.change >= 0
                                                                ? 'bg-green-500/20 text-green-300 border border-green-500 animate-pulse-glow-green'
                                                                : 'bg-red-500/20 text-red-300 border border-red-500 animate-pulse-glow-red'
                                                        }`}>
                                                            {stock.change >= 0 ? 'â†—' : 'â†˜'} {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                        </div>
                                                    </div>
                                                    <div className="text-center pt-4 border-t border-blue-600/50">
                                                        <div className="text-sm text-blue-300 mb-1">Current Price</div>
                                                        <div className="font-bold text-3xl text-white">${stock.price.toFixed(2)}</div>
                                                    </div>
                                                    <div className="mt-4 text-center">
                                                        <button className="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white py-2 rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-xl hover:scale-105 active-press hover-glow">
                                                            ðŸ“Š Trade This Stock
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* News View */}
                        {mainTab === 'news' && (
                            <>
                                <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 mb-6 shadow-2xl">
                                    <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
                                        <div>
                                            <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 flex items-center gap-2">
                                                ðŸ“° Market News
                                                <span className="ml-2 px-3 py-1 bg-green-500/20 text-green-300 border border-green-500 rounded-full text-xs font-bold animate-pulse">
                                                    â— LIVE
                                                </span>
                                            </h2>
                                            {lastNewsUpdate && (
                                                <div className="text-xs text-blue-300 mt-1 font-semibold">
                                                    ðŸ”„ Last updated: {lastNewsUpdate.toLocaleTimeString()} â€¢ Auto-refreshes every 2 min
                                                </div>
                                            )}
                                        </div>
                                        <button
                                            onClick={loadMarketNews}
                                            disabled={loadingMarketNews}
                                            className="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white px-5 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-xl hover:shadow-2xl hover:scale-105 active-press hover-glow"
                                        >
                                            {loadingMarketNews ? 'â³ Loading...' : 'ðŸ”„ Refresh News'}
                                        </button>
                                    </div>

                                    {loadingMarketNews ? (
                                        <div className="text-center py-16">
                                            <div className="inline-block animate-spin text-6xl mb-4">â³</div>
                                            <div className="text-blue-200 text-lg font-semibold">Loading latest market news...</div>
                                        </div>
                                    ) : marketNews.length === 0 ? (
                                        <div className="text-center py-16 bg-blue-900/30 rounded-xl border-2 border-dashed border-blue-500/50 animate-fade-in">
                                            <div className="text-8xl mb-4 opacity-50 animate-bounce">ðŸ“°</div>
                                            <h3 className="text-2xl font-bold text-white mb-3">No News Available</h3>
                                            <p className="text-blue-200 text-lg mb-6">Click refresh to load the latest market news</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {marketNews.map((article, idx) => (
                                                <a
                                                    key={idx}
                                                    href={article.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className={`block bg-blue-900/40 hover:bg-blue-900/60 backdrop-blur-sm rounded-xl p-5 transition-all border-2 border-blue-500/50 hover:border-cyan-400 shadow-xl hover:shadow-2xl hover:-translate-y-1 cursor-pointer hover-glow will-change-transform gpu-accelerated animate-fade-in stagger-${Math.min(idx + 1, 6)}`}
                                                >
                                                    <div className="flex gap-4">
                                                        {article.image && (
                                                            <img
                                                                src={article.image}
                                                                alt=""
                                                                className="w-32 h-32 rounded-lg object-cover flex-shrink-0 border-2 border-blue-600/30 hover:scale-105 transition-transform duration-300"
                                                                onError={(e) => e.target.style.display = 'none'}
                                                            />
                                                        )}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-3 flex-wrap">
                                                                <span className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                                                                    article.sentiment === 'positive' ? 'bg-green-500/20 text-green-300 border border-green-500 animate-pulse-glow-green' :
                                                                    article.sentiment === 'negative' ? 'bg-red-500/20 text-red-300 border border-red-500 animate-pulse-glow-red' :
                                                                    'bg-gray-500/20 text-gray-300 border border-gray-500'
                                                                }`}>
                                                                    {article.sentiment === 'positive' ? 'ðŸ“ˆ Bullish' :
                                                                     article.sentiment === 'negative' ? 'ðŸ“‰ Bearish' :
                                                                     'âž– Neutral'}
                                                                </span>
                                                                <span className="text-xs text-blue-400 font-semibold">
                                                                    {window.newsFeed.formatNewsDate(article.datetime)}
                                                                </span>
                                                                {article.category && (
                                                                    <span className="text-xs text-blue-300 bg-blue-700/50 px-2 py-1 rounded-full">
                                                                        {article.category}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <h4 className="text-white font-bold text-lg mb-2 line-clamp-2 hover:text-cyan-200 transition-colors">
                                                                {article.headline}
                                                            </h4>
                                                            <p className="text-sm text-blue-200 line-clamp-3 mb-3 leading-relaxed">
                                                                {article.summary}
                                                            </p>
                                                            <div className="flex items-center justify-between">
                                                                <div className="text-xs text-blue-400 font-semibold flex items-center gap-1">
                                                                    <span>ðŸ“¡</span>
                                                                    <span>{article.source}</span>
                                                                </div>
                                                                <div className="text-xs text-cyan-300 font-bold flex items-center gap-1">
                                                                    <span>Read full article</span>
                                                                    <span>â†’</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Market Overview */}
                                <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 shadow-2xl">
                                    <h3 className="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 mb-4 flex items-center gap-2">
                                        ðŸ“Š Market Overview
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                        {topStocks.slice(0, 6).map((stock, index) => (
                                            <div
                                                key={stock.symbol}
                                                onClick={() => {
                                                    addToWatchlist(stock.symbol);
                                                    setMainTab('trading');
                                                }}
                                                className={`bg-blue-900/40 rounded-lg p-4 border border-blue-400/30 hover:border-blue-400 transition-all cursor-pointer hover:-translate-y-1 shadow-lg hover:shadow-2xl hover-glow will-change-transform gpu-accelerated animate-fade-in stagger-${Math.min(index + 1, 6)}`}
                                            >
                                                <div className="font-bold text-white text-sm mb-1">{stock.symbol}</div>
                                                <div className="text-xl font-black text-white">${stock.price.toFixed(2)}</div>
                                                <div className={`text-xs font-bold mt-1 transition-all ${stock.change >= 0 ? 'text-green-300 animate-pulse-glow-green' : 'text-red-300 animate-pulse-glow-red'}`}>
                                                    {stock.change >= 0 ? 'â†—' : 'â†˜'} {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 text-center">
                                        <button
                                            onClick={() => setMainTab('trading')}
                                            className="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-xl hover:scale-105 active-press hover-glow"
                                        >
                                            ðŸš€ Go to Trading
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}

                        {/* AI Analysis View */}
                        {mainTab === 'ai-analysis' && (
                            <>
                                <div className="bg-gradient-to-br from-purple-900/60 via-indigo-900/60 to-blue-900/60 rounded-2xl p-8 border-2 border-purple-500/50 shadow-2xl mb-6">
                                    <div className="text-center mb-8">
                                        <div className="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full mb-6 shadow-2xl">
                                            <span className="text-5xl">ðŸ§ </span>
                                        </div>
                                        <h2 className="text-4xl font-black text-white mb-3 flex items-center justify-center gap-3">
                                            AI Stock Analysis
                                            <span className="text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full font-bold">ULTRATHINK</span>
                                        </h2>
                                        <p className="text-xl text-purple-200">Deep neural reasoning & market intelligence for any stock</p>
                                    </div>

                                    {/* Stock Search for AI Analysis */}
                                    <div className="max-w-2xl mx-auto mb-8">
                                        <label className="block text-blue-200 font-bold mb-3 text-sm uppercase tracking-wide">Select Stock to Analyze</label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                placeholder="Search for any stock (e.g., AAPL, TSLA, NVDA, GOOGL)..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full bg-blue-900/40 border-2 border-blue-500/50 rounded-xl px-6 py-4 text-white text-lg placeholder-blue-300 focus:border-cyan-400 focus:outline-none transition-all"
                                            />
                                            {searching && (
                                                <div className="absolute right-6 top-5">
                                                    <div className="text-cyan-300 animate-pulse text-xl">ðŸ”</div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Search Results for AI Analysis */}
                                        {searchQuery && showSearchResults && (
                                            <div className="mt-4 bg-blue-900/40 backdrop-blur-sm border-2 border-blue-500/50 rounded-xl overflow-hidden max-h-80 overflow-y-auto shadow-xl">
                                                {searching ? (
                                                    <div className="p-6 text-center">
                                                        <div className="text-blue-200">Searching...</div>
                                                    </div>
                                                ) : searchResults.length > 0 ? (
                                                    searchResults.map((result) => (
                                                        <div
                                                            key={result.symbol}
                                                            onClick={async () => {
                                                                setSearching(true);
                                                                setError(null);
                                                                const stockData = await fetchSingleStock(result.symbol, result.name);
                                                                const existingIndex = stocks.findIndex(s => s.symbol === result.symbol);
                                                                if (existingIndex >= 0) {
                                                                    const updatedStocks = [...stocks];
                                                                    updatedStocks[existingIndex] = stockData;
                                                                    setStocks(updatedStocks);
                                                                } else {
                                                                    setStocks([...stocks, stockData]);
                                                                }
                                                                setSelectedStock(result.symbol);
                                                                setSearchQuery('');
                                                                setShowSearchResults(false);
                                                                setSearching(false);
                                                                // Auto-load news for AI analysis
                                                                const news = await window.newsFeed.fetchStockNews(result.symbol, FINNHUB_API_KEY);
                                                                setStockNews(news);
                                                                // Clear previous AI analysis
                                                                setAiAnalysis(null);
                                                            }}
                                                            className="p-5 border-b border-blue-700 last:border-b-0 hover:bg-blue-800/50 cursor-pointer transition-all"
                                                        >
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1">
                                                                    <div className="font-bold text-white text-xl">{result.symbol}</div>
                                                                    <div className="text-sm text-blue-200">{result.name}</div>
                                                                    <div className="text-xs text-blue-400 mt-1">
                                                                        {result.region} â€¢ {result.currency}
                                                                    </div>
                                                                </div>
                                                                <div className="text-cyan-300 text-3xl">â†’</div>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : error ? (
                                                    <div className="p-6 text-center">
                                                        <div className="text-yellow-300 mb-2">âš ï¸</div>
                                                        <div className="text-yellow-200 text-sm">{error}</div>
                                                    </div>
                                                ) : (
                                                    <div className="p-6 text-center">
                                                        <div className="text-cyan-300 mb-2">ðŸ”</div>
                                                        <div className="text-blue-200">No results found for "{searchQuery}"</div>
                                                        <div className="text-xs text-blue-400 mt-2">Try: AAPL, GOOGL, MSFT, TSLA, NVDA</div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Selected Stock Display */}
                                    {selectedStock && (
                                        <div className="max-w-4xl mx-auto">
                                            <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500/50 mb-6 shadow-2xl">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div>
                                                        <h3 className="text-3xl font-black text-white">{selectedStock}</h3>
                                                        <p className="text-blue-200 text-lg">{stocks.find(s => s.symbol === selectedStock)?.name || selectedStock}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-4xl font-black text-white mb-1">
                                                            ${(stocks.find(s => s.symbol === selectedStock)?.price || 0).toFixed(2)}
                                                        </div>
                                                        <div className={`text-lg font-bold ${
                                                            (stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0
                                                                ? 'text-green-300'
                                                                : 'text-red-300'
                                                        }`}>
                                                            {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? 'â†— +' : 'â†˜ '}
                                                            {(stocks.find(s => s.symbol === selectedStock)?.change || 0).toFixed(2)}%
                                                        </div>
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={generateAIAnalysis}
                                                    disabled={loadingAnalysis}
                                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 disabled:from-gray-600 disabled:to-gray-700 text-white py-4 rounded-xl font-black text-xl transition-all shadow-2xl hover:shadow-purple-500/50 disabled:opacity-50 flex items-center justify-center gap-3 hover:scale-105 active-press hover-glow-amber will-change-transform gpu-accelerated"
                                                >
                                                    {loadingAnalysis ? (
                                                        <>
                                                            <span className="inline-block animate-spin text-2xl">âš¡</span>
                                                            <span>Analyzing with UltraThink...</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span className="text-2xl animate-pulse">ðŸ”®</span>
                                                            <span>Generate AI Analysis</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>

                                            {/* AI Analysis Results */}
                                            {loadingAnalysis && (
                                                <div className="bg-gradient-to-br from-purple-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-12 border-2 border-purple-500/50 shadow-2xl animate-pulse-glow-amber animate-scale-in">
                                                    <div className="text-center space-y-6">
                                                        <div className="inline-block animate-bounce">
                                                            <div className="w-24 h-24 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
                                                        </div>
                                                        <div className="space-y-3">
                                                            <p className="text-purple-200 font-bold text-xl animate-pulse">ðŸ§  Initializing neural networks...</p>
                                                            <p className="text-purple-300 animate-pulse">ðŸ“Š Analyzing technical indicators...</p>
                                                            <p className="text-purple-300 animate-pulse">ðŸ“° Processing news sentiment...</p>
                                                            <p className="text-purple-300 animate-pulse">âš¡ Calculating risk factors...</p>
                                                            <p className="text-purple-300 animate-pulse">ðŸŽ¯ Generating trade recommendations...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {!loadingAnalysis && aiAnalysis && (
                                                <div className="space-y-6 animate-fade-in">
                                                    {/* Timestamp */}
                                                    <div className="text-center text-sm text-purple-300">
                                                        Analysis generated: {aiAnalysis.timestamp}
                                                    </div>

                                                    {/* Main Recommendation */}
                                                    <div className={`bg-gradient-to-br ${
                                                        aiAnalysis.recommendation.color === 'green' ? 'from-green-900/40 to-emerald-900/40 border-green-500 hover-glow-green' :
                                                        aiAnalysis.recommendation.color === 'red' ? 'from-red-900/40 to-rose-900/40 border-red-500 hover-glow-red' :
                                                        'from-yellow-900/40 to-amber-900/40 border-yellow-500 hover-glow-amber'
                                                    } border-2 rounded-2xl p-8 shadow-2xl transition-all hover:-translate-y-1 will-change-transform gpu-accelerated animate-scale-in`}>
                                                        <div className="text-center mb-6">
                                                            <div className={`inline-block px-6 py-3 rounded-full font-black text-2xl mb-3 ${
                                                                aiAnalysis.recommendation.color === 'green' ? 'bg-green-500 text-white animate-pulse-glow-green' :
                                                                aiAnalysis.recommendation.color === 'red' ? 'bg-red-500 text-white animate-pulse-glow-red' :
                                                                'bg-yellow-500 text-gray-900 animate-pulse-glow-amber'
                                                            }`}>
                                                                {aiAnalysis.recommendation.action}
                                                            </div>
                                                            <div className="text-lg text-white mt-2">
                                                                Confidence: <span className="font-black text-2xl">{aiAnalysis.recommendation.confidence}%</span>
                                                            </div>
                                                        </div>

                                                        {/* Reasoning */}
                                                        <div className="space-y-4 mb-6">
                                                            {aiAnalysis.recommendation.reasoning.map((reason, idx) => (
                                                                <div key={idx} className="bg-black/20 rounded-xl p-4 text-white">
                                                                    {reason}
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Trade Targets */}
                                                        <div className="grid grid-cols-3 gap-4">
                                                            <div className="bg-blue-900/50 rounded-xl p-4 text-center border-2 border-blue-500/30">
                                                                <div className="text-sm text-blue-300 mb-2">Entry Price</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.entry}</div>
                                                            </div>
                                                            <div className="bg-red-900/50 rounded-xl p-4 text-center border-2 border-red-500/30">
                                                                <div className="text-sm text-red-300 mb-2">Stop Loss</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.stopLoss}</div>
                                                            </div>
                                                            <div className="bg-green-900/50 rounded-xl p-4 text-center border-2 border-green-500/30">
                                                                <div className="text-sm text-green-300 mb-2">Take Profit</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.takeProfit}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Detailed Analysis Cards */}
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                        {/* Technical Analysis */}
                                                        <div className="bg-gradient-to-br from-blue-900/40 to-cyan-900/40 border-2 border-blue-500/50 rounded-2xl p-6">
                                                            <h4 className="text-2xl font-black text-cyan-300 mb-6 flex items-center gap-2">
                                                                ðŸ“Š Technical Analysis
                                                            </h4>
                                                            <div className="space-y-4">
                                                                <div>
                                                                    <div className="text-sm text-blue-300 mb-1">Signal</div>
                                                                    <div className={`text-2xl font-bold ${
                                                                        aiAnalysis.technical.signal.includes('Bullish') ? 'text-green-300' :
                                                                        aiAnalysis.technical.signal.includes('Bearish') ? 'text-red-300' :
                                                                        'text-yellow-300'
                                                                    }`}>{aiAnalysis.technical.signal}</div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-sm text-blue-300 mb-1">Price Change</div>
                                                                    <div className={`text-2xl font-bold ${parseFloat(aiAnalysis.technical.priceChange) >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                        {parseFloat(aiAnalysis.technical.priceChange) >= 0 ? '+' : ''}{aiAnalysis.technical.priceChange}%
                                                                    </div>
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-4 pt-4 border-t border-blue-600/50">
                                                                    <div>
                                                                        <div className="text-xs text-blue-300 mb-1">Support</div>
                                                                        <div className="text-white font-bold text-lg">${aiAnalysis.technical.support}</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-blue-300 mb-1">Resistance</div>
                                                                        <div className="text-white font-bold text-lg">${aiAnalysis.technical.resistance}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Sentiment Analysis */}
                                                        <div className="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 border-2 border-indigo-500/50 rounded-2xl p-6">
                                                            <h4 className="text-2xl font-black text-indigo-300 mb-6 flex items-center gap-2">
                                                                ðŸ“° News Sentiment
                                                            </h4>
                                                            <div className="space-y-4">
                                                                <div>
                                                                    <div className="text-sm text-indigo-300 mb-1">Signal</div>
                                                                    <div className={`text-2xl font-bold ${
                                                                        aiAnalysis.sentiment.signal === 'Positive' ? 'text-green-300' :
                                                                        aiAnalysis.sentiment.signal === 'Negative' ? 'text-red-300' :
                                                                        'text-yellow-300'
                                                                    }`}>{aiAnalysis.sentiment.signal}</div>
                                                                </div>
                                                                <div>
                                                                    <div className="text-sm text-indigo-300 mb-1">Sentiment Score</div>
                                                                    <div className={`text-2xl font-bold ${
                                                                        parseFloat(aiAnalysis.sentiment.score) > 30 ? 'text-green-300' :
                                                                        parseFloat(aiAnalysis.sentiment.score) < -30 ? 'text-red-300' :
                                                                        'text-yellow-300'
                                                                    }`}>{aiAnalysis.sentiment.score}/100</div>
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-4 pt-4 border-t border-indigo-600/50">
                                                                    <div>
                                                                        <div className="text-xs text-indigo-300 mb-1">Articles</div>
                                                                        <div className="text-white font-bold text-lg">{aiAnalysis.sentiment.articlesAnalyzed}</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-indigo-300 mb-1">Interest</div>
                                                                        <div className="text-white font-bold text-lg">{aiAnalysis.sentiment.trending}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Risk Assessment */}
                                                    <div className="bg-gradient-to-br from-purple-900/40 to-pink-900/40 border-2 border-purple-500/50 rounded-2xl p-6">
                                                        <h4 className="text-2xl font-black text-purple-300 mb-6 flex items-center gap-2">
                                                            âš ï¸ Risk Assessment
                                                        </h4>
                                                        <div className="mb-6">
                                                            <div className="flex items-center justify-between mb-3">
                                                                <span className="text-lg text-purple-200">Risk Level: <span className={`font-black text-xl ${
                                                                    aiAnalysis.risk.level === 'High' ? 'text-red-300' :
                                                                    aiAnalysis.risk.level === 'Moderate' ? 'text-yellow-300' :
                                                                    'text-green-300'
                                                                }`}>{aiAnalysis.risk.level}</span></span>
                                                                <span className="text-lg text-purple-200">Rating: <span className="font-black text-xl text-white">{aiAnalysis.risk.rating}/10</span></span>
                                                            </div>
                                                            <div className="w-full bg-purple-950/50 rounded-full h-4 overflow-hidden border-2 border-purple-600/30">
                                                                <div
                                                                    className={`h-full rounded-full transition-all ${
                                                                        aiAnalysis.risk.rating >= 7 ? 'bg-gradient-to-r from-red-500 to-red-600' :
                                                                        aiAnalysis.risk.rating >= 4 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                                                                        'bg-gradient-to-r from-green-500 to-green-600'
                                                                    }`}
                                                                    style={{ width: `${aiAnalysis.risk.rating * 10}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-3">
                                                            {aiAnalysis.risk.factors.map((factor, idx) => (
                                                                <div key={idx} className="text-purple-100 bg-purple-950/30 rounded-lg p-3">
                                                                    {factor}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {!loadingAnalysis && !aiAnalysis && (
                                                <div className="bg-gradient-to-br from-purple-900/40 to-indigo-900/40 rounded-2xl p-16 border-2 border-purple-500/50 text-center">
                                                    <div className="text-8xl mb-6">ðŸ”®</div>
                                                    <h3 className="text-3xl font-bold text-white mb-4">Ready to Analyze {selectedStock}</h3>
                                                    <p className="text-xl text-purple-200 mb-8">Click the button above to generate comprehensive AI-powered insights</p>
                                                    <div className="flex items-center justify-center gap-3 text-purple-300">
                                                        <span className="text-lg">Powered by</span>
                                                        <span className="text-2xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">UltraThink AI</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {!selectedStock && (
                                        <div className="max-w-2xl mx-auto text-center py-16">
                                            <div className="text-9xl mb-6 opacity-70">ðŸ”</div>
                                            <h3 className="text-3xl font-bold text-white mb-4">Search for Any Stock</h3>
                                            <p className="text-xl text-purple-200">Use the search bar above to find and analyze any stock with AI-powered insights</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingSimulator />);
    </script>
</body>
</html>
