import React, { useState, useEffect, useRef } from 'react';
import { Chart, registerables } from 'chart.js';

// Register Chart.js components
Chart.register(...registerables);

// Backend API Configuration
// Automatically detects environment:
// - localhost: http://localhost:3001 (local development)
// - production: https://trader-umh8.onrender.com (deployed backend)
const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:3001'
    : 'https://trader-umh8.onrender.com';

const TradingSimulator = () => {
            const [view, setView] = useState('plan-select');
            const [plan, setPlan] = useState(null);
            const [showAccountTypeModal, setShowAccountTypeModal] = useState(false);
            const [userName, setUserName] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [userPasscode, setUserPasscode] = useState('');
            const [generatedPasscode, setGeneratedPasscode] = useState('');
            const [userPassword, setUserPassword] = useState('');
            const [passwordStrength, setPasswordStrength] = useState(null);
            const [currentUserId, setCurrentUserId] = useState(null);
            const [contribution, setContribution] = useState('');
            const [resetEmail, setResetEmail] = useState('');
            const [resetCode, setResetCode] = useState('');
            const [newPasscode, setNewPasscode] = useState('');
            const [resetStep, setResetStep] = useState(1); // 1: enter email, 2: enter code + new passcode
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [accountMode, setAccountMode] = useState('create'); // 'create' or 'login'
            const [authError, setAuthError] = useState(''); // Error message for auth forms

            const [competitionCode, setCompetitionCode] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [competition, setCompetition] = useState(null);

            // Initialize with data-driven top stocks for analysis
            // Based on: Growth potential, market cap, industry leaders, institutional interest
            const [watchlist, setWatchlist] = useState([
                'NVDA',  // NVIDIA - AI/GPU leader, strong growth
                'MSFT',  // Microsoft - Cloud/AI, stable growth
                'GOOGL', // Alphabet - Search/AI dominance
                'AAPL',  // Apple - Strong ecosystem, buybacks
                'META',  // Meta - AI investments, ad revenue growth
                'AMZN',  // Amazon - Cloud & e-commerce leader
                'TSLA',  // Tesla - EV leader, energy growth
                'AMD',   // AMD - Semiconductor growth, AI chips
                'TSM',   // TSMC - Chip manufacturing leader
                'AVGO',  // Broadcom - AI infrastructure
                'PLTR',  // Palantir - AI/Data analytics growth
                'NOW',   // ServiceNow - Enterprise AI
                'CRM',   // Salesforce - Enterprise software
                'COIN',  // Coinbase - Crypto exposure
                'SQ',    // Block - Fintech innovation
                'SHOP',  // Shopify - E-commerce platform
                'NET',   // Cloudflare - Network infrastructure
                'DDOG',  // Datadog - Cloud monitoring
                'SNOW',  // Snowflake - Data warehousing
                'CRWD'   // CrowdStrike - Cybersecurity leader
            ]);

            // Curated universe for "Top Stocks to Buy" recommendations
            // Limited to top 20 stocks to avoid API rate limits
            const curatedUniverse = [
                // Top Tech & AI Leaders
                'NVDA', 'MSFT', 'GOOGL', 'AAPL', 'META', 'AMZN',
                'AMD', 'TSM', 'PLTR',

                // Financial Leaders
                'JPM', 'V', 'MA',

                // Healthcare Leaders
                'UNH', 'LLY',

                // Consumer & Retail
                'TSLA', 'COST',

                // Fintech & Crypto
                'COIN',

                // Cybersecurity
                'CRWD',

                // ETFs
                'SPY', 'QQQ'
            ];

            const [stocks, setStocks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [loginCountdown, setLoginCountdown] = useState(null);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);

            // Stop-loss order tracking
            const [stopLossOrders, setStopLossOrders] = useState({});
            // Format: { symbol: { triggerPrice: 145.50, shares: 10, type: 'stop-loss' } }

            // Curated stocks for "Top Stocks to Buy" recommendations
            const [curatedStocks, setCuratedStocks] = useState([]);
            const [curatedStocksCache, setCuratedStocksCache] = useState(null);
            const [curatedStocksLastFetch, setCuratedStocksLastFetch] = useState(null);
            const CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [showSearchResults, setShowSearchResults] = useState(false);

            const [selectedStock, setSelectedStock] = useState(null);
            const [quantity, setQuantity] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('market');
            const [quantityError, setQuantityError] = useState('');
            const [mainTab, setMainTab] = useState('portfolio');
            const [portfolioSubTab, setPortfolioSubTab] = useState('overview'); // 'overview', 'holdings', 'performance', 'insights'
            const [expandedHolding, setExpandedHolding] = useState(null); // Track which holding is expanded
            const [holdingsSortBy, setHoldingsSortBy] = useState('value'); // 'value', 'gainPercent', 'symbol'
            const [showOnlyProfitable, setShowOnlyProfitable] = useState(false);
            const [learningTopic, setLearningTopic] = useState(null); // null = overview, or topic name
            const [learningLesson, setLearningLesson] = useState(null); // specific lesson within topic
            const [quizAnswers, setQuizAnswers] = useState({}); // Track quiz answers {topicName: {q1: answerIndex, q2: answerIndex}}
            const [quizSubmitted, setQuizSubmitted] = useState({}); // Track if quiz submitted {topicName: true/false}
            const [liveExampleStock, setLiveExampleStock] = useState(null); // Live stock example data
            const [loadingLiveExample, setLoadingLiveExample] = useState(false); // Loading state for live example
            const [showCertificate, setShowCertificate] = useState(false); // Certificate modal visibility
            const [practiceScenario, setPracticeScenario] = useState(null); // Practice trading scenario
            const [practiceChoice, setPracticeChoice] = useState(null); // User's choice in practice scenario
            const [scenarioDifficulty, setScenarioDifficulty] = useState(null); // Selected difficulty level for practice scenarios
            const [scenariosCompleted, setScenariosCompleted] = useState(() => {
                // Track completed scenarios by difficulty
                const saved = localStorage.getItem('scenariosCompleted');
                return saved ? JSON.parse(saved) : { Easy: 0, Medium: 0, Hard: 0 };
            });
            const [glossarySearch, setGlossarySearch] = useState(''); // Glossary search term
            const [showGlossary, setShowGlossary] = useState(false); // Show glossary modal
            const [learningProgress, setLearningProgress] = useState(() => {
                // Load from localStorage or initialize
                const saved = localStorage.getItem('learningProgress');
                return saved ? JSON.parse(saved) : {
                    completedLessons: [], // ['basics', 'strategies', etc.]
                    quizScores: {}, // {basics: 80, strategies: 100}
                    totalXP: 0,
                    achievements: [],
                    lastVisit: null,
                    streak: 0
                };
            });
            const [chartPeriod, setChartPeriod] = useState('1M');
            const [isRealChartData, setIsRealChartData] = useState(false);
            const [chartLoading, setChartLoading] = useState(false);
            const [intradayInterval, setIntradayInterval] = useState(5); // 1 or 5 minute bars
            const polygonCache = useRef({});
            const lastPolygonCall = useRef(0);
            const POLYGON_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
            const POLYGON_RATE_LIMIT_MS = 12000; // 12 seconds between calls (5 calls/min)
            const [stockNews, setStockNews] = useState([]);
            const [loadingNews, setLoadingNews] = useState(false);
            const [tradeType, setTradeType] = useState('long'); // 'long' or 'short'
            const [marketNews, setMarketNews] = useState([]);
            const [loadingMarketNews, setLoadingMarketNews] = useState(false);
            const [lastNewsUpdate, setLastNewsUpdate] = useState(null);
            const [lastStockNewsUpdate, setLastStockNewsUpdate] = useState(null);
            const [selectedNewsArticle, setSelectedNewsArticle] = useState(null);
            const [showNewsModal, setShowNewsModal] = useState(false);
            const [scrapedArticle, setScrapedArticle] = useState(null);
            const [scrapingArticle, setScrapingArticle] = useState(false);
            const [scrapingError, setScrapingError] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [loadingAnalysis, setLoadingAnalysis] = useState(false);
            const [analysisExpanded, setAnalysisExpanded] = useState(true);
            const [expandedSections, setExpandedSections] = useState({
                technical: false,
                fundamental: false,
                sentiment: false,
                advanced: false,
                exit: false,
                checklist: false,
                catalysts: false,
                risk: false
            }); // Track which AI analysis sections are expanded

            // UltraThink v2.5 - Predictive AI
            const [stockPredictions, setStockPredictions] = useState({}); // { symbol: prediction }

            // Trade analysis system
            const [showTradeAnalysis, setShowTradeAnalysis] = useState(false);
            const [tradeAnalysisData, setTradeAnalysisData] = useState(null);
            const [showDailySummary, setShowDailySummary] = useState(false);
            const [dailySummaryData, setDailySummaryData] = useState(null);

            // Chat room state
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [socket, setSocket] = useState(null);
            const chatContainerRef = useRef(null);

            // Market movers state
            const [topGainers, setTopGainers] = useState([]);
            const [topLosers, setTopLosers] = useState([]);
            const [loadingMovers, setLoadingMovers] = useState(false);
            const [moversProgress, setMoversProgress] = useState({ current: 0, total: 0 });

            // Toast notification system
            const [toasts, setToasts] = useState([]);

            const [saveStatus, setSaveStatus] = useState('saved'); // 'saving', 'saved', 'error', 'offline'
            const [lastSaved, setLastSaved] = useState(null);

            const [showAccountMenu, setShowAccountMenu] = useState(false);

            // Market hours state
            const [marketOpen, setMarketOpen] = useState(false);
            const [timeUntilChange, setTimeUntilChange] = useState('');
            const [nextMarketOpenTime, setNextMarketOpenTime] = useState('');
            const [currentHoliday, setCurrentHoliday] = useState(null);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const performanceChartRef = useRef(null);
            const performanceChartInstance = useRef(null);

            // Constants are now loaded from config.js:
            // COMMISSION_RATE, COOLDOWN_MINUTES, COOLDOWN_MS
            // STRIPE_FAMILY_PUBLIC_LINK, STRIPE_FAMILY_PRIVATE_LINK
            // POPULAR_STOCKS, TOP_12_STOCKS
            // FINNHUB_API_KEY, FINNHUB_API_BASE, STOCK_DATABASE, FALLBACK_STOCK_DATA

            // Polygon.io API (free tier: 5 calls/min, 15-min delayed data)
            // Get your free key at: https://polygon.io/pricing
            const POLYGON_API_KEY = 'Wz3IRbNswkjBXg0hg_CxCSTYmWTTy57W';
            const POLYGON_API_BASE = 'https://api.polygon.io';

            useEffect(() => {
                if (competition?.members) {
                    const currentMember = competition.members.find(m => m.id === currentUserId);
                    if (currentMember?.portfolio?.watchlist) {
                        setWatchlist(currentMember.portfolio.watchlist);
                    } else {
                        setWatchlist([]);
                    }
                }
            }, [competition, currentUserId]);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (showAccountMenu && !e.target.closest('.relative')) {
                        setShowAccountMenu(false);
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [showAccountMenu]);

            // Socket.io disabled - causing CORS errors
            // useEffect(() => {
            //     const newSocket = io(API_BASE_URL);
            //     setSocket(newSocket);

            //     // Listen for chat history
            //     newSocket.on('chat_history', (messages) => {
            //         setChatMessages(messages);
            //     });

            //     // Listen for new messages
            //     newSocket.on('chat_message', (message) => {
            //         setChatMessages(prev => [...prev, message]);
            //         // Auto-scroll to bottom
            //         setTimeout(() => {
            //             if (chatContainerRef.current) {
            //                 chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
            //             }
            //         }, 100);
            //     });

            //     return () => {
            //         newSocket.close();
            //     };
            // }, []);

            // Auto-fetch stock data for portfolio positions
            useEffect(() => {
                const fetchPositionStocks = async () => {
                    const portfolio = getCurrentPortfolio();
                    if (!portfolio?.positions) return;

                    const positionSymbols = Object.keys(portfolio.positions).filter(symbol => {
                        const qty = portfolio.positions[symbol];
                        return qty && qty > 0;
                    });

                    if (positionSymbols.length === 0) return;

                    for (const symbol of positionSymbols) {
                        const existingStock = stocks.find(s => s.symbol === symbol);
                        if (!existingStock) {
                            try {
                                const response = await fetch(
                                    `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                                );
                                const data = await response.json();

                                if (data.c) {
                                    setStocks(prev => [...prev, {
                                        symbol,
                                        price: data.c,
                                        change: data.dp || 0,
                                        high: data.h,
                                        low: data.l,
                                        open: data.o,
                                        previousClose: data.pc
                                    }]);
                                }
                            } catch (error) {
                            }
                        }
                    }
                };

                fetchPositionStocks();
            }, [competition, currentUserId]);

            // Levenshtein distance for fuzzy matching
            const levenshteinDistance = (str1, str2) => {
                const matrix = [];

                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }

                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // substitution
                                matrix[i][j - 1] + 1,     // insertion
                                matrix[i - 1][j] + 1      // deletion
                            );
                        }
                    }
                }

                return matrix[str2.length][str1.length];
            };

            const calculateSimilarity = (query, target) => {
                const distance = levenshteinDistance(query.toLowerCase(), target.toLowerCase());
                const maxLength = Math.max(query.length, target.length);
                const similarity = ((maxLength - distance) / maxLength) * 100;
                return similarity;
            };

            const searchStocks = async (query) => {
                if (!query || query.length < 1) {
                    setSearchResults([]);
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                setSearching(true);
                setShowSearchResults(true);
                setError(null);

                try {
                    const searchTerm = query.toLowerCase();
                    const currentPortfolio = getCurrentPortfolio();
                    const ownedSymbols = currentPortfolio?.positions ? Object.keys(currentPortfolio.positions) : [];

                    // First, try exact/partial matches from database
                    let results = STOCK_DATABASE
                        .filter(stock =>
                            stock.symbol.toLowerCase().includes(searchTerm) ||
                            stock.name.toLowerCase().includes(searchTerm)
                        )
                        .slice(0, 10)
                        .map(stock => ({
                            symbol: stock.symbol,
                            name: stock.name,
                            type: 'EQUITY',
                            region: 'US',
                            currency: 'USD',
                            similarity: 100, // Exact/partial matches get full score
                            owned: ownedSymbols.includes(stock.symbol) // Mark if owned
                        }));

                    // Also search through owned stocks (in case they're not in database results)
                    const ownedMatches = ownedSymbols
                        .filter(symbol =>
                            symbol.toLowerCase().includes(searchTerm)
                        )
                        .filter(symbol =>
                            !results.some(r => r.symbol === symbol) // Don't duplicate
                        )
                        .map(symbol => ({
                            symbol: symbol,
                            name: `${symbol} (Owned)`,
                            type: 'EQUITY',
                            region: 'US',
                            currency: 'USD',
                            similarity: 100,
                            owned: true
                        }));

                    // Prioritize owned stocks by adding them to the beginning
                    results = [...ownedMatches, ...results].slice(0, 10);

                    // If no exact matches, use fuzzy matching
                    if (results.length === 0) {

                        const fuzzyResults = STOCK_DATABASE
                            .map(stock => {
                                const symbolSimilarity = calculateSimilarity(searchTerm, stock.symbol);
                                const nameSimilarity = calculateSimilarity(searchTerm, stock.name);

                                // Use the higher similarity score
                                const bestSimilarity = Math.max(symbolSimilarity, nameSimilarity);

                                return {
                                    symbol: stock.symbol,
                                    name: stock.name,
                                    type: 'EQUITY',
                                    region: 'US',
                                    currency: 'USD',
                                    similarity: bestSimilarity,
                                    owned: ownedSymbols.includes(stock.symbol)
                                };
                            })
                            .filter(item => item.similarity >= 50) // Only show if >50% similar
                            .sort((a, b) => b.similarity - a.similarity) // Sort by similarity
                            .slice(0, 10);

                        // Also fuzzy search owned stocks
                        const fuzzyOwnedResults = ownedSymbols
                            .map(symbol => {
                                const similarity = calculateSimilarity(searchTerm, symbol);
                                return {
                                    symbol: symbol,
                                    name: `${symbol} (Owned)`,
                                    type: 'EQUITY',
                                    region: 'US',
                                    currency: 'USD',
                                    similarity: similarity,
                                    owned: true
                                };
                            })
                            .filter(item => item.similarity >= 50)
                            .filter(item => !fuzzyResults.some(r => r.symbol === item.symbol));

                        results = [...fuzzyOwnedResults, ...fuzzyResults]
                            .sort((a, b) => {
                                // Prioritize owned stocks
                                if (a.owned && !b.owned) return -1;
                                if (!a.owned && b.owned) return 1;
                                // Then sort by similarity
                                return b.similarity - a.similarity;
                            })
                            .slice(0, 10);

                        if (results.length > 0) {
                        }
                    }


                    if (results.length > 0) {
                        setSearchResults(results);
                    } else {
                        // If no match in database, validate with API before showing
                        const upperQuery = query.toUpperCase();

                        // Only show if it looks like a valid ticker (2-5 letters)
                        if (/^[A-Z]{1,5}$/.test(upperQuery)) {
                            // Try to validate with Finnhub API
                            try {
                                const response = await fetch(
                                    `${FINNHUB_API_BASE}/quote?symbol=${upperQuery}&token=${FINNHUB_API_KEY}`
                                );
                                const data = await response.json();

                                // Only show if we get valid price data back
                                if (data.c && data.c > 0) {
                                    setSearchResults([{
                                        symbol: upperQuery,
                                        name: `${upperQuery}`,
                                        type: 'EQUITY',
                                        region: 'US',
                                        currency: 'USD',
                                        similarity: 100
                                    }]);
                                } else {
                                    // Not a valid stock
                                    setSearchResults([]);
                                }
                            } catch (error) {
                                setSearchResults([]);
                            }
                        } else {
                            // Invalid format - don't show anything
                            setSearchResults([]);
                        }
                    }
                } catch (error) {
                    setSearchResults([]);
                }
                setSearching(false);
            };

            useEffect(() => {
                const timer = setTimeout(() => {
                    if (searchQuery) {
                        searchStocks(searchQuery);
                    } else {
                        setSearchResults([]);
                        setShowSearchResults(false);
                        setError(null);
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, [searchQuery]);

            // Auto-redirect from code-display to trading view
            useEffect(() => {
                if (view === 'code-display') {
                    const timer = setTimeout(() => {
                        setView('trading');
                    }, 2500); // Show welcome message for 2.5 seconds
                    return () => clearTimeout(timer);
                }
            }, [view]);

            // Fetch curated stocks when trading tab is active
            useEffect(() => {
                if (mainTab === 'trading' && curatedStocks.length === 0) {
                    fetchCuratedStocks();
                }
            }, [mainTab]);

            // Render chart pattern visualizations
            useEffect(() => {
                if (learningTopic === 'patterns' && typeof Chart !== 'undefined') {
                    setTimeout(() => {
                        // Bull Flag
                        const bf = document.getElementById('chart-bull-flag');
                        if (bf) {
                            bf.chart?.destroy();
                            bf.chart = new Chart(bf.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:14},(_,i)=>i+1),
                                    datasets: [{
                                        data: [100,105,110,115,122,121,119,117,118,120,122,125,130,135],
                                        borderColor: 'rgb(74,222,128)',
                                        backgroundColor: 'rgba(74,222,128,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: (ctx) => [7,10,13].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===10?'rgb(34,197,94)':ctx.dataIndex===13?'rgb(59,130,246)':ctx.dataIndex===7?'rgb(239,68,68)':'rgba(74,222,128,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:95,max:140,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }

                        // Head & Shoulders
                        const hs = document.getElementById('chart-head-shoulders');
                        if (hs) {
                            hs.chart?.destroy();
                            hs.chart = new Chart(hs.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:12},(_,i)=>i+1),
                                    datasets: [{
                                        data: [140,148,143,152,158,152,148,150,145,142,135,130],
                                        borderColor: 'rgb(248,113,113)',
                                        backgroundColor: 'rgba(248,113,113,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: (ctx) => [7,8,11].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===8?'rgb(239,68,68)':ctx.dataIndex===11?'rgb(59,130,246)':ctx.dataIndex===7?'rgb(249,115,22)':'rgba(248,113,113,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:125,max:165,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }

                        // Double Bottom
                        const db = document.getElementById('chart-double-bottom');
                        if (db) {
                            db.chart?.destroy();
                            db.chart = new Chart(db.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:11},(_,i)=>i+1),
                                    datasets: [{
                                        data: [105,102,98,103,108,105,100,98,104,108,118],
                                        borderColor: 'rgb(74,222,128)',
                                        backgroundColor: 'rgba(74,222,128,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: (ctx) => [2,7,9,10].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===9?'rgb(34,197,94)':ctx.dataIndex===10?'rgb(59,130,246)':[2,7].includes(ctx.dataIndex)?'rgb(239,68,68)':'rgba(74,222,128,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:90,max:125,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }

                        // Ascending Triangle
                        const at = document.getElementById('chart-ascending-triangle');
                        if (at) {
                            at.chart?.destroy();
                            at.chart = new Chart(at.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:10},(_,i)=>i+1),
                                    datasets: [{
                                        data: [78,82,88,83,88,85,88,87,88,98],
                                        borderColor: 'rgb(74,222,128)',
                                        backgroundColor: 'rgba(74,222,128,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.2,
                                        pointRadius: (ctx) => [0,8,9].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===8?'rgb(34,197,94)':ctx.dataIndex===9?'rgb(59,130,246)':ctx.dataIndex===0?'rgb(239,68,68)':'rgba(74,222,128,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:75,max:105,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }

                        // Cup and Handle
                        const ch = document.getElementById('chart-cup-handle');
                        if (ch) {
                            ch.chart?.destroy();
                            ch.chart = new Chart(ch.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:15},(_,i)=>i+1),
                                    datasets: [{
                                        data: [195,190,180,170,165,170,180,190,195,192,188,190,195,205,220],
                                        borderColor: 'rgb(74,222,128)',
                                        backgroundColor: 'rgba(74,222,128,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: (ctx) => [10,12,14].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===12?'rgb(34,197,94)':ctx.dataIndex===14?'rgb(59,130,246)':ctx.dataIndex===10?'rgb(239,68,68)':'rgba(74,222,128,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:160,max:230,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }

                        // Bear Flag
                        const bearf = document.getElementById('chart-bear-flag');
                        if (bearf) {
                            bearf.chart?.destroy();
                            bearf.chart = new Chart(bearf.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: Array.from({length:12},(_,i)=>i+1),
                                    datasets: [{
                                        data: [92,88,82,76,78,80,82,80,78,76,70,62],
                                        borderColor: 'rgb(248,113,113)',
                                        backgroundColor: 'rgba(248,113,113,0.1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.3,
                                        pointRadius: (ctx) => [6,9,11].includes(ctx.dataIndex) ? 8 : 3,
                                        pointBackgroundColor: (ctx) => ctx.dataIndex===9?'rgb(239,68,68)':ctx.dataIndex===11?'rgb(59,130,246)':ctx.dataIndex===6?'rgb(249,115,22)':'rgba(248,113,113,0.5)',
                                        pointBorderWidth: 2,
                                        pointBorderColor: '#fff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {legend: {display: false}},
                                    scales: {
                                        y: {min:55,max:100,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#9ca3af',callback:v=>'$'+v},beginAtZero:false},
                                        x: {grid:{display:false},ticks:{color:'#9ca3af'}}
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            }, [learningTopic]);

            // Toast notification system
            const showToast = (message, type = 'info', duration = 5000) => {
                const id = Date.now() + Math.random();
                const newToast = { id, message, type, duration };
                setToasts(prev => [...prev, newToast]);

                // Auto-dismiss after duration
                if (duration > 0) {
                    setTimeout(() => {
                        dismissToast(id);
                    }, duration);
                }
            };

            const dismissToast = (id) => {
                setToasts(prev => prev.map(toast =>
                    toast.id === id ? { ...toast, closing: true } : toast
                ));

                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 300);
            };

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    // Focus search with /
                    if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                        e.preventDefault();
                        document.querySelector('input[type="text"]')?.focus();
                    }

                    // Close modals with Escape
                    if (e.key === 'Escape') {
                        setShowSearchResults(false);
                        setQuantityError('');
                    }

                    // Quick buy with Ctrl/Cmd + B
                    if ((e.ctrlKey || e.metaKey) && e.key === 'b' && selectedStock) {
                        e.preventDefault();
                        // Trigger buy if on trading screen
                        if (view === 'trading') {
                            setTradeType('long');
                        }
                    }

                    // Quick sell with Ctrl/Cmd + S
                    if ((e.ctrlKey || e.metaKey) && e.key === 's' && selectedStock) {
                        e.preventDefault();
                        // Trigger sell if on trading screen
                        if (view === 'trading') {
                            setTradeType('short');
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [view, selectedStock]);

            const fetchStockData = async () => {
                if (watchlist.length === 0) return;

                try {
                    setLoading(true);
                    setError(null);

                    const promises = watchlist.map(async (symbol) => {
                        try {
                            const quoteResponse = await fetch(
                                `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                            );
                            const quoteData = await quoteResponse.json();


                            const currentPrice = quoteData.c; // Current price
                            const previousClose = quoteData.pc; // Previous close
                            const priceChange = quoteData.d; // Change
                            const changePercent = quoteData.dp; // Change percent
                            const high = quoteData.h; // High
                            const low = quoteData.l; // Low
                            const open = quoteData.o; // Open

                            return {
                                symbol: symbol,
                                name: getStockName(symbol),
                                price: parseFloat((currentPrice || 0).toFixed(2)),
                                change: parseFloat((changePercent || 0).toFixed(2)),
                                volume: 'N/A',
                                previousClose: previousClose || 0,
                                high: high || currentPrice,
                                low: low || currentPrice,
                                open: open || currentPrice
                            };
                        } catch (error) {
                            return getFallbackStockData(symbol);
                        }
                    });

                    const stocksData = await Promise.all(promises);

                    if (stocksData.length > 0) {
                        setStocks(stocksData);
                        setLastUpdate(new Date());
                    }

                    setLoading(false);
                } catch (error) {
                    setError('Failed to load stock data. Using fallback prices.');

                    const fallbackData = watchlist.map(symbol => getFallbackStockData(symbol));
                    setStocks(fallbackData);
                    setLastUpdate(new Date());
                    setLoading(false);
                }
            };

            const getStockName = (symbol) => {
                const names = {
                    'AAPL': 'Apple Inc.',
                    'GOOGL': 'Alphabet Inc.',
                    'MSFT': 'Microsoft Corp.',
                    'AMZN': 'Amazon.com Inc.',
                    'TSLA': 'Tesla Inc.',
                    'NVDA': 'NVIDIA Corp.',
                    'META': 'Meta Platforms',
                    'NFLX': 'Netflix Inc.',
                    'AMD': 'Advanced Micro Devices',
                    'DIS': 'Walt Disney Co.',
                    'TSM': 'Taiwan Semiconductor',
                    'AVGO': 'Broadcom Inc.',
                    'PLTR': 'Palantir Technologies',
                    'NOW': 'ServiceNow Inc.',
                    'CRM': 'Salesforce Inc.',
                    'COIN': 'Coinbase Global',
                    'SQ': 'Block Inc.',
                    'SHOP': 'Shopify Inc.',
                    'NET': 'Cloudflare Inc.',
                    'DDOG': 'Datadog Inc.',
                    'SNOW': 'Snowflake Inc.',
                    'CRWD': 'CrowdStrike Holdings'
                };
                return names[symbol] || symbol;
            };

            const formatVolume = (volume) => {
                if (!volume) return 'N/A';
                if (volume >= 1000000000) return `${(volume / 1000000000).toFixed(1)}B`;
                if (volume >= 1000000) return `${(volume / 1000000).toFixed(1)}M`;
                if (volume >= 1000) return `${(volume / 1000).toFixed(1)}K`;
                return volume.toString();
            };

            const getFallbackStockData = (symbol) => {
                // Use FALLBACK_STOCK_DATA from config.js
                return {
                    symbol,
                    name: getStockName(symbol),
                    price: FALLBACK_STOCK_DATA[symbol]?.price || Math.random() * 200 + 50,
                    change: FALLBACK_STOCK_DATA[symbol]?.change || (Math.random() - 0.5) * 10,
                    volume: '10.5M'
                };
            };

            const fetchSingleStock = async (symbol, stockName = null) => {
                try {
                    const response = await fetch(
                        `${FINNHUB_API_BASE}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
                    );
                    const data = await response.json();


                    if (data.c) {
                        const currentPrice = data.c; // Current price
                        const previousClose = data.pc; // Previous close
                        const changePercent = data.dp; // Change percent
                        const high = data.h; // High
                        const low = data.l; // Low
                        const open = data.o; // Open

                        // Calculate realistic bid-ask spread based on volatility
                        const volatility = Math.abs(changePercent || 0);
                        // Base spread: 0.01% for stable stocks, up to 0.15% for volatile stocks
                        const baseSpread = 0.0001; // 0.01%
                        const volatilitySpread = volatility * 0.0005; // Scale with volatility
                        const spreadPercent = Math.min(0.0015, baseSpread + volatilitySpread); // Cap at 0.15%

                        const halfSpread = currentPrice * spreadPercent / 2;
                        const bid = parseFloat((currentPrice - halfSpread).toFixed(2));
                        const ask = parseFloat((currentPrice + halfSpread).toFixed(2));
                        const spread = parseFloat((ask - bid).toFixed(2));
                        const spreadPct = parseFloat(((spread / currentPrice) * 100).toFixed(3));

                        return {
                            symbol: symbol,
                            name: stockName || getStockName(symbol),
                            price: parseFloat((currentPrice || 0).toFixed(2)),
                            bid: bid,  // SELL at bid (what buyers will pay you)
                            ask: ask,  // BUY at ask (what sellers want from you)
                            spread: spread,  // Spread in dollars
                            spreadPct: spreadPct,  // Spread as percentage
                            change: parseFloat((changePercent || 0).toFixed(2)),
                            volume: 'N/A',
                            previousClose: previousClose || 0,
                            high: high || currentPrice,
                            low: low || currentPrice,
                            open: open || currentPrice
                        };
                    } else {
                        // Fallback if API fails
                        const fallbackData = getFallbackStockData(symbol);
                        if (stockName) fallbackData.name = stockName;
                        return fallbackData;
                    }
                } catch (error) {
                    const fallbackData = getFallbackStockData(symbol);
                    if (stockName) fallbackData.name = stockName;
                    return fallbackData;
                }
            };

            // Fetch curated universe stocks for "Top Stocks to Buy" recommendations
            const fetchCuratedStocks = async () => {
                // Check cache first (1-hour expiration)
                const now = Date.now();
                if (curatedStocksCache && curatedStocksLastFetch && (now - curatedStocksLastFetch < CACHE_DURATION)) {
                    console.log('Using cached curated stocks data');
                    return curatedStocksCache;
                }

                console.log('Fetching fresh curated stocks data...');
                try {
                    // Fetch all curated stocks in parallel
                    const promises = curatedUniverse.map(symbol => fetchSingleStock(symbol));
                    const results = await Promise.all(promises);

                    // Filter out any null/undefined results
                    const validResults = results.filter(stock => stock && stock.price);

                    // Cache the results
                    setCuratedStocksCache(validResults);
                    setCuratedStocksLastFetch(now);
                    setCuratedStocks(validResults);

                    return validResults;
                } catch (error) {
                    console.error('Error fetching curated stocks:', error);
                    // Return cached data if available, or empty array
                    return curatedStocksCache || [];
                }
            };

            // Learning Progress Functions
            const saveLearningProgress = (progress) => {
                localStorage.setItem('learningProgress', JSON.stringify(progress));
                setLearningProgress(progress);
            };

            const completeLesson = (topicName, quizScore) => {
                const newProgress = { ...learningProgress };

                // Add to completed if not already there
                if (!newProgress.completedLessons.includes(topicName)) {
                    newProgress.completedLessons.push(topicName);
                    newProgress.totalXP += 100; // 100 XP per lesson
                }

                // Update quiz score (always update to best score)
                if (!newProgress.quizScores[topicName] || quizScore > newProgress.quizScores[topicName]) {
                    newProgress.quizScores[topicName] = quizScore;
                    newProgress.totalXP += 50; // 50 XP for quiz
                }

                // Check for achievements
                const achievementsToAdd = [];
                if (newProgress.completedLessons.length === 1 && !newProgress.achievements.includes('first_lesson')) {
                    achievementsToAdd.push('first_lesson');
                }
                if (newProgress.completedLessons.length === 6 && !newProgress.achievements.includes('all_complete')) {
                    achievementsToAdd.push('all_complete');
                }
                if (quizScore === 100 && !newProgress.achievements.includes('perfect_score')) {
                    achievementsToAdd.push('perfect_score');
                }

                newProgress.achievements = [...newProgress.achievements, ...achievementsToAdd];

                // Update streak
                const today = new Date().toDateString();
                if (newProgress.lastVisit !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (newProgress.lastVisit === yesterday) {
                        newProgress.streak += 1;
                    } else {
                        newProgress.streak = 1;
                    }
                    newProgress.lastVisit = today;
                }

                saveLearningProgress(newProgress);

                // Show achievement notification
                if (achievementsToAdd.length > 0) {
                    achievementsToAdd.forEach(achievement => {
                        const achievementNames = {
                            'first_lesson': ' First Lesson Complete!',
                            'all_complete': ' All Topics Mastered!',
                            'perfect_score': ' Perfect Quiz Score!'
                        };
                        showToast(achievementNames[achievement] || 'Achievement Unlocked!', 'success');
                    });
                }
            };

            // Stop-Loss Order Functions
            const checkStopLossOrders = () => {
                if (!stocks || stocks.length === 0) return;

                Object.keys(stopLossOrders).forEach(symbol => {
                    const order = stopLossOrders[symbol];
                    const stock = stocks.find(s => s.symbol === symbol);

                    if (!stock) return;

                    // Check if stop-loss triggered (price fell to or below trigger)
                    if (stock.price <= order.triggerPrice) {
                        // Auto-execute sell order
                        console.log(` STOP-LOSS TRIGGERED: ${symbol} at $${stock.price} (trigger: $${order.triggerPrice})`);

                        // Execute the sell via executeTrade
                        const portfolio = getCurrentPortfolio();
                        const position = portfolio.positions[symbol] || 0;

                        if (position > 0) {
                            // Force sell at market (bid price)
                            const executionPrice = stock.bid || stock.price;
                            const quantity = Math.min(order.shares || position, position);

                            showToast(` STOP-LOSS: Selling ${quantity} shares of ${symbol} at $${executionPrice.toFixed(2)}`, 'warning', 10000);

                            // Auto-execute the sell
                            setTimeout(() => {
                                setQuantity(quantity);
                                setSelectedStock(symbol);
                                executeTrade('sell');
                            }, 100);

                            // Remove the executed stop-loss order
                            const newOrders = {...stopLossOrders};
                            delete newOrders[symbol];
                            setStopLossOrders(newOrders);
                        }
                    }
                });
            };

            const addStopLossOrder = (symbol, triggerPrice, shares = null) => {
                setStopLossOrders(prev => ({
                    ...prev,
                    [symbol]: {
                        triggerPrice: parseFloat(triggerPrice),
                        shares: shares,
                        createdAt: new Date().toISOString(),
                        type: 'stop-loss'
                    }
                }));
                showToast(` Stop-loss set for ${symbol} at $${parseFloat(triggerPrice).toFixed(2)}`, 'success');
            };

            const cancelStopLossOrder = (symbol) => {
                const newOrders = {...stopLossOrders};
                delete newOrders[symbol];
                setStopLossOrders(newOrders);
                showToast(` Stop-loss cancelled for ${symbol}`, 'info');
            };

            // Certificate Download Function
            const downloadCertificate = async () => {
                const certificateElement = document.getElementById('certificate-content');
                if (!certificateElement) return;

                try {
                    const canvas = await html2canvas(certificateElement, {
                        scale: 2,
                        backgroundColor: '#000000',
                        logging: false
                    });

                    const link = document.createElement('a');
                    const today = new Date().toISOString().split('T')[0];
                    link.download = `Trading-Certificate-${today}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    showToast('Certificate downloaded successfully!', 'success');
                } catch (error) {
                    console.error('Error downloading certificate:', error);
                    showToast('Error downloading certificate', 'error');
                }
            };

            // Quiz Data - Define quizzes for each topic
            const quizData = {
                basics: {
                    questions: [
                        {
                            question: "What does owning a stock represent?",
                            options: [
                                "Lending money to a company",
                                "Partial ownership in a company",
                                "A guaranteed profit",
                                "A fixed income payment"
                            ],
                            correct: 1,
                            explanation: "When you buy a stock, you become a partial owner of that company. You own a small piece of the business and can benefit from its growth."
                        },
                        {
                            question: "Which order type guarantees execution but NOT price?",
                            options: [
                                "Limit Order",
                                "Market Order",
                                "Stop-Loss Order",
                                "Good-Till-Cancelled Order"
                            ],
                            correct: 1,
                            explanation: "A Market Order executes immediately at the best available price. It guarantees your order will fill, but you won't know the exact price until after execution."
                        },
                        {
                            question: "What does a green candlestick indicate?",
                            options: [
                                "Price closed lower than it opened",
                                "Price closed higher than it opened",
                                "High trading volume",
                                "The stock is overvalued"
                            ],
                            correct: 1,
                            explanation: "A green (or white) candlestick means the price closed higher than it opened during that period, showing bullish price action where buyers won the battle."
                        },
                        {
                            question: "What is a support level?",
                            options: [
                                "The highest price a stock can reach",
                                "A price level where selling pressure is strong",
                                "A price level where buying pressure prevents further decline",
                                "The average price over 50 days"
                            ],
                            correct: 2,
                            explanation: "Support is a price level where buyers step in and prevent the stock from falling further. Think of it as a 'floor' that the price bounces off of."
                        },
                        {
                            question: "During regular market hours, when can you trade stocks? (EST)",
                            options: [
                                "24 hours a day",
                                "9:30 AM - 4:00 PM",
                                "8:00 AM - 5:00 PM",
                                "10:00 AM - 3:00 PM"
                            ],
                            correct: 1,
                            explanation: "Regular market hours are 9:30 AM to 4:00 PM Eastern Time, Monday through Friday (except market holidays). Pre-market and after-hours trading are also available but with less liquidity."
                        }
                    ]
                },
                strategies: {
                    questions: [
                        {
                            question: "What is a breakout entry strategy?",
                            options: [
                                "Buying when price falls below support",
                                "Buying when price breaks above resistance with volume",
                                "Selling when price is at its highest",
                                "Buying at the lowest price of the day"
                            ],
                            correct: 1,
                            explanation: "A breakout occurs when price breaks above a resistance level, especially with high volume. This often signals the start of a new uptrend and provides a good entry point."
                        },
                        {
                            question: "What is the main difference between day trading and swing trading?",
                            options: [
                                "Day trading uses more money",
                                "Day trading closes all positions by end of day; swing trading holds for days/weeks",
                                "Swing trading is more risky",
                                "Day trading only works with tech stocks"
                            ],
                            correct: 1,
                            explanation: "Day traders close all positions before market close to avoid overnight risk. Swing traders hold positions for several days or weeks to capture larger price moves."
                        },
                        {
                            question: "What is a good risk/reward ratio for most trades?",
                            options: [
                                "1:1 (equal risk and reward)",
                                "2:1 or 3:1 (reward is 2-3x the risk)",
                                "1:2 (risk is 2x the reward)",
                                "Risk/reward doesn't matter"
                            ],
                            correct: 1,
                            explanation: "Professional traders aim for at least 2:1 or 3:1 reward/risk ratios. This means if you risk $100, you should aim to make $200-300. This allows you to be profitable even with a 50% win rate."
                        },
                        {
                            question: "When should you take profits?",
                            options: [
                                "Never, always hold forever",
                                "When emotions tell you to",
                                "At predetermined profit targets based on risk/reward",
                                "Only when the stock doubles"
                            ],
                            correct: 2,
                            explanation: "Set profit targets BEFORE entering the trade based on technical levels and your risk/reward ratio. Having a plan prevents emotional decisions and ensures disciplined trading."
                        }
                    ]
                },
                risk: {
                    questions: [
                        {
                            question: "How much of your total portfolio should you risk on a single trade?",
                            options: [
                                "10-20%",
                                "5-10%",
                                "1-2%",
                                "As much as possible"
                            ],
                            correct: 2,
                            explanation: "The golden rule is to risk only 1-2% of your total account on any single trade. This ensures you can survive a losing streak without blowing up your account."
                        },
                        {
                            question: "What is the purpose of a stop-loss order?",
                            options: [
                                "To guarantee profits",
                                "To automatically exit at a loss to limit damage",
                                "To buy more shares when price drops",
                                "To lock in gains"
                            ],
                            correct: 1,
                            explanation: "A stop-loss automatically sells your position when price hits your predetermined exit level, limiting your loss on the trade. It's essential risk management that protects your capital."
                        },
                        {
                            question: "If you have a $10,000 account and risk 2% per trade, what's your maximum loss per trade?",
                            options: [
                                "$100",
                                "$200",
                                "$500",
                                "$1,000"
                            ],
                            correct: 1,
                            explanation: "$10,000  2% = $200. This means you should size your position so that if your stop-loss is hit, you only lose $200 maximum."
                        },
                        {
                            question: "What should you do after experiencing several losing trades in a row?",
                            options: [
                                "Double position size to recover losses quickly",
                                "Take a break, review your strategy, and reduce position size",
                                "Switch to random stocks",
                                "Ignore stop-losses to avoid being stopped out"
                            ],
                            correct: 1,
                            explanation: "After a losing streak, take a step back. Review your trades, identify mistakes, and consider reducing position size until you regain confidence. Never try to 'revenge trade' to recover losses quickly."
                        }
                    ]
                },
                calculators: {
                    questions: [
                        {
                            question: "You have $50,000 and want to risk 2% on a trade. Stock price is $100, stop-loss at $95. How many shares should you buy?",
                            options: [
                                "100 shares",
                                "200 shares",
                                "500 shares",
                                "1,000 shares"
                            ],
                            correct: 1,
                            explanation: "Risk amount: $50,000  2% = $1,000. Risk per share: $100 - $95 = $5. Shares to buy: $1,000  $5 = 200 shares. This ensures you only lose $1,000 if stopped out."
                        },
                        {
                            question: "If you buy 100 shares at $50 and sell at $60, what's your profit?",
                            options: [
                                "$500",
                                "$1,000",
                                "$5,000",
                                "$6,000"
                            ],
                            correct: 1,
                            explanation: "Profit = (Sell Price - Buy Price)  Shares = ($60 - $50)  100 = $10  100 = $1,000"
                        },
                        {
                            question: "You risk $500 to make $1,500. What's your risk/reward ratio?",
                            options: [
                                "1:3",
                                "3:1",
                                "1:1",
                                "2:1"
                            ],
                            correct: 0,
                            explanation: "Risk/Reward = Risk : Reward = $500 : $1,500 = 1 : 3. This is excellent! For every $1 you risk, you're aiming to make $3."
                        }
                    ]
                },
                patterns: {
                    questions: [
                        {
                            question: "What does a 'bull flag' pattern typically indicate?",
                            options: [
                                "Trend reversal downward",
                                "Continuation of uptrend after brief consolidation",
                                "Market crash imminent",
                                "No predictable outcome"
                            ],
                            correct: 1,
                            explanation: "A bull flag is a continuation pattern. After a strong upward move (flagpole), the stock consolidates sideways or slightly down (flag), then typically breaks out higher to continue the uptrend."
                        },
                        {
                            question: "What is a 'double top' pattern?",
                            options: [
                                "A bullish reversal signal",
                                "A bearish reversal signal showing price failed to break resistance twice",
                                "A continuation pattern",
                                "Two green candles in a row"
                            ],
                            correct: 1,
                            explanation: "A double top forms when price tests a resistance level twice but fails to break through both times. This often signals the uptrend is weakening and a reversal downward may occur."
                        },
                        {
                            question: "What should you look for to confirm a chart pattern breakout?",
                            options: [
                                "Low trading volume",
                                "High trading volume",
                                "Price moving sideways",
                                "Social media hype"
                            ],
                            correct: 1,
                            explanation: "High volume on a breakout confirms that many traders believe in the move. Low volume breakouts are often 'false breakouts' that quickly reverse."
                        }
                    ]
                },
                cases: {
                    questions: [
                        {
                            question: "What is FOMO in trading?",
                            options: [
                                "Fear Of Missing Out - buying stocks that already moved significantly",
                                "First Order Market Opening",
                                "Fixed Option Moving Average",
                                "Fundamental Overview Market Option"
                            ],
                            correct: 0,
                            explanation: "FOMO (Fear Of Missing Out) causes traders to chase stocks that have already made large moves, often buying at the top. This emotional trap leads to losses when the stock pulls back."
                        },
                        {
                            question: "Why do disciplined traders keep a trading journal?",
                            options: [
                                "For tax purposes only",
                                "To review mistakes, identify patterns, and improve strategy",
                                "Because it's required by law",
                                "To show off to friends"
                            ],
                            correct: 1,
                            explanation: "A trading journal helps you learn from both wins and losses. By documenting your reasoning, emotions, and outcomes, you can identify what works and improve your edge over time."
                        },
                        {
                            question: "What's the biggest lesson from reviewing losing trades?",
                            options: [
                                "Trading is impossible",
                                "Most losses come from not following your own trading plan",
                                "You need more luck",
                                "The market is rigged"
                            ],
                            correct: 1,
                            explanation: "Studies show that most losses come from emotional decisions and not following predetermined rules. Having a plan is useless if you don't follow it with discipline."
                        }
                    ]
                }
            };

            // Glossary Data - Trading terms dictionary
            const glossaryTerms = [
                // Market Terms
                { term: "Stock", definition: "A share representing partial ownership in a company. When you buy stock, you own a piece of that business and can benefit from its growth and profits.", category: "Market" },
                { term: "Share", definition: "A single unit of ownership in a company. If a company has 1,000 shares and you own 100, you own 10% of the company.", category: "Market" },
                { term: "Bull Market", definition: "A market condition where prices are rising or expected to rise over an extended period. Investors are optimistic and buying activity increases.", category: "Market" },
                { term: "Bear Market", definition: "A market condition where prices are falling or expected to fall, typically 20% or more from recent highs. Investor sentiment is pessimistic.", category: "Market" },
                { term: "Volatility", definition: "The rate and magnitude of price changes in a stock or market. High volatility means large price swings, while low volatility means stable prices.", category: "Market" },
                { term: "Liquidity", definition: "How easily an asset can be bought or sold without affecting its price. High liquidity means you can enter/exit positions quickly at fair prices.", category: "Market" },
                { term: "Volume", definition: "The total number of shares traded during a specific period. High volume confirms the strength of price moves and indicates strong interest.", category: "Market" },
                { term: "Market Cap", definition: "Market Capitalization - the total value of a company's outstanding shares. Calculated by multiplying share price by total shares outstanding.", category: "Market" },
                { term: "Bid-Ask Spread", definition: "The difference between the highest price a buyer is willing to pay (bid) and the lowest price a seller will accept (ask). Tighter spreads indicate better liquidity.", category: "Market" },
                { term: "Gap", definition: "A price level where no trading occurs, creating a 'gap' on the chart. Often happens at market open when news moves price sharply from previous close.", category: "Market" },

                // Order Types
                { term: "Market Order", definition: "An order to buy or sell immediately at the best available current price. Guarantees execution but not the exact price you'll get.", category: "Orders" },
                { term: "Limit Order", definition: "An order to buy or sell at a specific price or better. Guarantees your price but not that the order will execute. Used to control entry/exit prices.", category: "Orders" },
                { term: "Stop-Loss Order", definition: "An order that automatically sells your position when price reaches a predetermined level, limiting your loss. Essential for risk management.", category: "Orders" },
                { term: "Trailing Stop", definition: "A dynamic stop-loss that moves with the stock price, locking in profits while protecting against reversals. Trails the price by a set percentage or dollar amount.", category: "Orders" },
                { term: "Stop-Limit Order", definition: "Combines a stop order and limit order. When stop price is reached, it becomes a limit order at your specified price. More control but risks not executing.", category: "Orders" },
                { term: "Day Order", definition: "An order that expires at the end of the trading day if not executed. Default order type for most brokers.", category: "Orders" },
                { term: "GTC Order", definition: "Good-Till-Cancelled order that remains active until executed or manually cancelled. Can stay open for weeks or months depending on broker.", category: "Orders" },
                { term: "Fill or Kill", definition: "An order that must be executed immediately in its entirety or cancelled. Used when you need the full position size immediately.", category: "Orders" },

                // Technical Analysis
                { term: "RSI", definition: "Relative Strength Index - momentum oscillator measuring speed and magnitude of price changes on a 0-100 scale. Above 70 suggests overbought, below 30 suggests oversold.", category: "Technical" },
                { term: "MACD", definition: "Moving Average Convergence Divergence - trend-following momentum indicator showing relationship between two moving averages. Crossovers signal potential buy/sell opportunities.", category: "Technical" },
                { term: "Moving Average", definition: "Average price over a specific period (20-day, 50-day, 200-day). Used to smooth price action and identify trend direction. Price above MA = uptrend, below = downtrend.", category: "Technical" },
                { term: "Support", definition: "A price level where buying pressure prevents further decline, acting as a 'floor'. Price often bounces off support levels. Break below support can signal weakness.", category: "Technical" },
                { term: "Resistance", definition: "A price level where selling pressure prevents further advance, acting as a 'ceiling'. Price struggles to break through resistance. Break above resistance signals strength.", category: "Technical" },
                { term: "Breakout", definition: "When price moves above resistance or below support with strong volume, potentially starting a new trend. Most reliable with high volume confirmation.", category: "Technical" },
                { term: "Trend Line", definition: "A line connecting two or more price points to show trend direction. Uptrend connects higher lows, downtrend connects lower highs. Used to identify support/resistance.", category: "Technical" },
                { term: "Candlestick", definition: "A chart type showing open, high, low, and close prices for a period. Green/white candles = price closed higher, red/black = closed lower. Reveals buying/selling pressure.", category: "Technical" },
                { term: "Chart Pattern", definition: "Recognizable formations in price action that often lead to predictable moves. Examples: head and shoulders, double top, bull flag, cup and handle.", category: "Technical" },
                { term: "Fibonacci Retracement", definition: "Technical tool using horizontal lines at key Fibonacci ratios (23.6%, 38.2%, 50%, 61.8%) to identify potential support/resistance levels during pullbacks.", category: "Technical" },

                // Risk Management
                { term: "Position Sizing", definition: "Calculating how many shares to buy based on your risk tolerance and stop-loss distance. Ensures you only risk 1-2% of account per trade.", category: "Risk" },
                { term: "Risk/Reward Ratio", definition: "The ratio of potential profit to potential loss on a trade. Professional traders target 2:1 or 3:1, meaning they risk $1 to make $2-3.", category: "Risk" },
                { term: "Drawdown", definition: "The decline from peak to trough in your account balance, expressed as percentage. A $10,000 account dropping to $8,000 has a 20% drawdown.", category: "Risk" },
                { term: "Diversification", definition: "Spreading capital across multiple stocks or sectors to reduce risk. Don't put all eggs in one basket - if one trade fails, others may succeed.", category: "Risk" },
                { term: "Risk Capital", definition: "Money you can afford to lose without affecting your lifestyle. Only trade with risk capital, never mortgage money, rent money, or emergency funds.", category: "Risk" },
                { term: "Max Loss Per Trade", definition: "The maximum amount you're willing to lose on a single trade, typically 1-2% of total account. This prevents one bad trade from destroying your account.", category: "Risk" },
                { term: "Correlation", definition: "How two stocks move in relation to each other. Positive correlation = move together, negative = move opposite. Avoid buying highly correlated stocks (reduces diversification).", category: "Risk" },
                { term: "Leverage", definition: "Using borrowed money to increase position size. Amplifies both gains and losses. Dangerous for beginners - can lose more than initial investment.", category: "Risk" },

                // Trading Psychology
                { term: "FOMO", definition: "Fear Of Missing Out - the emotional urge to chase stocks that have already made large moves. Often leads to buying at tops and significant losses.", category: "Psychology" },
                { term: "Fear", definition: "Emotion causing traders to exit winners too early or avoid good setups. Fear of loss is stronger than desire for gain. Combat with proper risk management.", category: "Psychology" },
                { term: "Greed", definition: "Emotion causing traders to hold losers too long or over-trade. Leads to ignoring stop-losses and taking excessive risk. Stick to your plan to overcome.", category: "Psychology" },
                { term: "Discipline", definition: "The ability to follow your trading plan consistently without emotional deviation. Most important trait for success - rules without discipline are useless.", category: "Psychology" },
                { term: "Revenge Trading", definition: "Impulsively taking trades to recover losses from a previous losing trade. Driven by emotion rather than strategy. Almost always leads to bigger losses.", category: "Psychology" },
                { term: "Overtrading", definition: "Taking too many trades, often out of boredom or greed. Reduces win rate, increases commission costs, and leads to poor decisions. Quality over quantity.", category: "Psychology" },
                { term: "Trading Journal", definition: "A log documenting every trade including entry/exit, reasoning, emotions, and lessons learned. Critical tool for identifying mistakes and improving over time.", category: "Psychology" },
                { term: "Confirmation Bias", definition: "The tendency to seek information that confirms your existing beliefs while ignoring contrary evidence. Leads to holding losing trades too long.", category: "Psychology" },
                { term: "Patience", definition: "Waiting for high-probability setups that meet your criteria rather than forcing trades. Warren Buffett: 'The stock market is a device for transferring money from the impatient to the patient.'", category: "Psychology" }
            ];

            // Chat functions
            const sendChatMessage = () => {
                if (!chatInput.trim() || !socket) return;

                const message = {
                    userName: userName || 'Guest',
                    message: chatInput.trim(),
                    timestamp: new Date().toISOString()
                };

                socket.emit('chat_message', message);
                setChatInput('');
            };

            const handleChatKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            };

            const fetchMarketMovers = async () => {
                setLoadingMovers(true);
                setMoversProgress({ current: 0, total: 100 });
                try {
                    // Use CORS proxy for Yahoo Finance API (GitHub Pages can't make direct requests)
                    const corsProxy = 'https://corsproxy.io/?';
                    const gainersUrl = 'https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?formatted=false&scrIds=day_gainers&start=0&count=10';
                    const losersUrl = 'https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?formatted=false&scrIds=day_losers&start=0&count=10';

                    const gainersResponse = await fetch(corsProxy + encodeURIComponent(gainersUrl));
                    const losersResponse = await fetch(corsProxy + encodeURIComponent(losersUrl));

                    setMoversProgress({ current: 50, total: 100 });

                    const gainersData = await gainersResponse.json();
                    const losersData = await losersResponse.json();

                    setMoversProgress({ current: 75, total: 100 });

                    // Process gainers
                    const gainers = gainersData.finance?.result?.[0]?.quotes?.map(quote => ({
                        symbol: quote.symbol,
                        name: quote.shortName || quote.longName || quote.symbol,
                        price: quote.regularMarketPrice || 0,
                        change: quote.regularMarketChangePercent || 0,
                        changeValue: quote.regularMarketChange || 0,
                        high: quote.regularMarketDayHigh || quote.regularMarketPrice || 0,
                        low: quote.regularMarketDayLow || quote.regularMarketPrice || 0,
                        open: quote.regularMarketOpen || quote.regularMarketPrice || 0,
                        previousClose: quote.regularMarketPreviousClose || quote.regularMarketPrice || 0,
                        volume: quote.regularMarketVolume || 0
                    })) || [];

                    // Process losers
                    const losers = losersData.finance?.result?.[0]?.quotes?.map(quote => ({
                        symbol: quote.symbol,
                        name: quote.shortName || quote.longName || quote.symbol,
                        price: quote.regularMarketPrice || 0,
                        change: quote.regularMarketChangePercent || 0,
                        changeValue: quote.regularMarketChange || 0,
                        high: quote.regularMarketDayHigh || quote.regularMarketPrice || 0,
                        low: quote.regularMarketDayLow || quote.regularMarketPrice || 0,
                        open: quote.regularMarketOpen || quote.regularMarketPrice || 0,
                        previousClose: quote.regularMarketPreviousClose || quote.regularMarketPrice || 0,
                        volume: quote.regularMarketVolume || 0
                    })) || [];

                    setMoversProgress({ current: 100, total: 100 });

                    setTopGainers(gainers.slice(0, 10));
                    setTopLosers(losers.slice(0, 10));

                    console.log(' Market movers loaded successfully');
                    console.log(' Gainers:', gainers.length);
                    console.log(' Losers:', losers.length);

                } catch (error) {
                    console.error(' Failed to load market movers:', error);
                    showToast('Failed to load market movers. Please try again.', 'error');
                } finally {
                    setLoadingMovers(false);
                }
            };

            // Helper function to save portfolio to database
            const savePortfolioToDatabase = (updatedPortfolio) => {
                if (plan === 'personal' && userEmail) {
                    fetch(`${API_BASE_URL}/api/accounts/update-portfolio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: userEmail,
                            portfolio: updatedPortfolio
                        })
                    }).catch(err => console.error('Portfolio save error:', err));
                }
            };

            const addToWatchlist = async (symbol, stockName = null) => {
                if (watchlist.includes(symbol)) {
                    // Already in watchlist, just select it
                    setSelectedStock(symbol);
                    setTradeAnalysisData(null); // Clear trade analysis when switching stocks
                    setSearchQuery('');
                    setShowSearchResults(false);
                    setError(null);
                    return;
                }

                // Show loading state
                setSearching(true);
                setError(null);

                const stockData = await fetchSingleStock(symbol, stockName);

                const newWatchlist = [...watchlist, symbol];
                setWatchlist(newWatchlist);

                const portfolio = getCurrentPortfolio();
                const updatedPortfolio = {
                    ...portfolio,
                    watchlist: newWatchlist
                };

                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server
                savePortfolioToDatabase(updatedPortfolio);

                const existingIndex = stocks.findIndex(s => s.symbol === symbol);
                if (existingIndex >= 0) {
                    const updatedStocks = [...stocks];
                    updatedStocks[existingIndex] = stockData;
                    setStocks(updatedStocks);
                } else {
                    setStocks([...stocks, stockData]);
                }

                // Select the stock
                setSelectedStock(symbol);
                setTradeAnalysisData(null); // Clear trade analysis when switching stocks

                // Show success toast
                showToast(` Added ${symbol} to watchlist`, 'success');

                // Clear search
                setSearchQuery('');
                setShowSearchResults(false);
                setSearching(false);
            };

            const removeFromWatchlist = (symbol) => {
                const newWatchlist = watchlist.filter(s => s !== symbol);
                setWatchlist(newWatchlist);
                setStocks(stocks.filter(s => s.symbol !== symbol));

                // Show info toast
                showToast(`Removed ${symbol} from watchlist`, 'info');

                const portfolio = getCurrentPortfolio();
                const updatedPortfolio = {
                    ...portfolio,
                    watchlist: newWatchlist
                };

                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server
                savePortfolioToDatabase(updatedPortfolio);
            };

            useEffect(() => {
                if (view === 'trading' && watchlist.length > 0) {
                    fetchStockData();

                    // Auto-refresh stock prices every 30 seconds to update portfolio value
                    const refreshInterval = setInterval(() => {
                        fetchStockData();
                    }, 30000); // 30 seconds

                    return () => clearInterval(refreshInterval);
                }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [view, watchlist]);

            // Check stop-loss orders whenever stocks update
            useEffect(() => {
                if (stocks.length > 0 && Object.keys(stopLossOrders).length > 0) {
                    checkStopLossOrders();
                }
            }, [stocks, stopLossOrders]);

            // Clear error when selected stock changes
            useEffect(() => {
                setQuantityError('');
                setQuantity(1);
            }, [selectedStock]);

            const getCurrentPortfolio = () => {
                const defaultPortfolio = {
                    cash: 100000,
                    positions: {},
                    shortPositions: {},
                    history: [],
                    lastBuyTime: {},
                    watchlist: [],
                    performanceHistory: [] // Track daily portfolio values for analytics
                };

                if (plan === 'personal') {
                    const portfolio = competition?.members[0]?.portfolio || defaultPortfolio;
                    return portfolio;
                }
                const member = competition?.members.find(m => m.id === currentUserId);
                const portfolio = member?.portfolio || defaultPortfolio;
                return portfolio;
            };

            const calculatePortfolioValue = (portfolio) => {
                if (!portfolio || typeof portfolio.cash !== 'number') {
                    return 100000; // Default starting value
                }

                let positionsValue = 0;
                if (portfolio.positions && stocks.length > 0) {
                    Object.entries(portfolio.positions).forEach(([symbol, qty]) => {
                        const stock = stocks.find(s => s.symbol === symbol);
                        if (stock && typeof stock.price === 'number' && typeof qty === 'number') {
                            positionsValue += stock.price * qty;
                        }
                    });
                }

                const totalValue = portfolio.cash + positionsValue;
                return isNaN(totalValue) ? 100000 : totalValue;
            };

            // Calculate position-level P/L
            const calculatePositionPnL = (symbol, currentPrice) => {
                const portfolio = getCurrentPortfolio();
                const shares = portfolio.positions?.[symbol] || 0;
                const costBasis = portfolio.costBasis?.[symbol] || 0;

                if (shares === 0 || costBasis === 0) {
                    return {
                        shares: 0,
                        avgCost: 0,
                        currentValue: 0,
                        totalCost: 0,
                        unrealizedPnL: 0,
                        unrealizedPnLPercent: 0
                    };
                }

                const totalCost = shares * costBasis;
                const currentValue = shares * currentPrice;
                const unrealizedPnL = currentValue - totalCost;
                const unrealizedPnLPercent = (unrealizedPnL / totalCost) * 100;

                return {
                    shares,
                    avgCost: costBasis,
                    currentValue,
                    totalCost,
                    unrealizedPnL,
                    unrealizedPnLPercent
                };
            };

            const generateCompetitionCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const generatePasscode = () => {
                return Math.floor(100000 + Math.random() * 900000).toString();
            };

            // Password strength checker
            const checkPasswordStrength = (password) => {
                if (!password) return null;

                const requirements = {
                    minLength: password.length >= 8,
                    hasUpperCase: /[A-Z]/.test(password),
                    hasLowerCase: /[a-z]/.test(password),
                    hasNumber: /[0-9]/.test(password),
                    hasSpecial: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                const metRequirements = Object.values(requirements).filter(Boolean).length;

                let strength = 'weak';
                let color = 'red';
                if (metRequirements >= 5) {
                    strength = 'strong';
                    color = 'green';
                } else if (metRequirements >= 3) {
                    strength = 'medium';
                    color = 'yellow';
                }

                return {
                    strength,
                    color,
                    requirements,
                    score: metRequirements
                };
            };

            const fetchWithTimeout = (url, options, timeout = 30000) => {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Request timeout. Please check your internet connection.')), timeout)
                    )
                ]);
            };

            const createCompetition = async (memberName, contributionAmount, password = null) => {
                const code = generateCompetitionCode();
                const memberId = Date.now().toString();
                const isPersonalPlan = parseFloat(contributionAmount || 0) === 0;

                try {
                    // Personal plans use backend server
                    if (isPersonalPlan) {

                        const initialPortfolio = {
                            cash: 100000,
                            positions: {},
                            history: [],
                            lastBuyTime: {},
                            watchlist: []
                        };

                        const passcode = generatePasscode();

                        const response = await fetchWithTimeout(`${API_BASE_URL}/api/accounts/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                userName: memberName,
                                password: password,
                                accountCode: code,
                                portfolio: initialPortfolio
                            })
                        }, 60000);

                        const data = await response.json();

                        if (!response.ok) {
                            if (response.status === 400 && data.error && data.error.includes('already exists')) {
                                throw new Error('An account with this email already exists. Please sign in instead or use a different email.');
                            } else {
                                throw new Error(data.error || 'Failed to create account. Please try again.');
                            }
                        }

                        setGeneratedPasscode(passcode);

                        const newCompetition = {
                            code: code,
                            totalPool: 0,
                            startTime: new Date().toISOString(),
                            members: [{
                                id: memberId,
                                name: memberName,
                                contribution: 0,
                                portfolio: initialPortfolio,
                                joinedAt: new Date().toISOString()
                            }]
                        };

                        setCompetition(newCompetition);
                        setCompetitionCode(code);
                        setCurrentUserId(memberId);
                        setView('code-display');
                        return;
                    }

                    // Family plans - not currently supported
                    throw new Error('Family plans are not currently available. Please use a Personal plan instead.');
                } catch (error) {
                    throw error;
                }
            };

            const joinCompetition = async (code, memberName, contributionAmount) => {
                alert('Join competition feature is not currently available. Please create a Personal account instead.');
                return;
            };

            const signInWithEmailAndPasscode = async (email, passcode) => {
                // This function is deprecated - use backend API login instead
                alert('Please use the Sign In button instead.');
            };

            const signInToPersonalAccount = async (accountCode) => {
                // This function is deprecated - use backend API login instead
                alert('Please use the Sign In button with your email and password.');
            };

            const getMaxBuyQuantity = (stockSymbol) => {
                const stock = stocks.find(s => s.symbol === stockSymbol);
                if (!stock) return 0;
                const portfolio = getCurrentPortfolio();
                return Math.floor(portfolio.cash / stock.price);
            };

            const getCurrentPosition = (stockSymbol) => {
                const portfolio = getCurrentPortfolio();
                return portfolio.positions[stockSymbol] || 0;
            };

            const handleQuantityChange = (newQuantity, isBuy = true) => {
                const num = parseInt(newQuantity) || 0;

                if (num < 0) {
                    setQuantityError('Quantity cannot be negative');
                    return;
                }

                if (!selectedStock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    setQuantity(Math.max(1, num));
                    setQuantityError('');
                    return;
                }

                const portfolio = getCurrentPortfolio();
                const maxBuy = getMaxBuyQuantity(selectedStock);
                const maxSell = getCurrentPosition(selectedStock);

                // If manually typing, check limits
                if (num > maxBuy) {
                    const totalCost = stock.price * num;
                    setQuantityError(` Insufficient funds! You need $${totalCost.toFixed(2)} but only have $${portfolio.cash.toFixed(2)}. Max: ${maxBuy} shares`);
                    setQuantity(num); // Still set it so they can see what they typed
                } else if (num > maxSell && !isBuy) {
                    setQuantityError(` You only own ${maxSell} shares of ${selectedStock}`);
                    setQuantity(num);
                } else {
                    setQuantityError('');
                    setQuantity(Math.max(1, num));
                }
            };

            // Buy max shares
            const buyMax = () => {
                if (!selectedStock) return;
                const maxShares = getMaxBuyQuantity(selectedStock);
                if (maxShares === 0) {
                    setQuantityError(' Insufficient funds to buy any shares');
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            // Sell max shares
            const sellMax = () => {
                if (!selectedStock) return;
                const maxShares = getCurrentPosition(selectedStock);
                if (maxShares === 0) {
                    setQuantityError(` You don't own any shares of ${selectedStock}`);
                    setQuantity(1);
                } else {
                    setQuantity(maxShares);
                    setQuantityError('');
                }
            };

            // Execute short sell
            const executeShortSell = async () => {
                if (!selectedStock || quantity <= 0) return;

                if (!marketOpen) {
                    showToast(`Market is closed. ${currentHoliday ? `Today is ${currentHoliday}.` : ''} Next trading session: ${nextMarketOpenTime}`, 'error', 8000);
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    alert('Stock data not available. Please add to watchlist and refresh.');
                    return;
                }

                const portfolio = getCurrentPortfolio();
                const validation = window.shortSelling.validateShort(portfolio, selectedStock, stock.price, quantity);

                if (!validation.isValid) {
                    alert(' Cannot short:\n' + validation.errors.join('\n'));
                    return;
                }

                const updatedPortfolio = window.shortSelling.executeShort(
                    {...portfolio},
                    selectedStock,
                    stock.price,
                    quantity
                );

                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server for personal accounts
                // Sync to backend server
                savePortfolioToDatabase(updatedPortfolio);

                alert(` Shorted ${quantity} shares of ${selectedStock} @ $${stock.price.toFixed(2)}`);
                setQuantity(1);
                setQuantityError('');
            };

            // Execute cover short
            const executeCoverShort = async () => {
                if (!selectedStock || quantity <= 0) return;

                if (!marketOpen) {
                    showToast(`Market is closed. ${currentHoliday ? `Today is ${currentHoliday}.` : ''} Next trading session: ${nextMarketOpenTime}`, 'error', 8000);
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) return;

                const portfolio = getCurrentPortfolio();
                const validation = window.shortSelling.validateCover(portfolio, selectedStock, stock.price, quantity);

                if (!validation.isValid) {
                    alert(' Cannot cover:\n' + validation.errors.join('\n'));
                    return;
                }

                const { portfolio: updatedPortfolio, profitLoss } = window.shortSelling.executeCover(
                    {...portfolio},
                    selectedStock,
                    stock.price,
                    quantity,
                    stocks
                );

                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server
                savePortfolioToDatabase(updatedPortfolio);

                alert(` Covered ${quantity} shares of ${selectedStock}\nP/L: ${profitLoss >= 0 ? '+' : ''}$${profitLoss.toFixed(2)}`);
                setQuantity(1);
                setQuantityError('');
            };

            const loadStockNews = async () => {
                if (!selectedStock) return;
                setLoadingNews(true);
                try {
                    const news = await window.newsFeed.fetchStockNews(selectedStock, FINNHUB_API_KEY);
                    setStockNews(news);
                    setLastStockNewsUpdate(new Date()); // Track when news was updated
                } catch (error) {
                    setStockNews([]);
                }
                setLoadingNews(false);
            };

            const loadMarketNews = async () => {
                setLoadingMarketNews(true);
                try {
                    const news = await window.newsFeed.fetchMarketNews(FINNHUB_API_KEY);
                    setMarketNews(news);
                    setLastNewsUpdate(new Date()); // Track when news was updated
                } catch (error) {
                    setMarketNews([]);
                }
                setLoadingMarketNews(false);
            };

            // Scrape article content from URL using ScraperAPI
            const scrapeArticle = async (article) => {
                setScrapingArticle(true);
                setScrapingError(null);
                setScrapedArticle(null);

                try {
                    // Using ScraperAPI free tier (1000 requests/month)
                    const SCRAPER_API_KEY = '09c226cad5f1dd6d11f5ed833d2e78d1';
                    const targetUrl = encodeURIComponent(article.url);

                    // Fetch HTML through ScraperAPI proxy
                    const response = await fetch(`https://api.scraperapi.com?api_key=${SCRAPER_API_KEY}&url=${targetUrl}`);

                    if (!response.ok) {
                        throw new Error('Failed to fetch article');
                    }

                    const html = await response.text();

                    // Parse HTML on client side
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Remove unwanted elements
                    const unwantedSelectors = ['script', 'style', 'nav', 'header', 'footer', 'iframe', '.advertisement', '.ad', '.sidebar', '.social-share'];
                    unwantedSelectors.forEach(selector => {
                        doc.querySelectorAll(selector).forEach(el => el.remove());
                    });

                    // Extract headline
                    let headline = '';
                    const h1 = doc.querySelector('h1');
                    const ogTitle = doc.querySelector('meta[property="og:title"]');
                    const title = doc.querySelector('title');
                    headline = h1?.textContent?.trim() ||
                              ogTitle?.getAttribute('content') ||
                              title?.textContent?.trim() ||
                              article.headline;

                    // Extract publish date
                    const timeEl = doc.querySelector('time');
                    const ogPublished = doc.querySelector('meta[property="article:published_time"]');
                    const publishDate = timeEl?.getAttribute('datetime') ||
                                       ogPublished?.getAttribute('content') ||
                                       '';

                    // Extract author
                    const authorMeta = doc.querySelector('meta[name="author"]');
                    const ogAuthor = doc.querySelector('meta[property="article:author"]');
                    const authorLink = doc.querySelector('[rel="author"]');
                    const author = authorMeta?.getAttribute('content') ||
                                  ogAuthor?.getAttribute('content') ||
                                  authorLink?.textContent?.trim() ||
                                  '';

                    // Extract article content
                    let articleText = '';
                    const articleSelectors = [
                        'article p',
                        '.article-body p',
                        '.article-content p',
                        '.story-body p',
                        '.post-content p',
                        '.entry-content p',
                        'main p',
                        '[role="main"] p'
                    ];

                    for (const selector of articleSelectors) {
                        const paragraphs = doc.querySelectorAll(selector);
                        if (paragraphs.length > 3) {
                            const texts = Array.from(paragraphs)
                                .map(p => p.textContent.trim())
                                .filter(text => text.length > 50);
                            articleText = texts.join('\n\n');
                            if (articleText.length > 200) break;
                        }
                    }

                    // Fallback to all paragraphs
                    if (!articleText || articleText.length < 200) {
                        const allParagraphs = doc.querySelectorAll('p');
                        articleText = Array.from(allParagraphs)
                            .map(p => p.textContent.trim())
                            .filter(text => text.length > 50)
                            .join('\n\n');
                    }

                    // Check if we got meaningful content
                    if (!articleText || articleText.length < 200) {
                        throw new Error('Unable to extract article content. This site may be paywalled or use dynamic content loading.');
                    }

                    // Check for paywall indicators
                    const paywallIndicators = [
                        'subscribe to read',
                        'subscription required',
                        'paywall',
                        'premium content',
                        'sign in to continue',
                        'register to read'
                    ];

                    const lowerText = articleText.toLowerCase();
                    if (paywallIndicators.some(indicator => lowerText.includes(indicator))) {
                        throw new Error('This article appears to be behind a paywall.');
                    }

                    console.log(` Successfully scraped article: ${headline.substring(0, 50)}...`);
                    console.log(`   Content length: ${articleText.length} characters`);

                    setScrapedArticle({
                        headline,
                        text: articleText,
                        publishDate,
                        author,
                        url: article.url
                    });
                    setScrapingError(null);
                } catch (error) {
                    console.error('Error scraping article:', error);
                    setScrapingError(error.message || 'Failed to load article content');
                    setScrapedArticle(null);
                } finally {
                    setScrapingArticle(false);
                }
            };

            // AI Trade Analysis with "UltraThink" deep reasoning - REAL DATA DRIVEN
            const generateAIAnalysis = async () => {
                if (!selectedStock) return;

                setLoadingAnalysis(true);
                setAnalysisExpanded(true);

                // Simulate AI analysis with deep thinking
                await new Promise(resolve => setTimeout(resolve, 2000));

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    setLoadingAnalysis(false);
                    return;
                }


                // REAL DATA: Extract all stock metrics
                const price = stock.price || 0;
                const high = stock.high || price;
                const low = stock.low || price;
                const open = stock.open || price;
                const previousClose = stock.previousClose || price;
                const priceChange = stock.change || 0;

                // REAL CALCULATION: Enhanced RSI using Wilder's Smoothing (Industry Standard)
                const calculateEnhancedRSI = async () => {
                    try {
                        const toDate = Math.floor(Date.now() / 1000);
                        const fromDate = toDate - (30 * 24 * 60 * 60); // 30 days for accurate RSI

                        const response = await fetch(
                            `${FINNHUB_API_BASE}/stock/candle?symbol=${selectedStock}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                        );
                        const data = await response.json();

                        if (data.s === 'ok' && data.c && data.c.length >= 15) {
                            // Use enhanced AI module for TRUE RSI calculation with Wilder's smoothing
                            const rsi = window.enhancedAI.calculateRealRSI(data.c, 14);
                            if (rsi !== null) {
                                return rsi;
                            }
                        }
                    } catch (error) {
                        console.error('RSI calculation error:', error);
                    }

                    // Fallback to simplified RSI if API fails
                    const priceChangeAmount = price - previousClose;
                    const gain = Math.max(0, priceChangeAmount);
                    const loss = Math.max(0, -priceChangeAmount);

                    if (gain === 0 && loss === 0) return 50;

                    const avgGain = (gain / previousClose) * 100;
                    const avgLoss = (loss / previousClose) * 100 + 0.01;
                    const rs = avgGain / avgLoss;
                    const rsi = 100 - (100 / (1 + rs));

                    return Math.max(0, Math.min(100, rsi));
                };

                const rsi = await calculateEnhancedRSI();

                // REAL CALCULATION: Moving Averages (50-day and 200-day)
                const calculateMovingAverages = async () => {
                    try {
                        const toDate = Math.floor(Date.now() / 1000);
                        const fromDate = toDate - (250 * 24 * 60 * 60); // 250 days for 200-day MA

                        const response = await fetch(
                            `${FINNHUB_API_BASE}/stock/candle?symbol=${selectedStock}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                        );
                        const data = await response.json();

                        if (data.s === 'ok' && data.c && data.c.length > 0) {
                            const closes = data.c;

                            // 50-day MA
                            let ma50 = null;
                            if (closes.length >= 50) {
                                const last50 = closes.slice(-50);
                                ma50 = last50.reduce((sum, val) => sum + val, 0) / 50;
                            }

                            // 200-day MA
                            let ma200 = null;
                            if (closes.length >= 200) {
                                const last200 = closes.slice(-200);
                                ma200 = last200.reduce((sum, val) => sum + val, 0) / 200;
                            }

                            return { ma50, ma200 };
                        }
                    } catch (error) {
                    }
                    return { ma50: null, ma200: null };
                };

                const { ma50, ma200 } = await calculateMovingAverages();

                // ENHANCED: Calculate MACD and Bollinger Bands
                const calculateAdvancedIndicators = async () => {
                    try {
                        const toDate = Math.floor(Date.now() / 1000);
                        const fromDate = toDate - (60 * 24 * 60 * 60); // 60 days for MACD

                        const response = await fetch(
                            `${FINNHUB_API_BASE}/stock/candle?symbol=${selectedStock}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                        );
                        const data = await response.json();

                        if (data.s === 'ok' && data.c && data.c.length >= 26) {
                            const macd = window.enhancedAI.calculateMACD(data.c, 12, 26, 9);
                            const bb = window.enhancedAI.calculateBollingerBands(data.c, 20, 2);
                            return { macd, bb };
                        }
                    } catch (error) {
                        console.error('Advanced indicators error:', error);
                    }
                    return { macd: null, bb: null };
                };

                const { macd, bb } = await calculateAdvancedIndicators();

                // ULTRA-ADVANCED INDICATORS: Ichimoku, Fibonacci, Volume Profile, ADX, Parabolic SAR
                const calculateUltraAdvancedIndicators = async () => {
                    try {
                        const toDate = Math.floor(Date.now() / 1000);
                        const fromDate = toDate - (60 * 24 * 60 * 60); // 60 days

                        const response = await fetch(
                            `${FINNHUB_API_BASE}/stock/candle?symbol=${selectedStock}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                        );
                        const data = await response.json();

                        if (data.s === 'ok' && data.c && data.c.length >= 52) {
                            const historicalData = {
                                closes: data.c,
                                highs: data.h,
                                lows: data.l,
                                volumes: data.v
                            };

                            // Calculate all advanced indicators
                            const ichimoku = window.advancedIndicators?.calculateIchimokuCloud(historicalData);
                            const fibonacci = window.advancedIndicators?.calculateFibonacciLevels(historicalData);
                            const volumeProfile = window.advancedIndicators?.calculateVolumeProfile(historicalData);
                            const adx = window.advancedIndicators?.calculateADX(historicalData);
                            const sar = window.advancedIndicators?.calculateParabolicSAR(historicalData);

                            return { ichimoku, fibonacci, volumeProfile, adx, sar, historicalData };
                        }
                    } catch (error) {
                        console.error('Ultra-advanced indicators error:', error);
                    }
                    return { ichimoku: null, fibonacci: null, volumeProfile: null, adx: null, sar: null, historicalData: null };
                };

                const { ichimoku, fibonacci, volumeProfile, adx, sar, historicalData } = await calculateUltraAdvancedIndicators();

                // FUNDAMENTAL ANALYSIS: Fetch company financials
                const fetchFundamentals = async () => {
                    try {
                        if (window.fundamentalAnalyzer) {
                            const fundamentals = await window.fundamentalAnalyzer.fetchCompanyFundamentals(selectedStock);
                            if (fundamentals) {
                                const analysis = window.fundamentalAnalyzer.analyzeFundamentals(fundamentals);
                                const dcf = window.fundamentalAnalyzer.calculateIntrinsicValue(fundamentals, price);
                                return { fundamentals, analysis, dcf };
                            }
                        }
                    } catch (error) {
                        console.error('Fundamentals error:', error);
                    }
                    return { fundamentals: null, analysis: null, dcf: null };
                };

                const { fundamentals, analysis: fundamentalAnalysis, dcf } = await fetchFundamentals();

                // Trend analysis from moving averages
                const trendSignal = ma50 && ma200 ?
                    (ma50 > ma200 && price > ma50 ? 'Strong Uptrend (Golden Cross)' :
                     ma50 > ma200 ? 'Uptrend' :
                     ma50 < ma200 && price < ma50 ? 'Strong Downtrend (Death Cross)' :
                     'Downtrend') :
                    (price > previousClose ? 'Upward' : 'Downward');

                // REAL CALCULATION: Intraday Volatility from high/low range
                const intradayVolatility = ((high - low) / low * 100);

                // REAL CALCULATION: Price momentum
                const momentum = ((price - open) / open * 100);

                // REAL CALCULATION: Support and Resistance from actual price action
                const support = ma50 ? Math.min(ma50, low * 0.98).toFixed(2) : (low * 0.98).toFixed(2);
                const resistance = ma50 ? Math.max(ma50 * 1.02, high * 1.02).toFixed(2) : (high * 1.02).toFixed(2);

                // TECHNICAL ANALYSIS based on real RSI and momentum
                const isOverbought = rsi > 70;
                const isOversold = rsi < 30;
                const technicalSignal = isOverbought ? 'Overbought - Consider Selling' :
                                       isOversold ? 'Oversold - Consider Buying' :
                                       rsi > 60 ? 'Strong Bullish' :
                                       rsi > 50 ? 'Bullish' :
                                       rsi < 40 ? 'Bearish' :
                                       rsi < 30 ? 'Strong Bearish' : 'Neutral';

                // REAL NEWS SENTIMENT ANALYSIS with weighted scoring
                let sentimentScore = 0;
                let positiveCount = 0;
                let negativeCount = 0;
                let neutralCount = 0;

                if (stockNews.length > 0) {
                    // Weight recent news more heavily (time decay factor)
                    stockNews.forEach((article, index) => {
                        const recencyWeight = 1 - (index / stockNews.length) * 0.3; // 30% decay

                        if (article.sentiment === 'positive') {
                            sentimentScore += 1 * recencyWeight;
                            positiveCount++;
                        } else if (article.sentiment === 'negative') {
                            sentimentScore -= 1 * recencyWeight;
                            negativeCount++;
                        } else {
                            neutralCount++;
                        }
                    });

                    // Normalize to -100 to +100 scale
                    sentimentScore = (sentimentScore / stockNews.length) * 100;
                }


                const newsSignal = sentimentScore > 50 ? 'Very Positive' :
                                  sentimentScore > 20 ? 'Positive' :
                                  sentimentScore < -50 ? 'Very Negative' :
                                  sentimentScore < -20 ? 'Negative' : 'Neutral';

                // REAL RISK ASSESSMENT
                const volatilityRisk = intradayVolatility > 5 ? 3 : intradayVolatility > 2 ? 2 : 1;
                const sentimentRisk = Math.abs(sentimentScore) > 70 ? 2 : Math.abs(sentimentScore) > 40 ? 1 : 0;
                const liquidityRisk = stockNews.length < 3 ? 2 : stockNews.length < 5 ? 1 : 0;
                const rsiRisk = (isOverbought || isOversold) ? 2 : 1;

                const totalRiskScore = volatilityRisk + sentimentRisk + liquidityRisk + rsiRisk;
                const riskLevel = totalRiskScore >= 7 ? 'High' : totalRiskScore >= 4 ? 'Moderate' : 'Low';
                const riskRating = totalRiskScore;


                // COMPREHENSIVE RECOMMENDATION based on multiple real factors
                const technicalScore = rsi > 50 ? (rsi - 50) / 10 : -(50 - rsi) / 10;
                const sentimentScoreNormalized = sentimentScore / 25; // Scale to similar range
                const momentumScore = momentum / 2;

                // Moving average trend score
                let trendScore = 0;
                if (ma50 && ma200) {
                    if (ma50 > ma200 && price > ma50) trendScore = 4; // Strong uptrend
                    else if (ma50 > ma200) trendScore = 2; // Uptrend
                    else if (ma50 < ma200 && price < ma50) trendScore = -4; // Strong downtrend
                    else trendScore = -2; // Downtrend
                } else if (ma50) {
                    trendScore = price > ma50 ? 2 : -2;
                }

                // MACD score
                let macdScore = 0;
                if (macd) {
                    if (macd.interpretation === 'bullish' && macd.histogram > 0) {
                        macdScore = 3; // Strong bullish
                    } else if (macd.interpretation === 'bullish') {
                        macdScore = 1.5; // Moderate bullish
                    } else if (macd.interpretation === 'bearish' && macd.histogram < 0) {
                        macdScore = -3; // Strong bearish
                    } else {
                        macdScore = -1.5; // Moderate bearish
                    }
                }

                // Bollinger Bands score
                let bbScore = 0;
                if (bb) {
                    if (bb.interpretation === 'oversold') {
                        bbScore = 2; // At lower band - buy signal
                    } else if (bb.interpretation === 'overbought') {
                        bbScore = -2; // At upper band - sell signal
                    }
                    if (bb.squeeze) {
                        bbScore += 1; // Volatility squeeze - potential breakout
                    }
                }

                // Adjust for overbought/oversold
                let adjustedTechnicalScore = technicalScore;
                if (isOverbought) adjustedTechnicalScore -= 3;
                if (isOversold) adjustedTechnicalScore += 3;

                // ULTRA-ADVANCED INDICATOR SCORES
                // Ichimoku Cloud Score
                let ichimokuScore = 0;
                if (ichimoku) {
                    ichimokuScore = (ichimoku.strength - 50) / 10; // Convert 0-100 to -5 to +5 scale
                }

                // Fibonacci Level Score
                let fibonacciScore = 0;
                if (fibonacci && fibonacci.atKeyLevel) {
                    fibonacciScore = fibonacci.signal === 'potential_bounce' ? 2 : -2;
                }

                // Volume Profile Score
                let volumeProfileScore = 0;
                if (volumeProfile) {
                    if (volumeProfile.signal === 'undervalued') volumeProfileScore = 2.5;
                    else if (volumeProfile.signal === 'overvalued') volumeProfileScore = -2.5;
                    else if (volumeProfile.signal === 'at_poc') volumeProfileScore = 0; // Fair value
                }

                // ADX Trend Strength Score
                let adxScore = 0;
                if (adx) {
                    const baseScore = (parseFloat(adx.adx) / 25); // Normalize ADX
                    adxScore = adx.trendDirection === 'bullish' ? baseScore : -baseScore;
                }

                // Parabolic SAR Score
                let sarScore = 0;
                if (sar) {
                    sarScore = (sar.signal - 50) / 10; // Convert 0-100 to -5 to +5 scale
                }

                // Fundamental Analysis Score
                let fundamentalScore = 0;
                if (fundamentalAnalysis) {
                    fundamentalScore = (fundamentalAnalysis.qualityScore - 50) / 10; // Convert to -5 to +5 scale
                }

                // DCF Intrinsic Value Score
                let dcfScore = 0;
                if (dcf && dcf.marginOfSafety) {
                    const margin = parseFloat(dcf.marginOfSafety);
                    if (margin > 20) dcfScore = 3;
                    else if (margin > 10) dcfScore = 2;
                    else if (margin > 0) dcfScore = 1;
                    else if (margin < -20) dcfScore = -3;
                    else if (margin < -10) dcfScore = -2;
                    else dcfScore = -1;
                }

                // ULTRATHINK COMPOSITE SCORE - New Weighted Formula
                // Weights: Technical(18%), Sentiment(15%), Momentum(12%), Trend(15%),
                //          MACD(10%), BB(6%), Ichimoku(8%), Fundamentals(8%), DCF(5%), ADX(3%)
                const compositeScore = (adjustedTechnicalScore * 0.18) + (sentimentScoreNormalized * 0.15) +
                                      (momentumScore * 0.12) + (trendScore * 0.15) +
                                      (macdScore * 0.10) + (bbScore * 0.06) +
                                      (ichimokuScore * 0.08) + (fundamentalScore * 0.08) +
                                      (dcfScore * 0.05) + (adxScore * 0.03);

                // Risk-adjusted confidence
                const riskAdjustment = riskLevel === 'High' ? -15 : riskLevel === 'Moderate' ? -5 : 0;

                const overallRecommendation = (() => {
                    if (compositeScore > 3) return { action: 'Strong Buy', confidence: Math.min(95, 80 + compositeScore + riskAdjustment), color: 'green' };
                    if (compositeScore > 1) return { action: 'Buy', confidence: Math.min(85, 70 + compositeScore + riskAdjustment), color: 'green' };
                    if (compositeScore < -3) return { action: 'Strong Sell', confidence: Math.min(90, 75 - compositeScore + riskAdjustment), color: 'red' };
                    if (compositeScore < -1) return { action: 'Sell', confidence: Math.min(80, 65 - compositeScore + riskAdjustment), color: 'red' };
                    return { action: 'Hold', confidence: Math.min(75, 55 + Math.abs(compositeScore) + riskAdjustment), color: 'yellow' };
                })();


                const atr = high - low; // Average True Range (simplified)
                const stopLossDistance = atr * 1.5;
                const takeProfitDistance = atr * 3; // 2:1 reward/risk ratio

                // POSITION SIZING - Calculate based on portfolio and risk tolerance
                const currentPortfolio = getCurrentPortfolio();
                const portfolioValue = calculatePortfolioValue(currentPortfolio);
                const riskPercentage = riskLevel === 'High' ? 0.01 : riskLevel === 'Moderate' ? 0.02 : 0.03; // 1-3% risk per trade
                const dollarRisk = portfolioValue * riskPercentage;
                const stopLossPercentage = (stopLossDistance / price) * 100;
                const suggestedShares = Math.floor(dollarRisk / stopLossDistance);
                const positionValue = suggestedShares * price;
                const positionSizePercent = ((positionValue / portfolioValue) * 100).toFixed(1);

                // ACTION TIMELINE - Determine urgency
                const now = new Date();
                const marketOpen = new Date(now);
                marketOpen.setHours(9, 30, 0, 0); // 9:30 AM
                const marketClose = new Date(now);
                marketClose.setHours(16, 0, 0, 0); // 4:00 PM
                const isMarketHours = now >= marketOpen && now <= marketClose && now.getDay() !== 0 && now.getDay() !== 6;
                const minutesToClose = isMarketHours ? Math.floor((marketClose - now) / 60000) : 0;

                const actionTiming = (() => {
                    if (overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Strong Sell') {
                        return isMarketHours ?
                            `EXECUTE NOW - High conviction signal. Act within next 30 minutes.` :
                            `PREPARE ORDER - Set limit order for market open tomorrow.`;
                    }
                    if (overallRecommendation.action === 'Buy') {
                        return isMarketHours ?
                            `BUY TODAY - Execute before close (${minutesToClose} minutes remaining) if price  $${(price * 1.01).toFixed(2)}` :
                            `SET ALERT - Enter if price drops to support at $${support} during next session.`;
                    }
                    if (overallRecommendation.action === 'Sell') {
                        return isMarketHours ?
                            `SELL TODAY - Exit position before close (${minutesToClose} minutes remaining)` :
                            `PREPARE EXIT - Set limit order to sell at market open.`;
                    }
                    return `WAIT - Monitor for price action confirmation. Set price alerts at $${support} (support) and $${resistance} (resistance).`;
                })();

                // SIGNAL STRENGTH - 0-100 scale combining all factors
                const signalStrength = Math.round(Math.max(0, Math.min(100,
                    50 + (compositeScore * 8) + (overallRecommendation.confidence - 50) / 2
                )));

                // MULTI-SCENARIO EXIT PLANS
                const bullTarget = (price + takeProfitDistance).toFixed(2);
                const baseTarget = (price + takeProfitDistance * 0.65).toFixed(2);
                const stopLossPrice = Math.max(0, price - stopLossDistance).toFixed(2);
                const emergencyStop = Math.max(0, price * 0.92).toFixed(2); // 8% hard stop

                const exitPlan = {
                    bull: {
                        target: bullTarget,
                        gain: ((bullTarget - price) / price * 100).toFixed(1),
                        action: `Price reaches $${bullTarget}  Sell 50% of position, move stop-loss to breakeven ($${price.toFixed(2)}), let remaining 50% run with 5% trailing stop`
                    },
                    base: {
                        target: baseTarget,
                        gain: ((baseTarget - price) / price * 100).toFixed(1),
                        action: `Price reaches $${baseTarget}  Sell 75% of position, keep 25% with stop at $${(price * 1.03).toFixed(2)}`
                    },
                    bear: {
                        target: stopLossPrice,
                        loss: ((stopLossPrice - price) / price * 100).toFixed(1),
                        action: `Price drops to $${stopLossPrice}  Exit 100% immediately (planned stop-loss)`
                    },
                    emergency: {
                        target: emergencyStop,
                        loss: '-8.0',
                        action: `Price drops to $${emergencyStop}  EMERGENCY EXIT 100% (hard stop, no exceptions)`
                    }
                };

                // NATURAL LANGUAGE ACTION SUMMARY
                const orderType = Math.abs(momentum) > 2 ? 'market order' : `limit order at $${(price * (overallRecommendation.action.includes('Buy') ? 1.005 : 0.995)).toFixed(2)}`;
                const timeframe = overallRecommendation.action.includes('Strong') ? 'immediately' :
                                 isMarketHours ? 'before market close today' : 'at market open tomorrow';

                const actionSummary = (() => {
                    if (overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Buy') {
                        return `${overallRecommendation.action.toUpperCase()} ${suggestedShares} shares of ${selectedStock} ${timeframe} using ${orderType} ($${price.toFixed(2)} range), set stop-loss at $${stopLossPrice}, target $${bullTarget}, hold for ${Math.ceil(takeProfitDistance / (price * 0.02))} - ${Math.ceil(takeProfitDistance / (price * 0.01))} trading days. Position size: $${positionValue.toFixed(0)} (${positionSizePercent}% of portfolio).`;
                    }
                    if (overallRecommendation.action === 'Strong Sell' || overallRecommendation.action === 'Sell') {
                        return `${overallRecommendation.action.toUpperCase()} your ${selectedStock} position ${timeframe} using ${orderType}. Current price: $${price.toFixed(2)}. ${isOverbought ? 'Stock is overbought (RSI: ' + rsi.toFixed(1) + ')' : 'Downward momentum detected'}. Set stop-buy at $${resistance} in case trend reverses.`;
                    }
                    return `HOLD - Do not enter ${selectedStock} position yet. Current price: $${price.toFixed(2)} shows mixed signals (confidence: ${overallRecommendation.confidence}%). Wait for confirmation. Set alerts: BUY if price breaks above $${resistance} with volume, or SELL if drops below $${support}.`;
                })();

                // EXECUTION CHECKLIST
                const checklist = [
                    { task: `Verify current ${selectedStock} price (target: $${price.toFixed(2)})`, checked: false },
                    { task: `Confirm available cash: $${(portfolioValue * 0.1).toFixed(0)}+ available`, checked: false },
                    { task: `Set stop-loss order at $${stopLossPrice} (-${stopLossPercentage.toFixed(1)}%)`, checked: false },
                    { task: `Set take-profit alert at $${bullTarget} (+${((bullTarget - price) / price * 100).toFixed(1)}%)`, checked: false },
                    { task: `Position size confirmed: ${suggestedShares} shares = ${positionSizePercent}% of portfolio`, checked: false },
                    { task: `Review latest news (${stockNews.length} articles analyzed, sentiment: ${newsSignal})`, checked: false }
                ];

                // CATALYST-BASED TRIGGERS - Event-driven trading signals
                const catalysts = [];

                // Check for upcoming earnings (simulate - typically 45 days between earnings)
                const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
                const daysUntilEarnings = 45 - (dayOfYear % 45);
                if (daysUntilEarnings <= 14) {
                    const earningsDate = new Date(now);
                    earningsDate.setDate(earningsDate.getDate() + daysUntilEarnings);
                    catalysts.push({
                        type: 'earnings',
                        title: 'Earnings Report',
                        daysAway: daysUntilEarnings,
                        date: earningsDate.toLocaleDateString(),
                        impact: daysUntilEarnings <= 3 ? 'high' : daysUntilEarnings <= 7 ? 'medium' : 'low',
                        recommendation: daysUntilEarnings <= 3 ?
                            ` WAIT - Earnings in ${daysUntilEarnings} days. High volatility expected. Consider entering AFTER report if results beat expectations by 5%+` :
                            ` WATCH - Earnings in ${daysUntilEarnings} days. ${overallRecommendation.action.includes('Buy') ? 'Can enter now but reduce position size by 50% due to earnings risk' : 'Monitor for post-earnings entry opportunity'}`
                    });
                }

                // News-based catalysts
                if (stockNews.length > 0) {
                    const recentPositive = stockNews.filter(n => n.sentiment === 'positive').length;
                    const recentNegative = stockNews.filter(n => n.sentiment === 'negative').length;

                    if (recentPositive >= 5 && sentimentScore > 60) {
                        catalysts.push({
                            type: 'news',
                            title: 'Strong Positive News Flow',
                            daysAway: 0,
                            date: 'Ongoing',
                            impact: 'high',
                            recommendation: ` BUY NOW - ${recentPositive} positive articles in recent cycle creating momentum. Strike while sentiment is hot. Set alerts for sentiment reversal.`
                        });
                    } else if (recentNegative >= 5 && sentimentScore < -60) {
                        catalysts.push({
                            type: 'news',
                            title: 'Negative News Cycle',
                            daysAway: 0,
                            date: 'Ongoing',
                            impact: 'high',
                            recommendation: ` AVOID - ${recentNegative} negative articles indicate trouble. Wait 2-3 weeks for sentiment to stabilize before considering entry.`
                        });
                    }
                }

                // Technical breakout catalysts
                if (price >= parseFloat(resistance) * 0.98) {
                    catalysts.push({
                        type: 'technical',
                        title: 'Approaching Resistance Breakout',
                        daysAway: 0,
                        date: 'Imminent',
                        impact: 'medium',
                        recommendation: ` SET ALERT - Price near resistance ($${resistance}). If breaks above with volume, BUY immediately. Target +${((parseFloat(resistance) * 1.1 - price) / price * 100).toFixed(1)}% move.`
                    });
                } else if (price <= parseFloat(support) * 1.02) {
                    catalysts.push({
                        type: 'technical',
                        title: 'Testing Support Level',
                        daysAway: 0,
                        date: 'Imminent',
                        impact: 'medium',
                        recommendation: ` BUYING OPPORTUNITY - Price testing support ($${support}). ${overallRecommendation.action.includes('Buy') ? 'Strong buy zone if support holds' : 'Wait for bounce confirmation before entering'}. Set stop below $${(parseFloat(support) * 0.97).toFixed(2)}.`
                    });
                }

                // RSI extreme catalysts
                if (rsi >= 75) {
                    catalysts.push({
                        type: 'technical',
                        title: 'Extremely Overbought (RSI)',
                        daysAway: 0,
                        date: 'Current',
                        impact: 'high',
                        recommendation: ` TAKE PROFITS - RSI at ${rsi.toFixed(1)} indicates extreme overbought. If holding, sell 50-75% here. If not holding, wait for pullback to RSI 50-60 before entering.`
                    });
                } else if (rsi <= 25) {
                    catalysts.push({
                        type: 'technical',
                        title: 'Extremely Oversold (RSI)',
                        daysAway: 0,
                        date: 'Current',
                        impact: 'high',
                        recommendation: ` STRONG BUY ZONE - RSI at ${rsi.toFixed(1)} indicates extreme oversold. High probability bounce incoming. Enter with 50% position now, add remaining 50% if RSI crosses above 30.`
                    });
                }

                // Moving average catalysts
                if (ma50 && ma200 && Math.abs(ma50 - ma200) / ma200 < 0.02 && price > ma50) {
                    if (ma50 > ma200) {
                        catalysts.push({
                            type: 'technical',
                            title: 'Potential Golden Cross',
                            daysAway: 0,
                            date: 'Forming',
                            impact: 'high',
                            recommendation: ` STRONG BUY - 50-day MA ($${ma50.toFixed(2)}) crossing above 200-day MA ($${ma200.toFixed(2)}). Golden Cross pattern = strong bullish signal. Target +15-20% over next 2-3 months.`
                        });
                    }
                } else if (ma50 && ma200 && Math.abs(ma50 - ma200) / ma200 < 0.02 && price < ma50) {
                    if (ma50 < ma200) {
                        catalysts.push({
                            type: 'technical',
                            title: 'Death Cross Warning',
                            daysAway: 0,
                            date: 'Forming',
                            impact: 'high',
                            recommendation: ` EXIT NOW - 50-day MA ($${ma50.toFixed(2)}) crossing below 200-day MA ($${ma200.toFixed(2)}). Death Cross pattern = strong bearish signal. Exit all positions. Re-evaluate in 1-2 months.`
                        });
                    }
                }

                // Market hours catalyst
                if (!isMarketHours && (overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Strong Sell')) {
                    catalysts.push({
                        type: 'timing',
                        title: 'Market Closed - High Conviction Signal',
                        daysAway: 0,
                        date: 'Next Open',
                        impact: 'medium',
                        recommendation: ` PREPARE ORDER - Market currently closed. ${overallRecommendation.action} signal with ${overallRecommendation.confidence}% confidence. Set limit order for market open at $${(price * (overallRecommendation.action.includes('Buy') ? 1.005 : 0.995)).toFixed(2)} to execute at open.`
                    });
                }

                const analysis = {
                    symbol: selectedStock,
                    name: stock.name,
                    timestamp: new Date().toLocaleString(),

                    // NEW: Action Summary (Top Priority)
                    actionSummary,
                    actionTiming,
                    signalStrength,

                    // NEW: Position Sizing
                    positionSizing: {
                        suggestedShares,
                        positionValue: positionValue.toFixed(2),
                        positionPercent: positionSizePercent,
                        dollarRisk: dollarRisk.toFixed(2),
                        riskPercent: (riskPercentage * 100).toFixed(1),
                        stopLossPercent: stopLossPercentage.toFixed(2)
                    },

                    // NEW: Exit Plan
                    exitPlan,

                    // NEW: Execution Checklist
                    checklist,

                    // NEW: Catalyst-Based Triggers
                    catalysts,

                    // NEW: Advanced Technical Indicators
                    advancedIndicators: {
                        ichimoku,
                        fibonacci,
                        volumeProfile,
                        adx,
                        sar
                    },

                    // NEW: Fundamental Analysis
                    fundamentalAnalysis,
                    dcf,

                    technical: {
                        signal: technicalSignal,
                        trend: trendSignal,
                        priceChange: priceChange.toFixed(2),
                        currentPrice: price.toFixed(2),
                        support: support,
                        resistance: resistance,
                        rsi: rsi.toFixed(1),
                        ma50: ma50?.toFixed(2) || 'N/A',
                        ma200: ma200?.toFixed(2) || 'N/A',
                        momentum: momentum.toFixed(2),
                        volatility: intradayVolatility.toFixed(2),
                        open: open.toFixed(2),
                        high: high.toFixed(2),
                        low: low.toFixed(2),
                        previousClose: previousClose.toFixed(2)
                    },

                    sentiment: {
                        signal: newsSignal,
                        score: sentimentScore.toFixed(0),
                        articlesAnalyzed: stockNews.length,
                        positiveCount,
                        negativeCount,
                        neutralCount,
                        trending: stockNews.length > 10 ? 'Very High Interest' :
                                 stockNews.length > 5 ? 'High Interest' :
                                 stockNews.length > 2 ? 'Moderate Interest' : 'Low Interest'
                    },

                    risk: {
                        level: riskLevel,
                        rating: riskRating,
                        volatilityRisk,
                        sentimentRisk,
                        liquidityRisk,
                        factors: [
                            `Volatility: ${intradayVolatility.toFixed(2)}% intraday range (${volatilityRisk === 3 ? 'High' : volatilityRisk === 2 ? 'Moderate' : 'Low'} risk)`,
                            `Sentiment: ${Math.abs(sentimentScore).toFixed(0)} intensity (${sentimentRisk === 2 ? 'High' : sentimentRisk === 1 ? 'Moderate' : 'Low'} risk)`,
                            `Liquidity: ${stockNews.length} news articles (${liquidityRisk === 2 ? 'High' : liquidityRisk === 1 ? 'Moderate' : 'Low'} risk)`,
                            `RSI: ${rsi.toFixed(1)} ${isOverbought ? '(Overbought)' : isOversold ? '(Oversold)' : '(Normal)'}`
                        ]
                    },

                    recommendation: {
                        action: overallRecommendation.action,
                        confidence: overallRecommendation.confidence.toFixed(1),
                        color: overallRecommendation.color,
                        reasoning: [
                            ` Real 14-day RSI at ${rsi.toFixed(1)} shows ${technicalSignal.toLowerCase()} conditions with ${momentum >= 0 ? 'positive' : 'negative'} momentum (${momentum >= 0 ? '+' : ''}${momentum.toFixed(2)}% from open)`,
                            ` Trend Analysis: ${trendSignal}${ma50 && ma200 ? ` (MA50: $${ma50.toFixed(2)}, MA200: $${ma200.toFixed(2)}, Current: $${price.toFixed(2)})` : ''}`,
                            macd ? ` MACD: ${macd.interpretation} signal (Histogram: ${macd.histogram > 0 ? '+' : ''}${macd.histogram.toFixed(2)})` : null,
                            bb ? ` Bollinger Bands: ${bb.interpretation} (Price at ${(bb.percentB * 100).toFixed(0)}% of bands${bb.squeeze ? ', volatility squeeze detected' : ''})` : null,
                            ` Sentiment analysis of ${stockNews.length} articles: ${positiveCount} positive, ${negativeCount} negative, ${neutralCount} neutral (Score: ${sentimentScore.toFixed(0)}/100)`,
                            ` Intraday volatility at ${intradayVolatility.toFixed(2)}% with ${riskLevel.toLowerCase()} risk profile (Risk score: ${riskRating}/10)`,
                            ` ${overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Buy' ?
                                `Multiple indicators align for bullish entry. ${trendSignal.includes('Uptrend') ? 'Trend supports upward move.' : ''} Consider ${momentum > 0 ? 'buying on strength' : 'buying on dips near support at $${support}'}` :
                                overallRecommendation.action === 'Strong Sell' || overallRecommendation.action === 'Sell' ?
                                `Multiple indicators suggest caution. ${trendSignal.includes('Downtrend') ? 'Trend shows weakness.' : ''} ${isOverbought ? 'RSI overbought suggests profit-taking' : 'Consider protective stops or exit strategies'}` :
                                `Mixed signals warrant patience. ${trendSignal} trend requires confirmation. Wait for ${rsi < 50 ? 'upward momentum' : 'clearer direction'} before committing capital`}`
                        ].filter(r => r !== null),
                        strategy: overallRecommendation.action === 'Strong Buy' || overallRecommendation.action === 'Buy' ?
                                'Long position with tight stops' :
                                overallRecommendation.action === 'Strong Sell' || overallRecommendation.action === 'Sell' ?
                                'Exit or short with defined risk' : 'Cash or wait for setup',
                        targets: {
                            entry: price.toFixed(2),
                            stopLoss: Math.max(0, price - stopLossDistance).toFixed(2),
                            takeProfit: (price + takeProfitDistance).toFixed(2),
                            riskRewardRatio: '2:1'
                        }
                    }
                };

                setAiAnalysis(analysis);
                setLoadingAnalysis(false);
            };

            // 
            // ULTRATHINK V2.5 - PREDICTIVE AI & MARKET INTELLIGENCE
            // 

            // Fetch price prediction for a specific stock
            const fetchStockPrediction = async (symbol) => {
                try {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (!stock) {
                        console.log('Stock not found:', symbol);
                        return null;
                    }

                    // Check if enhancedAI is loaded
                    if (!window.enhancedAI || !window.enhancedAI.predictNextWeekPrice) {
                        console.warn(' Enhanced AI not loaded yet. Waiting...');
                        // Wait for script to load
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // Try again after waiting
                        if (!window.enhancedAI || !window.enhancedAI.predictNextWeekPrice) {
                            console.error(' Enhanced AI failed to load');
                            return null;
                        }
                    }

                    // Fetch historical data
                    const toDate = Math.floor(Date.now() / 1000);
                    const fromDate = toDate - (30 * 24 * 60 * 60);

                    const response = await fetch(
                        `${FINNHUB_API_BASE}/stock/candle?symbol=${symbol}&resolution=D&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                    );
                    const data = await response.json();

                    if (data.s === 'ok') {
                        const historicalData = {
                            closes: data.c || [],
                            highs: data.h || [],
                            lows: data.l || [],
                            volumes: data.v || []
                        };

                        console.log(` Generating prediction for ${symbol}...`);
                        const prediction = window.enhancedAI.predictNextWeekPrice(stock, historicalData);

                        if (prediction) {
                            console.log(` Prediction generated for ${symbol}:`, prediction);
                            setStockPredictions(prev => ({
                                ...prev,
                                [symbol]: prediction
                            }));
                            return prediction;
                        } else {
                            console.warn(` No prediction returned for ${symbol}`);
                        }
                    } else {
                        console.warn(` Failed to fetch historical data for ${symbol}:`, data);
                    }
                } catch (error) {
                    console.error(` Error fetching prediction for ${symbol}:`, error);
                }
                return null;
            };

            // Auto-generate AI analysis when stock is selected in AI Analysis tab
            useEffect(() => {
                if (selectedStock && mainTab === 'ai-analysis' && !aiAnalysis && !loadingAnalysis) {
                    // Auto-generate analysis when entering AI Analysis tab with a selected stock
                    const autoGenerate = setTimeout(() => {
                        generateAIAnalysis();
                    }, 500); // Small delay to prevent rapid re-renders

                    return () => clearTimeout(autoGenerate);
                }
            }, [selectedStock, mainTab]);

            // Auto-fetch prediction when stock is selected in Trading tab
            useEffect(() => {
                if (selectedStock && mainTab === 'trading' && !stockPredictions[selectedStock]) {
                    console.log(` Trading tab: Auto-fetching prediction for ${selectedStock}`);
                    fetchStockPrediction(selectedStock);
                }
            }, [selectedStock, mainTab]);

            // Market Hours Detection Functions
            const getEasterDate = (year) => {
                // Simplified Easter calculation (Meeus/Jones/Butcher algorithm)
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31) - 1; // 0-indexed
                const day = ((h + l - 7 * m + 114) % 31) + 1;
                return new Date(year, month, day);
            };

            const isMarketHoliday = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-indexed
                const day = date.getDate();
                const dayOfWeek = date.getDay();

                // Fixed holidays
                const holidays = {
                    'New Year\'s Day': month === 0 && day === 1,
                    'Juneteenth': month === 5 && day === 19,
                    'Independence Day': month === 6 && day === 4,
                    'Christmas': month === 11 && day === 25
                };

                for (const [name, isHoliday] of Object.entries(holidays)) {
                    if (isHoliday) {
                        setCurrentHoliday(name);
                        return true;
                    }
                }

                // MLK Day - 3rd Monday in January
                if (month === 0 && dayOfWeek === 1) {
                    const weekOfMonth = Math.ceil(day / 7);
                    if (weekOfMonth === 3) {
                        setCurrentHoliday('Martin Luther King Jr. Day');
                        return true;
                    }
                }

                // Presidents Day - 3rd Monday in February
                if (month === 1 && dayOfWeek === 1) {
                    const weekOfMonth = Math.ceil(day / 7);
                    if (weekOfMonth === 3) {
                        setCurrentHoliday('Presidents\' Day');
                        return true;
                    }
                }

                // Memorial Day - Last Monday in May
                if (month === 4 && dayOfWeek === 1) {
                    const nextWeek = new Date(date);
                    nextWeek.setDate(day + 7);
                    if (nextWeek.getMonth() !== 4) {
                        setCurrentHoliday('Memorial Day');
                        return true;
                    }
                }

                // Labor Day - 1st Monday in September
                if (month === 8 && dayOfWeek === 1 && day <= 7) {
                    setCurrentHoliday('Labor Day');
                    return true;
                }

                // Thanksgiving - 4th Thursday in November
                if (month === 10 && dayOfWeek === 4) {
                    const weekOfMonth = Math.ceil(day / 7);
                    if (weekOfMonth === 4) {
                        setCurrentHoliday('Thanksgiving Day');
                        return true;
                    }
                }

                // Good Friday - Friday before Easter
                const easter = getEasterDate(year);
                const goodFriday = new Date(easter);
                goodFriday.setDate(easter.getDate() - 2);
                if (month === goodFriday.getMonth() && day === goodFriday.getDate()) {
                    setCurrentHoliday('Good Friday');
                    return true;
                }

                setCurrentHoliday(null);
                return false;
            };

            const isMarketOpenNow = () => {
                const now = new Date();
                const etTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));

                const day = etTime.getDay(); // 0 = Sunday, 6 = Saturday
                const hours = etTime.getHours();
                const minutes = etTime.getMinutes();

                if (day === 0 || day === 6) return false;

                if (isMarketHoliday(etTime)) return false;

                const currentTime = hours * 60 + minutes; // Convert to minutes
                const marketOpen = 9 * 60 + 30; // 9:30 AM in minutes
                const marketClose = 16 * 60; // 4:00 PM in minutes

                return currentTime >= marketOpen && currentTime < marketClose;
            };

            const getNextMarketOpen = () => {
                const now = new Date();
                let nextOpen = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));

                // If currently during market hours, return today's close time for countdown purposes
                if (isMarketOpenNow()) {
                    nextOpen.setHours(16, 0, 0, 0); // Market closes at 4:00 PM
                    return nextOpen;
                }

                // Start checking from tomorrow if after hours today
                const hours = nextOpen.getHours();
                const minutes = nextOpen.getMinutes();
                const currentTime = hours * 60 + minutes;

                if (currentTime >= 16 * 60) {
                    // After market close, check next day
                    nextOpen.setDate(nextOpen.getDate() + 1);
                }

                // Find next valid trading day
                let attempts = 0;
                while (attempts < 10) { // Safety limit
                    nextOpen.setHours(9, 30, 0, 0);

                    const day = nextOpen.getDay();
                    if (day === 0 || day === 6) {
                        // Skip weekends
                        nextOpen.setDate(nextOpen.getDate() + 1);
                        attempts++;
                        continue;
                    }

                    if (isMarketHoliday(nextOpen)) {
                        // Skip holidays
                        nextOpen.setDate(nextOpen.getDate() + 1);
                        attempts++;
                        continue;
                    }

                    break;
                }

                return nextOpen;
            };

            const formatCountdown = (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                if (hours > 24) {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    return `${days}d ${remainingHours}h ${minutes}m`;
                }

                if (hours > 0) {
                    return `${hours}h ${minutes}m ${seconds}s`;
                }

                return `${minutes}m ${seconds}s`;
            };

            useEffect(() => {
                const updateMarketStatus = () => {
                    const isOpen = isMarketOpenNow();
                    setMarketOpen(isOpen);

                    const nextChange = getNextMarketOpen();
                    const now = new Date();
                    const etNow = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                    const timeDiff = nextChange - etNow;

                    setTimeUntilChange(formatCountdown(timeDiff));

                    const options = {
                        weekday: 'long',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        timeZone: 'America/New_York'
                    };
                    setNextMarketOpenTime(nextChange.toLocaleString('en-US', options) + ' ET');
                };

                // Initial update
                updateMarketStatus();

                const interval = setInterval(updateMarketStatus, 1000);

                return () => clearInterval(interval);
            }, []);

            const executeTrade = async (type) => {
                if (!selectedStock || quantity <= 0) return;

                if (!marketOpen) {
                    showToast(`Market is closed. ${currentHoliday ? `Today is ${currentHoliday}.` : ''} Next trading session: ${nextMarketOpenTime}`, 'error', 8000);
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    showToast('Stock data not available. Please add to watchlist and refresh.', 'error');
                    return;
                }

                // Use bid/ask spread for realistic execution
                // BUY at ASK price (you pay what sellers want)
                // SELL at BID price (you receive what buyers will pay)
                const executionPrice = type === 'buy' ? (stock.ask || stock.price) : (stock.bid || stock.price);
                const totalCost = executionPrice * quantity;
                const portfolio = getCurrentPortfolio();
                const COOLDOWN_MINUTES = 15;
                const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;

                // No trading fees
                const tradingFee = 0;

                if (type === 'buy') {
                    const totalWithFee = totalCost;
                    if (totalWithFee > portfolio.cash) {
                        showToast(`Insufficient funds! Total: $${totalWithFee.toFixed(2)} - You have $${portfolio.cash.toFixed(2)} available.`, 'error');
                        return;
                    }
                } else {
                    // SELL - Check position
                    const currentPosition = portfolio.positions[selectedStock] || 0;
                    if (quantity > currentPosition) {
                        showToast(`Insufficient shares! You only own ${currentPosition} shares of ${selectedStock}`, 'error');
                        return;
                    }

                    const lastBuyTime = portfolio.lastBuyTime?.[selectedStock];
                    if (lastBuyTime) {
                        const timeSinceBuy = Date.now() - new Date(lastBuyTime).getTime();
                        const minutesSinceBuy = Math.floor(timeSinceBuy / 60000);

                        if (timeSinceBuy < COOLDOWN_MS) {
                            const minutesRemaining = COOLDOWN_MINUTES - minutesSinceBuy;
                            const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceBuy) / 1000) % 60;
                            showToast(` Trading Cooldown! Wait ${minutesRemaining}m ${secondsRemaining}s before selling ${selectedStock}`, 'warning', 8000);
                            return;
                        }
                    }
                }

                // For sell trades, find the original buy price and timestamp
                let buyPrice = stock.price;
                let buyTimestamp = Date.now();
                if (type === 'sell') {
                    // Find the most recent buy trade for this stock
                    const buyTrades = portfolio.history.filter(h =>
                        h.type === 'buy' &&
                        h.symbol === selectedStock
                    ).reverse(); // Get most recent first

                    if (buyTrades.length > 0) {
                        // Use the average buy price if multiple buys
                        const totalShares = buyTrades.reduce((sum, t) => sum + t.quantity, 0);
                        const totalCost = buyTrades.reduce((sum, t) => sum + (t.price * t.quantity), 0);
                        buyPrice = totalCost / totalShares;
                        buyTimestamp = new Date(buyTrades[0].timestamp).getTime();
                    }
                }

                // Calculate cost basis (Average method)
                const costBasis = portfolio.costBasis || {};
                let newCostBasis = {...costBasis};

                if (type === 'buy') {
                    // Update average cost basis on buy
                    const currentShares = portfolio.positions[selectedStock] || 0;
                    const currentAvgCost = costBasis[selectedStock] || 0;
                    const currentTotalCost = currentShares * currentAvgCost;
                    const newTotalCost = currentTotalCost + totalCost;
                    const newTotalShares = currentShares + quantity;
                    newCostBasis[selectedStock] = newTotalShares > 0 ? newTotalCost / newTotalShares : 0;
                } else {
                    // On sell, keep same average cost basis (don't change)
                    // Cost basis remains until position fully closed
                    const remainingShares = (portfolio.positions[selectedStock] || 0) - quantity;
                    if (remainingShares <= 0) {
                        delete newCostBasis[selectedStock]; // Position closed, remove cost basis
                    }
                }

                const updatedPortfolio = {
                    ...portfolio,
                    cash: type === 'buy'
                        ? portfolio.cash - totalCost
                        : portfolio.cash + totalCost,
                    positions: {
                        ...portfolio.positions,
                        [selectedStock]: type === 'buy'
                            ? (portfolio.positions[selectedStock] || 0) + quantity
                            : (portfolio.positions[selectedStock] || 0) - quantity
                    },
                    costBasis: newCostBasis,  // Track average cost basis per position
                    history: [...portfolio.history, {
                        type,
                        symbol: selectedStock,
                        quantity,
                        price: executionPrice,  // Use actual execution price (bid/ask)
                        total: totalCost,
                        fee: tradingFee,
                        timestamp: new Date().toISOString(),
                        // Store buy price and timestamp for analysis
                        buyPrice: type === 'sell' ? buyPrice : executionPrice,
                        buyTimestamp: type === 'sell' ? buyTimestamp : Date.now()
                    }],
                    lastBuyTime: type === 'buy'
                        ? { ...portfolio.lastBuyTime, [selectedStock]: new Date().toISOString() }
                        : portfolio.lastBuyTime
                };

                setCompetition(prev => ({
                    ...prev,
                    members: prev.members.map(m =>
                        m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                    )
                }));

                // Sync to backend server
                savePortfolioToDatabase(updatedPortfolio);

                // Show success toast
                const tradeIcon = type === 'buy' ? '' : '';
                const tradeAction = type === 'buy' ? 'Bought' : 'Sold';
                const priceType = type === 'buy' ? 'ASK' : 'BID';
                showToast(`${tradeIcon} ${tradeAction} ${quantity} shares of ${selectedStock} at $${executionPrice.toFixed(2)} (${priceType})`, 'success');

                if (type === 'sell') {
                    const analysis = generateTradeAnalysis(stock, buyPrice, stock.price, quantity, buyTimestamp);
                    setTradeAnalysisData(analysis);
                    setShowTradeAnalysis(true);
                }

                setSaveStatus('saved');
                setLastSaved(new Date());

                setQuantity(1);
                setQuantityError('');
            };

            // AI Trade Analysis Functions
            const calculateOptimalSellPrice = (stock, buyTimestamp, sellTimestamp) => {
                // In a real implementation, this would check historical data
                // For simulation, we'll estimate based on current stock data
                const currentPrice = stock.price;
                const priceVolatility = Math.abs(stock.change) / 100;

                // Simulate peak price during hold period (could be higher or lower)
                const peakMultiplier = 1 + (Math.random() * priceVolatility * 2);
                return currentPrice * peakMultiplier;
            };

            const calculateOverallGrade = (profitPercent, missedProfitPercent, holdDurationHours) => {
                let score = 0;

                // Profit/Loss scoring (50 points)
                if (profitPercent > 10) score += 50;
                else if (profitPercent > 5) score += 40;
                else if (profitPercent > 2) score += 30;
                else if (profitPercent > 0) score += 20;
                else if (profitPercent > -5) score += 10;
                else score += 0;

                // Timing scoring (30 points)
                if (missedProfitPercent < 2) score += 30;
                else if (missedProfitPercent < 5) score += 20;
                else if (missedProfitPercent < 10) score += 10;
                else score += 0;

                // Hold duration scoring (20 points)
                if (holdDurationHours >= 2) score += 20;
                else if (holdDurationHours >= 1) score += 15;
                else if (holdDurationHours >= 0.5) score += 10;
                else score += 5;

                if (score >= 90) return { grade: 'A+', color: '#10b981' };
                if (score >= 85) return { grade: 'A', color: '#10b981' };
                if (score >= 80) return { grade: 'A-', color: '#10b981' };
                if (score >= 75) return { grade: 'B+', color: '#22c55e' };
                if (score >= 70) return { grade: 'B', color: '#84cc16' };
                if (score >= 65) return { grade: 'B-', color: '#eab308' };
                if (score >= 60) return { grade: 'C+', color: '#f59e0b' };
                if (score >= 55) return { grade: 'C', color: '#f59e0b' };
                if (score >= 50) return { grade: 'C-', color: '#ef4444' };
                if (score >= 40) return { grade: 'D', color: '#dc2626' };
                return { grade: 'F', color: '#991b1b' };
            };

            const generateTradeAnalysis = (stock, buyPrice, sellPrice, shares, buyTimestamp) => {
                const sellTimestamp = Date.now();
                const profitLoss = (sellPrice - buyPrice) * shares;
                const profitPercent = ((sellPrice - buyPrice) / buyPrice) * 100;
                const holdDuration = sellTimestamp - buyTimestamp;
                const holdDurationHours = holdDuration / (1000 * 60 * 60);
                const holdDurationMinutes = Math.floor(holdDuration / (1000 * 60));

                const optimalPrice = calculateOptimalSellPrice(stock, buyTimestamp, sellTimestamp);
                const missedProfit = (optimalPrice - sellPrice) * shares;
                const missedProfitPercent = ((optimalPrice - sellPrice) / sellPrice) * 100;

                // Determine timing quality
                let timingFeedback, timingGrade, timingColor;
                if (missedProfit < 0) {
                    timingFeedback = `Perfect timing! Stock dropped ${Math.abs(missedProfitPercent).toFixed(1)}% after you sold.`;
                    timingGrade = "A+";
                    timingColor = "#10b981";
                } else if (missedProfitPercent < 2) {
                    timingFeedback = "Excellent timing! You captured nearly all available gains.";
                    timingGrade = "A";
                    timingColor = "#10b981";
                } else if (missedProfitPercent < 5) {
                    timingFeedback = `Good timing! You left only ${missedProfitPercent.toFixed(1)}% on the table.`;
                    timingGrade = "B";
                    timingColor = "#22c55e";
                } else if (missedProfitPercent < 10) {
                    timingFeedback = `Decent timing, but you missed ${missedProfitPercent.toFixed(1)}% more gains.`;
                    timingGrade = "C";
                    timingColor = "#eab308";
                } else {
                    timingFeedback = `You sold too early! You could have made $${Math.abs(missedProfit).toFixed(2)} more (${missedProfitPercent.toFixed(1)}%).`;
                    timingGrade = "D";
                    timingColor = "#ef4444";
                }

                const insights = [];

                if (profitPercent > 10) {
                    insights.push({
                        icon: "",
                        text: "Excellent profit! You're showing strong stock picking skills.",
                        type: "success"
                    });
                } else if (profitPercent > 5) {
                    insights.push({
                        icon: "",
                        text: "Solid profit! Keep up the good work.",
                        type: "success"
                    });
                } else if (profitPercent > 0) {
                    insights.push({
                        icon: "",
                        text: "Profitable trade, but aim for higher returns.",
                        type: "neutral"
                    });
                }

                if (holdDurationHours < 0.5) {
                    insights.push({
                        icon: "",
                        text: `Very short hold (${holdDurationMinutes}min). Consider holding longer for bigger gains.`,
                        type: "warning"
                    });
                } else if (holdDurationHours < 1) {
                    insights.push({
                        icon: "",
                        text: "Quick trade. Make sure you're not overtrading.",
                        type: "neutral"
                    });
                }

                if (profitPercent < -5) {
                    insights.push({
                        icon: "",
                        text: "Consider using stop-losses at -5% to protect your capital.",
                        type: "warning"
                    });
                } else if (profitPercent < -2) {
                    insights.push({
                        icon: "",
                        text: "Small loss. Review why the trade didn't work out.",
                        type: "warning"
                    });
                }

                if (missedProfitPercent > 10) {
                    insights.push({
                        icon: "",
                        text: "You're selling winning positions too early. Be more patient!",
                        type: "tip"
                    });
                }

                if (profitPercent > 0 && missedProfitPercent < 5) {
                    insights.push({
                        icon: "",
                        text: "Great exit! You timed this sale very well.",
                        type: "success"
                    });
                }

                const gradeInfo = calculateOverallGrade(profitPercent, Math.abs(missedProfitPercent), holdDurationHours);

                return {
                    stock: stock.symbol,
                    stockName: stock.name || getStockName(stock.symbol),
                    buyPrice: buyPrice.toFixed(2),
                    sellPrice: sellPrice.toFixed(2),
                    shares,
                    profitLoss: profitLoss.toFixed(2),
                    profitPercent: profitPercent.toFixed(2),
                    holdDuration,
                    holdDurationFormatted: holdDurationHours >= 1
                        ? `${holdDurationHours.toFixed(1)} hours`
                        : `${holdDurationMinutes} minutes`,
                    optimalPrice: optimalPrice.toFixed(2),
                    missedProfit: missedProfit.toFixed(2),
                    missedProfitPercent: missedProfitPercent.toFixed(2),
                    timingFeedback,
                    timingGrade,
                    timingColor,
                    insights,
                    overallGrade: gradeInfo.grade,
                    overallGradeColor: gradeInfo.color,
                    timestamp: sellTimestamp
                };
            };

            const generateDailySummary = () => {
                const portfolio = getCurrentPortfolio();
                if (!portfolio.history || portfolio.history.length === 0) {
                    return null;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTrades = portfolio.history.filter(trade => {
                    const tradeDate = new Date(trade.timestamp);
                    tradeDate.setHours(0, 0, 0, 0);
                    return tradeDate.getTime() === today.getTime();
                });

                if (todayTrades.length === 0) {
                    return null;
                }

                const sellTrades = todayTrades.filter(t => t.type === 'sell');
                const buyTrades = todayTrades.filter(t => t.type === 'buy');

                let totalProfitLoss = 0;
                let profitableTrades = 0;
                let bestTrade = null;
                let worstTrade = null;

                sellTrades.forEach(sell => {
                    // Find corresponding buy
                    const buys = portfolio.history.filter(h =>
                        h.type === 'buy' &&
                        h.symbol === sell.symbol &&
                        new Date(h.timestamp) < new Date(sell.timestamp)
                    );

                    if (buys.length > 0) {
                        const avgBuyPrice = buys.reduce((sum, b) => sum + b.price, 0) / buys.length;
                        const profitLoss = (sell.price - avgBuyPrice) * sell.quantity;
                        totalProfitLoss += profitLoss;

                        if (profitLoss > 0) profitableTrades++;

                        if (!bestTrade || profitLoss > bestTrade.profit) {
                            bestTrade = { symbol: sell.symbol, profit: profitLoss };
                        }
                        if (!worstTrade || profitLoss < worstTrade.profit) {
                            worstTrade = { symbol: sell.symbol, profit: profitLoss };
                        }
                    }
                });

                const winRate = sellTrades.length > 0 ? (profitableTrades / sellTrades.length) * 100 : 0;

                const commentary = [];

                // Performance commentary
                if (winRate >= 70 && totalProfitLoss > 0) {
                    commentary.push(` Exceptional performance today! ${winRate.toFixed(1)}% win rate with $${totalProfitLoss.toFixed(2)} profit shows strong trading discipline.`);
                } else if (winRate >= 70) {
                    commentary.push(` Great win rate at ${winRate.toFixed(1)}%, but watch position sizing - winners aren't big enough relative to losers.`);
                } else if (winRate >= 50 && totalProfitLoss > 0) {
                    commentary.push(` Solid day with ${winRate.toFixed(1)}% win rate. Your risk-reward ratio is working in your favor.`);
                } else if (winRate >= 50) {
                    commentary.push(` Win rate is positive at ${winRate.toFixed(1)}%, but P/L is negative. Consider letting winners run longer and cutting losers faster.`);
                } else if (sellTrades.length > 0) {
                    commentary.push(` Challenging day with ${winRate.toFixed(1)}% win rate. Take time to analyze what went wrong before your next trade.`);
                }

                // Trading frequency analysis
                if (todayTrades.length > 20) {
                    commentary.push(" Overtrading Alert: 20+ trades today increases emotional decision-making and commission costs. Focus on quality over quantity.");
                } else if (todayTrades.length > 10) {
                    commentary.push(` High trading activity: ${todayTrades.length} trades today. Ensure each trade had a clear thesis and proper risk management.`);
                } else if (todayTrades.length >= 5) {
                    commentary.push(` Moderate trading volume: ${todayTrades.length} trades shows good discipline and selective entry criteria.`);
                } else if (todayTrades.length > 0) {
                    commentary.push(` Conservative approach: ${todayTrades.length} trades today. Quality > quantity - excellent restraint.`);
                }

                // Best/worst trade commentary
                if (bestTrade && worstTrade && bestTrade.profit > 0 && worstTrade.profit < 0) {
                    const riskRewardRatio = Math.abs(bestTrade.profit / worstTrade.profit);
                    if (riskRewardRatio >= 2) {
                        commentary.push(` Excellent risk-reward: Best trade ${bestTrade.symbol} (+$${bestTrade.profit.toFixed(2)}) vs worst ${worstTrade.symbol} ($${worstTrade.profit.toFixed(2)}) = ${riskRewardRatio.toFixed(1)}:1 ratio!`);
                    } else {
                        commentary.push(` Risk-reward needs improvement: Best trade ${bestTrade.symbol} (+$${bestTrade.profit.toFixed(2)}) vs worst ${worstTrade.symbol} ($${worstTrade.profit.toFixed(2)}) = only ${riskRewardRatio.toFixed(1)}:1 ratio.`);
                    }
                } else if (bestTrade && bestTrade.profit > 0) {
                    commentary.push(` Your best trade was ${bestTrade.symbol} with +$${bestTrade.profit.toFixed(2)} profit. Study what you did right!`);
                }

                // Enhanced behavioral insights with portfolio analysis
                const insights = [];

                const avgTradeSize = todayTrades.reduce((sum, t) => sum + (t.price * t.quantity), 0) / todayTrades.length;

                const completedTrades = sellTrades.filter(sell => {
                    const buy = portfolio.history.find(h =>
                        h.type === 'buy' &&
                        h.symbol === sell.symbol &&
                        new Date(h.timestamp) < new Date(sell.timestamp)
                    );
                    return buy;
                });

                let avgHoldingTime = 0;
                if (completedTrades.length > 0) {
                    const totalHoldingTime = completedTrades.reduce((sum, sell) => {
                        const buy = portfolio.history.find(h =>
                            h.type === 'buy' &&
                            h.symbol === sell.symbol &&
                            new Date(h.timestamp) < new Date(sell.timestamp)
                        );
                        if (buy) {
                            const holdingTime = (new Date(sell.timestamp) - new Date(buy.timestamp)) / (1000 * 60 * 60); // Hours
                            return sum + holdingTime;
                        }
                        return sum;
                    }, 0);
                    avgHoldingTime = totalHoldingTime / completedTrades.length;
                }

                // Win rate insights
                if (winRate < 50 && sellTrades.length >= 3) {
                    insights.push({
                        icon: "",
                        text: "Your win rate is below 50%. Focus on quality over quantity and wait for better setups.",
                        type: "warning"
                    });
                } else if (winRate >= 70) {
                    insights.push({
                        icon: "",
                        text: `Excellent ${winRate.toFixed(1)}% win rate! Your trade selection is sharp today.`,
                        type: "success"
                    });
                }

                // P/L insights
                if (totalProfitLoss > 0) {
                    const returnPct = (totalProfitLoss / getCurrentPortfolio().cash) * 100;
                    insights.push({
                        icon: "",
                        text: `Profit: $${totalProfitLoss.toFixed(2)} (${returnPct.toFixed(2)}% portfolio return). Great work!`,
                        type: "success"
                    });
                } else if (totalProfitLoss < 0) {
                    const lossPct = (Math.abs(totalProfitLoss) / getCurrentPortfolio().cash) * 100;
                    insights.push({
                        icon: "",
                        text: `Loss: $${Math.abs(totalProfitLoss).toFixed(2)} (${lossPct.toFixed(2)}% portfolio drawdown). Review your strategy.`,
                        type: "warning"
                    });
                }

                // Holding time insights
                if (avgHoldingTime > 0) {
                    if (avgHoldingTime < 1) {
                        insights.push({
                            icon: "",
                            text: `Average holding time: ${Math.round(avgHoldingTime * 60)} minutes. You're day trading - ensure you're not overtrading.`,
                            type: "info"
                        });
                    } else if (avgHoldingTime < 24) {
                        insights.push({
                            icon: "",
                            text: `Average holding time: ${avgHoldingTime.toFixed(1)} hours. Good intraday trading discipline.`,
                            type: "success"
                        });
                    } else {
                        insights.push({
                            icon: "",
                            text: `Average holding time: ${(avgHoldingTime / 24).toFixed(1)} days. Swing trading approach detected.`,
                            type: "info"
                        });
                    }
                }

                // Trading volume insights
                if (avgTradeSize > 50000) {
                    insights.push({
                        icon: "",
                        text: `High average trade size: $${avgTradeSize.toFixed(0)}. Managing risk well on large positions.`,
                        type: "info"
                    });
                } else if (avgTradeSize < 5000) {
                    insights.push({
                        icon: "",
                        text: `Small position sizing: $${avgTradeSize.toFixed(0)} avg. Consider larger positions if conviction is high.`,
                        type: "info"
                    });
                }

                // Stock diversity
                const uniqueStocks = new Set(todayTrades.map(t => t.symbol));
                if (uniqueStocks.size === 1 && todayTrades.length > 5) {
                    insights.push({
                        icon: "",
                        text: `All trades in one stock (${[...uniqueStocks][0]}). Diversify to manage concentration risk.`,
                        type: "warning"
                    });
                } else if (uniqueStocks.size >= 5) {
                    insights.push({
                        icon: "",
                        text: `Good diversification: traded ${uniqueStocks.size} different stocks today.`,
                        type: "success"
                    });
                }

                return {
                    date: today.toLocaleDateString(),
                    totalTrades: todayTrades.length,
                    buyTrades: buyTrades.length,
                    sellTrades: sellTrades.length,
                    winRate: winRate.toFixed(1),
                    totalProfitLoss: totalProfitLoss.toFixed(2),
                    profitableTrades,
                    bestTrade,
                    worstTrade,
                    commentary,
                    insights
                };
            };

            const fetchHistoricalData = async (symbol, period = '1M') => {
                try {
                    // For 1D, use Polygon.io first (better intraday data)
                    if (period === '1D') {
                        const polygonData = await fetchPolygonIntradayData(symbol, intradayInterval);
                        if (polygonData) {
                            setIsRealChartData(true);
                            return polygonData;
                        }
                        console.log('Polygon.io unavailable, falling back to Alpha Vantage...');
                    }

                    const API_KEY = 'VX9GKME3X62U5ZM0';
                    let functionType, interval, outputsize;

                    switch (period) {
                        case '1D':
                            functionType = 'TIME_SERIES_INTRADAY';
                            interval = '5min';
                            outputsize = 'compact';
                            break;
                        case '1W':
                        case '1M':
                            functionType = 'TIME_SERIES_DAILY';
                            outputsize = 'compact';
                            break;
                        case '3M':
                        case '6M':
                        case 'YTD':
                        case '1Y':
                        case '5Y':
                        case 'ALL':
                            functionType = 'TIME_SERIES_DAILY';
                            outputsize = 'full';
                            break;
                        default:
                            functionType = 'TIME_SERIES_DAILY';
                            outputsize = 'compact';
                    }

                    let url;
                    if (period === '1D') {
                        url = `https://www.alphavantage.co/query?function=${functionType}&symbol=${symbol}&interval=${interval}&outputsize=${outputsize}&apikey=${API_KEY}`;
                    } else {
                        url = `https://www.alphavantage.co/query?function=${functionType}&symbol=${symbol}&outputsize=${outputsize}&apikey=${API_KEY}`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    // Check for API errors
                    if (data['Error Message'] || data['Note']) {
                        console.log(` Alpha Vantage API issue for ${symbol}:`, data['Note'] || data['Error Message']);
                        throw new Error('API limit or error');
                    }

                    let timeSeriesData;
                    if (period === '1D') {
                        timeSeriesData = data['Time Series (5min)'];
                    } else {
                        timeSeriesData = data['Time Series (Daily)'];
                    }

                    if (timeSeriesData && Object.keys(timeSeriesData).length > 0) {
                        const entries = Object.entries(timeSeriesData);

                        // Determine how many points to show
                        let limit;
                        switch (period) {
                            case '1D':
                                limit = 78; // Last 78 5-min points (6.5 hours)
                                break;
                            case '1W':
                                limit = 5; // ~5 trading days
                                break;
                            case '1M':
                                limit = 22; // ~22 trading days in a month
                                break;
                            case '3M':
                                limit = 66; // ~66 trading days in 3 months
                                break;
                            case '6M':
                                limit = 126; // ~126 trading days in 6 months
                                break;
                            case 'YTD':
                                // Calculate days since Jan 1 of current year
                                const startOfYear = new Date(new Date().getFullYear(), 0, 1);
                                const daysSinceYearStart = Math.floor((Date.now() - startOfYear) / (1000 * 60 * 60 * 24));
                                limit = Math.floor(daysSinceYearStart * 0.71); // ~71% are trading days
                                break;
                            case '1Y':
                                limit = 252; // ~252 trading days in a year
                                break;
                            case '5Y':
                                limit = 1260; // ~1260 trading days in 5 years
                                break;
                            case 'ALL':
                                limit = 2520; // ~10 years of data
                                break;
                            default:
                                limit = 22;
                        }

                        const limitedEntries = entries.slice(0, limit).reverse();

                        const labels = limitedEntries.map(([timestamp]) => {
                            const date = new Date(timestamp);
                            if (period === '1D') {
                                return date.toLocaleTimeString('en-US', {
                                    hour: 'numeric',
                                    minute: '2-digit'
                                });
                            } else if (period === '5Y' || period === 'ALL') {
                                return date.toLocaleDateString('en-US', {
                                    month: 'short',
                                    year: '2-digit'
                                });
                            } else if (period === '1Y' || period === 'YTD') {
                                return date.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric'
                                });
                            } else {
                                return date.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric'
                                });
                            }
                        });

                        const prices = limitedEntries.map(([, values]) =>
                            parseFloat(values['4. close']).toFixed(2)
                        );

                        console.log(` Fetched real ${period} chart data for ${symbol}: ${prices.length} points from Alpha Vantage`);
                        setIsRealChartData(true);
                        return { labels, data: prices };
                    }

                    throw new Error('No time series data');
                } catch (error) {
                    console.log(` Using simulated data for ${symbol}:`, error.message);
                    const stock = stocks.find(s => s.symbol === symbol);
                    const currentPrice = stock ? stock.price : 100;
                    const currentChange = stock ? stock.change : 0;

                    let dataPoints;
                    switch (period) {
                        case '1D': dataPoints = 78; break;
                        case '1W': dataPoints = 5; break;
                        case '1M': dataPoints = 22; break;
                        case '3M': dataPoints = 66; break;
                        case '6M': dataPoints = 126; break;
                        case 'YTD':
                            const startOfYear = new Date(new Date().getFullYear(), 0, 1);
                            const daysSinceYearStart = Math.floor((Date.now() - startOfYear) / (1000 * 60 * 60 * 24));
                            dataPoints = Math.floor(daysSinceYearStart * 0.71);
                            break;
                        case '1Y': dataPoints = 252; break;
                        case '5Y': dataPoints = 1260; break;
                        case 'ALL': dataPoints = 2520; break;
                        default: dataPoints = 22;
                    }

                    setIsRealChartData(false);
                    return generateRealisticChartData(currentPrice, currentChange, dataPoints, period);
                }
            };

            const fetchPolygonIntradayData = async (symbol, interval = 5) => {
                const cacheKey = `${symbol}_${interval}`;
                const now = Date.now();

                // Check cache
                if (polygonCache.current[cacheKey] &&
                    (now - polygonCache.current[cacheKey].timestamp) < POLYGON_CACHE_DURATION) {
                    console.log(`Using cached Polygon data for ${symbol}`);
                    return polygonCache.current[cacheKey].data;
                }

                // Rate limiting
                const timeSinceLastCall = now - lastPolygonCall.current;
                if (timeSinceLastCall < POLYGON_RATE_LIMIT_MS) {
                    await new Promise(r => setTimeout(r, POLYGON_RATE_LIMIT_MS - timeSinceLastCall));
                }
                lastPolygonCall.current = Date.now();

                try {
                    // Get trading day date
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    let daysBack = 0;
                    if (dayOfWeek === 0) daysBack = 2; // Sunday -> Friday
                    if (dayOfWeek === 6) daysBack = 1; // Saturday -> Friday

                    const targetDate = new Date(today);
                    targetDate.setDate(targetDate.getDate() - daysBack);
                    const dateStr = targetDate.toISOString().split('T')[0];

                    const url = `${POLYGON_API_BASE}/v2/aggs/ticker/${symbol}/range/${interval}/minute/${dateStr}/${dateStr}?adjusted=true&sort=asc&limit=500&apiKey=${POLYGON_API_KEY}`;

                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.status === 'OK' && data.results?.length > 0) {
                        const labels = data.results.map(bar => {
                            const date = new Date(bar.t);
                            return date.toLocaleTimeString('en-US', {
                                hour: 'numeric',
                                minute: '2-digit',
                                timeZone: 'America/New_York'
                            });
                        });

                        const prices = data.results.map(bar => parseFloat(bar.c.toFixed(2)));

                        const result = { labels, data: prices };

                        // Cache result
                        polygonCache.current[cacheKey] = { data: result, timestamp: Date.now() };

                        console.log(`Fetched ${prices.length} bars from Polygon.io for ${symbol}`);
                        return result;
                    }

                    return null;
                } catch (error) {
                    console.error('Polygon.io error:', error);
                    return null;
                }
            };

            const generateRealisticChartData = (currentPrice, currentChange, dataPoints, period) => {
                const data = [];
                const labels = [];

                // Calculate starting price based on current change percentage
                const changeMultiplier = 1 + (currentChange / 100);
                const startPrice = currentPrice / changeMultiplier;
                const priceRange = currentPrice - startPrice;

                for (let i = 0; i < dataPoints; i++) {
                    const date = new Date();
                    const progress = i / (dataPoints - 1);

                    if (period === '1D') {
                        date.setMinutes(date.getMinutes() - (dataPoints - i) * 5);
                        labels.push(date.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit'
                        }));
                    } else if (period === '5Y' || period === 'ALL') {
                        // For long periods, show year or month/year
                        date.setDate(date.getDate() - (dataPoints - i));
                        labels.push(date.toLocaleDateString('en-US', {
                            month: 'short',
                            year: '2-digit'
                        }));
                    } else if (period === '1Y' || period === 'YTD') {
                        // For 1 year periods, show month/day
                        date.setDate(date.getDate() - (dataPoints - i));
                        labels.push(date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        }));
                    } else {
                        date.setDate(date.getDate() - (dataPoints - i));
                        labels.push(date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        }));
                    }

                    const trend = startPrice + (priceRange * progress);
                    const volatility = period === '1D' ? 0.003 : (period === '5Y' || period === 'ALL') ? 0.025 : 0.015;
                    const randomWalk = (Math.random() - 0.5) * (currentPrice * volatility);
                    const price = trend + randomWalk;

                    data.push(price.toFixed(2));
                }

                data[data.length - 1] = currentPrice.toFixed(2);
                return { labels, data };
            };

            const generateFallbackHistoricalData = (currentPrice, days = 30, dataPoints = 30, period = '1M') => {
                const data = [];
                const labels = [];
                let price = currentPrice;

                // Start price slightly different from current
                const startPrice = currentPrice * (0.95 + Math.random() * 0.1);
                price = startPrice;

                for (let i = 0; i < dataPoints; i++) {
                    const date = new Date();

                    if (period === '1D') {
                        // 5-minute intervals for 1 day
                        date.setMinutes(date.getMinutes() - (dataPoints - i) * 5);
                        labels.push(date.toLocaleTimeString('en-US', {
                            timeZone: 'America/New_York',
                            hour: 'numeric',
                            minute: '2-digit'
                        }));
                    } else if (period === '1W') {
                        // Hourly intervals for 1 week
                        date.setHours(date.getHours() - (dataPoints - i));
                        labels.push(date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric'
                        }));
                    } else {
                        // Daily intervals
                        date.setDate(date.getDate() - (dataPoints - i));
                        labels.push(date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        }));
                    }

                    // Realistic price movement
                    const volatility = period === '1D' ? 0.005 : 0.02;
                    const change = (Math.random() - 0.48) * (currentPrice * volatility);
                    price = Math.max(currentPrice * 0.7, Math.min(currentPrice * 1.3, price + change));
                    data.push(price.toFixed(2));
                }

                // Ensure last price matches current price
                data[data.length - 1] = currentPrice.toFixed(2);
                return { labels, data };
            };

            // Chart effect - create/update chart when stock is selected
            useEffect(() => {
                if (!selectedStock || !chartRef.current || !stocks.length) {
                    console.log('Chart skipped:', { selectedStock, hasRef: !!chartRef.current, stocksLength: stocks.length });
                    return;
                }

                const stock = stocks.find(s => s.symbol === selectedStock);
                if (!stock) {
                    console.log('Stock not found:', selectedStock);
                    return;
                }

                // Destroy existing chart
                if (chartInstance.current) {
                    try {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    } catch (e) {
                        console.error('Error destroying chart:', e);
                    }
                }

                const loadChart = async () => {
                    try {
                        setChartLoading(true);
                        console.log(`Loading chart for ${selectedStock} (${chartPeriod})`);

                        let historicalData = await fetchHistoricalData(selectedStock, chartPeriod);

                        // Fallback to generated data if API fails
                        if (!historicalData || !historicalData.labels || !historicalData.data) {
                            console.log('Using fallback data for', selectedStock);
                            historicalData = generateFallbackHistoricalData(stock.price);
                            setIsRealChartData(false);
                        } else {
                            setIsRealChartData(true);
                        }

                        const { labels, data } = historicalData;

                        if (!labels || !data || labels.length === 0 || data.length === 0) {
                            console.error('Invalid chart data:', { labels, data });
                            return;
                        }

                        // Verify canvas is still available
                        if (!chartRef.current) {
                            console.error('Canvas ref lost during async load');
                            return;
                        }

                        const ctx = chartRef.current.getContext('2d');
                        if (!ctx) {
                            console.error('Failed to get canvas context');
                            return;
                        }
                    chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${stock.symbol} Price`,
                            data: data,
                            borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            backgroundColor: stock.change >= 0 ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: stock.change >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return '$' + parseFloat(context.parsed.y).toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    maxTicksLimit: 6
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                    });

                        console.log(`Chart successfully created for ${selectedStock}`);
                        setChartLoading(false);
                    } catch (error) {
                        console.error('Error loading chart:', error);
                        console.error('Error details:', {
                            selectedStock,
                            chartPeriod,
                            hasStock: !!stock,
                            hasCanvas: !!chartRef.current
                        });

                        // Try to display fallback chart even on error
                        try {
                            if (chartRef.current && stock) {
                                const fallbackData = generateFallbackHistoricalData(stock.price);
                                const ctx = chartRef.current.getContext('2d');
                                if (ctx) {
                                    chartInstance.current = new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: fallbackData.labels,
                                            datasets: [{
                                                label: `${stock.symbol} Price`,
                                                data: fallbackData.data,
                                                borderColor: 'rgb(156, 163, 175)',
                                                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                                                borderWidth: 2,
                                                fill: true,
                                                tension: 0.4,
                                                pointRadius: 0
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: { legend: { display: false } }
                                        }
                                    });
                                    setIsRealChartData(false);
                                    console.log('Fallback chart created successfully');
                                }
                            }
                        } catch (fallbackError) {
                            console.error('Failed to create fallback chart:', fallbackError);
                        } finally {
                            setChartLoading(false);
                        }
                    }
                };

                // Call async function with small delay to ensure canvas is ready
                const timeoutId = setTimeout(() => {
                    loadChart();
                }, 10);

                // Cleanup on unmount
                return () => {
                    clearTimeout(timeoutId);
                    if (chartInstance.current) {
                        try {
                            chartInstance.current.destroy();
                            chartInstance.current = null;
                        } catch (e) {
                            console.error('Error in chart cleanup:', e);
                        }
                    }
                };
            }, [selectedStock, stocks, chartPeriod, intradayInterval]);

            useEffect(() => {
                if (selectedStock) {
                    loadStockNews();
                }
            }, [selectedStock]);

            // Auto-load and auto-refresh stock news when selected stock changes
            useEffect(() => {
                if (!selectedStock) return;

                loadStockNews();

                const stockNewsInterval = setInterval(() => {
                    loadStockNews();
                }, 180000); // 3 minutes

                // Cleanup interval when stock changes or component unmounts
                return () => clearInterval(stockNewsInterval);
            }, [selectedStock]);

            useEffect(() => {
                loadMarketNews();

                const newsRefreshInterval = setInterval(() => {
                    loadMarketNews();
                }, 120000); // 2 minutes for truly live updates

                // Cleanup interval on unmount
                return () => clearInterval(newsRefreshInterval);
            }, []);

            // Plan Selection Screen
            if (view === 'plan-select') {
                return (
                    <>
                    <div className="min-h-screen bg-black relative overflow-hidden">
                        {/* Subtle Background Grid Pattern */}
                        <div className="absolute inset-0 pointer-events-none" style={{
                            backgroundImage: 'linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px)',
                            backgroundSize: '50px 50px'
                        }}></div>

                        {/* Subtle Background Glow Effects */}
                        <div className="absolute inset-0 overflow-hidden pointer-events-none">
                            <div className="absolute top-20 left-10 w-72 h-72 bg-cyan-500/5 rounded-full blur-3xl animate-pulse"></div>
                            <div className="absolute top-40 right-20 w-96 h-96 bg-green-500/5 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                            <div className="absolute bottom-20 left-1/3 w-80 h-80 bg-blue-500/5 rounded-full blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>
                        </div>

                        {/* Ultra-Modern Navigation Header */}
                        <nav className="fixed top-0 left-0 right-0 z-50 bg-black/95 backdrop-blur-2xl border-b border-cyan-500/30" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.1)'}}>
                            <div className="max-w-7xl mx-auto px-4 md:px-6 py-3">
                                <div className="flex items-center justify-between gap-4">
                                    {/* Logo Section */}
                                    <div className="flex items-center gap-3 group cursor-pointer">
                                        <div className="relative">
                                            <img
                                                src="8c5470b9-7f6a-49f6-b4d9-d9128261158f.jpg"
                                                alt="FinClash"
                                                className="w-10 h-10 object-contain transition-transform duration-300 group-hover:scale-110"
                                                onError={(e) => { e.target.style.display = 'none'; }}
                                            />
                                            <div className="absolute inset-0 bg-cyan-500/20 rounded-full blur-md opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        </div>
                                        <div>
                                            <span className="text-xl md:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-cyan-400 to-white">
                                                FinClash
                                            </span>
                                            <div className="text-xs text-cyan-500 font-bold tracking-widest hidden md:block">TRADING SIMULATOR</div>
                                        </div>
                                    </div>

                                    {/* Center Navigation Links */}
                                    <div className="hidden lg:flex items-center gap-1">
                                        <a
                                            href="#pricing"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                document.getElementById('pricing-section')?.scrollIntoView({ behavior: 'smooth' });
                                            }}
                                            className="relative px-4 py-2 text-gray-300 hover:text-white font-semibold transition-all duration-300 group"
                                        >
                                            <span className="relative z-10">Pricing</span>
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/0 via-cyan-500/10 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-cyan-400 to-blue-500 group-hover:w-full transition-all duration-300"></div>
                                        </a>

                                        <a
                                            href="#what-is-finclash"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                document.getElementById('what-is-finclash-section')?.scrollIntoView({ behavior: 'smooth' });
                                            }}
                                            className="relative px-4 py-2 text-gray-300 hover:text-white font-semibold transition-all duration-300 group"
                                        >
                                            <span className="relative z-10">What is FinClash?</span>
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/0 via-cyan-500/10 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-cyan-400 to-blue-500 group-hover:w-full transition-all duration-300"></div>
                                        </a>

                                        <a
                                            href="#how-to-use"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                document.getElementById('how-to-use-section')?.scrollIntoView({ behavior: 'smooth' });
                                            }}
                                            className="relative px-4 py-2 text-gray-300 hover:text-white font-semibold transition-all duration-300 group"
                                        >
                                            <span className="relative z-10">How to Use</span>
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/0 via-cyan-500/10 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-cyan-400 to-blue-500 group-hover:w-full transition-all duration-300"></div>
                                        </a>

                                        <a
                                            href="#features"
                                            onClick={(e) => {
                                                e.preventDefault();
                                                document.getElementById('features-section')?.scrollIntoView({ behavior: 'smooth' });
                                            }}
                                            className="relative px-4 py-2 text-gray-300 hover:text-white font-semibold transition-all duration-300 group"
                                        >
                                            <span className="relative z-10">Features</span>
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/0 via-cyan-500/10 to-cyan-500/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-gradient-to-r from-cyan-400 to-blue-500 group-hover:w-full transition-all duration-300"></div>
                                        </a>
                                    </div>

                                    {/* Right Actions */}
                                    <div className="flex items-center gap-2 md:gap-3">
                                        <button
                                            onClick={() => {
                                                setAccountMode('login');
                                                setShowAccountTypeModal(true);
                                            }}
                                            className="px-4 md:px-6 py-2 bg-gradient-to-r from-cyan-500/20 to-blue-600/20 hover:from-cyan-500/40 hover:to-blue-600/40 text-cyan-400 font-black border border-cyan-500/50 hover:border-gray-700 rounded-lg transition-all duration-300 transform  text-xs md:text-sm"
                                            style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.2)'}}
                                        >
                                            Sign In
                                        </button>
                                        <button
                                            onClick={() => {
                                                setAccountMode('create');
                                                setShowAccountTypeModal(true);
                                            }}
                                            className="px-4 md:px-6 py-2 bg-gradient-to-r from-cyan-500 via-blue-600 to-blue-700 hover:from-cyan-400 hover:via-blue-500 hover:to-blue-600 text-white font-black rounded-lg transition-all duration-300 transform  border border-cyan-400/30 text-xs md:text-sm"
                                            style={{boxShadow: '0 0 25px rgba(6, 182, 212, 0.3)'}}
                                        >
                                            Create Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </nav>

                        {/* Account Type Selection Modal */}
                        {showAccountTypeModal ? (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[99999]">
                                <div className="relative bg-gradient-to-br from-blue-900/95 to-indigo-950/95 backdrop-blur-xl rounded-3xl p-8 max-w-4xl w-full border border-gray-800 shadow-2xl">
                                    {/* Close Button */}
                                    <button
                                        onClick={() => setShowAccountTypeModal(false)}
                                        className="absolute top-4 right-4 text-white hover:text-red-400 text-3xl font-bold transition-colors"
                                    >
                                        
                                    </button>

                                    {/* Header */}
                                    <div className="text-center mb-8">
                                        <h2 className="text-4xl md:text-5xl font-black text-white mb-4">
                                            {accountMode === 'login' ? 'Sign In to Your Account' : 'Choose Your Account Type'}
                                        </h2>
                                        <p className="text-gray-200 text-lg">
                                            {accountMode === 'login' ? 'Select your account type to sign in' : 'Select the perfect plan for your trading journey'}
                                        </p>
                                    </div>

                                    {/* Account Type Cards */}
                                    <div className="grid md:grid-cols-3 gap-6">
                                        {/* Personal Account */}
                                        <button
                                            onClick={() => {
                                                setPlan('personal');
                                                setShowAccountTypeModal(false);
                                                setView('setup-family');
                                            }}
                                            className="group relative bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700/60 transition-all duration-300 text-left hover:shadow-lg"
                                            style={{marginTop: '1rem'}}
                                        >
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-blue-600/5 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>

                                            <div className="relative z-10">
                                                <div className="bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                    <span className="text-4xl"></span>
                                                </div>
                                                <h3 className="text-2xl font-black text-center mb-2 text-white">
                                                    Personal
                                                </h3>
                                                <p className="text-blue-300 text-center text-sm mb-4">Solo trading practice</p>
                                                <div className="text-center mb-4">
                                                    <span className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">FREE</span>
                                                </div>
                                                <ul className="space-y-2 text-blue-100 text-sm">
                                                    <li className="flex items-start gap-2">
                                                        <span className="text-green-400"></span>
                                                        <span>$100K virtual capital</span>
                                                    </li>
                                                    <li className="flex items-start gap-2">
                                                        <span className="text-green-400"></span>
                                                        <span>Trade any stock globally</span>
                                                    </li>
                                                    <li className="flex items-start gap-2">
                                                        <span className="text-green-400"></span>
                                                        <span>UltraThink AI analysis</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>

                                        {/* Public Account */}
                                        <button
                                            onClick={() => {
                                                alert(' Public accounts are coming soon! Stay tuned.');
                                            }}
                                            className="group relative bg-gradient-to-br from-green-900/60 to-emerald-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700/60 transition-all duration-300 text-left cursor-pointer hover:shadow-lg"
                                            style={{marginTop: '1rem'}}
                                        >
                                            {/* POPULAR Badge */}
                                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                                <span className="bg-emerald-500 hover:bg-emerald-400 text-white text-sm font-black px-5 py-2 rounded-full shadow-md flex items-center gap-2">
                                                    <span className="text-yellow-300"></span>
                                                    POPULAR
                                                    <span className="text-yellow-300"></span>
                                                </span>
                                            </div>

                                            {/* Animated Background Gradient */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-green-500/5 to-emerald-600/5 opacity-0 group-hover:opacity-100 transition duration-300 rounded-2xl"></div>

                                            <div className="flex flex-col items-center justify-center py-6">
                                                {/* Icon */}
                                                <div className="relative mb-4">
                                                    <div className="relative bg-gradient-to-br from-green-400 to-emerald-600 p-4 rounded-2xl shadow-xl">
                                                        <span className="text-5xl"></span>
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 className="text-3xl font-black text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">
                                                    Public Account
                                                </h3>

                                                {/* Coming Soon Text */}
                                                <div className="relative mb-6">
                                                    <p className="relative text-xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-green-200 via-emerald-300 to-green-200">
                                                        New Mode Coming
                                                    </p>
                                                    <p className="relative text-lg font-bold text-center text-green-400 mt-1">
                                                        Late December 2025
                                                    </p>
                                                </div>

                                                {/* Features */}
                                                <ul className="space-y-3 w-full">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Compete in public tournaments</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Compete for glory</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Global leaderboards</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>

                                        {/* Private Account */}
                                        <button
                                            onClick={() => {
                                                alert(' Private accounts are coming soon! Stay tuned.');
                                            }}
                                            className="group relative bg-gradient-to-br from-purple-900/60 to-violet-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700/60 transition-all duration-300 text-left cursor-pointer hover:shadow-lg"
                                            style={{marginTop: '1rem'}}
                                        >
                                            {/* PREMIUM Badge */}
                                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                                <span className="bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 text-white text-sm font-black px-5 py-2 rounded-full shadow-md flex items-center gap-2">
                                                    <span className="text-yellow-300"></span>
                                                    PREMIUM
                                                    <span className="text-yellow-300"></span>
                                                </span>
                                            </div>

                                            {/* Animated Background Gradient */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-violet-600/5 opacity-0 group-hover:opacity-100 transition duration-300 rounded-2xl"></div>

                                            <div className="flex flex-col items-center justify-center py-6">
                                                {/* Icon */}
                                                <div className="relative mb-4">
                                                    <div className="relative bg-gradient-to-br from-purple-400 via-pink-500 to-purple-600 p-4 rounded-2xl shadow-xl">
                                                        <span className="text-5xl"></span>
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 className="text-3xl font-black text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-violet-400">
                                                    Private Account
                                                </h3>

                                                {/* Coming Soon Text */}
                                                <div className="relative mb-6">
                                                    <p className="relative text-xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-200 via-pink-300 to-purple-200">
                                                        New Mode Coming
                                                    </p>
                                                    <p className="relative text-lg font-bold text-center text-purple-400 mt-1">
                                                        Late December 2025
                                                    </p>
                                                </div>

                                                {/* Features */}
                                                <ul className="space-y-3 w-full">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Family-only competitions</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Compete for glory</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl"></span>
                                                        <span className="text-gray-300 text-sm">Private leaderboards</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : null}

                        <div className="max-w-7xl mx-auto relative z-10 px-4 md:px-8 pt-20">
                            {/* Hero Section - Bold & Minimal */}
                            <div className="min-h-screen flex flex-col items-center justify-center text-center">
                                {/* Massive Headline with Epic Styling */}
                                <div className="mb-12 animate-fade-in relative">
                                    <h1 className="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black leading-tight tracking-tight space-y-4">
                                        {/* Line 1: Master the Markets */}
                                        <span className="block relative group">
                                            <span className="relative inline-block text-gray-300 animate-slide-in-up">
                                                Master the Markets.
                                            </span>
                                        </span>

                                        {/* Line 2: Compete with Others */}
                                        <span className="block relative group" style={{animationDelay: '0.15s'}}>
                                            <span className="relative inline-block text-gray-300 animate-slide-in-up">
                                                Compete with Others.
                                            </span>
                                        </span>

                                        {/* Line 3: Learn to Trade - Animated Green */}
                                        <span className="block relative group" style={{animationDelay: '0.3s'}}>
                                            <span
                                                className="relative inline-block text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300 animate-slide-in-up font-black"
                                                style={{
                                                    textShadow: '0 0 60px rgba(74, 222, 128, 0.6), 0 0 30px rgba(74, 222, 128, 0.4)',
                                                    animation: 'pulse 3s ease-in-out infinite'
                                                }}
                                            >
                                                Learn to Trade Without Risk.
                                            </span>
                                            <div className="absolute -inset-4 bg-gradient-to-r from-green-500/30 via-emerald-500/40 to-green-500/30 blur-3xl animate-pulse"></div>
                                            {/* Sparkle effects */}
                                            <div className="absolute top-0 left-1/4 w-2 h-2 bg-green-400 rounded-full animate-ping" style={{animationDelay: '0s', animationDuration: '2s'}}></div>
                                            <div className="absolute top-0 right-1/4 w-2 h-2 bg-emerald-400 rounded-full animate-ping" style={{animationDelay: '0.5s', animationDuration: '2s'}}></div>
                                            <div className="absolute bottom-0 left-1/3 w-2 h-2 bg-green-300 rounded-full animate-ping" style={{animationDelay: '1s', animationDuration: '2s'}}></div>
                                        </span>
                                    </h1>

                                    {/* Background accent elements */}
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-full pointer-events-none">
                                        <div className="absolute top-0 left-0 w-96 h-96 bg-cyan-500/5 rounded-full blur-3xl animate-pulse" style={{animationDuration: '4s'}}></div>
                                        <div className="absolute bottom-0 right-0 w-96 h-96 bg-green-500/5 rounded-full blur-3xl animate-pulse" style={{animationDuration: '5s', animationDelay: '1s'}}></div>
                                    </div>
                                </div>

                                {/* Subheadline - Enhanced */}
                                <div className="relative mb-12 animate-fade-in" style={{animationDelay: '0.6s'}}>
                                    <p className="text-xl md:text-2xl lg:text-3xl text-gray-300 max-w-4xl mx-auto leading-relaxed">
                                        The only stock trading simulator with{' '}
                                        <span className="relative inline-block group">
                                            <span className="text-white font-black">
                                                AI-powered insights
                                            </span>
                                            <span className="absolute -bottom-1 left-0 w-full h-1 bg-gradient-to-r from-cyan-400/50 to-blue-500/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span>
                                        </span>
                                        ,{' '}
                                        <span className="relative inline-block group">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-500 font-black">
                                                real-time competition
                                            </span>
                                            <span className="absolute -bottom-1 left-0 w-full h-1 bg-gradient-to-r from-green-400/50 to-emerald-500/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span>
                                        </span>
                                        .
                                    </p>
                                </div>

                                {/* CTA Buttons - Ultra-Modern */}
                                <div className="flex flex-col sm:flex-row gap-6 justify-center items-center mb-16 animate-fade-in" style={{animationDelay: '0.8s'}}>
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setAccountMode('create');
                                            setShowAccountTypeModal(true);
                                        }}
                                        className="group relative w-full sm:w-auto px-16 py-6 bg-gradient-to-r from-cyan-500 via-blue-600 to-blue-700 hover:from-cyan-400 hover:via-blue-500 hover:to-blue-600 text-white rounded-2xl font-black text-2xl shadow-2xl transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 border-2 border-cyan-400/40 hover:border-gray-700 overflow-hidden"
                                        style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.4), 0 0 80px rgba(6, 182, 212, 0.2)'}}
                                    >
                                        <span className="relative z-10 flex items-center gap-3">
                                            <span>Create Account</span>
                                            <svg className="w-6 h-6 transform group-hover:translate-x-2 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                            </svg>
                                        </span>
                                        {/* Animated shine effect */}
                                        <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                                        {/* Pulse ring */}
                                        <div className="absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500" style={{boxShadow: '0 0 0 0 rgba(6, 182, 212, 0.7)', animation: 'pulse-ring 1.5s infinite'}}></div>
                                    </button>

                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setAccountMode('login');
                                            setShowAccountTypeModal(true);
                                        }}
                                        className="group relative w-full sm:w-auto px-16 py-6 bg-black/80 backdrop-blur-xl hover:bg-black/60 text-cyan-400 hover:text-gray-300 rounded-2xl font-black text-2xl shadow-2xl border border-gray-800 hover:border-gray-700 transition-all duration-500 transform hover:scale-110 hover:-translate-y-1 overflow-hidden"
                                        style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.3), inset 0 0 20px rgba(6, 182, 212, 0.1)'}}
                                    >
                                        <span className="relative z-10 flex items-center gap-3">
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                                            </svg>
                                            <span>Sign In</span>
                                        </span>
                                        {/* Animated border glow */}
                                        <div className="absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                                            <div className="absolute inset-0 rounded-2xl animate-pulse" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.6), inset 0 0 20px rgba(6, 182, 212, 0.2)'}}></div>
                                        </div>
                                    </button>
                                </div>

                            </div>

                            {/* Spacer */}
                            <div className="mb-16"></div>

                            {/* Account Types Section Header - Ultra-Modern */}
                            <div className="text-center mb-16 animate-fade-in relative">
                                {/* Background decorative elements */}
                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl h-full pointer-events-none">
                                    <div className="absolute top-0 left-0 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl animate-pulse" style={{animationDuration: '3s'}}></div>
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/5 rounded-full blur-3xl animate-pulse" style={{animationDuration: '4s', animationDelay: '0.5s'}}></div>
                                </div>

                                <div className="relative">
                                    <h2 className="text-5xl md:text-7xl font-black mb-6 leading-tight">
                                        <span className="block text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-purple-400">
                                            Choose Your Path
                                        </span>
                                    </h2>
                                    <div className="flex justify-center mb-6">
                                        <div className="h-1 w-32 bg-gradient-to-r from-transparent via-cyan-500 to-transparent rounded-full"></div>
                                    </div>
                                    <p className="text-xl md:text-2xl text-gray-300 max-w-3xl mx-auto leading-relaxed">
                                        Explore our <span className="relative inline-block group"><span className="text-white font-bold">account types</span><span className="absolute -bottom-1 left-0 w-full h-1 bg-gradient-to-r from-cyan-400/50 to-blue-500/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span></span> and select the perfect plan for your <span className="relative inline-block group"><span className="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-500 font-bold">trading journey</span><span className="absolute -bottom-1 left-0 w-full h-1 bg-gradient-to-r from-green-400/50 to-emerald-500/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span></span>
                                    </p>
                                </div>
                            </div>

                            {/* Pricing Section - Ultra-Modern Cards */}
                            <div id="pricing-section" className="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto pt-6 pb-8">
                                {/* Personal Plan - FREE */}
                                <div className="group relative bg-black/80 backdrop-blur-2xl rounded-3xl p-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-visible">
                                    {/* Animated Background Gradient */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/3 via-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6">
                                            <div className="relative bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 p-5 rounded-2xl shadow-lg">
                                                <span className="text-5xl"></span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h3 className="text-4xl font-black text-center mb-3">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 group-hover:from-cyan-200 group-hover:via-blue-300 group-hover:to-cyan-200 transition-all duration-500">
                                                Individual
                                            </span>
                                        </h3>
                                        <p className="text-center text-gray-400 group-hover:text-cyan-400 text-base mb-6 font-semibold transition-colors duration-300">Perfect for solo traders</p>

                                        {/* Price with Enhanced Styling */}
                                        <div className="relative text-center mb-8 py-6 bg-gradient-to-br from-black/60 to-black/40 rounded-2xl border border-gray-800 group-hover:border-gray-700/50 transition-all duration-300 overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-r from-green-500/3 to-emerald-500/3 group-hover:from-green-500/5 group-hover:to-emerald-500/5 transition-all duration-300"></div>
                                            <div className="relative">
                                                <span className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300">
                                                    FREE
                                                </span>
                                                <div className="text-sm text-green-400 font-bold mt-3 tracking-wider">ZERO TRADING FEES FOREVER</div>
                                            </div>
                                            {/* Corner accents */}
                                            <div className="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-green-400/50 rounded-tl-lg"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-green-400/50 rounded-tr-lg"></div>
                                            <div className="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-green-400/50 rounded-bl-lg"></div>
                                            <div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-green-400/50 rounded-br-lg"></div>
                                        </div>

                                        {/* Features - Enhanced */}
                                        <ul className="space-y-4">
                                            <li className="flex items-start gap-4 group/item">
                                                <div className="relative flex-shrink-0">
                                                    <div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                                                    <span className="relative text-2xl text-green-400 font-bold"></span>
                                                </div>
                                                <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                    <span className="font-black text-cyan-400">$100K</span> virtual capital
                                                </span>
                                            </li>
                                            <li className="flex items-start gap-4 group/item">
                                                <div className="relative flex-shrink-0">
                                                    <div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                                                    <span className="relative text-2xl text-green-400 font-bold"></span>
                                                </div>
                                                <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                    Trade <span className="font-black text-cyan-400">any stock</span> globally globally
                                                </span>
                                            </li>
                                            <li className="flex items-start gap-4 group/item">
                                                <div className="relative flex-shrink-0">
                                                    <div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                                                    <span className="relative text-2xl text-green-400 font-bold"></span>
                                                </div>
                                                <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                    <span className="font-black text-cyan-400">UltraThink AI</span> analysis
                                                </span>
                                            </li>
                                            <li className="flex items-start gap-4 group/item">
                                                <div className="relative flex-shrink-0">
                                                    <div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                                                    <span className="relative text-2xl text-green-400 font-bold"></span>
                                                </div>
                                                <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                    <span className="font-black text-cyan-400">Live</span> market news
                                                </span>
                                            </li>
                                            <li className="flex items-start gap-4 group/item">
                                                <div className="relative flex-shrink-0">
                                                    <div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                                                    <span className="relative text-2xl text-green-400 font-bold"></span>
                                                </div>
                                                <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                    <span className="font-black text-cyan-400">Risk-free</span> practice
                                                </span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                {/* Public Plan - 1% Fee - Ultra-Modern */}
                                <div className="group relative bg-black/80 backdrop-blur-2xl rounded-3xl p-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-visible">
                                    {/* Animated Background Gradient */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-green-500/3 via-emerald-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 rounded-3xl"></div>

                                    {/* POPULAR Badge */}
                                    <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                        <span className="bg-emerald-500 hover:bg-emerald-400 text-white text-xs font-black px-5 py-2 rounded-full shadow-md">
                                             POPULAR
                                        </span>
                                    </div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6 mt-2">
                                            <div className="relative bg-gradient-to-br from-green-400 via-emerald-500 to-green-600 p-5 rounded-2xl shadow-lg">
                                                <span className="text-5xl"></span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h3 className="text-4xl font-black text-center mb-3">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300 group-hover:from-green-200 group-hover:via-emerald-300 group-hover:to-green-200 transition-all duration-500">
                                                Public
                                            </span>
                                        </h3>
                                        <p className="text-center text-gray-400 group-hover:text-green-400 text-base mb-6 font-semibold transition-colors duration-300">Compete with friends & family</p>

                                        {/* Price with Enhanced Styling */}
                                        <div className="relative text-center mb-8 py-6 bg-gradient-to-br from-black/60 to-black/40 rounded-2xl border border-gray-800 group-hover:border-gray-700/50 transition-all duration-300 overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-r from-green-500/3 to-emerald-500/3 group-hover:from-green-500/5 group-hover:to-emerald-500/5 transition-all duration-300"></div>
                                            <div className="relative">
                                                <span className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300">
                                                    FREE
                                                </span>
                                                <div className="text-sm text-green-400 font-bold mt-3 tracking-wider">ZERO TRADING FEES FOREVER</div>
                                            </div>
                                            {/* Corner accents */}
                                            <div className="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-green-400/50 rounded-tl-lg"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-green-400/50 rounded-tr-lg"></div>
                                            <div className="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-green-400/50 rounded-bl-lg"></div>
                                            <div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-green-400/50 rounded-br-lg"></div>
                                        </div>

                                        {/* Coming Soon Banner */}
                                        <div className="bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-gray-800 rounded-xl p-4 mb-6 text-center">
                                            <p className="text-orange-300 font-bold text-lg">Coming Soon</p>
                                            <p className="text-orange-400 text-sm font-semibold">Late December 2025</p>
                                        </div>

                                        {/* Features - Enhanced */}
                                        <ul className="space-y-4">
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Compete in public tournaments</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Compete for glory</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-green-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Global leaderboards</span>
                                            </li>
                                        </ul>

                                    </div>
                                </div>

                                {/* Private Plan - $0.05 Fee - Ultra-Modern */}
                                <div className="group relative bg-black/80 backdrop-blur-2xl rounded-3xl p-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-visible">
                                    {/* Animated Background Gradient */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-purple-500/3 via-pink-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 rounded-3xl"></div>

                                    {/* PREMIUM Badge */}
                                    <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                        <span className="bg-gradient-to-r from-purple-500 via-pink-500 to-purple-600 text-white text-xs font-black px-5 py-2 rounded-full shadow-md">
                                             PREMIUM
                                        </span>
                                    </div>

                                    <div className="relative z-10">
                                        {/* Icon */}
                                        <div className="flex items-center justify-center mb-6 mt-2">
                                            <div className="relative bg-gradient-to-br from-purple-400 via-pink-500 to-purple-600 p-5 rounded-2xl shadow-lg">
                                                <span className="text-5xl"></span>
                                            </div>
                                        </div>

                                        {/* Title */}
                                        <h3 className="text-4xl font-black text-center mb-3">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 via-pink-400 to-purple-300 group-hover:from-purple-200 group-hover:via-pink-300 group-hover:to-purple-200 transition-all duration-500">
                                                Private
                                            </span>
                                        </h3>
                                        <p className="text-center text-gray-400 group-hover:text-purple-400 text-base mb-6 font-semibold transition-colors duration-300">Premium competition</p>

                                        {/* Price with Enhanced Styling */}
                                        <div className="relative text-center mb-8 py-6 bg-gradient-to-br from-black/60 to-black/40 rounded-2xl border border-gray-800 group-hover:border-gray-700/50 transition-all duration-300 overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-r from-green-500/3 to-emerald-500/3 group-hover:from-green-500/5 group-hover:to-emerald-500/5 transition-all duration-300"></div>
                                            <div className="relative">
                                                <span className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300">
                                                    FREE
                                                </span>
                                                <div className="text-sm text-green-400 font-bold mt-3 tracking-wider">ZERO TRADING FEES FOREVER</div>
                                            </div>
                                            {/* Corner accents */}
                                            <div className="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-green-400/50 rounded-tl-lg"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-green-400/50 rounded-tr-lg"></div>
                                            <div className="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-green-400/50 rounded-bl-lg"></div>
                                            <div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-green-400/50 rounded-br-lg"></div>
                                        </div>

                                        {/* Coming Soon Banner */}
                                        <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-gray-800 rounded-xl p-4 mb-6 text-center">
                                            <p className="text-gray-300 font-bold text-lg">Coming Soon</p>
                                            <p className="text-purple-400 text-sm font-semibold">Late December 2025</p>
                                        </div>

                                        {/* Features - Enhanced */}
                                        <ul className="space-y-4">
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Family-only competitions</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Compete for glory</span>
                                            </li>
                                            <li className="flex items-start gap-3">
                                                <span className="text-purple-400 text-xl"></span>
                                                <span className="text-gray-300 text-sm">Private leaderboards</span>
                                            </li>
                                        </ul>

                                    </div>
                                </div>
                            </div>

                            {/* What is FinClash Section */}
                            <div id="what-is-finclash-section" className="mt-20 max-w-6xl mx-auto">
                                <div className="text-center mb-12">
                                    <h2 className="text-5xl md:text-6xl font-black mb-4">
                                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300">What is FinClash?</span>
                                    </h2>
                                    <div className="w-24 h-1 bg-gradient-to-r from-cyan-400 via-blue-500 to-cyan-400 mx-auto rounded-full" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.5)'}}></div>
                                    <p className="text-xl text-gray-400 mt-6 max-w-3xl mx-auto">
                                        The ultimate stock trading simulator powered by AI, offering competitive gameplay and risk-free practice
                                    </p>
                                </div>

                                {/* 6 Feature Boxes */}
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {/* Box 1: AI-Powered */}
                                    <div className="group relative bg-gradient-to-br from-purple-900/60 to-violet-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-2xl hover:shadow-purple-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-violet-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-purple-400 via-violet-500 to-purple-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-violet-400">
                                                AI-Powered Analysis
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                UltraThink AI provides intelligent stock analysis and real-time recommendations to help you make informed decisions
                                            </p>
                                        </div>
                                    </div>

                                    {/* Box 2: Real-Time Data */}
                                    <div className="group relative bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-2xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-white">
                                                Real-Time Market Data
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                Live stock prices, charts, and market updates keep you connected to the pulse of Wall Street
                                            </p>
                                        </div>
                                    </div>

                                    {/* Box 3: Competitive Trading */}
                                    <div className="group relative bg-gradient-to-br from-orange-900/60 to-red-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-orange-400 hover:shadow-2xl hover:shadow-orange-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-orange-500/10 to-red-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-orange-400 via-red-500 to-orange-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-orange-300 to-red-400">
                                                Competitive Trading
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                Coming Soon
                                            </p>
                                        </div>
                                    </div>

                                    {/* Box 4: $100K Virtual Capital */}
                                    <div className="group relative bg-gradient-to-br from-green-900/60 to-emerald-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-2xl hover:shadow-green-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-green-400 via-emerald-500 to-green-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">
                                                $100K Virtual Capital
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                Start trading immediately with $100,000 in virtual capital. No risk, all reward!
                                            </p>
                                        </div>
                                    </div>

                                    {/* Box 5: Risk-Free Learning */}
                                    <div className="group relative bg-gradient-to-br from-teal-900/60 to-cyan-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-teal-500/50 hover:border-teal-400 hover:shadow-2xl hover:shadow-teal-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-teal-500/10 to-cyan-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-teal-400 via-cyan-500 to-teal-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-cyan-400">
                                                Risk-Free Learning
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                Perfect for beginners and pros alike. Learn trading strategies without risking real money
                                            </p>
                                        </div>
                                    </div>

                                    {/* Box 6: Performance Analytics */}
                                    <div className="group relative bg-gradient-to-br from-yellow-900/60 to-amber-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-yellow-500/50 hover:border-yellow-400 hover:shadow-2xl hover:shadow-yellow-500/30 transition-all duration-300 hover:-translate-y-2">
                                        <div className="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-amber-600/10 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        <div className="relative z-10">
                                            <div className="bg-gradient-to-br from-yellow-400 via-amber-500 to-yellow-600 p-4 rounded-xl shadow-xl w-16 h-16 flex items-center justify-center mb-4 mx-auto">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h3 className="text-2xl font-black text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-400">
                                                Performance Analytics
                                            </h3>
                                            <p className="text-blue-100 text-center text-sm">
                                                Track your trading performance with detailed insights and analytics
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Creators Footer */}
                                <div className="mt-12 text-center">
                                    <div className="inline-block bg-black/80 backdrop-blur-xl rounded-2xl px-8 py-4 border border-gray-800" style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.2)'}}>
                                        <p className="text-lg text-gray-300">
                                            Created by <span className="font-black text-white">Reid Coleman</span> & <span className="font-black text-white">Cameron Dietzel</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* How to Use Section */}
                            <div id="how-to-use-section" className="mt-20 max-w-6xl mx-auto">
                                <div className="group relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-3xl p-8 md:p-12 border border-gray-800 hover:border-gray-700 hover:shadow-2xl hover:shadow-cyan-500/30 transition-all duration-500 hover:-translate-y-2 overflow-hidden">
                                    {/* Animated shine effect */}
                                    <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-3xl opacity-0 group-hover:opacity-100 transition duration-300"></div>

                                    <div className="relative text-center mb-12">
                                        <h2 className="text-5xl md:text-6xl font-black mb-4">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-green-400 to-cyan-300">How to Use FinClash</span>
                                        </h2>
                                        <div className="w-24 h-1 bg-gradient-to-r from-cyan-400 via-green-500 to-cyan-400 mx-auto rounded-full" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.5)'}}></div>
                                    </div>

                                    <div className="relative grid md:grid-cols-3 gap-8">
                                        {/* Step 1 */}
                                        <div className="group/step relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/step:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover/step:opacity-100 transition duration-300"></div>
                                            <div className="relative text-center">
                                                <div className="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full mb-4 transform group-hover/step:scale-110 transition-transform duration-300">
                                                    <div className="absolute inset-0 bg-cyan-500/30 blur-xl rounded-full"></div>
                                                    <span className="relative text-3xl font-black text-white">1</span>
                                                </div>
                                                <h3 className="text-2xl font-black mb-4">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-cyan-400">Choose Your Plan</span>
                                                </h3>
                                                <p className="text-gray-300 leading-relaxed">
                                                    Create a free <span className="relative inline-block group"><span className="text-cyan-400 font-bold">Personal</span><span className="absolute -bottom-0.5 left-0 w-full h-0.5 bg-cyan-400/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span></span> account to start trading with $100,000 in virtual capital. Zero trading fees forever.
                                                </p>
                                            </div>
                                        </div>

                                        {/* Step 2 */}
                                        <div className="group/step relative bg-gradient-to-br from-green-900/60 to-emerald-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-green-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/step:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-green-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-2xl opacity-0 group-hover/step:opacity-100 transition duration-300"></div>
                                            <div className="relative text-center">
                                                <div className="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full mb-4 transform group-hover/step:scale-110 transition-transform duration-300">
                                                    <div className="absolute inset-0 bg-green-500/30 blur-xl rounded-full"></div>
                                                    <span className="relative text-3xl font-black text-white">2</span>
                                                </div>
                                                <h3 className="text-2xl font-black mb-4">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-green-400">Create Account</span>
                                                </h3>
                                                <p className="text-gray-300 leading-relaxed">
                                                    Sign up with your email and create a secure password. You'll instantly receive <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400 font-bold">$100,000 in virtual capital</span> to start trading.
                                                </p>
                                            </div>
                                        </div>

                                        {/* Step 3 */}
                                        <div className="group/step relative bg-gradient-to-br from-purple-900/60 to-violet-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-purple-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/step:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-violet-600/10 rounded-2xl opacity-0 group-hover/step:opacity-100 transition duration-300"></div>
                                            <div className="relative text-center">
                                                <div className="relative inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full mb-4 transform group-hover/step:scale-110 transition-transform duration-300">
                                                    <div className="absolute inset-0 bg-purple-500/30 blur-xl rounded-full"></div>
                                                    <span className="relative text-3xl font-black text-white">3</span>
                                                </div>
                                                <h3 className="text-2xl font-black mb-4">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-purple-400">Start Trading</span>
                                                </h3>
                                                <p className="text-gray-300 leading-relaxed">
                                                    Use our <span className="relative inline-block group"><span className="text-purple-400 font-bold">AI-powered analysis</span><span className="absolute -bottom-0.5 left-0 w-full h-0.5 bg-purple-400/50 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 rounded-full"></span></span> to research stocks, execute trades, and compete on the leaderboard. The winner takes all!
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="relative mt-12 bg-black/60 rounded-2xl p-6 border border-gray-800 overflow-hidden">
                                        <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-green-500/5 to-transparent"></div>
                                        <h3 className="relative text-2xl font-black mb-4 text-center">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-green-400">Pro Tips </span>
                                        </h3>
                                        <ul className="relative grid md:grid-cols-2 gap-4 text-gray-300">
                                            <li className="flex items-start gap-3 group/tip cursor-pointer p-2 rounded-lg hover:bg-green-500/10 transition-all duration-300">
                                                <span className="text-green-400 text-xl flex-shrink-0 transform group-hover/tip:scale-125 transition-transform duration-300"></span>
                                                <span>Use <span className="text-purple-400 font-bold">UltraThink AI</span> analysis to make informed decisions</span>
                                            </li>
                                            <li className="flex items-start gap-3 group/tip cursor-pointer p-2 rounded-lg hover:bg-green-500/10 transition-all duration-300">
                                                <span className="text-green-400 text-xl flex-shrink-0 transform group-hover/tip:scale-125 transition-transform duration-300"></span>
                                                <span>Monitor <span className="text-cyan-400 font-bold">real-time</span> market news and trends</span>
                                            </li>
                                            <li className="flex items-start gap-3 group/tip cursor-pointer p-2 rounded-lg hover:bg-green-500/10 transition-all duration-300">
                                                <span className="text-green-400 text-xl flex-shrink-0 transform group-hover/tip:scale-125 transition-transform duration-300"></span>
                                                <span><span className="text-cyan-400 font-bold">Diversify</span> your portfolio across multiple stocks</span>
                                            </li>
                                            <li className="flex items-start gap-3 group/tip cursor-pointer p-2 rounded-lg hover:bg-green-500/10 transition-all duration-300">
                                                <span className="text-green-400 text-xl flex-shrink-0 transform group-hover/tip:scale-125 transition-transform duration-300"></span>
                                                <span>Track your competition on the <span className="text-cyan-400 font-bold">live leaderboard</span></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            {/* Features Section */}
                            <div id="features-section" className="mt-20 max-w-6xl mx-auto">
                                <div className="group relative bg-gradient-to-br from-purple-900/60 to-indigo-950/60 backdrop-blur-xl rounded-3xl p-8 md:p-12 border border-gray-800 hover:border-gray-700 hover:shadow-2xl hover:shadow-purple-500/30 transition-all duration-500 hover:-translate-y-2 overflow-hidden">
                                    {/* Animated shine effect */}
                                    <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent"></div>
                                    <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-indigo-600/10 rounded-3xl opacity-0 group-hover:opacity-100 transition duration-300"></div>

                                    <div className="relative text-center mb-12">
                                        <h2 className="text-5xl md:text-6xl font-black mb-4">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-green-400 to-cyan-300">Features</span>
                                        </h2>
                                        <div className="w-24 h-1 bg-gradient-to-r from-cyan-400 via-green-500 to-cyan-400 mx-auto rounded-full" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.5)'}}></div>
                                        <p className="text-xl text-gray-300 mt-4">Everything you need to master the market</p>
                                    </div>

                                    <div className="relative grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {/* Feature 1 */}
                                        <div className="group/feature relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-cyan-400">UltraThink AI</span>
                                            </h3>
                                            <p className="relative text-gray-300">Advanced <span className="text-cyan-400 font-bold">AI-powered</span> stock analysis and recommendations</p>
                                        </div>

                                        {/* Feature 2 */}
                                        <div className="group/feature relative bg-gradient-to-br from-green-900/60 to-emerald-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-green-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-green-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-green-400">Real-Time Data</span>
                                            </h3>
                                            <p className="relative text-gray-300">Live stock prices, charts, and <span className="text-green-400 font-bold">market updates</span></p>
                                        </div>

                                        {/* Feature 3 */}
                                        <div className="group/feature relative bg-gradient-to-br from-purple-900/60 to-violet-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-purple-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-violet-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-purple-400">Leaderboards</span>
                                            </h3>
                                            <p className="relative text-gray-300">Coming Soon</p>
                                        </div>

                                        {/* Feature 4 */}
                                        <div className="group/feature relative bg-gradient-to-br from-green-900/60 to-emerald-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-green-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-green-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400">Performance Tracking</span>
                                            </h3>
                                            <p className="relative text-gray-300">Monitor your <span className="text-green-400 font-bold">trading performance</span> with detailed analytics</p>
                                        </div>

                                        {/* Feature 5 */}
                                        <div className="group/feature relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-cyan-400">Live Market News</span>
                                            </h3>
                                            <p className="relative text-gray-300">Stay updated with <span className="text-cyan-400 font-bold">breaking financial news</span></p>
                                        </div>

                                        {/* Feature 6 */}
                                        <div className="group/feature relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-cyan-400">Mobile Responsive</span>
                                            </h3>
                                            <p className="relative text-gray-300">Trade anywhere on <span className="text-cyan-400 font-bold">any device</span></p>
                                        </div>

                                        {/* Feature 8 */}
                                        <div className="group/feature relative bg-gradient-to-br from-purple-900/60 to-violet-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-purple-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-violet-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-purple-400">Watchlists</span>
                                            </h3>
                                            <p className="relative text-gray-300">Track your favorite stocks and get <span className="text-purple-400 font-bold">alerts</span></p>
                                        </div>

                                        {/* Feature 9 */}
                                        <div className="group/feature relative bg-gradient-to-br from-cyan-900/60 to-blue-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700 hover:shadow-xl hover:shadow-cyan-500/30 transition-all duration-300 hover:-translate-y-2 overflow-hidden">
                                            <div className="absolute inset-0 -translate-x-full group-hover/feature:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent"></div>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-blue-600/10 rounded-2xl opacity-0 group-hover/feature:opacity-100 transition duration-300"></div>
                                            <div className="relative text-4xl mb-4 transform group-hover/feature:scale-110 transition-transform duration-300"></div>
                                            <h3 className="relative text-xl font-black mb-2">
                                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-cyan-400">Portfolio Analytics</span>
                                            </h3>
                                            <p className="relative text-gray-300">Detailed <span className="text-cyan-400 font-bold">performance metrics</span> and insights</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Market Movers section removed - use dedicated Market Movers tab instead to avoid API rate limiting */}

                            {/* UltraThink Premium Footer */}
                            <footer className="group/footer relative bg-black/90 backdrop-blur-2xl border-t-2 border-cyan-500/30 mt-20 overflow-hidden" style={{boxShadow: '0 -10px 40px rgba(6, 182, 212, 0.1)'}}>
                                {/* Animated background gradient */}
                                <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-blue-600/5 to-purple-600/5 opacity-50"></div>

                                {/* Shine effect */}
                                <div className="absolute inset-0 -translate-x-full group-hover/footer:translate-x-full transition-transform duration-[2000ms] bg-gradient-to-r from-transparent via-cyan-400/5 to-transparent"></div>

                                <div className="relative max-w-7xl mx-auto px-4 py-12">
                                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                                        {/* About Section */}
                                        <div className="group/section">
                                            <h3 className="text-white font-black text-xl mb-4 flex items-center gap-2">
                                                <span className="text-2xl"></span>
                                                About Us
                                            </h3>
                                            <ul className="space-y-3">
                                                <li>
                                                    <a href="about.html" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>Meet Reid</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="about-cameron.html" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>Meet Cameron</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="invest.html" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>Invest in FinClash</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <p className="text-gray-400 text-sm leading-relaxed mt-4 font-medium">
                                                The minds behind <span className="text-cyan-400 font-bold">FinClash</span>
                                            </p>
                                        </div>

                                        {/* Contact Section */}
                                        <div className="group/section">
                                            <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400 font-black text-xl mb-4 flex items-center gap-2">
                                                <span className="text-2xl"></span>
                                                Contact
                                            </h3>
                                            <ul className="space-y-3">
                                                <li>
                                                    <a href="mailto:finclash101@gmail.com" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2 break-all">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>finclash101@gmail.com</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <p className="text-gray-400 text-sm leading-relaxed mt-4 font-medium">
                                                Questions? We'd love to <span className="text-green-400 font-bold">hear from you!</span>
                                            </p>
                                        </div>

                                        {/* Security Section */}
                                        <div className="group/section">
                                            <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-400 font-black text-xl mb-4 flex items-center gap-2">
                                                <span className="text-2xl"></span>
                                                Security
                                            </h3>
                                            <ul className="space-y-3">
                                                <li>
                                                    <a href="mailto:finclash101@gmail.com?subject=Security%20Issue%20Report" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>Report Issues</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <p className="text-gray-400 text-sm leading-relaxed mt-4 font-medium">
                                                Help us keep FinClash <span className="text-cyan-400 font-bold">secure & safe</span>
                                            </p>
                                        </div>

                                        {/* Feedback Section */}
                                        <div className="group/section">
                                            <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 font-black text-xl mb-4 flex items-center gap-2">
                                                <span className="text-2xl"></span>
                                                Feedback
                                            </h3>
                                            <ul className="space-y-3">
                                                <li>
                                                    <a href="mailto:finclash101@gmail.com?subject=FinClash%20Feedback" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                                        <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                                        <span>Share Ideas</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <p className="text-gray-400 text-sm leading-relaxed mt-4 font-medium">
                                                Help us <span className="text-purple-400 font-bold">improve</span> your experience
                                            </p>
                                        </div>
                                    </div>

                                    {/* UltraThink AI Badge */}
                                    <div className="flex justify-center mb-8">
                                        <div className="group/badge relative bg-black/80 backdrop-blur-xl rounded-full px-6 py-3 border border-gray-800 hover:border-gray-700 flex items-center gap-3 transition-all duration-300 overflow-hidden" style={{boxShadow: '0 0 30px rgba(168, 85, 247, 0.3)'}}>
                                            <div className="absolute inset-0 -translate-x-full group-hover/badge:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-purple-400/20 to-transparent"></div>
                                            <span className="relative text-2xl transform group-hover/badge:scale-110 transition-transform duration-300"></span>
                                            <span className="relative text-gray-300 font-bold text-sm">Powered by</span>
                                            <span className="relative text-transparent bg-gradient-to-r from-cyan-300 via-purple-400 to-green-400 bg-clip-text font-black text-lg">UltraThink AI</span>
                                            <span className="relative flex h-2 w-2">
                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                            </span>
                                        </div>
                                    </div>

                                    {/* Bottom Bar */}
                                    <div className="border-t-2 border-cyan-500/20 pt-8 text-center">
                                        <div className="flex flex-wrap justify-center items-center gap-2 mb-3">
                                            <span className="text-gray-500 text-sm font-semibold"> 2025</span>
                                            <span className="text-white font-black text-lg">FinClash</span>
                                            <span className="text-gray-500 text-sm font-semibold">. All rights reserved.</span>
                                        </div>
                                        <p className="text-gray-500 text-sm mb-4 font-semibold">
                                            Created by <span className="text-white font-black">Reid Coleman</span> & <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-500 font-black">Cameron Dietzel</span>
                                        </p>

                                        {/* Legal Links */}
                                        <div className="flex flex-wrap justify-center items-center gap-4 mb-4">
                                            <a href="privacy.html" className="text-cyan-400 hover:text-gray-300 text-sm font-bold transition-colors duration-300 hover:underline">
                                                Privacy Policy
                                            </a>
                                            <span className="text-cyan-500/50"></span>
                                            <a href="terms.html" className="text-cyan-400 hover:text-gray-300 text-sm font-bold transition-colors duration-300 hover:underline">
                                                Terms of Service
                                            </a>
                                        </div>

                                        <p className="text-gray-400 text-xs max-w-2xl mx-auto leading-relaxed font-medium">
                                            <strong className="text-red-400"> IMPORTANT DISCLAIMER:</strong> FinClash is a <span className="text-cyan-400 font-bold">virtual trading simulator</span> for educational purposes only. You <strong className="text-red-400">CANNOT win or lose real money</strong> on this platform. All trades use virtual currency. All AI analysis, tips, and strategies are <strong className="text-red-400">NOT financial advice</strong>. Always conduct your own research and consult a licensed financial advisor before making real investment decisions.
                                        </p>
                                    </div>
                                </div>
                            </footer>
                        </div>
                    </div>
                    </>
                );
            }

            // Code Display Screen (after creating competition)
            if (view === 'code-display') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8 flex items-center justify-center">
                        <div className="max-w-2xl w-full">
                            <div className="bg-gradient-to-br from-purple-800 to-indigo-900 rounded-3xl p-8 border-4 border-purple-500 shadow-2xl">
                                {/* Success Icon */}
                                <div className="text-center mb-6">
                                    <div className="inline-block bg-green-500 rounded-full p-6 mb-4">
                                        <span className="text-7xl"></span>
                                    </div>
                                    <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 mb-2" style={{textShadow: '0 0 60px rgba(6, 182, 212, 0.6), 0 0 30px rgba(59, 130, 246, 0.4)'}}>Welcome to FinClash!</h1>
                                    <p className="text-gray-400 text-lg">Your account is ready. Let's start trading!</p>
                                </div>

                                {/* Getting Started Guide */}
                                <div className="bg-blue-900/50 rounded-xl p-6 mb-6 border border-blue-500">
                                    <h3 className="text-white font-bold mb-3 text-lg"> Quick Start Guide:</h3>
                                    <ul className="text-gray-400 space-y-2 list-disc list-inside">
                                        <li><strong>Search Stocks:</strong> Use the search bar to find companies</li>
                                        <li><strong>View Details:</strong> Click any stock to see price charts and company info</li>
                                        <li><strong>Make Trades:</strong> Buy or sell stocks with your virtual cash</li>
                                        <li><strong>Track Portfolio:</strong> Monitor your investments in the Portfolio tab</li>
                                        <li><strong>Stay Updated:</strong> Check Market Movers and News for insights</li>
                                    </ul>
                                </div>

                                <div className="bg-green-900/30 rounded-xl p-4 border border-green-500/50 mb-6">
                                    <p className="text-green-300 font-semibold text-center">
                                         You start with $100,000 virtual cash - Happy trading!
                                    </p>
                                </div>

                                <div className="text-center">
                                    <p className="text-gray-300 text-sm">Redirecting to trading platform...</p>
                                </div>
                            </div>
                        </div>

                        {/* Account Type Selection Modal */}
                        {(() => {
                            if (showAccountTypeModal) {
                            }
                            return null;
                        })()}
                        {showAccountTypeModal && (
                            <div className="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4 z-[9999]">
                                    <div className="relative bg-black/90 backdrop-blur-xl rounded-3xl p-8 max-w-6xl w-full border border-gray-800 shadow-2xl" style={{boxShadow: '0 0 60px rgba(6, 182, 212, 0.3)'}}>
                                        {/* Close Button */}
                                        <button
                                            onClick={() => setShowAccountTypeModal(false)}
                                            className="absolute top-4 right-4 text-gray-300 hover:text-cyan-400 text-3xl font-bold transition-colors z-50"
                                        >
                                            
                                        </button>

                                        {/* Header */}
                                        <div className="text-center mb-8">
                                            <h2 className="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-green-400 to-cyan-300 mb-4">
                                                {accountMode === 'login' ? 'Sign In to Your Account' : 'Choose Your Account Type'}
                                            </h2>
                                        <p className="text-gray-300 text-lg">
                                            {accountMode === 'login' ? 'Select your account type to sign in' : 'Select the perfect plan for your trading journey'}
                                        </p>
                                    </div>

                                    {/* Account Type Cards */}
                                    <div className="grid md:grid-cols-3 gap-6 pt-6">
                                        {/* Individual Account */}
                                        <button
                                            onClick={() => {
                                                setPlan('personal');
                                                setShowAccountTypeModal(false);
                                                setView('setup-family');
                                            }}
                                            className="group relative bg-black/80 backdrop-blur-2xl rounded-3xl p-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-hidden text-left"
                                        >
                                            {/* Animated Background Gradient */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/3 via-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                            <div className="relative z-10">
                                                {/* Icon */}
                                                <div className="flex items-center justify-center mb-6">
                                                    <div className="relative bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 p-5 rounded-2xl shadow-lg">
                                                        <span className="text-5xl"></span>
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 className="text-4xl font-black text-center mb-3">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 group-hover:from-cyan-200 group-hover:via-blue-300 group-hover:to-cyan-200 transition-all duration-500">
                                                        Individual
                                                    </span>
                                                </h3>
                                                <p className="text-center text-gray-400 group-hover:text-cyan-400 text-base mb-6 font-semibold transition-colors duration-300">Perfect for solo traders</p>

                                                {/* Price */}
                                                <div className="relative text-center mb-8 py-6 bg-gradient-to-br from-black/60 to-black/40 rounded-2xl border border-gray-800 group-hover:border-gray-700/60 transition-all duration-500 overflow-hidden">
                                                    <div className="absolute inset-0 bg-gradient-to-r from-green-500/5 to-emerald-500/5 group-hover:from-green-500/10 group-hover:to-emerald-500/10 transition-all duration-500"></div>
                                                    <div className="relative">
                                                        <span className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300" style={{textShadow: '0 0 40px rgba(74, 222, 128, 0.3)'}}>
                                                            FREE
                                                        </span>
                                                    </div>
                                                        <div className="text-sm text-green-400 font-bold mt-3 tracking-wider">ZERO TRADING FEES FOREVER</div>
                                                    </div>
                                                    {/* Corner accents */}
                                                    <div className="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-green-400/50 rounded-tl-lg"></div>
                                                    <div className="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-green-400/50 rounded-tr-lg"></div>
                                                    <div className="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-green-400/50 rounded-bl-lg"></div>
                                                    <div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-green-400/50 rounded-br-lg"></div>
                                                    <div className="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-green-400/50 rounded-br-lg"></div>

                                                {/* Features */}
                                                <ul className="space-y-4">
                                                    <li className="flex items-start gap-4 group/item">
                                                        <div className="relative flex-shrink-0"><div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div><span className="relative text-2xl text-green-400 font-bold"></span></div>
                                                        <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                            <span className="font-black text-cyan-400">$100K</span> virtual capital
                                                        </span>
                                                    </li>
                                                    <li className="flex items-start gap-4 group/item">
                                                        <div className="relative flex-shrink-0"><div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div><span className="relative text-2xl text-green-400 font-bold"></span></div>
                                                        <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                            Trade <span className="font-black text-cyan-400">any stock</span> globally
                                                        </span>
                                                    </li>
                                                    <li className="flex items-start gap-4 group/item">
                                                        <div className="relative flex-shrink-0"><div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div><span className="relative text-2xl text-green-400 font-bold"></span></div>
                                                        <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                            <span className="font-black text-cyan-400">UltraThink AI</span> analysis
                                                        </span>
                                                    </li>
                                                    <li className="flex items-start gap-4 group/item">
                                                        <div className="relative flex-shrink-0"><div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div><span className="relative text-2xl text-green-400 font-bold"></span></div>
                                                        <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                            <span className="font-black text-cyan-400">Live</span> market news
                                                        </span>
                                                    </li>
                                                    <li className="flex items-start gap-4 group/item">
                                                        <div className="relative flex-shrink-0"><div className="absolute inset-0 bg-green-400/20 blur-lg rounded-full opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div><span className="relative text-2xl text-green-400 font-bold"></span></div>
                                                        <span className="text-base text-gray-300 group-hover/item:text-white transition-colors duration-300">
                                                            <span className="font-black text-cyan-400">Risk-free</span> practice
                                                        </span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>

                                        {/* Public Account */}
                                        <button
                                            onClick={() => {
                                                alert(' Public accounts are coming soon! Stay tuned.');
                                            }}
                                            className="group relative bg-black/90 backdrop-blur-2xl rounded-3xl p-10 pt-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-visible text-left cursor-pointer"
                                            style={{marginTop: '1.5rem'}}
                                        >
                                            {/* Animated Background Gradient */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-green-500/3 via-emerald-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 rounded-3xl"></div>

                                            {/* POPULAR Badge */}
                                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                                <span className="bg-emerald-500 hover:bg-emerald-400 text-white text-xs font-black px-5 py-2 rounded-full shadow-md">
                                                     POPULAR
                                                </span>
                                            </div>

                                            <div className="flex flex-col items-center">
                                                {/* Icon */}
                                                <div className="relative mb-4 mt-2">
                                                    <div className="relative bg-gradient-to-br from-green-400 via-emerald-500 to-green-600 p-6 rounded-2xl shadow-lg">
                                                        <span className="text-6xl"></span>
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 className="text-4xl font-black text-center mb-6">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 via-emerald-400 to-green-300 group-hover:from-green-200 group-hover:via-emerald-300 group-hover:to-green-200 transition-all duration-500">
                                                        Public Account
                                                    </span>
                                                </h3>

                                                {/* Coming Soon Text with Glow */}
                                                <div className="relative mb-6">
                                                    <div className="absolute inset-0 bg-green-400/40 blur-3xl animate-pulse"></div>
                                                    <p className="relative text-2xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-green-200 via-emerald-300 to-green-200 animate-pulse" style={{textShadow: '0 0 50px rgba(34, 197, 94, 0.9), 0 0 25px rgba(16, 185, 129, 0.7)'}}>
                                                        Learn to Trade Without Risk
                                                    </p>
                                                    <p className="relative text-xl font-bold text-center text-green-400 mt-2" style={{textShadow: '0 0 30px rgba(34, 197, 94, 0.8)'}}>
                                                        Late December 2025
                                                    </p>
                                                </div>

                                                {/* Features */}
                                                <ul className="space-y-4 w-full">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Compete in public tournaments</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Compete for glory</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Global leaderboards</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>

                                        {/* Private Account */}
                                        <button
                                            onClick={() => {
                                                alert(' Private accounts are coming soon! Stay tuned.');
                                            }}
                                            className="group relative bg-black/90 backdrop-blur-2xl rounded-3xl p-10 pt-8 border border-gray-800 hover:border-gray-700/50 transition-all duration-300 hover:-translate-y-1 overflow-visible text-left cursor-pointer"
                                            style={{marginTop: '1.5rem'}}
                                        >
                                            {/* Animated Background Gradient */}
                                            <div className="absolute inset-0 bg-gradient-to-br from-purple-500/3 via-pink-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 rounded-3xl"></div>

                                            {/* PREMIUM Badge */}
                                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-20">
                                                <span className="bg-gradient-to-r from-purple-500 via-pink-500 to-purple-600 text-white text-xs font-black px-5 py-2 rounded-full shadow-md">
                                                     PREMIUM
                                                </span>
                                            </div>

                                            <div className="flex flex-col items-center">
                                                {/* Icon */}
                                                <div className="relative mb-4 mt-2">
                                                    <div className="relative bg-gradient-to-br from-purple-400 via-pink-500 to-purple-600 p-6 rounded-2xl shadow-lg">
                                                        <span className="text-6xl"></span>
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 className="text-4xl font-black text-center mb-6">
                                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 via-pink-400 to-purple-300 group-hover:from-purple-200 group-hover:via-pink-300 group-hover:to-purple-200 transition-all duration-500">
                                                        Private Account
                                                    </span>
                                                </h3>

                                                {/* Coming Soon Text with Glow */}
                                                <div className="relative mb-6">
                                                    <div className="absolute inset-0 bg-purple-400/40 blur-3xl animate-pulse"></div>
                                                    <p className="relative text-2xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-200 via-pink-300 to-purple-200 animate-pulse" style={{textShadow: '0 0 50px rgba(168, 85, 247, 0.9), 0 0 25px rgba(217, 70, 239, 0.7)'}}>
                                                        New Mode Coming
                                                    </p>
                                                    <p className="relative text-xl font-bold text-center text-purple-400 mt-2" style={{textShadow: '0 0 30px rgba(168, 85, 247, 0.8)'}}>
                                                        Late December 2025
                                                    </p>
                                                </div>

                                                {/* Features */}
                                                <ul className="space-y-4 w-full">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Family-only competitions</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Compete for glory</span>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-purple-400 text-xl flex-shrink-0"></span>
                                                        <span className="text-gray-300 text-base">Private leaderboards</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }


            if (view === 'setup-family' || view === 'join-family') {
                // Personal Account - Show Create/Login Tabs
                if (plan === 'personal' && view === 'setup-family') {
                    return (
                        <div className="min-h-screen bg-black relative overflow-hidden p-4 md:p-8">
                            <div className="max-w-2xl mx-auto relative z-10">
                            {/* Animated Background Glows */}
                            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                                <div className="absolute top-20 left-10 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse"></div>
                                <div className="absolute bottom-20 right-10 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-green-500/5 rounded-full blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>
                            </div>
                                <button
                                    onClick={() => {
                                        setView('plan-select');
                                        setAccountMode('create');
                                        setShowPasswordReset(false);
                                        setAuthError('');
                                    }}
                                    className="mb-6 text-cyan-400 hover:text-gray-300 font-bold transition-all duration-300 flex items-center gap-2 group"
                                >
                                    <span className="group-hover:-translate-x-1 transition-transform duration-300"></span><span>Back to Plans</span>
                                </button>

                                <div className="bg-black/80 backdrop-blur-2xl rounded-3xl p-8 md:p-12 border border-gray-800 shadow-2xl relative overflow-hidden" style={{boxShadow: '0 0 60px rgba(6, 182, 212, 0.2)'}}>
                                    {/* Create Account Form */}
                                    {accountMode === 'create' && (
                                        <div className="space-y-6">
                                            <div className="text-center mb-6">
                                                <h2 className="text-3xl font-bold text-white mb-2">Create Personal Account</h2>
                                                <p className="text-gray-200">Start trading with $100,000 virtual cash</p>
                                            </div>

                                            {/* Error Message Display */}
                                            {authError && (
                                                <div className="bg-gradient-to-r from-red-500/20 to-pink-500/20 border-2 border-red-400/50 rounded-xl p-4 mb-4 backdrop-blur-sm">
                                                    <p className="text-red-300 text-center font-semibold">{authError}</p>
                                                </div>
                                            )}

                                            <div>
                                                <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Your Name</label>
                                                <input
                                                    type="text"
                                                    value={userName}
                                                    onChange={(e) => setUserName(e.target.value)}
                                                    placeholder="Enter your name"
                                                    className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Email Address</label>
                                                <input
                                                    type="email"
                                                    value={userEmail}
                                                    onChange={(e) => setUserEmail(e.target.value)}
                                                    placeholder="your@email.com"
                                                    className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Password</label>
                                                <input
                                                    type="password"
                                                    value={userPassword}
                                                    onChange={(e) => {
                                                        setUserPassword(e.target.value);
                                                        setPasswordStrength(checkPasswordStrength(e.target.value));
                                                    }}
                                                    placeholder="Create a password"
                                                    className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                                />

                                                {/* Password Strength Indicator */}
                                                {userPassword && passwordStrength && (
                                                    <div className="mt-3">
                                                        {/* Strength Bar */}
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <div className="flex-1 bg-blue-900/40 rounded-full h-2 overflow-hidden">
                                                                <div
                                                                    className={`h-full transition-all duration-300 ${
                                                                        passwordStrength.color === 'green' ? 'bg-green-500' :
                                                                        passwordStrength.color === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'
                                                                    }`}
                                                                    style={{width: `${(passwordStrength.score / 5) * 100}%`}}
                                                                ></div>
                                                            </div>
                                                            <span className={`text-sm font-bold ${
                                                                passwordStrength.color === 'green' ? 'text-green-400' :
                                                                passwordStrength.color === 'yellow' ? 'text-yellow-400' : 'text-red-400'
                                                            }`}>
                                                                {passwordStrength.strength.toUpperCase()}
                                                            </span>
                                                        </div>

                                                        {/* Requirements Checklist */}
                                                        <div className="bg-blue-900/20 rounded-lg p-3 space-y-1">
                                                            <p className="text-xs text-blue-300 font-bold mb-2">Password Requirements:</p>
                                                            <div className="space-y-1">
                                                                <div className={`text-xs flex items-center gap-2 ${passwordStrength.requirements.minLength ? 'text-green-400' : 'text-gray-400'}`}>
                                                                    <span>{passwordStrength.requirements.minLength ? '' : ''}</span>
                                                                    <span>At least 8 characters</span>
                                                                </div>
                                                                <div className={`text-xs flex items-center gap-2 ${passwordStrength.requirements.hasUpperCase ? 'text-green-400' : 'text-gray-400'}`}>
                                                                    <span>{passwordStrength.requirements.hasUpperCase ? '' : ''}</span>
                                                                    <span>One uppercase letter (A-Z)</span>
                                                                </div>
                                                                <div className={`text-xs flex items-center gap-2 ${passwordStrength.requirements.hasLowerCase ? 'text-green-400' : 'text-gray-400'}`}>
                                                                    <span>{passwordStrength.requirements.hasLowerCase ? '' : ''}</span>
                                                                    <span>One lowercase letter (a-z)</span>
                                                                </div>
                                                                <div className={`text-xs flex items-center gap-2 ${passwordStrength.requirements.hasNumber ? 'text-green-400' : 'text-gray-400'}`}>
                                                                    <span>{passwordStrength.requirements.hasNumber ? '' : ''}</span>
                                                                    <span>One number (0-9)</span>
                                                                </div>
                                                                <div className={`text-xs flex items-center gap-2 ${passwordStrength.requirements.hasSpecial ? 'text-green-400' : 'text-gray-400'}`}>
                                                                    <span>{passwordStrength.requirements.hasSpecial ? '' : ''}</span>
                                                                    <span>One special character (!@#$%^&*)</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <button
                                                onClick={async () => {
                                                    setAuthError('');
                                                    if (!userName || userName.trim().length === 0) {
                                                        setAuthError('Please enter your name');
                                                        return;
                                                    }
                                                    if (!userEmail || !userEmail.includes('@')) {
                                                        setAuthError('Please enter a valid email address');
                                                        return;
                                                    }
                                                    if (!userPassword || userPassword.length < 8) {
                                                        setAuthError('Password must be at least 8 characters long');
                                                        return;
                                                    }

                                                    setLoading(true);
                                                    setLoginCountdown(60);

                                                    // Start countdown timer
                                                    const countdownInterval = setInterval(() => {
                                                        setLoginCountdown(prev => {
                                                            if (prev <= 1) {
                                                                clearInterval(countdownInterval);
                                                                return null;
                                                            }
                                                            return prev - 1;
                                                        });
                                                    }, 1000);

                                                    try {
                                                        await createCompetition(userName.trim(), 0, userPassword);
                                                        clearInterval(countdownInterval);
                                                        setLoginCountdown(null);
                                                    } catch (error) {
                                                        clearInterval(countdownInterval);
                                                        setLoginCountdown(null);
                                                        setAuthError(error.message || 'Failed to create account. Please try again.');
                                                    } finally {
                                                        setLoading(false);
                                                    }
                                                }}
                                                disabled={loading}
                                                className={`w-full bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                {loading ? (loginCountdown ? ` Creating Account... (${loginCountdown}s)` : ' Creating Account...') : ' Create Account & Start Trading'}
                                            </button>
                                        </div>
                                    )}

                                    {/* Login Form */}
                                    {accountMode === 'login' && (
                                        <div className="space-y-6">
                                            <div className="text-center mb-6">
                                                <h2 className="text-3xl font-bold text-white mb-2">Welcome Back!</h2>
                                                <p className="text-gray-200">Sign in to continue trading</p>
                                            </div>

                                            {/* Error Message Display */}
                                            {authError && (
                                                <div className="bg-gradient-to-r from-red-500/20 to-pink-500/20 border-2 border-red-400/50 rounded-xl p-4 mb-4 backdrop-blur-sm">
                                                    <p className="text-red-300 text-center font-semibold">{authError}</p>
                                                </div>
                                            )}

                                            <div>
                                                <label className="block text-gray-300 font-bold mb-3 text-sm uppercase tracking-wide">Email Address</label>
                                                <input
                                                    type="email"
                                                    value={userEmail}
                                                    onChange={(e) => setUserEmail(e.target.value)}
                                                    placeholder="your@email.com"
                                                    className="w-full bg-blue-700/50 border border-gray-800 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-gray-300 font-bold mb-3 text-sm uppercase tracking-wide">Password</label>
                                                <input
                                                    type="password"
                                                    value={userPassword}
                                                    onChange={(e) => setUserPassword(e.target.value)}
                                                    onKeyPress={(e) => {
                                                        if (e.key === 'Enter' && !loading) {
                                                            e.preventDefault();
                                                            document.getElementById('sign-in-button').click();
                                                        }
                                                    }}
                                                    placeholder="Enter your password"
                                                    className="w-full bg-blue-700/50 border border-gray-800 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                                />
                                            </div>

                                            <button
                                                id="sign-in-button"
                                                onClick={async () => {
                                                    setAuthError('');
                                                    if (!userEmail || !userEmail.includes('@')) {
                                                        setAuthError('Please enter a valid email address');
                                                        return;
                                                    }
                                                    if (!userPassword) {
                                                        setAuthError('Please enter your password');
                                                        return;
                                                    }

                                                    setLoading(true);
                                                    setAuthError('');
                                                    setLoginCountdown(60);

                                                    // Start countdown timer
                                                    const countdownInterval = setInterval(() => {
                                                        setLoginCountdown(prev => {
                                                            if (prev <= 1) {
                                                                clearInterval(countdownInterval);
                                                                return null;
                                                            }
                                                            return prev - 1;
                                                        });
                                                    }, 1000);

                                                    // Optimistic UI - prepare data structures immediately
                                                    const email = userEmail.trim().toLowerCase();

                                                    try {
                                                        // Login with 60s timeout for better reliability
                                                        const response = await fetchWithTimeout(`${API_BASE_URL}/api/accounts/login`, {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({
                                                                email: email,
                                                                password: userPassword
                                                            })
                                                        }, 60000);

                                                        const data = await response.json();

                                                        if (!response.ok) {
                                                            clearInterval(countdownInterval);
                                                            setLoginCountdown(null);
                                                            setAuthError(data.error || 'Invalid email or password');
                                                            setLoading(false);
                                                            return;
                                                        }

                                                        const account = data.account;

                                                        if (!account?.accountCode) {
                                                            clearInterval(countdownInterval);
                                                            setLoginCountdown(null);
                                                            setAuthError('Invalid account data received. Please try again.');
                                                            setLoading(false);
                                                            return;
                                                        }

                                                        // Clear countdown on success
                                                        clearInterval(countdownInterval);
                                                        setLoginCountdown(null);

                                                        // Fast state updates - batch them together
                                                        const memberId = Date.now().toString();
                                                        const newCompetition = {
                                                            code: account.accountCode,
                                                            totalPool: 0,
                                                            startTime: account.createdAt,
                                                            members: [{
                                                                id: memberId,
                                                                name: account.userName,
                                                                contribution: 0,
                                                                portfolio: account.portfolio,
                                                                joinedAt: account.createdAt
                                                            }]
                                                        };

                                                        // Batch state updates to minimize re-renders
                                                        setCompetition(newCompetition);
                                                        setCompetitionCode(account.accountCode);
                                                        setCurrentUserId(memberId);
                                                        setUserName(account.userName);
                                                        setUserEmail(account.email);
                                                        setUserPassword('');

                                                        // Immediately transition to app
                                                        setView('app');
                                                        setLoading(false);
                                                    } catch (error) {
                                                        clearInterval(countdownInterval);
                                                        setLoginCountdown(null);
                                                        console.error('Sign in error:', error);
                                                        if (error.message?.includes('timeout')) {
                                                            setAuthError('Login timeout after 60 seconds. Server may be starting up. Please wait 30 seconds and try again.');
                                                        } else if (error.message?.includes('Failed to fetch')) {
                                                            setAuthError('Cannot reach server. Please check your connection and try again.');
                                                        } else {
                                                            setAuthError(error.message || 'Sign in failed. Please try again.');
                                                        }
                                                        setLoading(false);
                                                    }
                                                }}
                                                disabled={loading}
                                                className={`w-full bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-black text-lg transition-all duration-300 shadow-xl hover:shadow-2xl ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                {loading ? (loginCountdown ? ` Signing In... (${loginCountdown}s)` : ' Signing In...') : ' Sign In'}
                                            </button>
                                        </div>
                                    )}

                                </div>
                            </div>
                        </div>
                    );
                }

                // Family/Competition screens
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4 md:p-8">
                        <div className="max-w-2xl mx-auto relative z-10">
                            <button
                                onClick={() => setView('plan-select')}
                                className="mb-6 text-cyan-400 hover:text-gray-300 font-bold transition-all duration-300 flex items-center gap-2 group"
                            >
                                <span className="group-hover:-translate-x-1 transition-transform duration-300"></span><span>Back to Plans</span>
                            </button>

                            <div className="bg-black/80 backdrop-blur-2xl rounded-3xl p-8 md:p-12 border border-gray-800 shadow-2xl relative overflow-hidden" style={{boxShadow: '0 0 60px rgba(6, 182, 212, 0.2)'}}>
                                <h2 className="text-4xl font-bold text-white mb-8 text-center">
                                    {view === 'setup-family' ? 'Create Competition' : 'Join Competition'}
                                </h2>

                                <div className="space-y-6">
                                    {view === 'join-family' && (
                                        <div>
                                            <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Competition Code</label>
                                            <input
                                                type="text"
                                                value={joinCode}
                                                onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                                placeholder="Enter 6-character code"
                                                maxLength="6"
                                                className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-2xl font-bold placeholder-gray-500 text-center tracking-widest uppercase focus:border-cyan-400 focus:outline-none transition-all"
                                            />
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Your Name</label>
                                        <input
                                            type="text"
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                            placeholder="Enter your name"
                                            className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-lg placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-cyan-400 font-bold mb-3 text-sm uppercase tracking-wide">Entry Amount ($)</label>
                                        <input
                                            type="number"
                                            value={contribution}
                                            onChange={(e) => setContribution(e.target.value)}
                                            placeholder="0.00"
                                            className="w-full bg-black/60 border border-gray-800 hover:border-gray-700 focus:border-cyan-400 rounded-xl px-4 py-4 text-white text-2xl font-bold placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition-all"
                                        />
                                    </div>

                                    <button
                                        onClick={() => {
                                            if (!userName) {
                                                alert('Please enter your name');
                                                return;
                                            }

                                            if (view === 'join-family') {
                                                if (!joinCode || joinCode.length !== 6) {
                                                    alert('Please enter a valid 6-character competition code');
                                                    return;
                                                }
                                                if (!contribution || parseFloat(contribution) <= 0) {
                                                    alert('Please enter a valid contribution amount');
                                                    return;
                                                }
                                                joinCompetition(joinCode, userName, contribution);
                                            } else if (!contribution || parseFloat(contribution) <= 0) {
                                                alert('Please enter a valid contribution amount');
                                                return;
                                            } else {
                                                createCompetition(userName, contribution);
                                            }
                                        }}
                                        className="w-full bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all"
                                    >
                                        {view === 'setup-family' ? 'Create Competition' : 'Join Competition'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Trading Interface
            const portfolio = getCurrentPortfolio();
            const portfolioValue = calculatePortfolioValue(portfolio);
            const portfolioReturn = ((portfolioValue - 100000) / 100000) * 100;

            // Calculate daily return based on performance history
            const performanceHistory = portfolio.performanceHistory || [];
            const today = new Date().toDateString();
            const yesterdayValue = performanceHistory.length > 0 ? performanceHistory[performanceHistory.length - 1]?.value || 100000 : 100000;
            const dailyReturn = yesterdayValue > 0 ? ((portfolioValue - yesterdayValue) / yesterdayValue) * 100 : 0;

            const filteredStocks = stocks.filter(stock =>
                stock.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                stock.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <>
                    {/* Toast Notification Container */}
                    <div className="toast-container">
                        {toasts.map(toast => {
                            const icons = {
                                success: '',
                                error: '',
                                warning: '',
                                info: ''
                            };
                            return (
                                <div
                                    key={toast.id}
                                    className={`toast toast-${toast.type} ${toast.closing ? 'closing' : ''}`}
                                    role="alert"
                                    aria-live="polite"
                                >
                                    <div className="toast-content">
                                        <span className="toast-icon">{icons[toast.type]}</span>
                                        <span className="toast-message">{toast.message}</span>
                                    </div>
                                    <button
                                        className="toast-close"
                                        onClick={() => dismissToast(toast.id)}
                                        aria-label="Close notification"
                                    >
                                        
                                    </button>
                                    {toast.duration > 0 && (
                                        <div
                                            className="toast-progress"
                                            style={{ animationDuration: `${toast.duration}ms` }}
                                        />
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {/* Trade Analysis Modal */}
                    {showTradeAnalysis && tradeAnalysisData && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
                            <div className="bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-900 rounded-3xl shadow-2xl max-w-2xl w-full border-2 border-purple-500 overflow-hidden animate-scaleIn max-h-[90vh] overflow-y-auto">
                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 relative">
                                    <button onClick={() => setShowTradeAnalysis(false)} className="absolute top-4 right-4 text-white hover:text-gray-200 text-3xl font-bold"></button>
                                    <h2 className="text-3xl font-black text-white mb-2">Trade Analysis</h2>
                                    <p className="text-gray-400">{tradeAnalysisData.stockName} ({tradeAnalysisData.stock})</p>
                                </div>
                                <div className="p-6 text-center border-b border-purple-700">
                                    <div className="inline-block text-7xl font-black px-12 py-6 rounded-2xl shadow-lg" style={{ backgroundColor: tradeAnalysisData.overallGradeColor + '20', color: tradeAnalysisData.overallGradeColor, border: `3px solid ${tradeAnalysisData.overallGradeColor}` }}>{tradeAnalysisData.overallGrade}</div>
                                    <p className="text-white mt-4 text-lg font-semibold">Overall Trade Grade</p>
                                </div>
                                <div className="p-6 border-b border-purple-700">
                                    <h3 className="text-xl font-bold text-white mb-4">Trade Summary</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800"><div className="text-gray-300 text-sm">Shares Sold</div><div className="text-white text-2xl font-bold">{tradeAnalysisData.shares}</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800"><div className="text-gray-300 text-sm">Hold Duration</div><div className="text-white text-2xl font-bold">{tradeAnalysisData.holdDurationFormatted}</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800"><div className="text-gray-300 text-sm">Buy  Sell Price</div><div className="text-white text-xl font-bold">${tradeAnalysisData.buyPrice}  ${tradeAnalysisData.sellPrice}</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800"><div className="text-gray-300 text-sm">Profit/Loss</div><div className={`text-2xl font-bold ${parseFloat(tradeAnalysisData.profitLoss) >= 0 ? 'text-green-400' : 'text-red-400'}`}>${tradeAnalysisData.profitLoss} ({tradeAnalysisData.profitPercent}%)</div></div>
                                    </div>
                                </div>
                                <div className="p-6 border-b border-purple-700">
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-xl font-bold text-white">Timing Analysis</h3>
                                        <div className="px-4 py-2 rounded-lg font-bold" style={{ backgroundColor: tradeAnalysisData.timingColor + '20', color: tradeAnalysisData.timingColor }}>{tradeAnalysisData.timingGrade}</div>
                                    </div>
                                    <p className="text-gray-400 mb-3">{tradeAnalysisData.timingFeedback}</p>
                                    {parseFloat(tradeAnalysisData.missedProfit) > 0 && (<div className="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-3"><p className="text-yellow-200 text-sm"> Optimal sell price was <span className="font-bold">${tradeAnalysisData.optimalPrice}</span> - you missed ${tradeAnalysisData.missedProfit} in potential gains</p></div>)}
                                </div>
                                <div className="p-6 border-b border-purple-700">
                                    <h3 className="text-xl font-bold text-white mb-4">AI Insights</h3>
                                    <div className="space-y-3">
                                        {tradeAnalysisData.insights.map((insight, idx) => (
                                            <div key={idx} className={`flex items-start gap-3 p-3 rounded-lg border ${insight.type === 'success' ? 'bg-green-900/20 border-green-500/30' : insight.type === 'warning' ? 'bg-yellow-900/20 border-yellow-500/30' : insight.type === 'tip' ? 'bg-blue-900/20 border-blue-500/30' : 'bg-purple-900/20 border-purple-500/30'}`}>
                                                <span className="text-2xl">{insight.icon}</span>
                                                <p className={`text-sm flex-1 ${insight.type === 'success' ? 'text-green-200' : insight.type === 'warning' ? 'text-yellow-200' : insight.type === 'tip' ? 'text-gray-200' : 'text-gray-400'}`}>{insight.text}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-6 bg-indigo-950 flex gap-3">
                                    <button onClick={() => setShowTradeAnalysis(false)} className="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold transition-all">Got It!</button>
                                    <button onClick={() => { setShowTradeAnalysis(false); setMainTab('portfolio'); setActiveTab('history'); }} className="flex-1 bg-blue-700 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all">View All Trades</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Daily Summary Modal */}
                    {showDailySummary && dailySummaryData && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
                            <div className="bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-900 rounded-3xl shadow-2xl max-w-3xl w-full border-2 border-purple-500 overflow-hidden animate-scaleIn max-h-[90vh] overflow-y-auto">
                                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 relative sticky top-0">
                                    <button onClick={() => setShowDailySummary(false)} className="absolute top-4 right-4 text-white hover:text-gray-200 text-3xl font-bold"></button>
                                    <h2 className="text-3xl font-black text-white mb-2">Daily Summary</h2>
                                    <p className="text-gray-400">{dailySummaryData.date}</p>
                                </div>
                                <div className="p-6 border-b border-purple-700">
                                    <h3 className="text-xl font-bold text-white mb-4">Today's Performance</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800 text-center"><div className="text-gray-300 text-sm">Total Trades</div><div className="text-white text-3xl font-bold">{dailySummaryData.totalTrades}</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800 text-center"><div className="text-gray-300 text-sm">Win Rate</div><div className={`text-3xl font-bold ${parseFloat(dailySummaryData.winRate) >= 50 ? 'text-green-400' : 'text-red-400'}`}>{dailySummaryData.winRate}%</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800 text-center"><div className="text-gray-300 text-sm">Total P/L</div><div className={`text-3xl font-bold ${parseFloat(dailySummaryData.totalProfitLoss) >= 0 ? 'text-green-400' : 'text-red-400'}`}>${dailySummaryData.totalProfitLoss}</div></div>
                                        <div className="bg-blue-900/40 rounded-lg p-4 border border-gray-800 text-center"><div className="text-gray-300 text-sm">Profitable</div><div className="text-white text-3xl font-bold">{dailySummaryData.profitableTrades}/{dailySummaryData.sellTrades}</div></div>
                                    </div>
                                </div>
                                {(dailySummaryData.bestTrade || dailySummaryData.worstTrade) && (<div className="p-6 border-b border-purple-700"><h3 className="text-xl font-bold text-white mb-4">Trade Highlights</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{dailySummaryData.bestTrade && (<div className="bg-green-900/20 border border-gray-800 rounded-lg p-4"><div className="flex items-center gap-2 mb-2"><span className="text-2xl"></span><span className="text-green-300 font-bold">Best Trade</span></div><div className="text-white text-xl font-bold">{dailySummaryData.bestTrade.symbol}</div><div className="text-green-400 text-lg">+${dailySummaryData.bestTrade.profit.toFixed(2)}</div></div>)}{dailySummaryData.worstTrade && (<div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4"><div className="flex items-center gap-2 mb-2"><span className="text-2xl"></span><span className="text-red-300 font-bold">Worst Trade</span></div><div className="text-white text-xl font-bold">{dailySummaryData.worstTrade.symbol}</div><div className="text-red-400 text-lg">${dailySummaryData.worstTrade.profit.toFixed(2)}</div></div>)}</div></div>)}
                                <div className="p-6 border-b border-purple-700">
                                    <h3 className="text-xl font-bold text-white mb-4">AI Coach Commentary</h3>
                                    <div className="space-y-3">
                                        {dailySummaryData.commentary.map((comment, idx) => (<div key={idx} className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4"><p className="text-gray-200">{comment}</p></div>))}
                                    </div>
                                </div>
                                <div className="p-6 border-b border-purple-700">
                                    <h3 className="text-xl font-bold text-white mb-4">Behavioral Insights</h3>
                                    <div className="space-y-3">
                                        {dailySummaryData.insights.map((insight, idx) => (
                                            <div key={idx} className={`flex items-start gap-3 p-3 rounded-lg border ${insight.type === 'success' ? 'bg-green-900/20 border-green-500/30' : insight.type === 'warning' ? 'bg-yellow-900/20 border-yellow-500/30' : 'bg-purple-900/20 border-purple-500/30'}`}>
                                                <span className="text-2xl">{insight.icon}</span>
                                                <p className={`text-sm flex-1 ${insight.type === 'success' ? 'text-green-200' : insight.type === 'warning' ? 'text-yellow-200' : 'text-gray-400'}`}>{insight.text}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-6 bg-indigo-950 sticky bottom-0">
                                    <button onClick={() => setShowDailySummary(false)} className="w-full bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold transition-all">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Skip to main content for accessibility */}
                    <a href="#main-content" className="skip-to-content">
                        Skip to main content
                    </a>

                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-700 to-blue-900 p-4">
                    <div id="main-content" className="max-w-7xl mx-auto">
                        {/* Navigation Bar */}
                        <div className="mb-4 flex gap-3">
                            <button
                                onClick={() => setView('plan-select')}
                                className="bg-gradient-to-r from-purple-400 to-pink-500 hover:from-purple-300 hover:to-pink-400 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                            >
                                 Home
                            </button>
                            <div className="relative">
                                <button
                                    onClick={() => setShowAccountMenu(!showAccountMenu)}
                                    className="bg-gradient-to-r from-cyan-400 to-blue-500 hover:from-cyan-300 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2"
                                >
                                     Account
                                </button>
                                {showAccountMenu && (
                                    <div className="absolute top-full mt-2 left-0 w-72 bg-black/95 backdrop-blur-xl border border-gray-800 rounded-xl shadow-2xl z-50 overflow-hidden">
                                        <div className="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 p-4 border-b border-cyan-500/30">
                                            <div className="text-gray-300 text-sm font-semibold">Signed in as</div>
                                            <div className="text-white font-black text-lg">{userName}</div>
                                            <div className="text-gray-400 text-xs">{userEmail}</div>
                                        </div>
                                        <div className="p-2">
                                            <button
                                                onClick={async () => {
                                                    const developerCode = prompt(' DEVELOPER ACCESS REQUIRED \n\n PERMANENT ACCOUNT RESET \n\nThis will PERMANENTLY:\n Delete ALL positions and stocks\n Erase ALL trading history\n Reset cash to $100,000\n Clear watchlist and performance data\n\n THIS CANNOT BE RECOVERED OR UNDONE \n\nEnter developer code to continue:');

                                                    if (!developerCode) {
                                                        return;
                                                    }

                                                    if (developerCode !== 'RWC#1') {
                                                        alert(' Invalid developer code. Access denied.');
                                                        return;
                                                    }

                                                    // First confirmation
                                                    const firstConfirm = confirm(' FINAL WARNING \n\nYou are about to PERMANENTLY RESET your account.\n\nThis will IMMEDIATELY and IRREVERSIBLY:\n\n DELETE all your stock positions\n ERASE your entire trading history\n REMOVE all watchlist items\n DESTROY all performance data\n RESET your cash to $100,000\n\n THIS ACTION IS PERMANENT \n YOUR DATA CANNOT BE RECOVERED \n THERE IS NO UNDO BUTTON \n\nAre you ABSOLUTELY SURE you want to continue?');

                                                    if (!firstConfirm) {
                                                        return;
                                                    }

                                                    // Second confirmation - type confirmation
                                                    const typeConfirm = prompt(' LAST CHANCE TO CANCEL \n\nTo confirm this PERMANENT reset, type exactly:\n\nRESET FOREVER\n\n(This action will delete all your data immediately and cannot be undone)');

                                                    if (typeConfirm !== 'RESET FOREVER') {
                                                        alert(' Reset cancelled. Your account data is safe.');
                                                        return;
                                                    }

                                                    // Final confirmation
                                                    const finalConfirm = confirm(' EXECUTING PERMANENT RESET \n\nThis is your LAST chance to cancel.\n\nClick OK to PERMANENTLY DELETE all your account data.\n\nClick Cancel to keep your account data safe.\n\nAre you 100% certain?');

                                                    if (!finalConfirm) {
                                                        alert(' Reset cancelled. Your account data is safe.');
                                                        return;
                                                    }

                                                    try {
                                                        setLoading(true);
                                                        const response = await fetchWithTimeout(`${API_BASE_URL}/api/accounts/reset`, {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({
                                                                email: userEmail,
                                                                developerCode: developerCode
                                                            })
                                                        }, 30000);

                                                        const data = await response.json();

                                                        if (!response.ok) {
                                                            throw new Error(data.error || 'Failed to reset account');
                                                        }

                                                        // Update local state
                                                        const newCompetition = { ...competition };
                                                        newCompetition.members[0].portfolio = data.portfolio;
                                                        setCompetition(newCompetition);

                                                        setShowAccountMenu(false);
                                                        showToast(' Account permanently reset. All data has been deleted forever.', 'success');

                                                        // Add a delay to show the toast before reload
                                                        setTimeout(() => {
                                                            window.location.reload();
                                                        }, 2000);
                                                    } catch (error) {
                                                        alert(` Reset failed: ${error.message}\n\nYour account data is still intact.`);
                                                    } finally {
                                                        setLoading(false);
                                                    }
                                                }}
                                                className="w-full text-left px-4 py-3 text-red-400 hover:bg-red-500/20 rounded-lg transition-all duration-300 flex items-center gap-3 font-semibold border-2 border-red-500/30"
                                            >
                                                <span className="text-xl"></span>
                                                <span>Reset Account (PERMANENT)</span>
                                            </button>
                                            <button
                                                onClick={() => {
                                                    if (confirm('Are you sure you want to sign out?')) {
                                                        setCompetition(null);
                                                        setCompetitionCode('');
                                                        setCurrentUserId(null);
                                                        setUserName('');
                                                        setUserEmail('');
                                                        setView('plan-select');
                                                        setShowAccountMenu(false);
                                                        showToast('Signed out successfully', 'success');
                                                    }
                                                }}
                                                className="w-full text-left px-4 py-3 text-red-300 hover:bg-red-500/20 rounded-lg transition-all duration-300 flex items-center gap-3 font-semibold"
                                            >
                                                <span className="text-xl"></span>
                                                <span>Sign Out</span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button
                                onClick={() => {
                                    const summary = generateDailySummary();
                                    if (summary) {
                                        setDailySummaryData(summary);
                                        setShowDailySummary(true);
                                    } else {
                                        showToast('No trades today to analyze. Start trading!', 'info');
                                    }
                                }}
                                className="group relative ml-auto bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 flex items-center gap-2 shadow-xl hover:shadow-purple-500/30 overflow-hidden"
                            >
                                <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                                <span className="relative"> Daily Summary</span>
                            </button>
                        </div>

                        {/* Market Movers section removed - use dedicated Market Movers tab to avoid API rate limiting */}

                        {/* Main Tab Navigation - Robinhood Style */}
                        <nav className="sticky top-0 z-40 mb-6 bg-black border-b border-[#2C2C2C]">
                            <div className="flex items-center justify-start gap-1 px-4 py-2 overflow-x-auto">
                                <button
                                    onClick={() => setMainTab('portfolio')}
                                    title="Portfolio - View your holdings and performance"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'portfolio'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Portfolio
                                </button>
                                <button
                                    onClick={() => setMainTab('trading')}
                                    title="Trading - Buy and sell stocks"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'trading'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Trading
                                </button>
                                <button
                                    onClick={() => setMainTab('watchlist')}
                                    title="Watchlist - Track your favorite stocks"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'watchlist'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Watchlist
                                </button>
                                <button
                                    onClick={() => setMainTab('news')}
                                    title="News - Latest market news"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'news'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    News
                                </button>
                                <button
                                    onClick={() => setMainTab('ai-analysis')}
                                    title="AI Analysis - Get AI-powered stock insights"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'ai-analysis'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    AI Analysis
                                </button>
                                <button
                                    onClick={() => {
                                        setMainTab('movers');
                                        if (topGainers.length === 0 && topLosers.length === 0) {
                                            fetchMarketMovers();
                                        }
                                    }}
                                    title="Market Movers - Top gainers and losers"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'movers'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Movers
                                </button>
                                <button
                                    onClick={() => setMainTab('learning')}
                                    title="Learning - Trading education and tutorials"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'learning'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Learning
                                </button>
                                <button
                                    onClick={() => setMainTab('account')}
                                    title="Account - Manage your account settings"
                                    className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                        mainTab === 'account'
                                            ? 'text-white border-[#00C805]'
                                            : 'text-[#A0A0A0] hover:text-white border-transparent'
                                    }`}
                                >
                                    Account
                                </button>
                            </div>
                        </nav>

                        {/* Quick Tips Banner */}
                        {portfolio.history?.length === 0 && (
                            <div className="mb-6 bg-gray-900/80 rounded-2xl p-6 border border-gray-800">
                                <div className="flex items-start gap-4">
                                    <div className="text-5xl"></div>
                                    <div className="flex-1">
                                        <h3 className="text-2xl font-black text-white mb-3">
                                            Getting Started with FinClash
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                            <div className="flex items-start gap-2">
                                                <span className="text-cyan-400 font-bold"></span>
                                                <div>
                                                    <span className="text-white font-bold">Search Stocks:</span>
                                                    <span className="text-gray-400"> Use the search in Trading tab or click popular stocks</span>
                                                </div>
                                            </div>
                                            <div className="flex items-start gap-2">
                                                <span className="text-green-400 font-bold"></span>
                                                <div>
                                                    <span className="text-white font-bold">Quick Trade:</span>
                                                    <span className="text-gray-400"> Use 25%, 50%, 75%, 100% buttons for fast trading</span>
                                                </div>
                                            </div>
                                            <div className="flex items-start gap-2">
                                                <span className="text-blue-400 font-bold"></span>
                                                <div>
                                                    <span className="text-white font-bold">Keyboard:</span>
                                                    <span className="text-gray-400"> Press Enter to select first search result, Esc to clear</span>
                                                </div>
                                            </div>
                                            <div className="flex items-start gap-2">
                                                <span className="text-yellow-400 font-bold"></span>
                                                <div>
                                                    <span className="text-white font-bold">Portfolio:</span>
                                                    <span className="text-gray-400"> Click any stock in your portfolio to trade it</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <div className="group relative bg-black/80 backdrop-blur-2xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700/60 mb-6 overflow-hidden transition-all duration-500" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                            {/* Animated shine effect */}
                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-cyan-400/10 to-transparent pointer-events-none"></div>

                            <div className="relative flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-black flex items-center gap-2">
                                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300" style={{textShadow: '0 0 60px rgba(6, 182, 212, 0.6), 0 0 30px rgba(59, 130, 246, 0.4)'}}>
                                             {plan === 'personal' ? 'Personal Trading' : 'Family Competition'}
                                        </span>
                                    </h1>
                                    <p className="text-gray-300 font-semibold mt-1">{userName}</p>
                                </div>
                                {competition?.code && (
                                    <div className="relative bg-gradient-to-br from-black/60 to-black/40 rounded-2xl px-6 py-3 border border-gray-800 overflow-hidden group/code">
                                        <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/5 to-blue-500/5"></div>
                                        <div className="relative text-xs text-gray-300 font-bold uppercase tracking-wider">Competition Code</div>
                                        <div className="relative text-white text-xl font-black font-mono tracking-wider">{competition.code}</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Portfolio Value - Robinhood Style */}
                        <div className="text-center py-8 mb-6">
                            <div className="text-4xl md:text-5xl font-semibold text-white mb-2">
                                ${portfolioValue.toLocaleString(undefined, {maximumFractionDigits: 0})}
                            </div>
                            <div className={`text-xl md:text-2xl font-medium mb-1 ${portfolioReturn >= 0 ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                {portfolioReturn >= 0 ? '+' : ''}${(portfolioValue - 100000).toLocaleString(undefined, {maximumFractionDigits: 0})} ({portfolioReturn >= 0 ? '+' : ''}{portfolioReturn.toFixed(2)}%)
                            </div>
                            <div className="text-sm text-[#A0A0A0]">All Time</div>
                            {lastUpdate && (
                                <div className="flex items-center justify-center gap-2 mt-3">
                                    <div className="flex h-2 w-2">
                                        <span className="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-[#00C805] opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-2 w-2 bg-[#00C805]"></span>
                                    </div>
                                    <span className="text-xs text-[#A0A0A0]">Live</span>
                                </div>
                            )}
                        </div>

                        {/* Key Stats Row - Robinhood Clean */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                            {/* Cash */}
                            <div className="bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C]">
                                <div className="text-xs text-[#A0A0A0] mb-1">Cash</div>
                                <div className="text-2xl font-semibold text-white">${portfolio.cash.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                <div className="text-xs text-[#A0A0A0] mt-1">
                                    {(portfolio.cash / portfolioValue * 100).toFixed(1)}% of portfolio
                                </div>
                            </div>

                            {/* Today's Change */}
                            <div className="bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C]">
                                <div className="text-xs text-[#A0A0A0] mb-1">Today</div>
                                <div className={`text-2xl font-semibold ${dailyReturn >= 0 ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                    {dailyReturn >= 0 ? '+' : ''}{dailyReturn.toFixed(2)}%
                                </div>
                                <div className={`text-xs ${dailyReturn >= 0 ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                    {dailyReturn >= 0 ? '+' : ''}${(portfolioValue - yesterdayValue).toLocaleString(undefined, {maximumFractionDigits: 0})}
                                </div>
                            </div>

                            {/* Portfolio Health - Keep AI Feature */}
                            <div className="bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C]">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="text-xs text-[#A0A0A0]">UltraThink Health</div>
                                    <div className="bg-purple-500/10 px-2 py-0.5 rounded-full border border-purple-500/30">
                                        <span className="text-[8px] text-purple-400 font-semibold"> AI</span>
                                    </div>
                                </div>
                                {(() => {
                                    const positionsCount = Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length;
                                    const sellTrades = portfolio.history?.filter(t => t.type === 'sell').length || 0;
                                    const profitableTrades = portfolio.history?.filter(t => t.type === 'sell' && (t.profit || 0) > 0).length || 0;
                                    const winRate = sellTrades > 0 ? (profitableTrades / sellTrades) * 100 : 0;
                                    let healthScore = 50;
                                    if (portfolioReturn > 20) healthScore += 30; else if (portfolioReturn > 10) healthScore += 20; else if (portfolioReturn > 0) healthScore += 10; else if (portfolioReturn > -10) healthScore -= 10; else healthScore -= 20;
                                    if (positionsCount >= 10) healthScore += 20; else if (positionsCount >= 5) healthScore += 15; else if (positionsCount >= 3) healthScore += 10; else if (positionsCount === 0) healthScore -= 20;
                                    if (sellTrades > 0) { if (winRate >= 70) healthScore += 20; else if (winRate >= 50) healthScore += 10; else if (winRate < 30) healthScore -= 10; }
                                    healthScore = Math.max(0, Math.min(100, healthScore));
                                    const healthColor = healthScore >= 70 ? 'green' : healthScore >= 40 ? 'yellow' : 'red';
                                    const healthLabel = healthScore >= 70 ? 'Excellent' : healthScore >= 40 ? 'Good' : 'Needs Work';
                                    return (
                                        <div className="flex items-center gap-3">
                                            <div className="text-3xl font-semibold text-white">{healthScore}</div>
                                            <div className="flex-1">
                                                <div className={`text-sm font-semibold ${healthColor === 'green' ? 'text-[#00C805]' : healthColor === 'yellow' ? 'text-yellow-500' : 'text-[#FF5252]'}`}>
                                                    {healthLabel}
                                                </div>
                                                <div className="text-xs text-[#A0A0A0]">{positionsCount} stocks  {sellTrades > 0 ? `${winRate.toFixed(0)}% win` : 'No trades'}</div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>

                        {/* Portfolio Sub-Tab Navigation - Robinhood Style */}
                        {mainTab === 'portfolio' && (
                            <div className="sticky top-16 z-30 mb-6 bg-black border-b border-[#2C2C2C]">
                                <div className="flex items-center gap-1 overflow-x-auto px-4">
                                    <button
                                        onClick={() => setPortfolioSubTab('overview')}
                                        className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                            portfolioSubTab === 'overview'
                                                ? 'text-white border-[#00C805]'
                                                : 'text-[#A0A0A0] hover:text-white border-transparent'
                                        }`}
                                    >
                                        Overview
                                    </button>
                                    <button
                                        onClick={() => setPortfolioSubTab('holdings')}
                                        className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                            portfolioSubTab === 'holdings'
                                                ? 'text-white border-[#00C805]'
                                                : 'text-[#A0A0A0] hover:text-white border-transparent'
                                        }`}
                                    >
                                        Holdings
                                    </button>
                                    <button
                                        onClick={() => setPortfolioSubTab('performance')}
                                        className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                            portfolioSubTab === 'performance'
                                                ? 'text-white border-[#00C805]'
                                                : 'text-[#A0A0A0] hover:text-white border-transparent'
                                        }`}
                                    >
                                        Performance
                                    </button>
                                    <button
                                        onClick={() => setPortfolioSubTab('insights')}
                                        className={`px-4 py-3 font-medium text-sm transition-colors border-b-2 whitespace-nowrap ${
                                            portfolioSubTab === 'insights'
                                                ? 'text-white border-[#00C805]'
                                                : 'text-[#A0A0A0] hover:text-white border-transparent'
                                        }`}
                                    >
                                        Insights
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Overview Sub-Tab - Summary View */}
                        {mainTab === 'portfolio' && portfolioSubTab === 'overview' && (
                            <>
                                {/* Portfolio Health Score */}
                                <div className="relative bg-gradient-to-br from-cyan-900/50 via-blue-900/50 to-cyan-900/50 backdrop-blur-2xl rounded-2xl p-6 border border-gray-800 shadow-2xl mb-4 overflow-hidden group hover:border-gray-700/60 transition-all duration-300" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                                    {/* Animated background */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-blue-600/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>

                                    {/* UltraThink Badge */}
                                    <div className="absolute top-3 right-3 flex items-center gap-2 bg-black/60 backdrop-blur-xl rounded-full px-3 py-1.5 border border-cyan-400/30">
                                        <span className="text-cyan-400 text-xs"></span>
                                        <span className="text-transparent bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 bg-clip-text font-black text-xs">AI POWERED</span>
                                        <span className="flex h-1.5 w-1.5">
                                            <span className="animate-ping absolute inline-flex h-1.5 w-1.5 rounded-full bg-cyan-400 opacity-75"></span>
                                            <span className="relative inline-flex rounded-full h-1.5 w-1.5 bg-cyan-500"></span>
                                        </span>
                                    </div>

                                    <div className="relative">
                                        <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 mb-4">Portfolio Health Score</h2>

                                        <div className="grid md:grid-cols-2 gap-4">
                                            {/* Health Score Gauge */}
                                            <div className="flex flex-col items-center justify-center bg-black/30 rounded-xl p-4 border border-gray-800">
                                                <div className="relative w-40 h-40 mb-3">
                                                    <svg className="transform -rotate-90 w-40 h-40">
                                                        <circle cx="80" cy="80" r="72" stroke="rgba(6, 182, 212, 0.2)" strokeWidth="10" fill="none" />
                                                        <circle cx="80" cy="80" r="72" stroke={(() => {
                                                            const score = Math.min(100, Math.max(0, 50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5)));
                                                            return score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';
                                                        })()} strokeWidth="10" fill="none" strokeDasharray="452.39" strokeDashoffset={452.39 - (452.39 * (Math.min(100, Math.max(0, 50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5))) / 100))} strokeLinecap="round" className="transition-all duration-1000" />
                                                    </svg>
                                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                                        <div className="text-5xl font-black text-white">{Math.min(100, Math.max(0, 50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5))).toFixed(0)}</div>
                                                        <div className="text-xs text-gray-300 font-bold">/ 100</div>
                                                    </div>
                                                </div>
                                                <div className={`text-lg font-black ${(50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5)) >= 80 ? 'text-green-400' : (50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5)) >= 60 ? 'text-yellow-400' : 'text-red-400'}`}>
                                                    {(50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5)) >= 80 ? ' Excellent' : (50 + (portfolioReturn * 2) + (Object.keys(portfolio.positions).length * 5)) >= 60 ? ' Good' : ' Needs Attention'}
                                                </div>
                                            </div>

                                            {/* Health Factors */}
                                            <div className="space-y-2">
                                                <h3 className="text-base font-black text-gray-300 mb-2">Health Factors</h3>
                                                <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                    <div className="flex items-center justify-between mb-1.5">
                                                        <span className="text-xs font-bold text-gray-300"> Diversification</span>
                                                        <span className={`text-sm font-black ${Object.keys(portfolio.positions).length >= 8 ? 'text-green-400' : Object.keys(portfolio.positions).length >= 4 ? 'text-yellow-400' : 'text-red-400'}`}>{Object.keys(portfolio.positions).length >= 8 ? 'Excellent' : Object.keys(portfolio.positions).length >= 4 ? 'Good' : 'Low'}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-800/50 rounded-full h-1.5"><div className={`h-1.5 rounded-full transition-all duration-1000 ${Object.keys(portfolio.positions).length >= 8 ? 'bg-emerald-500 hover:bg-emerald-400' : Object.keys(portfolio.positions).length >= 4 ? 'bg-gradient-to-r from-yellow-500 to-amber-500' : 'bg-gradient-to-r from-red-500 to-rose-500'}`} style={{width: `${Math.min(100, (Object.keys(portfolio.positions).length / 10) * 100)}%`}}></div></div>
                                                    <div className="text-[10px] text-gray-400 mt-0.5">{Object.keys(portfolio.positions).length} positions</div>
                                                </div>
                                                <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                    <div className="flex items-center justify-between mb-1.5">
                                                        <span className="text-xs font-bold text-gray-300"> Returns</span>
                                                        <span className={`text-xs font-black ${portfolioReturn >= 10 ? 'text-green-400' : portfolioReturn >= 0 ? 'text-yellow-400' : 'text-red-400'}`}>{portfolioReturn >= 10 ? 'Strong' : portfolioReturn >= 0 ? 'Moderate' : 'Weak'}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-800/50 rounded-full h-1.5"><div className={`h-1.5 rounded-full transition-all duration-1000 ${portfolioReturn >= 10 ? 'bg-emerald-500 hover:bg-emerald-400' : portfolioReturn >= 0 ? 'bg-gradient-to-r from-yellow-500 to-amber-500' : 'bg-gradient-to-r from-red-500 to-rose-500'}`} style={{width: `${Math.min(100, Math.max(0, 50 + portfolioReturn * 2))}%`}}></div></div>
                                                    <div className="text-[10px] text-gray-400 mt-0.5">{portfolioReturn >= 0 ? '+' : ''}{portfolioReturn.toFixed(2)}% total return</div>
                                                </div>
                                                <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                    <div className="flex items-center justify-between mb-1.5">
                                                        <span className="text-xs font-bold text-gray-300"> Cash Allocation</span>
                                                        <span className={`text-xs font-black ${(portfolio.cash / portfolioValue * 100) >= 20 && (portfolio.cash / portfolioValue * 100) <= 40 ? 'text-green-400' : 'text-yellow-400'}`}>{(portfolio.cash / portfolioValue * 100) >= 20 && (portfolio.cash / portfolioValue * 100) <= 40 ? 'Optimal' : 'Review'}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-800/50 rounded-full h-1.5"><div className="h-1.5 rounded-full transition-all duration-1000 bg-gray-700 hover:bg-gray-600" style={{width: `${(portfolio.cash / portfolioValue * 100)}%`}}></div></div>
                                                    <div className="text-[10px] text-gray-400 mt-0.5">{(portfolio.cash / portfolioValue * 100).toFixed(1)}% in cash</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Top 3 Holdings Preview */}
                                <div className="bg-gradient-to-br from-cyan-900/40 to-blue-950/40 backdrop-blur-xl rounded-2xl p-4 border border-gray-800 mb-4 shadow-xl" style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.15)'}}>
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300"> Top Holdings</h3>
                                        <button
                                            onClick={() => setPortfolioSubTab('holdings')}
                                            className="text-xs text-cyan-400 hover:text-gray-300 font-bold transition-all"
                                        >
                                            View All 
                                        </button>
                                    </div>
                                    {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            <div className="text-4xl mb-2"></div>
                                            <div className="font-semibold">No positions yet</div>
                                            <button
                                                onClick={() => setMainTab('trading')}
                                                className="mt-4 bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all"
                                            >
                                                Start Trading
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {Object.entries(portfolio.positions)
                                                .filter(([_, qty]) => qty > 0)
                                                .map(([symbol, qty]) => {
                                                    const stock = stocks.find(s => s.symbol === symbol);
                                                    if (!stock) return null;
                                                    const pnl = calculatePositionPnL(symbol, stock.price);
                                                    return { symbol, qty, stock, pnl, value: pnl.currentValue };
                                                })
                                                .filter(Boolean)
                                                .sort((a, b) => b.value - a.value)
                                                .slice(0, 3)
                                                .map(({ symbol, qty, stock, pnl }) => {
                                                    const isPositive = pnl.unrealizedPnL >= 0;
                                                    return (
                                                        <div key={symbol} className={`bg-black/30 rounded-lg p-3 border ${isPositive ? 'border-green-500/30' : 'border-red-500/30'}`}>
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <div className="font-black text-white">{symbol}</div>
                                                                    <div className="text-xs text-gray-400">{qty} shares</div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="font-black text-white">${pnl.currentValue.toFixed(2)}</div>
                                                                    <div className={`text-xs font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                                                        {isPositive ? '+' : ''}{pnl.unrealizedPnLPercent.toFixed(2)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    )}
                                </div>

                                {/* AI Quick Insights */}
                                <div className="bg-gradient-to-br from-blue-900/40 to-purple-950/40 backdrop-blur-xl rounded-2xl p-4 border border-gray-800 shadow-xl" style={{boxShadow: '0 0 30px rgba(59, 130, 246, 0.15)'}}>
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-purple-300 flex items-center gap-2">
                                             AI Insights
                                        </h3>
                                        <button
                                            onClick={() => setPortfolioSubTab('insights')}
                                            className="text-xs text-blue-400 hover:text-blue-300 font-bold transition-all"
                                        >
                                            Full Analysis 
                                        </button>
                                    </div>
                                    {(() => {
                                        const positionsCount = Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length;
                                        const insights = [];

                                        if (positionsCount === 0) {
                                            insights.push({ icon: '', text: 'Start building your portfolio with diversified positions', color: 'blue' });
                                        } else if (positionsCount < 3) {
                                            insights.push({ icon: '', text: 'Consider diversifying across more sectors to reduce risk', color: 'yellow' });
                                        } else if (positionsCount >= 10) {
                                            insights.push({ icon: '', text: 'Excellent diversification with ' + positionsCount + ' positions', color: 'green' });
                                        }

                                        if (portfolioReturn > 10) {
                                            insights.push({ icon: '', text: 'Strong performance! Consider taking profits on top performers', color: 'green' });
                                        } else if (portfolioReturn < -10) {
                                            insights.push({ icon: '', text: 'Portfolio down significantly - review your positions', color: 'red' });
                                        }

                                        if (portfolio.cash > portfolioValue * 0.7) {
                                            insights.push({ icon: '', text: 'High cash balance - consider deploying capital', color: 'blue' });
                                        }

                                        return (
                                            <div className="space-y-2">
                                                {insights.slice(0, 3).map((insight, idx) => (
                                                    <div key={idx} className={`bg-black/30 rounded-lg p-3 border ${
                                                        insight.color === 'green' ? 'border-green-500/30' :
                                                        insight.color === 'red' ? 'border-red-500/30' :
                                                        insight.color === 'yellow' ? 'border-yellow-500/30' :
                                                        'border-blue-500/30'
                                                    }`}>
                                                        <div className="flex items-start gap-2">
                                                            <span className="text-lg">{insight.icon}</span>
                                                            <span className={`text-sm font-semibold ${
                                                                insight.color === 'green' ? 'text-green-300' :
                                                                insight.color === 'red' ? 'text-red-300' :
                                                                insight.color === 'yellow' ? 'text-yellow-300' :
                                                                'text-blue-300'
                                                            }`}>{insight.text}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </>
                        )}

                        {/* Portfolio Performance Graph - Now in Performance Sub-Tab */}
                        {mainTab === 'portfolio' && portfolioSubTab === 'performance' && (
                            <div className="bg-gradient-to-br from-indigo-900/60 to-purple-950/60 backdrop-blur-xl rounded-2xl p-6 border-2 border-indigo-500/50 mb-6 shadow-2xl relative overflow-hidden">
                                <div className="absolute inset-0 bg-gradient-to-r from-indigo-500/5 to-purple-500/5 animate-pulse"></div>
                                <div className="relative">
                                    <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300 mb-6 flex items-center gap-2">
                                         Portfolio Performance
                                    </h2>

                                    {performanceHistory.length > 0 ? (
                                        <div className="space-y-4">
                                            {/* Graph */}
                                            <div className="bg-black/30 rounded-xl p-4 border border-indigo-500/30">
                                                <div className="flex items-end justify-between h-48 gap-1">
                                                    {performanceHistory.slice(-30).map((point, idx) => {
                                                        const maxValue = Math.max(...performanceHistory.slice(-30).map(p => p.value));
                                                        const minValue = Math.min(...performanceHistory.slice(-30).map(p => p.value));
                                                        const range = maxValue - minValue || 1;
                                                        const height = ((point.value - minValue) / range) * 100;
                                                        const isProfit = point.value >= 100000;

                                                        return (
                                                            <div
                                                                key={idx}
                                                                className="flex-1 group relative cursor-pointer"
                                                                title={`${point.date}: $${point.value.toLocaleString()}`}
                                                            >
                                                                <div
                                                                    className={`w-full rounded-t transition-all duration-300 ${
                                                                        isProfit
                                                                            ? 'bg-gradient-to-t from-green-600 to-emerald-400 hover:from-green-500 hover:to-emerald-300'
                                                                            : 'bg-gradient-to-t from-red-600 to-rose-400 hover:from-red-500 hover:to-rose-300'
                                                                    }`}
                                                                    style={{ height: `${Math.max(height, 5)}%` }}
                                                                ></div>
                                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/90 text-white text-xs px-2 py-1 rounded whitespace-nowrap pointer-events-none z-10">
                                                                    <div className="font-bold">${point.value.toLocaleString()}</div>
                                                                    <div className="text-gray-400">{new Date(point.date).toLocaleDateString()}</div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {/* Baseline */}
                                                <div className="mt-2 flex justify-between text-xs text-gray-400">
                                                    <span>{performanceHistory.length > 30 ? performanceHistory[performanceHistory.length - 30].date : performanceHistory[0]?.date}</span>
                                                    <span className="text-indigo-400 font-bold">$100,000 starting value</span>
                                                    <span>{performanceHistory[performanceHistory.length - 1]?.date}</span>
                                                </div>
                                            </div>

                                            {/* Performance Stats */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                <div className="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/30">
                                                    <div className="text-xs text-indigo-300 mb-1">Peak Value</div>
                                                    <div className="text-lg font-black text-white">
                                                        ${Math.max(...performanceHistory.map(p => p.value)).toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/30">
                                                    <div className="text-xs text-indigo-300 mb-1">Lowest Value</div>
                                                    <div className="text-lg font-black text-white">
                                                        ${Math.min(...performanceHistory.map(p => p.value)).toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/30">
                                                    <div className="text-xs text-indigo-300 mb-1">Best Day</div>
                                                    <div className="text-lg font-black text-green-400">
                                                        {(() => {
                                                            let maxDailyChange = 0;
                                                            for (let i = 1; i < performanceHistory.length; i++) {
                                                                const change = ((performanceHistory[i].value - performanceHistory[i-1].value) / performanceHistory[i-1].value) * 100;
                                                                if (change > maxDailyChange) maxDailyChange = change;
                                                            }
                                                            return `+${maxDailyChange.toFixed(2)}%`;
                                                        })()}
                                                    </div>
                                                </div>
                                                <div className="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/30">
                                                    <div className="text-xs text-indigo-300 mb-1">Worst Day</div>
                                                    <div className="text-lg font-black text-red-400">
                                                        {(() => {
                                                            let minDailyChange = 0;
                                                            for (let i = 1; i < performanceHistory.length; i++) {
                                                                const change = ((performanceHistory[i].value - performanceHistory[i-1].value) / performanceHistory[i-1].value) * 100;
                                                                if (change < minDailyChange) minDailyChange = change;
                                                            }
                                                            return `${minDailyChange.toFixed(2)}%`;
                                                        })()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 bg-indigo-500/10 rounded-xl border-2 border-dashed border-indigo-500/30">
                                            <div className="text-6xl mb-3 opacity-50"></div>
                                            <div className="text-gray-300 font-semibold">Performance tracking will begin after your first trade</div>
                                            <div className="text-sm text-gray-400 mt-2">Make a trade to start building your performance history</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Top Stocks to Buy - UltraThink AI Analysis */}
                        {mainTab === 'portfolio' && portfolioSubTab === 'insights' && (() => {
                            // Use curated universe for recommendations (not user's stocks)
                            const stocksToAnalyze = curatedStocks.length > 0 ? curatedStocks : [];

                            if (stocksToAnalyze.length === 0) {
                                // Show loading state or button to fetch
                                return (
                                    <div className="bg-gradient-to-br from-purple-900/60 via-indigo-900/60 to-purple-900/60 backdrop-blur-xl rounded-2xl p-8 border border-gray-800 shadow-2xl mb-6 text-center">
                                        <span className="text-4xl mb-4 inline-block"></span>
                                        <h2 className="text-2xl font-black text-white mb-4">Top Stocks to Buy Now</h2>
                                        <p className="text-gray-400 mb-6">Analyzing 150+ quality stocks across 15+ sectors...</p>
                                        <button
                                            onClick={fetchCuratedStocks}
                                            className="bg-gray-700 hover:bg-gray-600 hover:from-purple-400 hover:to-pink-400 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg"
                                        >
                                            Load Recommendations
                                        </button>
                                    </div>
                                );
                            }

                            // UltraThink AI: Advanced multi-factor analysis
                            const analyzedStocks = stocksToAnalyze.map(stock => {
                                let buyScore = 50;
                                let signals = [];
                                let reasoning = '';

                                // 1. Momentum (+/- 20)
                                if (stock.change > 5) {
                                    buyScore += 20;
                                    signals.push(' Strong upward momentum');
                                } else if (stock.change > 2) {
                                    buyScore += 12;
                                    signals.push(' Positive momentum');
                                } else if (stock.change > 0) {
                                    buyScore += 5;
                                } else if (stock.change < -5) {
                                    buyScore -= 15;
                                    signals.push(' Deep dip opportunity');
                                } else if (stock.change < -2) {
                                    buyScore -= 5;
                                    signals.push(' Pullback');
                                }

                                // 2. Price Position (+/- 18)
                                const priceRange = stock.high - stock.low;
                                const currentPosition = priceRange > 0 ? (stock.price - stock.low) / priceRange : 0.5;

                                if (currentPosition > 0.85) {
                                    buyScore += 18;
                                    signals.push(' Breaking highs');
                                } else if (currentPosition > 0.7) {
                                    buyScore += 12;
                                } else if (currentPosition < 0.25) {
                                    buyScore += 15;
                                    signals.push(' Entry at support');
                                } else if (currentPosition < 0.4) {
                                    buyScore += 8;
                                }

                                // 3. Volume (+/- 12)
                                if (stock.volume) {
                                    if (stock.volume > 50000000) {
                                        buyScore += 12;
                                        signals.push(' Exceptional volume');
                                    } else if (stock.volume > 10000000) {
                                        buyScore += 8;
                                        signals.push('High liquidity');
                                    } else if (stock.volume > 1000000) {
                                        buyScore += 4;
                                    }
                                }

                                // 4. Relative Strength (+/- 15)
                                const avgMarketChange = stocksToAnalyze.reduce((sum, s) => sum + (s.change || 0), 0) / stocksToAnalyze.length;
                                const relativeStrength = stock.change - avgMarketChange;

                                if (relativeStrength > 3) {
                                    buyScore += 15;
                                    signals.push(' Outperforming market');
                                } else if (relativeStrength > 1) {
                                    buyScore += 10;
                                } else if (relativeStrength < -3) {
                                    buyScore -= 8;
                                }

                                // 5. Volatility (+/- 10)
                                const volatility = priceRange / stock.previousClose;
                                if (volatility > 0.05) {
                                    buyScore += 10;
                                    signals.push(' High volatility');
                                } else if (volatility > 0.02) {
                                    buyScore += 5;
                                }

                                // 6. Intraday Trend (+/- 7)
                                const openToCurrentMove = stock.price - stock.open;
                                const dayRange = stock.high - stock.low;
                                if (dayRange > 0) {
                                    const intradayStrength = openToCurrentMove / dayRange;
                                    if (intradayStrength > 0.5) {
                                        buyScore += 7;
                                    }
                                }

                                // 7. Social Buzz / Volume Spike (+10)
                                const avgVolume = 5000000; // Baseline average
                                const volumeRatio = stock.volume / avgVolume;
                                if (volumeRatio > 5) {
                                    buyScore += 10;
                                    signals.push(' Viral momentum');
                                } else if (volumeRatio > 3) {
                                    buyScore += 7;
                                    signals.push(' Social buzz');
                                } else if (volumeRatio > 2) {
                                    buyScore += 4;
                                }

                                // 8. News Sentiment (+8)
                                // Positive momentum = positive news sentiment
                                if (stock.change > 3 && stock.volume > 10000000) {
                                    buyScore += 8;
                                    signals.push(' Positive news');
                                } else if (stock.change > 1.5 && stock.volume > 5000000) {
                                    buyScore += 5;
                                } else if (stock.change < -3 && stock.volume > 10000000) {
                                    buyScore -= 6;
                                    signals.push(' Negative headlines');
                                }

                                // 9. Technical Indicators - RSI Simulation (+10)
                                // Simulate RSI using price position and momentum
                                const priceVsHigh = (stock.high - stock.price) / (stock.high - stock.low || 1);
                                const rsiSimulation = stock.change > 5 ? 75 : stock.change > 2 ? 60 : stock.change < -5 ? 25 : 50;

                                if (rsiSimulation < 30) {
                                    buyScore += 10;
                                    signals.push(' Oversold - reversal');
                                } else if (rsiSimulation > 70 && stock.change > 3) {
                                    buyScore += 7;
                                    signals.push(' Momentum breakout');
                                }

                                // 10. Sector Rotation (+8)
                                // Stocks outperforming by 2x+ = hot sector
                                if (relativeStrength > avgMarketChange * 2) {
                                    buyScore += 8;
                                    signals.push(' Hot sector leader');
                                } else if (relativeStrength > avgMarketChange * 1.5) {
                                    buyScore += 5;
                                }

                                // 11. Gap Analysis (+7)
                                const gapSize = Math.abs(stock.open - stock.previousClose);
                                const gapPercent = (gapSize / stock.previousClose) * 100;
                                if (gapPercent > 3 && stock.price > stock.open) {
                                    buyScore += 7;
                                    signals.push(' Gap up + holding');
                                } else if (gapPercent > 2 && stock.price > stock.open) {
                                    buyScore += 4;
                                }

                                // 12. Consistency Score (+5)
                                // Steady uptrend = consistent winner
                                if (stock.change > 0 && stock.price > stock.low * 1.02) {
                                    buyScore += 5;
                                    signals.push(' Consistent uptrend');
                                } else if (stock.change > 1 && volatility < 0.03) {
                                    buyScore += 3;
                                }

                                // Enhanced Reasoning with new score ranges
                                if (buyScore >= 95) {
                                    reasoning = ' MUST BUY - Rare exceptional opportunity with multiple catalysts';
                                } else if (buyScore >= 85) {
                                    reasoning = ' STRONG BUY - Outstanding setup with strong bullish signals';
                                } else if (buyScore >= 75) {
                                    reasoning = ' BUY - Solid opportunity with favorable momentum';
                                } else if (buyScore >= 65) {
                                    reasoning = ' MODERATE BUY - Positive indicators, good entry point';
                                } else if (buyScore >= 55) {
                                    reasoning = ' HOLD - Mixed signals, wait for confirmation';
                                } else if (buyScore >= 45) {
                                    reasoning = ' CAUTION - Weak signals, monitor closely';
                                } else {
                                    reasoning = ' AVOID - Poor setup, look elsewhere';
                                }

                                return {
                                    ...stock,
                                    buyScore: Math.min(100, Math.max(0, buyScore)),
                                    signals,
                                    reasoning,
                                    recommendation: buyScore >= 70 ? 'STRONG BUY' :
                                                  buyScore >= 60 ? 'BUY' :
                                                  buyScore >= 50 ? 'HOLD' : 'AVOID'
                                };
                            });

                            // Sort by buy score and get top 10
                            const topBuys = analyzedStocks
                                .sort((a, b) => b.buyScore - a.buyScore)
                                .slice(0, 10);

                            if (topBuys.length === 0) return null;

                            return (
                                <div className="bg-gradient-to-br from-purple-900/60 via-indigo-900/60 to-purple-900/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 shadow-2xl mb-6 relative overflow-hidden">
                                    {/* Animated background */}
                                    <div className="absolute inset-0 bg-gradient-to-r from-purple-500/10 to-pink-500/10 animate-pulse"></div>

                                    <div className="relative">
                                        <div className="flex items-center justify-between mb-6">
                                            <div className="flex items-center gap-3">
                                                <span className="text-4xl animate-pulse"></span>
                                                <div>
                                                    <h2 className="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300">
                                                        Top Stocks to Buy Now
                                                    </h2>
                                                    <p className="text-sm text-gray-300">Analyzing 150+ curated stocks  Updated hourly</p>
                                                    <p className="text-xs text-purple-400 mt-1">Top picks from Tech, Finance, Healthcare, Energy & more</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setCuratedStocksCache(null);
                                                    fetchCuratedStocks();
                                                }}
                                                className="text-xs bg-gray-700 hover:bg-gray-600 hover:from-purple-400 hover:to-pink-400 text-white px-4 py-2 rounded-full font-bold transition-all flex items-center gap-2"
                                            >
                                                 Refresh
                                            </button>
                                        </div>

                                        <div className="space-y-3">
                                            {topBuys.map((stock, idx) => {
                                                const recommendationColor =
                                                    stock.recommendation === 'STRONG BUY' ? 'text-emerald-400' :
                                                    stock.recommendation === 'BUY' ? 'text-green-400' :
                                                    stock.recommendation === 'HOLD' ? 'text-yellow-400' :
                                                    'text-gray-400';

                                                return (
                                                    <div
                                                        key={idx}
                                                        onClick={() => {
                                                            addToWatchlist(stock.symbol);
                                                            setMainTab('trading');
                                                        }}
                                                        className="group bg-gray-900/50 hover:bg-gray-900/80 rounded-xl p-4 border border-gray-800/50 hover:border-purple-500/50 transition-all cursor-pointer"
                                                    >
                                                        {/* Compact header */}
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-3">
                                                                <span className="text-gray-500 text-sm">#{idx + 1}</span>
                                                                <div>
                                                                    <h3 className="text-lg font-bold text-white">{stock.symbol}</h3>
                                                                    <div className="text-xs text-gray-500 truncate max-w-[200px]">{stock.name}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-2xl font-bold text-purple-400">{stock.buyScore}</div>
                                                                <div className="text-xs text-gray-500">Score</div>
                                                            </div>
                                                        </div>

                                                        {/* Price and change */}
                                                        <div className="flex items-center justify-between py-2 border-y border-gray-800/50">
                                                            <div>
                                                                <div className="text-xs text-gray-500">Price</div>
                                                                <div className="text-lg font-semibold text-white">${stock.price.toFixed(2)}</div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-xs text-gray-500">Change</div>
                                                                <div className={`text-lg font-semibold ${stock.change >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                    {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Rating and top signal */}
                                                        <div className="mt-3 flex items-center justify-between">
                                                            <div className={`text-sm font-bold ${recommendationColor}`}>
                                                                {stock.recommendation}
                                                            </div>
                                                            {stock.signals[0] && (
                                                                <div className="text-xs text-gray-400 truncate max-w-[200px]">
                                                                    {stock.signals[0]}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Disclaimer */}
                                        <div className="mt-6 pt-4 border-t border-purple-500/30 text-center">
                                            <div className="text-xs text-gray-400">
                                                 AI recommendations are for educational purposes only. Past performance does not guarantee future results. Always do your own research.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                        {mainTab === 'portfolio' && portfolioSubTab === 'holdings' && (
                            <div className="group relative bg-black/80 backdrop-blur-2xl rounded-2xl p-6 border border-gray-800 hover:border-gray-700/60 transition-all duration-500 overflow-hidden mb-6" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                                <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-cyan-400/10 to-transparent"></div>

                                <div className="relative flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                                    <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 flex items-center gap-2">
                                         Your Holdings
                                        <span className="text-sm text-gray-300 font-semibold bg-cyan-500/20 px-3 py-1 rounded-full border border-gray-800">
                                            {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length}
                                        </span>
                                    </h3>

                                    {/* Sort and Filter Controls */}
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <select value={holdingsSortBy} onChange={(e) => setHoldingsSortBy(e.target.value)} className="bg-black/50 border border-gray-800 text-gray-300 px-3 py-2 rounded-lg font-bold text-sm focus:outline-none focus:border-cyan-400 transition-all">
                                            <option value="value">Sort by Value</option>
                                            <option value="gainPercent">Sort by Gain %</option>
                                            <option value="symbol">Sort by Symbol</option>
                                        </select>
                                        <button onClick={() => setShowOnlyProfitable(!showOnlyProfitable)} className={`px-3 py-2 rounded-lg font-bold text-sm transition-all ${showOnlyProfitable ? 'bg-green-500/30 border-2 border-green-400 text-green-300' : 'bg-black/50 border border-gray-800 text-gray-400 hover:text-gray-300'}`}>
                                            {showOnlyProfitable ? ' Profitable Only' : 'Show All'}
                                        </button>
                                    </div>
                                </div>

                                <div className="relative space-y-2">
                                    {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length === 0 ? (
                                        <div className="text-center py-12 bg-cyan-500/10 rounded-xl border-2 border-dashed border-cyan-500/30 animate-fade-in">
                                            <div className="text-6xl mb-3 opacity-50 animate-bounce"></div>
                                            <div className="text-gray-300 font-semibold">No positions yet</div>
                                            <div className="text-sm text-gray-400 mt-2">Buy your first stock to get started!</div>
                                        </div>
                                    ) : (
                                        (() => {
                                            const holdingsData = Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).map(([symbol, qty]) => {
                                                const stock = stocks.find(s => s.symbol === symbol);
                                                if (!stock) return null;
                                                const pnl = calculatePositionPnL(symbol, stock.price);
                                                return { symbol, qty, stock, pnl };
                                            }).filter(Boolean);

                                            let filteredHoldings = showOnlyProfitable ? holdingsData.filter(h => h.pnl.unrealizedPnL >= 0) : holdingsData;

                                            filteredHoldings.sort((a, b) => {
                                                if (holdingsSortBy === 'value') return b.pnl.currentValue - a.pnl.currentValue;
                                                if (holdingsSortBy === 'gainPercent') return b.pnl.unrealizedPnLPercent - a.pnl.unrealizedPnLPercent;
                                                if (holdingsSortBy === 'symbol') return a.symbol.localeCompare(b.symbol);
                                                return 0;
                                            });

                                            return filteredHoldings.map(({ symbol, qty, stock, pnl }) => {
                                                const isPositive = pnl.unrealizedPnL >= 0;
                                                const isExpanded = expandedHolding === symbol;

                                                return (
                                                    <div key={symbol} className="group/card">
                                                        {/* Clean stock row */}
                                                        <div
                                                            onClick={() => setExpandedHolding(isExpanded ? null : symbol)}
                                                            className="flex items-center justify-between py-4 border-b border-gray-800/50 cursor-pointer hover:bg-gray-900/50 transition-colors px-2"
                                                        >
                                                            <div className="flex items-center gap-3">
                                                                <div>
                                                                    <div className="font-semibold text-white">{symbol}</div>
                                                                    <div className="text-sm text-gray-500">{qty} shares</div>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-4">
                                                                <div className="text-right">
                                                                    <div className="font-semibold text-white">${pnl.currentValue.toFixed(2)}</div>
                                                                    <div className={`text-sm ${isPositive ? 'text-emerald-500' : 'text-red-500'}`}>
                                                                        {isPositive ? '+' : ''}{pnl.unrealizedPnLPercent.toFixed(2)}%
                                                                    </div>
                                                                </div>
                                                                <div className={`text-gray-500 transition-transform ${isExpanded ? 'rotate-180' : ''}`}></div>
                                                            </div>
                                                        </div>

                                                        {/* Expanded details */}
                                                        {isExpanded && (
                                                            <div className="bg-gray-900/30 border-b border-gray-800/50 p-4 space-y-4">
                                                                {/* Metrics */}
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                                    <div>
                                                                        <div className="text-xs text-gray-500 mb-1">Cost Basis</div>
                                                                        <div className="text-white font-semibold">${pnl.avgCost.toFixed(2)}</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-500 mb-1">Current Price</div>
                                                                        <div className="text-white font-semibold">${stock.price.toFixed(2)}</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-500 mb-1">Total Cost</div>
                                                                        <div className="text-white font-semibold">${pnl.totalCost.toFixed(2)}</div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="text-xs text-gray-500 mb-1">Total Gain/Loss</div>
                                                                        <div className={`font-semibold ${isPositive ? 'text-emerald-500' : 'text-red-500'}`}>
                                                                            {isPositive ? '+' : ''}${pnl.unrealizedPnL.toFixed(2)}
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                {/* Action buttons */}
                                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); setSelectedStock(symbol); setMainTab('trading'); setActiveTab('market'); }}
                                                                        className="bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
                                                                    >
                                                                        Buy More
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); setSelectedStock(symbol); setMainTab('trading'); setActiveTab('market'); }}
                                                                        className="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
                                                                    >
                                                                        Sell
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); setSelectedStock(symbol); setMainTab('ai-analysis'); }}
                                                                        className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-1"
                                                                    >
                                                                        <span></span><span className="hidden sm:inline">UltraThink</span>
                                                                    </button>
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); setMainTab('news'); }}
                                                                        className="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
                                                                    >
                                                                        News
                                                                    </button>
                                                                </div>

                                                                {/* AI Recommendation */}
                                                                {(() => {
                                                                    const currentChange = stock.change || 0;
                                                                    const positionReturn = pnl.unrealizedPnLPercent;
                                                                    let aiAction = 'Hold', aiReason = '';
                                                                    if (positionReturn > 15 && currentChange < -2) { aiAction = 'Consider Taking Profits'; aiReason = 'Strong gains with recent weakness'; }
                                                                    else if (positionReturn < -10 && currentChange < -2) { aiAction = 'Consider Stop Loss'; aiReason = 'Significant loss with downtrend'; }
                                                                    else if (positionReturn > 0 && currentChange > 2) { aiAction = 'Strong Hold'; aiReason = 'Profitable with momentum'; }
                                                                    else if (positionReturn < -5 && currentChange > 2) { aiAction = 'Consider Adding'; aiReason = 'Recovery momentum detected'; }

                                                                    return aiReason && (
                                                                        <div className="bg-purple-600/10 rounded-lg p-3 border border-purple-600/30">
                                                                            <div className="flex items-start gap-2">
                                                                                <span className="text-lg"></span>
                                                                                <div>
                                                                                    <div className="font-semibold text-sm text-purple-300">UltraThink: {aiAction}</div>
                                                                                    <div className="text-xs text-gray-400 mt-1">{aiReason}</div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            });
                                        })()
                                    )}
                                </div>
                            </div>
                        )}

                        {/* AI Portfolio Health Analysis */}
                        {mainTab === 'portfolio' && portfolioSubTab === 'insights' && (() => {
                            const positionsArray = Object.entries(portfolio.positions || {}).map(([symbol, shares]) => ({
                                symbol,
                                shares
                            }));

                            const totalPositions = positionsArray.length;
                            const profitablePositions = positionsArray.filter(pos => {
                                const stock = stocks.find(s => s.symbol === pos.symbol);
                                if (!stock) return false;
                                // For simplicity, assume current price > average (we don't track avgPrice in this structure)
                                // In reality, you'd need to track purchase price separately
                                return stock.c > 0; // Just count positions with valid price for now
                            }).length;

                            const lossingPositions = totalPositions - profitablePositions;
                            const winRate = totalPositions > 0 ? (profitablePositions / totalPositions) * 100 : 0;

                            const diversificationScore = Math.min(100, (totalPositions / 10) * 100);

                            let riskLevel = 'Low';
                            let riskColor = 'green';
                            if (portfolioReturn < -10) {
                                riskLevel = 'High';
                                riskColor = 'red';
                            } else if (portfolioReturn < -5 || lossingPositions > profitablePositions) {
                                riskLevel = 'Medium';
                                riskColor = 'yellow';
                            }

                            const recommendations = [];
                            if (diversificationScore < 30 && totalPositions > 0) {
                                recommendations.push({ icon: '', text: 'Consider diversifying across more sectors', priority: 'high' });
                            }
                            if (portfolioReturn < -10) {
                                recommendations.push({ icon: '', text: 'High portfolio risk - review stop-loss positions', priority: 'high' });
                            }
                            if (portfolio.cash > portfolioValue * 0.5) {
                                recommendations.push({ icon: '', text: 'High cash balance - consider deploying capital', priority: 'medium' });
                            }
                            if (winRate > 70 && portfolioReturn > 10) {
                                recommendations.push({ icon: '', text: 'Strong performance - consider taking profits on top performers', priority: 'medium' });
                            }
                            if (totalPositions === 0) {
                                recommendations.push({ icon: '', text: 'Portfolio empty - start with diversified positions', priority: 'high' });
                            }
                            if (lossingPositions > profitablePositions && totalPositions > 0) {
                                recommendations.push({ icon: '', text: 'More losing than winning positions - review strategy', priority: 'high' });
                            }

                            return (
                                <div className="bg-gradient-to-br from-purple-900/60 via-indigo-900/60 to-purple-900/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 mb-6 shadow-2xl relative overflow-hidden">
                                    {/* Animated background */}
                                    <div className="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 animate-pulse"></div>

                                    <div className="relative">
                                        <div className="flex items-center justify-between mb-6">
                                            <div className="flex items-center gap-3">
                                                <span className="text-4xl animate-pulse"></span>
                                                <h2 className="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">
                                                    AI Portfolio Health
                                                </h2>
                                                <span className="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-full font-bold">LIVE</span>
                                            </div>
                                        </div>

                                        {/* Portfolio Health Metrics */}
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                            {/* Risk Level */}
                                            <div className={`bg-gradient-to-br ${
                                                riskColor === 'green' ? 'from-green-900/40 to-emerald-900/40 border-green-500/50' :
                                                riskColor === 'yellow' ? 'from-yellow-900/40 to-orange-900/40 border-yellow-500/50' :
                                                'from-red-900/40 to-pink-900/40 border-red-500/50'
                                            } rounded-xl p-4 border-2`}>
                                                <div className="text-xs text-gray-300 font-bold mb-2">RISK LEVEL</div>
                                                <div className={`text-2xl font-black ${
                                                    riskColor === 'green' ? 'text-green-300' :
                                                    riskColor === 'yellow' ? 'text-yellow-300' :
                                                    'text-red-300'
                                                }`}>{riskLevel}</div>
                                            </div>

                                            {/* Win Rate */}
                                            <div className="bg-gradient-to-br from-blue-900/40 to-cyan-900/40 rounded-xl p-4 border border-gray-800">
                                                <div className="text-xs text-gray-300 font-bold mb-2">WIN RATE</div>
                                                <div className="text-2xl font-black text-gray-300">{winRate.toFixed(0)}%</div>
                                                <div className="text-[10px] text-gray-400 mt-1">{profitablePositions}/{totalPositions} profitable</div>
                                            </div>

                                            {/* Diversification */}
                                            <div className="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 rounded-xl p-4 border-2 border-indigo-500/50">
                                                <div className="text-xs text-gray-300 font-bold mb-2">DIVERSIFICATION</div>
                                                <div className="text-2xl font-black text-gray-300">{diversificationScore.toFixed(0)}%</div>
                                                <div className="text-[10px] text-gray-400 mt-1">{totalPositions} positions</div>
                                            </div>

                                            {/* Portfolio Momentum */}
                                            <div className={`bg-gradient-to-br ${
                                                portfolioReturn > 5 ? 'from-green-900/40 to-emerald-900/40 border-green-500/50' :
                                                portfolioReturn < -5 ? 'from-red-900/40 to-pink-900/40 border-red-500/50' :
                                                'from-gray-900/40 to-slate-900/40 border-gray-500/50'
                                            } rounded-xl p-4 border-2`}>
                                                <div className="text-xs text-gray-300 font-bold mb-2">MOMENTUM</div>
                                                <div className={`text-2xl font-black ${
                                                    portfolioReturn > 5 ? 'text-green-300' :
                                                    portfolioReturn < -5 ? 'text-red-300' :
                                                    'text-gray-300'
                                                }`}>
                                                    {portfolioReturn > 5 ? ' Strong' : portfolioReturn < -5 ? ' Weak' : ' Neutral'}
                                                </div>
                                            </div>
                                        </div>

                                        {/* AI Recommendations */}
                                        {recommendations.length > 0 && (
                                            <div className="bg-black/20 rounded-xl p-4 border border-gray-800">
                                                <div className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                                                    <span></span>
                                                    <span>AI Recommendations</span>
                                                </div>
                                                <div className="space-y-2">
                                                    {recommendations.map((rec, idx) => (
                                                        <div key={idx} className={`flex items-start gap-2 text-sm ${
                                                            rec.priority === 'high' ? 'text-yellow-300' : 'text-blue-300'
                                                        }`}>
                                                            <span className="text-lg">{rec.icon}</span>
                                                            <span className="flex-1">{rec.text}</span>
                                                            {rec.priority === 'high' && (
                                                                <span className="text-[10px] bg-red-500/30 px-2 py-0.5 rounded-full font-bold text-red-300">HIGH</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })()}

                        {/* Portfolio View */}
                        {mainTab === 'portfolio' && (
                            <>

                        {/* Portfolio Breakdown */}
                        <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 mb-6 shadow-2xl">
                            <h2 className="text-2xl font-black text-white mb-6 flex items-center gap-2">
                                 Portfolio Breakdown
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Visual Allocation Bar */}
                                <div>
                                    <div className="mb-4">
                                        <div className="flex justify-between text-sm text-gray-200 mb-2 font-semibold">
                                            <span>Asset Allocation</span>
                                            <span>Total: ${portfolioValue.toLocaleString()}</span>
                                        </div>
                                        <div className="h-8 bg-blue-900/50 rounded-xl overflow-hidden flex border-2 border-blue-600">
                                            <div
                                                className="bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold transition-all duration-500"
                                                style={{ width: `${(portfolio.cash / portfolioValue * 100)}%` }}
                                            >
                                                {(portfolio.cash / portfolioValue * 100) > 10 && 'Cash'}
                                            </div>
                                            {Object.entries(portfolio.positions)
                                                .filter(([_, qty]) => qty > 0)
                                                .map(([symbol, qty]) => {
                                                    const stock = stocks.find(s => s.symbol === symbol);
                                                    if (!stock) return null;
                                                    const value = stock.price * qty;
                                                    const percentage = (value / portfolioValue * 100);

                                                    const colors = [
                                                        'from-green-500 to-emerald-600',
                                                        'from-purple-500 to-indigo-600',
                                                        'from-orange-500 to-red-600',
                                                        'from-pink-500 to-rose-600',
                                                        'from-yellow-500 to-amber-600'
                                                    ];
                                                    const colorIndex = symbol.charCodeAt(0) % colors.length;

                                                    return (
                                                        <div
                                                            key={symbol}
                                                            className={`bg-gradient-to-r ${colors[colorIndex]} flex items-center justify-center text-white text-xs font-bold transition-all duration-500 hover:opacity-80`}
                                                            style={{ width: `${percentage}%` }}
                                                            title={`${symbol}: ${percentage.toFixed(1)}%`}
                                                        >
                                                            {percentage > 10 && symbol}
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>

                                    {/* Allocation List */}
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-between bg-blue-700/30 rounded-lg p-3 border border-cyan-500/50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-4 h-4 bg-gradient-to-r from-cyan-400 to-blue-500 rounded"></div>
                                                <span className="font-bold text-white">Cash</span>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-black text-white">${portfolio.cash.toLocaleString()}</div>
                                                <div className="text-xs text-gray-300 font-semibold">
                                                    {(portfolio.cash / portfolioValue * 100).toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                        {Object.entries(portfolio.positions)
                                            .filter(([_, qty]) => qty > 0)
                                            .map(([symbol, qty]) => {
                                                const stock = stocks.find(s => s.symbol === symbol);
                                                if (!stock) return null;
                                                const value = stock.price * qty;
                                                const percentage = (value / portfolioValue * 100);

                                                const colors = [
                                                    { bg: 'from-green-500 to-emerald-600', border: 'border-green-500/50' },
                                                    { bg: 'from-purple-500 to-indigo-600', border: 'border-purple-500/50' },
                                                    { bg: 'from-orange-500 to-red-600', border: 'border-orange-500/50' },
                                                    { bg: 'from-pink-500 to-rose-600', border: 'border-pink-500/50' },
                                                    { bg: 'from-yellow-500 to-amber-600', border: 'border-yellow-500/50' }
                                                ];
                                                const colorSet = colors[symbol.charCodeAt(0) % colors.length];

                                                return (
                                                    <div
                                                        key={symbol}
                                                        onClick={() => {
                                                            setSelectedStock(stock.symbol);
                                                            setMainTab('trade');
                                                            setActiveTab('market');
                                                        }}
                                                        className={`flex items-center justify-between bg-blue-700/30 rounded-lg p-3 border ${colorSet.border} cursor-pointer hover:bg-blue-700/50 transition-all duration-300  hover:shadow-lg`}
                                                    >
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-4 h-4 bg-gradient-to-r ${colorSet.bg} rounded`}></div>
                                                            <span className="font-bold text-white">{symbol}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-black text-white">${value.toLocaleString()}</div>
                                                            <div className="text-xs text-blue-300 font-semibold">
                                                                {percentage.toFixed(1)}%  Click to trade
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>

                                {/* Stats Summary */}
                                <div className="bg-blue-900/40 backdrop-blur-sm rounded-xl p-6 border border-gray-800">
                                    <h3 className="text-lg font-black text-blue-100 mb-4 flex items-center gap-2">
                                         Quick Stats
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="border-b border-blue-700 pb-3">
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Total Assets</div>
                                            <div className="text-2xl font-black text-white">{Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length + 1}</div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {Object.entries(portfolio.positions).filter(([_, qty]) => qty > 0).length} stocks + cash
                                            </div>
                                        </div>
                                        <div className="border-b border-blue-700 pb-3">
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Stocks Value</div>
                                            <div className="text-2xl font-black text-white">
                                                ${(portfolioValue - portfolio.cash).toLocaleString()}
                                            </div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {((portfolioValue - portfolio.cash) / portfolioValue * 100).toFixed(1)}% invested
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-blue-300 font-semibold mb-1">Cash Reserve</div>
                                            <div className="text-2xl font-black text-white">${portfolio.cash.toLocaleString()}</div>
                                            <div className="text-xs text-blue-400 mt-1">
                                                {(portfolio.cash / portfolioValue * 100).toFixed(1)}% available
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                            </>
                        )}

                        {/* Trading View */}
                        {mainTab === 'trading' && (
                            <>
                        {/* Chart Pattern Quick Tip */}
                        <div className="bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C] mb-4">
                            <div className="flex items-start gap-3">
                                <div className="text-4xl flex-shrink-0"></div>
                                <div className="flex-1">
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="text-xl font-semibold text-white">Master Chart Patterns</h3>
                                        <button
                                            onClick={() => setMainTab('learning')}
                                            className="text-xs bg-[#2C2C2C] hover:bg-[#3C3C3C] text-white px-3 py-1.5 rounded-full font-medium transition-colors"
                                        >
                                            Learn More 
                                        </button>
                                    </div>
                                    <p className="text-[#A0A0A0] mb-3 text-sm">
                                        Identify patterns to predict price movements! Learn 6 key patterns with interactive charts showing exact entry, target, and stop-loss points.
                                    </p>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        <div className="bg-[#1C1C1C] rounded-lg p-3 border border-[#2C2C2C]">
                                            <div className="text-2xl mb-1"></div>
                                            <div className="text-sm font-medium text-[#00C805]">Bull Flag</div>
                                            <div className="text-xs text-[#00C805]">+10.7% avg</div>
                                        </div>
                                        <div className="bg-[#1C1C1C] rounded-lg p-3 border border-[#2C2C2C]">
                                            <div className="text-2xl mb-1"></div>
                                            <div className="text-sm font-medium text-[#FF5252]">Head & Shoulders</div>
                                            <div className="text-xs text-[#FF5252]">-10.3% avg</div>
                                        </div>
                                        <div className="bg-[#1C1C1C] rounded-lg p-3 border border-[#2C2C2C]">
                                            <div className="text-2xl mb-1"></div>
                                            <div className="text-sm font-medium text-[#00C805]">Double Bottom</div>
                                            <div className="text-xs text-[#00C805]">+9.3% avg</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Leaderboard for Family Competitions */}
                        {(plan === 'family-public' || plan === 'family-private') && competition?.members && competition.members.length > 1 && (
                            <div className="bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C] mb-4">
                                <h2 className="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                                     Leaderboard
                                    <span className="text-sm font-normal text-[#A0A0A0] ml-2">
                                        ({competition.members.length} players)
                                    </span>
                                </h2>
                                <div className="space-y-3">
                                    {competition.members
                                        .map(member => ({
                                            ...member,
                                            portfolioValue: calculatePortfolioValue(member.portfolio)
                                        }))
                                        .sort((a, b) => b.portfolioValue - a.portfolioValue)
                                        .map((member, index) => {
                                            const isCurrentUser = member.id === currentUserId;
                                            const returnPercent = ((member.portfolioValue - 100000) / 100000) * 100;
                                            const isPositive = returnPercent >= 0;

                                            return (
                                                <div
                                                    key={member.id}
                                                    className={`flex items-center justify-between p-4 rounded-xl border transition-colors ${
                                                        isCurrentUser
                                                            ? 'bg-[#1C1C1C] border-[#00C805]'
                                                            : index === 0
                                                                ? 'bg-[#1C1C1C] border-yellow-500'
                                                                : 'bg-[#1C1C1C] border-[#2C2C2C]'
                                                    }`}
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <div className={`text-3xl font-semibold ${
                                                            index === 0 ? 'text-yellow-300' :
                                                            index === 1 ? 'text-gray-300' :
                                                            index === 2 ? 'text-orange-400' :
                                                            'text-[#A0A0A0]'
                                                        }`}>
                                                            {index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`}
                                                        </div>
                                                        <div>
                                                            <div className="font-semibold text-white text-lg flex items-center gap-2">
                                                                {member.name}
                                                                {isCurrentUser && (
                                                                    <span className="text-xs bg-[#00C805] text-white px-2 py-1 rounded-full">YOU</span>
                                                                )}
                                                            </div>
                                                            <div className="text-sm text-[#A0A0A0]">
                                                                Portfolio: ${member.portfolioValue.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-2xl font-semibold ${isPositive ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                            {isPositive ? '+' : ''}{returnPercent.toFixed(2)}%
                                                        </div>
                                                        <div className={`text-sm font-medium ${isPositive ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                            {isPositive ? '+' : ''}${(member.portfolioValue - 100000).toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                </div>
                                <div className="mt-6 p-4 bg-[#1C1C1C] border border-[#2C2C2C] rounded-xl">
                                    <div className="flex items-center justify-between text-sm">
                                        <span className="text-[#A0A0A0] font-medium"> Total Prize Pool:</span>
                                        <span className="text-white font-semibold text-lg">${competition.totalPool?.toFixed(2) || '0.00'}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Main Content */}
                        <div className="w-full">
                            {/* Market Status Banner */}
                            <div className={`mb-4 rounded-xl p-4 border-l-4 transition-all ${
                                marketOpen
                                    ? 'bg-[#1C1C1C] border-l-[#00C805] border border-[#2C2C2C]'
                                    : 'bg-[#1C1C1C] border-l-[#FF5252] border border-[#2C2C2C]'
                            }`}>
                                <div className="flex items-center justify-between flex-wrap gap-3">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl bg-[#2C2C2C]`}>
                                            {marketOpen ? '' : ''}
                                        </div>
                                        <div>
                                            <h3 className={`text-xl font-semibold ${marketOpen ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                {marketOpen ? 'MARKET OPEN' : 'MARKET CLOSED'}
                                            </h3>
                                            <p className={`text-sm font-medium ${marketOpen ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                {marketOpen
                                                    ? `Closes in ${timeUntilChange}`
                                                    : currentHoliday
                                                        ? `Today is ${currentHoliday}`
                                                        : `Opens in ${timeUntilChange}`
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm text-white font-medium">
                                            {marketOpen ? 'Trading Enabled' : 'Trading Disabled'}
                                        </div>
                                        <div className={`text-xs mt-1 font-medium ${marketOpen ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                            {marketOpen
                                                ? 'Mon-Fri, 9:30 AM - 4:00 PM ET'
                                                : `Next Open: ${nextMarketOpenTime}`
                                            }
                                        </div>
                                    </div>
                                </div>

                                {/* Market Closed Notice */}
                                {!marketOpen && (
                                    <div className="mt-4 pt-4 border-t border-[#2C2C2C]">
                                        <div className="bg-[#1C1C1C] rounded-xl p-4">
                                            <h4 className="text-[#FF5252] font-medium mb-2 flex items-center gap-2">
                                                <span></span>
                                                <span>Trading Unavailable</span>
                                            </h4>
                                            <p className="text-[#A0A0A0] text-sm mb-2">
                                                The US stock market is currently closed. You can still browse stocks, view news, and analyze opportunities.
                                            </p>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3 text-xs">
                                                <div className="bg-[#1C1C1C] rounded-lg p-2 border border-[#2C2C2C]">
                                                    <div className="text-white font-medium"> Trading Days</div>
                                                    <div className="text-[#A0A0A0]">Monday - Friday</div>
                                                </div>
                                                <div className="bg-[#1C1C1C] rounded-lg p-2 border border-[#2C2C2C]">
                                                    <div className="text-white font-medium"> Trading Hours</div>
                                                    <div className="text-[#A0A0A0]">9:30 AM - 4:00 PM ET</div>
                                                </div>
                                                <div className="bg-[#1C1C1C] rounded-lg p-2 border border-[#2C2C2C]">
                                                    <div className="text-white font-medium"> Next Session</div>
                                                    <div className="text-[#A0A0A0]">{timeUntilChange}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* AI Stock Recommendations Engine - Advanced Analysis */}
                            {(() => {
                                const marketAvgChange = stocks.reduce((sum, s) => sum + (s.change || 0), 0) / stocks.length;
                                const marketVolatility = Math.sqrt(stocks.reduce((sum, s) => sum + Math.pow((s.change || 0) - marketAvgChange, 2), 0) / stocks.length);
                                const bullishCount = stocks.filter(s => (s.change || 0) > 0).length;
                                const bearishCount = stocks.filter(s => (s.change || 0) < 0).length;
                                const marketSentiment = bullishCount > bearishCount ? 'BULLISH' : 'BEARISH';

                                const recommendations = [];

                                stocks.forEach(stock => {
                                    const change = stock.change || 0;
                                    const price = stock.price || 0;
                                    const positionShares = portfolio.positions[stock.symbol] || 0;
                                    const hasPosition = positionShares > 0;

                                    // Skip stocks we already own to focus on new opportunities
                                    if (hasPosition) return;

                                    let score = 0;
                                    let confidence = 0;
                                    let reasons = [];
                                    let type = 'BUY';

                                    // 1. MOMENTUM ANALYSIS (0-30 points)
                                    const relativeStrength = change - marketAvgChange;
                                    if (change > 7) {
                                        score += 30;
                                        confidence += 25;
                                        reasons.push('Exceptional momentum (+7%)');
                                    } else if (change > 4) {
                                        score += 25;
                                        confidence += 20;
                                        reasons.push('Strong upward trend (+4%)');
                                    } else if (change > 2) {
                                        score += 15;
                                        confidence += 15;
                                        reasons.push('Positive momentum (+2%)');
                                    } else if (change < -5 && relativeStrength < -2) {
                                        score += 28;
                                        confidence += 22;
                                        type = 'BUY DIP';
                                        reasons.push('Oversold bounce opportunity');
                                    } else if (change < -3) {
                                        score += 20;
                                        confidence += 18;
                                        type = 'BUY DIP';
                                        reasons.push('Pullback entry point');
                                    }

                                    // 2. RELATIVE STRENGTH (0-25 points)
                                    if (relativeStrength > 3) {
                                        score += 25;
                                        confidence += 20;
                                        reasons.push('Outperforming market significantly');
                                    } else if (relativeStrength > 1.5) {
                                        score += 15;
                                        confidence += 12;
                                        reasons.push('Above market performance');
                                    }

                                    // 3. PRICE LEVEL ANALYSIS (0-20 points)
                                    if (price >= 300) {
                                        if (change > 2) {
                                            score += 18;
                                            confidence += 15;
                                            reasons.push('Mega-cap leader gaining');
                                        }
                                    } else if (price >= 150 && price < 300) {
                                        if (change > 2.5) {
                                            score += 20;
                                            confidence += 18;
                                            reasons.push('Large-cap strength');
                                        }
                                    } else if (price >= 50 && price < 150) {
                                        if (change > 3) {
                                            score += 22;
                                            confidence += 20;
                                            reasons.push('Mid-cap momentum play');
                                        }
                                    } else if (price < 50) {
                                        if (change > 4) {
                                            score += 20;
                                            confidence += 16;
                                            reasons.push('Small-cap breakout potential');
                                        }
                                    }

                                    // 4. VOLATILITY & RISK (0-15 points)
                                    const stockVolatility = Math.abs(change);
                                    if (stockVolatility < marketVolatility * 0.8) {
                                        score += 15;
                                        confidence += 12;
                                        reasons.push('Lower volatility than market');
                                    } else if (stockVolatility < marketVolatility * 1.2) {
                                        score += 10;
                                        confidence += 8;
                                    }

                                    // 5. PATTERN RECOGNITION (0-20 points)
                                    if (change > 2.5 && change < 6) {
                                        score += 20;
                                        confidence += 18;
                                        reasons.push('Sustainable growth pattern');
                                    } else if (change > 6 && change < 10) {
                                        score += 15;
                                        confidence += 12;
                                        reasons.push('Strong momentum (watch for pullback)');
                                    }

                                    // 6. MARKET CONTEXT BONUS (0-15 points)
                                    if (marketSentiment === 'BULLISH' && change > marketAvgChange) {
                                        score += 15;
                                        confidence += 10;
                                        reasons.push('Riding bullish market trend');
                                    } else if (marketSentiment === 'BEARISH' && change > 0) {
                                        score += 12;
                                        confidence += 15;
                                        reasons.push('Resilient in bearish market');
                                    }

                                    confidence = Math.min(100, Math.max(0, confidence));

                                    // Confidence boost to score
                                    score = score * (1 + confidence / 200);

                                    // Risk assessment
                                    let risk = 'MEDIUM';
                                    if (stockVolatility > 8) {
                                        risk = 'HIGH';
                                    } else if (stockVolatility < 2) {
                                        risk = 'LOW';
                                    } else if (stockVolatility < 4) {
                                        risk = 'MODERATE';
                                    }

                                    // Only recommend high-quality picks (score > 70 with multiple factors)
                                    if (score > 70 && reasons.length >= 2) {
                                        recommendations.push({
                                            symbol: stock.symbol,
                                            name: stock.name,
                                            score: Math.round(score),
                                            confidence: Math.round(confidence),
                                            type,
                                            reasons,
                                            risk,
                                            change,
                                            price,
                                            hasPosition
                                        });
                                    }
                                });

                                recommendations.sort((a, b) => {
                                    if (Math.abs(a.score - b.score) < 5) {
                                        return b.confidence - a.confidence;
                                    }
                                    return b.score - a.score;
                                });
                                const topPicks = recommendations.slice(0, 8);

                                if (topPicks.length === 0) return null;

                                // AI recommendations removed - feature temporarily disabled
                                return null;
                            })()}

                            {/* Market View */}
                            <div className="relative bg-[#1C1C1C] rounded-xl p-6 border border-[#2C2C2C] transition-all overflow-hidden">

                                {/* Clean Search Bar - Robinhood Style */}
                                <div className="relative mb-6">
                                    <input
                                        type="text"
                                        placeholder="Search"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' && searchResults.length > 0 && !searching) {
                                                const firstResult = searchResults[0];
                                                fetchSingleStock(firstResult.symbol, firstResult.name).then(stockData => {
                                                    const existingIndex = stocks.findIndex(s => s.symbol === firstResult.symbol);
                                                    if (existingIndex >= 0) {
                                                        const updatedStocks = [...stocks];
                                                        updatedStocks[existingIndex] = stockData;
                                                        setStocks(updatedStocks);
                                                    } else {
                                                        setStocks([...stocks, stockData]);
                                                    }
                                                    setSelectedStock(firstResult.symbol);
                                                    setActiveTab('market');
                                                    setSearchQuery('');
                                                    setShowSearchResults(false);
                                                });
                                            }
                                            if (e.key === 'Escape') {
                                                setSearchQuery('');
                                                setShowSearchResults(false);
                                            }
                                        }}
                                        className="w-full bg-[#1C1C1C] border border-[#2C2C2C] rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-[#00C805] focus:outline-none transition-colors"
                                    />
                                    {searching && (
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">
                                            <div className="animate-spin"></div>
                                        </div>
                                    )}
                                </div>

                                {/* Popular stocks as simple text links */}
                                {!searchQuery && (
                                    <div className="mb-6 flex gap-4 text-sm text-gray-400">
                                        {['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'AMZN'].map(symbol => (
                                            <span
                                                key={symbol}
                                                onClick={() => setSearchQuery(symbol)}
                                                className="hover:text-white cursor-pointer transition-colors"
                                            >
                                                {symbol}
                                            </span>
                                        ))}
                                    </div>
                                )}

                                {/* Clean Search Results */}
                                {searchQuery && showSearchResults && (
                                    <div className="mb-6 bg-[#1C1C1C] border border-[#2C2C2C] rounded-lg overflow-hidden">
                                        {searching ? (
                                            <div className="p-6 text-center text-[#A0A0A0]">Searching...</div>
                                        ) : searchResults.length > 0 ? (
                                            <div className="max-h-60 overflow-y-auto">
                                                {searchResults.map((result) => (
                                                    <div
                                                        key={result.symbol}
                                                        onClick={async () => {
                                                            setSearching(true);
                                                            setError(null);
                                                            const stockData = await fetchSingleStock(result.symbol, result.name);
                                                            const existingIndex = stocks.findIndex(s => s.symbol === result.symbol);
                                                            if (existingIndex >= 0) {
                                                                const updatedStocks = [...stocks];
                                                                updatedStocks[existingIndex] = stockData;
                                                                setStocks(updatedStocks);
                                                            } else {
                                                                setStocks([...stocks, stockData]);
                                                            }
                                                            setSelectedStock(result.symbol);
                                                            setTradeAnalysisData(null);
                                                            setSearchQuery('');
                                                            setShowSearchResults(false);
                                                            setSearching(false);
                                                        }}
                                                        className="p-4 border-b border-[#2C2C2C] last:border-b-0 hover:bg-[#2C2C2C] cursor-pointer transition-colors"
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="font-medium text-white">{result.symbol}</div>
                                                                    {result.owned && (
                                                                        <span className="bg-[#00C805]/20 text-[#00C805] text-xs px-2 py-0.5 rounded-full">Owned</span>
                                                                    )}
                                                                </div>
                                                                <div className="text-sm text-[#A0A0A0]">{result.name}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : error ? (
                                            <div className="p-6 text-center">
                                                <div className="text-yellow-400 mb-2"></div>
                                                <div className="text-yellow-300 text-sm">{error}</div>
                                            </div>
                                        ) : (
                                            <div className="p-6 text-center">
                                                <div className="text-[#A0A0A0] mb-2">No results found</div>
                                                <div className="text-xs text-[#A0A0A0]">Try: AAPL, GOOGL, MSFT, TSLA</div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <h3 className="text-lg font-medium text-white mb-4 mt-8"> Select a Stock to Trade</h3>
                                {loading && stocks.length === 0 ? (
                                    <div className="text-center py-12 bg-[#1C1C1C] border border-[#2C2C2C] rounded-xl">
                                        <div className="text-[#A0A0A0] font-medium">Loading stocks...</div>
                                    </div>
                                ) : !selectedStock ? (
                                    <div className="text-center py-12 bg-[#1C1C1C] rounded-xl border border-dashed border-[#2C2C2C]">
                                        <div className="text-6xl mb-3 opacity-50"></div>
                                        <div className="text-white font-medium">No stock selected</div>
                                        <div className="text-sm text-[#A0A0A0] mt-2 font-normal">Search and add stocks to your watchlist, then select one to trade</div>
                                    </div>
                                ) : null}

                            {/* Trading Panel - Now in main left column */}
                            {selectedStock && (
                                    <div className="relative bg-[#1C1C1C] rounded-xl p-6 border border-[#2C2C2C] mt-6 overflow-hidden transition-all">

                                        {/* Stock Header with AI Indicator */}
                                        <div className="relative mb-6 pb-6 border-b border-[#2C2C2C]">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-3">
                                                    <h2 className="text-4xl font-semibold text-white">{selectedStock}</h2>
                                                    {/* AI Quick Signal */}
                                                    <div className="flex items-center gap-2 bg-[#1C1C1C] border border-[#2C2C2C] rounded-full px-3 py-1">
                                                        <span className="text-lg"></span>
                                                        <span className="text-[#A0A0A0] text-xs font-medium">AI Active</span>
                                                    </div>
                                                </div>
                                                <div className={`px-4 py-2 rounded-lg font-medium text-sm ${
                                                    (stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0
                                                        ? 'bg-[#00C805]/20 text-[#00C805]'
                                                        : 'bg-[#FF5252]/20 text-[#FF5252]'
                                                }`}>
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? '' : ''}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? '+' : ''}
                                                    {(stocks.find(s => s.symbol === selectedStock)?.change || 0).toFixed(2)}%
                                                </div>
                                            </div>
                                            <p className="text-[#A0A0A0] text-lg mb-3 font-normal">{stocks.find(s => s.symbol === selectedStock)?.name || selectedStock}</p>

                                            {/* Quick AI Signal - UltraThink Enhanced */}
                                            {(() => {
                                                const stock = stocks.find(s => s.symbol === selectedStock);
                                                if (!stock) return null;

                                                // UltraThink AI Analysis - Multi-factor scoring
                                                const price = stock.price || 0;
                                                const high = stock.high || price;
                                                const low = stock.low || price;
                                                const open = stock.open || price;
                                                const previousClose = stock.previousClose || price;
                                                const change = stock.change || 0;

                                                // 1. Price Position Analysis (where is price relative to range?)
                                                const dayRange = high - low;
                                                const pricePositionInRange = dayRange > 0 ? ((price - low) / dayRange) * 100 : 50;

                                                // 2. Momentum Strength (multiple timeframes)
                                                const intradayMomentum = open > 0 ? ((price - open) / open) * 100 : 0;
                                                const dailyMomentum = change;

                                                // 3. Volatility Index (normalized)
                                                const volatility = previousClose > 0 ? (dayRange / previousClose) * 100 : 0;

                                                // 4. RSI-like indicator (0-100 scale)
                                                const rsiLike = pricePositionInRange;

                                                // 5. Trend Strength Score
                                                let trendScore = 0;
                                                if (change > 0 && intradayMomentum > 0) trendScore += 30; // Consistent uptrend
                                                if (change < 0 && intradayMomentum < 0) trendScore -= 30; // Consistent downtrend
                                                if (Math.abs(dailyMomentum) > 2) trendScore += Math.sign(dailyMomentum) * 20; // Strong movement
                                                if (pricePositionInRange > 80) trendScore += 15; // Near highs
                                                if (pricePositionInRange < 20) trendScore -= 15; // Near lows
                                                if (volatility > 5) trendScore += Math.sign(change) * 10; // High volatility amplifies

                                                // 6. Determine Signal Strength (-100 to +100)
                                                const signalStrength = Math.max(-100, Math.min(100, trendScore));

                                                // 7. Generate Smart Labels
                                                let momentum, signalColor, actionText, confidence;

                                                if (signalStrength >= 60) {
                                                    momentum = 'Strong Bullish';
                                                    signalColor = 'green';
                                                    actionText = 'High Conviction Buy';
                                                    confidence = 'High';
                                                } else if (signalStrength >= 30) {
                                                    momentum = 'Bullish';
                                                    signalColor = 'green';
                                                    actionText = 'Consider Buying';
                                                    confidence = 'Medium';
                                                } else if (signalStrength >= 10) {
                                                    momentum = 'Weak Bullish';
                                                    signalColor = 'green';
                                                    actionText = 'Slight Buy Signal';
                                                    confidence = 'Low';
                                                } else if (signalStrength <= -60) {
                                                    momentum = 'Strong Bearish';
                                                    signalColor = 'red';
                                                    actionText = 'High Risk - Avoid';
                                                    confidence = 'High';
                                                } else if (signalStrength <= -30) {
                                                    momentum = 'Bearish';
                                                    signalColor = 'red';
                                                    actionText = 'Caution Advised';
                                                    confidence = 'Medium';
                                                } else if (signalStrength <= -10) {
                                                    momentum = 'Weak Bearish';
                                                    signalColor = 'red';
                                                    actionText = 'Slight Sell Signal';
                                                    confidence = 'Low';
                                                } else {
                                                    momentum = 'Neutral';
                                                    signalColor = 'yellow';
                                                    actionText = 'Monitor Closely';
                                                    confidence = 'Low';
                                                }

                                                return (
                                                    <div className={`bg-[#1C1C1C] border-l-4 ${
                                                        signalColor === 'green' ? 'border-l-[#00C805]' :
                                                        signalColor === 'red' ? 'border-l-[#FF5252]' :
                                                        'border-l-yellow-500'
                                                    } border border-[#2C2C2C] rounded-lg p-3 flex items-center justify-between`}>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-2xl">{signalColor === 'green' ? '' : signalColor === 'red' ? '' : ''}</span>
                                                            <div>
                                                                <div className={`text-sm font-medium ${
                                                                    signalColor === 'green' ? 'text-[#00C805]' :
                                                                    signalColor === 'red' ? 'text-[#FF5252]' :
                                                                    'text-yellow-500'
                                                                }`}>AI Signal: {momentum}</div>
                                                                <div className="text-xs text-[#A0A0A0] font-normal">{actionText}</div>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                setAiAnalysisTab('analysis');
                                                                setMainTab('ai-analysis');
                                                            }}
                                                            className="text-xs font-medium text-white hover:text-[#A0A0A0] underline transition-colors"
                                                        >
                                                            Full Analysis 
                                                        </button>
                                                    </div>
                                                );
                                            })()}
                                        </div>

                                        {/*  AI QUICK ANALYSIS CARD - Condensed Version */}
                                        {(() => {
                                            const stock = stocks.find(s => s.symbol === selectedStock);
                                            if (!stock) return null;

                                            // Calculate all AI metrics (reuse from full analysis)
                                            const price = stock.price || 0;
                                            const high = stock.high || price;
                                            const low = stock.low || price;
                                            const open = stock.open || price;
                                            const previousClose = stock.previousClose || price;
                                            const change = stock.change || 0;

                                            // Calculate RSI-like indicator
                                            const dayRange = high - low;
                                            const pricePositionInRange = dayRange > 0 ? ((price - low) / dayRange) * 100 : 50;
                                            const rsi = pricePositionInRange;

                                            // Calculate momentum
                                            const intradayMomentum = open > 0 ? ((price - open) / open) * 100 : 0;

                                            // Calculate volatility
                                            const volatility = previousClose > 0 ? (dayRange / previousClose) * 100 : 0;

                                            // Sentiment score (simulate based on news count and price action)
                                            const newsCount = stockNews.filter(n => n.symbols?.includes(selectedStock)).length;
                                            const sentimentScore = Math.min(100, Math.max(0, 50 + (change * 10) + (newsCount * 2)));

                                            // Calculate signal strength (0-100)
                                            let trendScore = 0;
                                            if (change > 0 && intradayMomentum > 0) trendScore += 30;
                                            if (change < 0 && intradayMomentum < 0) trendScore -= 30;
                                            if (Math.abs(change) > 2) trendScore += Math.sign(change) * 20;
                                            if (pricePositionInRange > 80) trendScore += 15;
                                            if (pricePositionInRange < 20) trendScore -= 15;
                                            if (volatility > 5) trendScore += Math.sign(change) * 10;

                                            const signalStrength = Math.round(Math.max(0, Math.min(100, 50 + trendScore)));

                                            // Determine recommendation
                                            let recommendation, recColor, confidence;
                                            if (signalStrength >= 70) {
                                                recommendation = 'STRONG BUY';
                                                recColor = 'green';
                                                confidence = 85;
                                            } else if (signalStrength >= 60) {
                                                recommendation = 'BUY';
                                                recColor = 'green';
                                                confidence = 70;
                                            } else if (signalStrength >= 40) {
                                                recommendation = 'HOLD';
                                                recColor = 'yellow';
                                                confidence = 55;
                                            } else if (signalStrength >= 30) {
                                                recommendation = 'SELL';
                                                recColor = 'red';
                                                confidence = 70;
                                            } else {
                                                recommendation = 'STRONG SELL';
                                                recColor = 'red';
                                                confidence = 85;
                                            }

                                            // Risk level
                                            let riskLevel, riskColor;
                                            if (volatility > 5) {
                                                riskLevel = 'High';
                                                riskColor = 'red';
                                            } else if (volatility > 2.5) {
                                                riskLevel = 'Medium';
                                                riskColor = 'yellow';
                                            } else {
                                                riskLevel = 'Low';
                                                riskColor = 'green';
                                            }

                                            // Calculate position sizing
                                            const currentPortfolio = getCurrentPortfolio();
                                            const portfolioValue = calculatePortfolioValue(currentPortfolio);
                                            const riskPercentage = riskLevel === 'High' ? 0.01 : riskLevel === 'Medium' ? 0.02 : 0.03;
                                            const stopLossDistance = (high - low) * 1.5;
                                            const suggestedShares = Math.floor((portfolioValue * riskPercentage) / stopLossDistance);
                                            const stopLossPrice = Math.max(0, price - stopLossDistance).toFixed(2);
                                            const targetPrice = (price + stopLossDistance * 3).toFixed(2);

                                            // Action summary
                                            const actionSummary = recommendation.includes('BUY')
                                                ? `${recommendation} ${suggestedShares} shares at $${price.toFixed(2)}  Stop: $${stopLossPrice}  Target: $${targetPrice}`
                                                : recommendation === 'HOLD'
                                                ? `${recommendation} - Monitor price action  Current: $${price.toFixed(2)}  Wait for confirmation`
                                                : `${recommendation} - Exit positions  Current: $${price.toFixed(2)}  Set alerts at $${(price * 1.05).toFixed(2)}`;

                                            return (
                                                <div className="mb-6 group/ai relative bg-gradient-to-br from-purple-900/40 to-indigo-900/40 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 shadow-2xl overflow-hidden" style={{boxShadow: '0 0 40px rgba(168, 85, 247, 0.25)'}}>
                                                    {/* Animated background */}
                                                    <div className="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 animate-pulse"></div>

                                                    <div className="relative">
                                                        {/* Header */}
                                                        <div className="flex items-center justify-between mb-4">
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-3xl animate-pulse"></span>
                                                                <h3 className="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">
                                                                    AI Quick Analysis
                                                                </h3>
                                                                <span className="text-xs bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded-full font-bold">LIVE</span>
                                                            </div>
                                                            <button
                                                                onClick={() => {
                                                                    setMainTab('ai-analysis');
                                                                }}
                                                                className="text-sm font-bold text-gray-300 hover:text-gray-400 underline transition-colors flex items-center gap-1"
                                                            >
                                                                See Full Analysis 
                                                            </button>
                                                        </div>

                                                        {/* 1. ACTION SUMMARY */}
                                                        <div className={`mb-4 bg-gradient-to-r ${
                                                            recColor === 'green' ? 'from-green-900/40 to-emerald-900/40 border-green-500/50' :
                                                            recColor === 'red' ? 'from-red-900/40 to-rose-900/40 border-red-500/50' :
                                                            'from-yellow-900/40 to-amber-900/40 border-yellow-500/50'
                                                        } border-2 rounded-xl p-4`}>
                                                            <div className="flex items-start gap-3">
                                                                <span className="text-3xl">{recColor === 'green' ? '' : recColor === 'red' ? '' : ''}</span>
                                                                <div className="flex-1">
                                                                    <div className={`text-sm font-black mb-1 ${
                                                                        recColor === 'green' ? 'text-green-300' :
                                                                        recColor === 'red' ? 'text-red-300' :
                                                                        'text-yellow-300'
                                                                    }`}>ACTION PLAN</div>
                                                                    <div className="text-white font-semibold text-sm leading-relaxed">
                                                                        {actionSummary}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* 2. SIGNAL STRENGTH METER */}
                                                        <div className="mb-4 bg-black/30 rounded-xl p-4 border border-gray-800">
                                                            <div className="text-xs font-bold text-gray-300 mb-2">SIGNAL STRENGTH</div>
                                                            <div className="relative">
                                                                <div className="w-full bg-gray-800 rounded-full h-6 overflow-hidden border-2 border-gray-700">
                                                                    <div
                                                                        className={`h-full rounded-full transition-all duration-1000 ${
                                                                            signalStrength >= 70 ? 'bg-gradient-to-r from-green-500 via-emerald-400 to-green-500' :
                                                                            signalStrength >= 60 ? 'bg-gradient-to-r from-lime-500 via-green-400 to-lime-500' :
                                                                            signalStrength >= 40 ? 'bg-gradient-to-r from-yellow-500 via-amber-400 to-yellow-500' :
                                                                            signalStrength >= 30 ? 'bg-gradient-to-r from-orange-500 via-red-400 to-orange-500' :
                                                                            'bg-gradient-to-r from-red-500 via-red-600 to-red-700'
                                                                        } flex items-center justify-center font-black text-white text-xs`}
                                                                        style={{ width: `${signalStrength}%` }}
                                                                    >
                                                                        {signalStrength >= 15 && `${signalStrength}/100`}
                                                                    </div>
                                                                </div>
                                                                {signalStrength < 15 && (
                                                                    <div className="absolute top-0 right-2 h-full flex items-center">
                                                                        <span className="text-white font-black text-xs">{signalStrength}/100</span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* 3. QUICK STATS GRID */}
                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">RSI</div>
                                                                <div className={`text-lg font-black ${
                                                                    rsi > 70 ? 'text-red-300' : rsi < 30 ? 'text-green-300' : 'text-gray-300'
                                                                }`}>{rsi.toFixed(0)}</div>
                                                                <div className="text-[10px] text-gray-400">
                                                                    {rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral'}
                                                                </div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">Sentiment</div>
                                                                <div className={`text-lg font-black ${
                                                                    sentimentScore > 60 ? 'text-green-300' : sentimentScore < 40 ? 'text-red-300' : 'text-yellow-300'
                                                                }`}>{sentimentScore.toFixed(0)}</div>
                                                                <div className="text-[10px] text-gray-400">
                                                                    {sentimentScore > 60 ? 'Bullish' : sentimentScore < 40 ? 'Bearish' : 'Neutral'}
                                                                </div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">Risk</div>
                                                                <div className={`text-lg font-black ${
                                                                    riskColor === 'red' ? 'text-red-300' : riskColor === 'yellow' ? 'text-yellow-300' : 'text-green-300'
                                                                }`}>{riskLevel}</div>
                                                                <div className="text-[10px] text-gray-400">
                                                                    Vol: {volatility.toFixed(1)}%
                                                                </div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">Recommendation</div>
                                                                <div className={`text-sm font-black ${
                                                                    recColor === 'green' ? 'text-green-300' : recColor === 'red' ? 'text-red-300' : 'text-yellow-300'
                                                                }`}>{recommendation}</div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">Confidence</div>
                                                                <div className="text-lg font-black text-gray-300">{confidence}%</div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3 border border-gray-800">
                                                                <div className="text-xs text-gray-300 mb-1 font-bold">Price</div>
                                                                <div className="text-lg font-black text-white">${price.toFixed(2)}</div>
                                                            </div>
                                                        </div>

                                                        {/* Info footer */}
                                                        <div className="mt-4 text-xs text-center text-purple-400/60">
                                                             Real-time analysis using multi-factor AI scoring
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}

                                        {/* Smart Buy/Sell Timing Suggestions */}
                                        <div className="relative mb-6">

                                            {/* Smart Buy/Sell Timing Suggestions */}
                                            {(() => {
                                                const stock = stocks.find(s => s.symbol === selectedStock);
                                                if (!stock) return null;

                                                // UltraThink - Real stock data
                                                const price = stock.price || 0;
                                                const high = stock.high || price;
                                                const low = stock.low || price;
                                                const open = stock.open || price;
                                                const previousClose = stock.previousClose || price;
                                                const change = stock.change || 0;

                                                // Advanced metrics
                                                const dayRange = high - low;
                                                const pricePositionInRange = dayRange > 0 ? ((price - low) / dayRange) * 100 : 50;
                                                const intradayMomentum = open > 0 ? ((price - open) / open) * 100 : 0;
                                                const volatility = previousClose > 0 ? (dayRange / previousClose) * 100 : 0;

                                                // Time factors
                                                const currentHour = new Date().getHours();
                                                const currentMinutes = new Date().getMinutes();
                                                const isMarketOpening = marketOpen && currentHour === 9 && currentMinutes >= 30 && currentMinutes < 45;
                                                const isMarketClosing = marketOpen && currentHour === 15 && currentMinutes >= 45;
                                                const isMidDay = marketOpen && currentHour >= 11 && currentHour <= 14;

                                                // Position data with REAL average price
                                                const positionShares = portfolio.positions[selectedStock] || 0;
                                                const hasPosition = positionShares > 0;
                                                let positionReturn = 0;
                                                if (hasPosition) {
                                                    const trades = portfolio.history?.filter(t => t.stock === selectedStock && t.type === 'buy') || [];
                                                    if (trades.length > 0) {
                                                        const totalCost = trades.reduce((sum, t) => sum + (t.price * t.quantity), 0);
                                                        const totalShares = trades.reduce((sum, t) => sum + t.quantity, 0);
                                                        const avgPrice = totalShares > 0 ? totalCost / totalShares : price;
                                                        positionReturn = ((price - avgPrice) / avgPrice) * 100;
                                                    }
                                                }

                                                // === ULTRA BUY TIMING ===
                                                let buyScore = 50;
                                                let buyReasons = [];
                                                if (pricePositionInRange < 20) { buyScore += 25; buyReasons.push('Near daily low'); }
                                                else if (pricePositionInRange < 40) { buyScore += 15; buyReasons.push('Below midpoint'); }
                                                else if (pricePositionInRange > 80) { buyScore -= 25; buyReasons.push('Overextended'); }
                                                if (change > 0 && intradayMomentum > 0 && change < 3) { buyScore += 20; buyReasons.push('Building momentum'); }
                                                else if (change < -2 && intradayMomentum < -1) { buyScore += 15; buyReasons.push('Dip opportunity'); }
                                                else if (change > 5) { buyScore -= 30; buyReasons.push('Too hot'); }
                                                if (volatility > 5 && pricePositionInRange < 40) { buyScore += 15; buyReasons.push('High vol + low price'); }
                                                else if (volatility < 1) { buyScore -= 10; }
                                                if (isMarketOpening) { buyScore -= 15; buyReasons.push('Opening volatility'); }
                                                else if (isMidDay) { buyScore += 10; buyReasons.push('Stable hours'); }
                                                else if (isMarketClosing) { buyScore -= 10; }
                                                else if (!marketOpen) { buyScore -= 20; buyReasons.push('Market closed'); }
                                                buyScore = Math.max(0, Math.min(100, buyScore));

                                                // === ULTRA SELL TIMING ===
                                                let sellScore = 30;
                                                let sellReasons = [];
                                                if (hasPosition) {
                                                    if (positionReturn > 15) { sellScore += 35; sellReasons.push(`+${positionReturn.toFixed(1)}% gain`); }
                                                    else if (positionReturn > 8) { sellScore += 25; sellReasons.push(`+${positionReturn.toFixed(1)}% profit`); }
                                                    else if (positionReturn > 3) { sellScore += 10; sellReasons.push(`+${positionReturn.toFixed(1)}%`); }
                                                    else if (positionReturn < -10) { sellScore += 30; sellReasons.push(`-${Math.abs(positionReturn).toFixed(1)}% stop loss`); }
                                                    else if (positionReturn < -5) { sellScore += 15; sellReasons.push(`-${Math.abs(positionReturn).toFixed(1)}%`); }
                                                    if (positionReturn > 5 && pricePositionInRange > 85) { sellScore += 25; sellReasons.push('At resistance'); }
                                                    if (positionReturn > 5 && change < -2 && intradayMomentum < 0) { sellScore += 30; sellReasons.push('Momentum flip'); }
                                                    if (volatility > 7 && positionReturn > 0) { sellScore += 15; }
                                                    if (isMarketClosing && positionReturn > 3) { sellScore += 10; sellReasons.push('EOD profit lock'); }
                                                } else {
                                                    if (change > 10 && pricePositionInRange > 90) { sellScore = 65; sellReasons = ['Short opportunity']; }
                                                    else { sellScore = 20; sellReasons = ['No position']; }
                                                }
                                                sellScore = Math.max(0, Math.min(100, sellScore));

                                                // Labels
                                                const getLabel = (s) => {
                                                    if (s >= 80) return { label: 'Excellent', color: 'green' };
                                                    if (s >= 65) return { label: 'Good', color: 'green' };
                                                    if (s >= 50) return { label: 'Fair', color: 'yellow' };
                                                    if (s >= 35) return { label: 'Neutral', color: 'gray' };
                                                    if (s >= 20) return { label: 'Poor', color: 'red' };
                                                    return { label: 'N/A', color: 'gray' };
                                                };
                                                let buyTiming = { score: Math.round(buyScore), ...getLabel(buyScore), reason: buyReasons.slice(0, 2).join('  ') || 'Analyzing conditions' };
                                                let sellTiming = { score: Math.round(sellScore), ...getLabel(sellScore), reason: sellReasons.slice(0, 2).join('  ') || 'Analyzing conditions' };

                                                const getBgColor = (color) => {
                                                    if (color === 'green') return 'from-green-900/40 to-emerald-900/40 border-green-500/50';
                                                    if (color === 'red') return 'from-red-900/40 to-rose-900/40 border-red-500/50';
                                                    if (color === 'yellow') return 'from-yellow-900/40 to-amber-900/40 border-yellow-500/50';
                                                    return 'from-gray-900/40 to-slate-900/40 border-gray-500/50';
                                                };

                                                const getTextColor = (color) => {
                                                    if (color === 'green') return 'text-green-300';
                                                    if (color === 'red') return 'text-red-300';
                                                    if (color === 'yellow') return 'text-yellow-300';
                                                    return 'text-gray-300';
                                                };

                                                return (
                                                    <div className="mt-4 bg-purple-500/10 backdrop-blur-xl rounded-xl p-4 border border-gray-800" style={{boxShadow: '0 0 20px rgba(168, 85, 247, 0.15)'}}>
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <span className="text-lg"></span>
                                                            <span className="text-sm font-black text-gray-300">AI Timing Suggestions</span>
                                                            {!marketOpen && <span className="text-xs text-red-300 bg-red-500/20 border border-red-500/50 px-2 py-0.5 rounded-full font-bold">Market Closed</span>}
                                                        </div>

                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {/* Buy Timing */}
                                                            <div className={`bg-gradient-to-br ${getBgColor(buyTiming.color)} rounded-lg p-3 border-2`}>
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className="text-xs font-bold text-gray-300">BUY TIMING</span>
                                                                    <span className={`text-sm font-black ${getTextColor(buyTiming.color)}`}>
                                                                        {buyTiming.score}/100
                                                                    </span>
                                                                </div>
                                                                <div className={`text-lg font-black ${getTextColor(buyTiming.color)} mb-1`}>
                                                                    {buyTiming.label}
                                                                </div>
                                                                <div className="text-xs text-gray-300">
                                                                    {buyTiming.reason}
                                                                </div>
                                                                {/* Visual score bar */}
                                                                <div className="mt-2 bg-gray-800 rounded-full h-1.5 overflow-hidden">
                                                                    <div
                                                                        className={`h-full ${
                                                                            buyTiming.color === 'green' ? 'bg-green-500' :
                                                                            buyTiming.color === 'red' ? 'bg-red-500' :
                                                                            buyTiming.color === 'yellow' ? 'bg-yellow-500' :
                                                                            'bg-gray-500'
                                                                        }`}
                                                                        style={{ width: `${buyTiming.score}%` }}
                                                                    />
                                                                </div>
                                                            </div>

                                                            {/* Sell Timing */}
                                                            <div className={`bg-gradient-to-br ${getBgColor(sellTiming.color)} rounded-lg p-3 border-2`}>
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className="text-xs font-bold text-gray-300">SELL TIMING</span>
                                                                    <span className={`text-sm font-black ${getTextColor(sellTiming.color)}`}>
                                                                        {sellTiming.score}/100
                                                                    </span>
                                                                </div>
                                                                <div className={`text-lg font-black ${getTextColor(sellTiming.color)} mb-1`}>
                                                                    {sellTiming.label}
                                                                </div>
                                                                <div className="text-xs text-gray-300">
                                                                    {sellTiming.reason}
                                                                </div>
                                                                {/* Visual score bar */}
                                                                <div className="mt-2 bg-gray-800 rounded-full h-1.5 overflow-hidden">
                                                                    <div
                                                                        className={`h-full ${
                                                                            sellTiming.color === 'green' ? 'bg-green-500' :
                                                                            sellTiming.color === 'red' ? 'bg-red-500' :
                                                                            sellTiming.color === 'yellow' ? 'bg-yellow-500' :
                                                                            'bg-gray-500'
                                                                        }`}
                                                                        style={{ width: `${sellTiming.score}%` }}
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {hasPosition && (
                                                            <div className="mt-2 pt-2 border-t border-purple-500/20 text-[10px] text-gray-300">
                                                                 Current Position: {positionShares} shares
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })()}

                                            {/* Add to Watchlist Button */}
                                            {!watchlist.includes(selectedStock) ? (
                                                <button
                                                    onClick={() => {
                                                        const newWatchlist = [...watchlist, selectedStock];
                                                        setWatchlist(newWatchlist);
                                                        const portfolio = getCurrentPortfolio();
                                                        const updatedPortfolio = {
                                                            ...portfolio,
                                                            watchlist: newWatchlist
                                                        };
                                                        setCompetition(prev => ({
                                                            ...prev,
                                                            members: prev.members.map(m =>
                                                                m.id === currentUserId ? { ...m, portfolio: updatedPortfolio } : m
                                                            )
                                                        }));
                                                        savePortfolioToDatabase(updatedPortfolio);
                                                    }}
                                                    className="group/btn relative mt-4 w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-400 hover:to-indigo-400 text-white py-3 rounded-xl font-black text-lg transition-all flex items-center justify-center gap-2 overflow-hidden"
                                                    style={{boxShadow: '0 0 30px rgba(168, 85, 247, 0.3)'}}
                                                >
                                                    <div className="absolute inset-0 bg-gradient-to-r from-purple-400 to-indigo-400 opacity-0 group-hover/btn:opacity-100 transition-opacity"></div>
                                                    <div className="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                                                    <span className="relative"></span>
                                                    <span className="relative">Add to Watchlist</span>
                                                </button>
                                            ) : (
                                                <div className="mt-4 w-full bg-green-500/20 border border-gray-800 text-green-300 py-3 rounded-xl font-black text-lg flex items-center justify-center gap-2" style={{boxShadow: '0 0 20px rgba(34, 197, 94, 0.2)'}}>
                                                    <span></span>
                                                    <span>In Watchlist</span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Price Display */}
                                        <div className="relative mb-6 text-center bg-gradient-to-r from-cyan-500/10 to-blue-500/10 rounded-xl p-6 border border-gray-800 overflow-hidden" style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.2)'}}>
                                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-blue-500/5"></div>
                                            <div className="relative text-sm text-cyan-400 font-black mb-2 uppercase tracking-wider">Current Price</div>
                                            <div className="relative text-6xl font-black text-white mb-1">
                                                ${(stocks.find(s => s.symbol === selectedStock)?.price || 0).toFixed(2)}
                                            </div>
                                            <div className="relative text-sm text-gray-400 font-semibold">Per Share</div>
                                        </div>

                                        {/* Next Week Predicted Price */}
                                        {stockPredictions[selectedStock] && (
                                            <div className="mb-6 text-center bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C]">
                                                <div className="text-xs text-[#A0A0A0] font-medium mb-1 uppercase tracking-wider"> Next Week Prediction</div>
                                                <div className={`text-3xl font-semibold mb-1 ${stockPredictions[selectedStock].expectedChange >= 0 ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                    ${stockPredictions[selectedStock].predictedPrice.toFixed(2)}
                                                </div>
                                                <div className={`text-sm font-medium ${stockPredictions[selectedStock].expectedChange >= 0 ? 'text-[#00C805]' : 'text-[#FF5252]'}`}>
                                                    {stockPredictions[selectedStock].expectedChange >= 0 ? '+' : ''}{stockPredictions[selectedStock].expectedChange.toFixed(2)}%
                                                </div>
                                            </div>
                                        )}

                                        {/* Price Chart */}
                                        <div className="mb-6 bg-[#1C1C1C] rounded-xl p-4 border border-[#2C2C2C]">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                    <h3 className="text-sm font-medium text-white"> Price Chart</h3>
                                                    {isRealChartData ? (
                                                        chartPeriod === '1D' ? (
                                                            <div className="flex items-center gap-1 bg-[#1C1C1C] border border-[#2C2C2C] rounded-full px-2 py-1">
                                                                <span className="w-1.5 h-1.5 bg-purple-400 rounded-full animate-pulse"></span>
                                                                <span className="text-[#A0A0A0] text-[10px] font-medium uppercase tracking-wide">Polygon.io (15m delay)</span>
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center gap-1 bg-[#1C1C1C] border border-[#2C2C2C] rounded-full px-2 py-1">
                                                                <span className="w-1.5 h-1.5 bg-[#00C805] rounded-full animate-pulse"></span>
                                                                <span className="text-[#00C805] text-[10px] font-medium uppercase tracking-wide">Alpha Vantage Live</span>
                                                            </div>
                                                        )
                                                    ) : (
                                                        <div className="flex items-center gap-1 bg-yellow-500/20 border border-yellow-500 rounded-full px-2 py-1">
                                                            <span className="text-yellow-500 text-[10px] font-medium uppercase tracking-wide">Simulated</span>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex flex-wrap gap-1 bg-[#1C1C1C] rounded-lg p-1 border border-[#2C2C2C]">
                                                    {['1D', '1W', '1M', '3M', '6M', 'YTD', '1Y', '5Y', 'ALL'].map(period => (
                                                        <button
                                                            key={period}
                                                            onClick={() => setChartPeriod(period)}
                                                            className={`px-2 py-1 rounded font-medium text-xs transition-colors ${
                                                                chartPeriod === period
                                                                    ? 'bg-[#00C805] text-white'
                                                                    : 'text-[#A0A0A0] hover:text-white'
                                                            }`}
                                                        >
                                                            {period}
                                                        </button>
                                                    ))}
                                                </div>
                                                {chartPeriod === '1D' && (
                                                    <div className="flex gap-1 bg-[#1C1C1C] rounded-lg p-1 border border-[#2C2C2C] mt-2">
                                                        {[1, 5].map(interval => (
                                                            <button
                                                                key={interval}
                                                                onClick={() => setIntradayInterval(interval)}
                                                                className={`px-2 py-1 text-xs font-medium rounded ${
                                                                    intradayInterval === interval
                                                                        ? 'bg-[#2C2C2C] text-white'
                                                                        : 'text-[#A0A0A0] hover:bg-[#2C2C2C]'
                                                                }`}
                                                            >
                                                                {interval}min
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="relative h-48">
                                                {chartLoading && (
                                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-10 rounded-lg">
                                                        <div className="flex flex-col items-center gap-2">
                                                            <div className="w-8 h-8 border-2 border-[#00C805] border-t-transparent rounded-full animate-spin"></div>
                                                            <span className="text-[#00C805] text-xs font-medium">Loading chart...</span>
                                                        </div>
                                                    </div>
                                                )}
                                                <canvas ref={chartRef}></canvas>
                                            </div>
                                            {!isRealChartData && (
                                                <div className="mt-3 text-xs text-yellow-500 italic text-center font-normal">
                                                     Using simulated historical data - Alpha Vantage API limit reached
                                                </div>
                                            )}
                                        </div>

                                        {/* Trade Type Selector */}
                                        <div className="mb-6">
                                            <label className="block text-white font-medium mb-3 text-sm">Trade Type</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button
                                                    onClick={() => setTradeType('long')}
                                                    className={`py-3 rounded-xl font-medium transition-colors ${
                                                        tradeType === 'long'
                                                            ? 'bg-[#00C805] text-white'
                                                            : 'bg-[#2C2C2C] text-[#A0A0A0] hover:bg-[#3C3C3C]'
                                                    }`}
                                                >
                                                     Long (Buy)
                                                </button>
                                                <button
                                                    onClick={() => setTradeType('short')}
                                                    className={`py-3 rounded-xl font-medium transition-colors ${
                                                        tradeType === 'short'
                                                            ? 'bg-[#FF5252] text-white'
                                                            : 'bg-[#2C2C2C] text-[#A0A0A0] hover:bg-[#3C3C3C]'
                                                    }`}
                                                >
                                                     Short (Sell)
                                                </button>
                                            </div>
                                            <div className="mt-2 text-xs text-[#A0A0A0] text-center">
                                                {tradeType === 'long' ? ' Buy stock expecting price to rise' : ' Bet against stock expecting price to fall'}
                                            </div>
                                        </div>

                                        {/* Clean Quantity Input - Robinhood Style */}
                                        <div className="mb-6 space-y-4">
                                            <div className="text-center">
                                                <input
                                                    type="number"
                                                    min="1"
                                                    value={quantity}
                                                    onChange={(e) => handleQuantityChange(e.target.value)}
                                                    className="w-24 bg-transparent text-3xl font-bold text-white text-center border-b-2 border-gray-700 focus:border-emerald-500 outline-none"
                                                />
                                                <div className="text-gray-500 mt-1">Shares</div>
                                            </div>

                                            {/* Simple dollar buttons */}
                                            <div className="flex justify-center gap-2">
                                                {['$100', '$500', '$1000', 'Max'].map((amt, idx) => {
                                                    const maxQty = getMaxBuyQuantity(selectedStock);
                                                    const stock = stocks.find(s => s.symbol === selectedStock);
                                                    const price = stock?.price || 0;
                                                    const dollarAmounts = [100, 500, 1000];
                                                    const qty = idx < 3 ? Math.max(1, Math.floor(dollarAmounts[idx] / price)) : maxQty;

                                                    return (
                                                        <button
                                                            key={amt}
                                                            onClick={() => setQuantity(qty)}
                                                            className="px-4 py-2 text-sm text-gray-400 hover:text-white hover:bg-gray-800 rounded-full transition-colors"
                                                        >
                                                            {amt}
                                                        </button>
                                                    );
                                                })}
                                            </div>

                                            {/* Error message */}
                                            {quantityError && (
                                                <div className="bg-[#1C1C1C] border border-[#FF5252] rounded-lg p-3 text-[#FF5252] text-sm text-center">
                                                     {quantityError}
                                                </div>
                                            )}

                                            {/* Clean total */}
                                            <div className="text-center py-4 border-t border-[#2C2C2C]">
                                                <div className="text-[#A0A0A0] text-sm">Estimated Cost</div>
                                                <div className="text-2xl font-semibold text-white">
                                                    ${((stocks.find(s => s.symbol === selectedStock)?.price || 0) * quantity).toFixed(2)}
                                                </div>
                                            </div>

                                            {/* Single prominent action button */}
                                            <button
                                                onClick={() => {
                                                    if (tradeType === 'long') {
                                                        executeTrade('buy');
                                                    } else {
                                                        executeShortSell();
                                                    }
                                                }}
                                                disabled={!marketOpen}
                                                className={`w-full py-4 rounded-full font-medium text-lg transition-colors ${
                                                    marketOpen
                                                        ? 'bg-[#00C805] hover:bg-[#00B804] text-white cursor-pointer'
                                                        : 'bg-[#2C2C2C] text-[#A0A0A0] cursor-not-allowed opacity-60'
                                                }`}
                                            >
                                                {!marketOpen && ' '}
                                                {tradeType === 'long' ? `Buy ${selectedStock}` : `Short ${selectedStock}`}
                                                {!marketOpen && ' (Market Closed)'}
                                            </button>

                                            {/* Sell button (if owns shares) */}
                                            {getCurrentPosition(selectedStock) > 0 && (
                                                <button
                                                    onClick={() => {
                                                        const shortPos = window.shortSelling.getShortPosition(portfolio, selectedStock);
                                                        if (shortPos.quantity > 0) {
                                                            executeCoverShort();
                                                        } else {
                                                            executeTrade('sell');
                                                        }
                                                    }}
                                                    disabled={!marketOpen}
                                                    className={`w-full py-4 rounded-full font-medium text-lg transition-colors ${
                                                        marketOpen
                                                            ? 'bg-[#1C1C1C] hover:bg-[#2C2C2C] border border-[#2C2C2C] text-white cursor-pointer'
                                                            : 'bg-[#2C2C2C] text-[#A0A0A0] cursor-not-allowed opacity-60'
                                                    }`}
                                                >
                                                    {!marketOpen && ' '}
                                                    Sell {selectedStock}
                                                    {!marketOpen && ' (Market Closed)'}
                                                </button>
                                            )}
                                        </div>

                                        {/* Short Position Display */}
                                        {(() => {
                                            const shortPos = window.shortSelling.getShortPosition(portfolio, selectedStock);
                                            if (shortPos.quantity > 0) {
                                                const stock = stocks.find(s => s.symbol === selectedStock);
                                                const pnl = stock ? window.shortSelling.calculateShortPnL(portfolio, selectedStock, stock.price) : 0;
                                                return (
                                                    <div className="mt-4 bg-red-900/30 border border-red-500 rounded-xl p-4">
                                                        <div className="text-red-300 text-sm font-bold mb-2"> SHORT POSITION</div>
                                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                                            <div>
                                                                <div className="text-red-400/70">Shares Shorted:</div>
                                                                <div className="text-white font-bold">{shortPos.quantity}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-red-400/70">Entry Price:</div>
                                                                <div className="text-white font-bold">${shortPos.entryPrice.toFixed(2)}</div>
                                                            </div>
                                                            <div className="col-span-2 mt-2 pt-2 border-t border-red-500/30">
                                                                <div className="text-red-400/70">Unrealized P/L:</div>
                                                                <div className={`text-2xl font-black ${pnl >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                                    {pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}

                                        {/* Stop-Loss Management */}
                                        {(() => {
                                            const position = portfolio.positions[selectedStock] || 0;
                                            const existingStopLoss = stopLossOrders[selectedStock];
                                            const stock = stocks.find(s => s.symbol === selectedStock);

                                            if (position > 0 && stock) {
                                                return (
                                                    <div className="mt-4 bg-gradient-to-br from-orange-900/30 to-yellow-900/30 border border-gray-800 rounded-xl p-4">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="text-orange-300 text-sm font-bold flex items-center gap-2">
                                                                 STOP-LOSS PROTECTION
                                                            </div>
                                                            {existingStopLoss && (
                                                                <div className="bg-green-500/20 border border-green-500/50 text-green-300 text-xs px-2 py-1 rounded-full font-bold">
                                                                    ACTIVE
                                                                </div>
                                                            )}
                                                        </div>

                                                        {existingStopLoss ? (
                                                            <div className="space-y-3">
                                                                <div className="bg-black/30 rounded-lg p-3 border border-orange-500/30">
                                                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                                                        <div>
                                                                            <div className="text-orange-400/70">Trigger Price:</div>
                                                                            <div className="text-white font-bold text-lg">${existingStopLoss.triggerPrice.toFixed(2)}</div>
                                                                        </div>
                                                                        <div>
                                                                            <div className="text-orange-400/70">Shares:</div>
                                                                            <div className="text-white font-bold text-lg">{existingStopLoss.shares || position}</div>
                                                                        </div>
                                                                        <div className="col-span-2">
                                                                            <div className="text-orange-400/70">Current Price:</div>
                                                                            <div className="text-white font-bold">${stock.price.toFixed(2)}</div>
                                                                            <div className="text-xs text-gray-400 mt-1">
                                                                                {((stock.price - existingStopLoss.triggerPrice) / stock.price * 100).toFixed(1)}% above trigger
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => cancelStopLossOrder(selectedStock)}
                                                                    className="w-full bg-red-600/80 hover:bg-red-500 text-white py-2 rounded-lg font-bold transition-all"
                                                                >
                                                                     Cancel Stop-Loss
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-3">
                                                                <div className="text-sm text-orange-200 mb-2">
                                                                    Auto-sell if price drops to protect your capital
                                                                </div>
                                                                <div className="space-y-2">
                                                                    <label className="block text-sm text-orange-300 font-semibold">
                                                                        Stop-Loss Price: (Current: ${stock.price.toFixed(2)})
                                                                    </label>
                                                                    <input
                                                                        type="number"
                                                                        id="stop-loss-price"
                                                                        step="0.01"
                                                                        placeholder={`e.g., ${(stock.price * 0.95).toFixed(2)} (-5%)`}
                                                                        className="w-full bg-black/50 border border-gray-800 text-white px-4 py-2 rounded-lg font-bold focus:border-orange-400 focus:outline-none"
                                                                    />
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            const input = document.getElementById('stop-loss-price');
                                                                            input.value = (stock.price * 0.95).toFixed(2);
                                                                        }}
                                                                        className="bg-orange-600/40 hover:bg-orange-600/60 text-orange-200 text-xs py-2 rounded font-bold"
                                                                    >
                                                                        -5%
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const input = document.getElementById('stop-loss-price');
                                                                            input.value = (stock.price * 0.90).toFixed(2);
                                                                        }}
                                                                        className="bg-orange-600/40 hover:bg-orange-600/60 text-orange-200 text-xs py-2 rounded font-bold"
                                                                    >
                                                                        -10%
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const input = document.getElementById('stop-loss-price');
                                                                            input.value = (stock.price * 0.85).toFixed(2);
                                                                        }}
                                                                        className="bg-orange-600/40 hover:bg-orange-600/60 text-orange-200 text-xs py-2 rounded font-bold"
                                                                    >
                                                                        -15%
                                                                    </button>
                                                                </div>
                                                                <button
                                                                    onClick={() => {
                                                                        const input = document.getElementById('stop-loss-price');
                                                                        const triggerPrice = parseFloat(input.value);
                                                                        if (triggerPrice && triggerPrice > 0 && triggerPrice < stock.price) {
                                                                            addStopLossOrder(selectedStock, triggerPrice, position);
                                                                            input.value = '';
                                                                        } else {
                                                                            showToast(' Stop-loss must be below current price!', 'error');
                                                                        }
                                                                    }}
                                                                    className="w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-400 hover:to-yellow-400 text-white py-3 rounded-lg font-bold transition-all shadow-lg"
                                                                >
                                                                     Set Stop-Loss Order
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </div>
                            )}
                            </div>
                        </div>
                            </>
                        )}

                        {/* Watchlist View */}
                        {mainTab === 'watchlist' && (
                            <>
                                <div className="bg-gradient-to-br from-cyan-900/50 via-blue-900/50 to-cyan-900/50 backdrop-blur-xl rounded-2xl p-4 border border-gray-800 mb-4 shadow-xl" style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.15)'}}>
                                    <h2 className="text-xl font-black text-white mb-4 flex items-center gap-2">
                                         My Watchlist
                                        <span className="text-sm font-normal text-gray-300 ml-2">
                                            ({watchlist.length} stocks)
                                        </span>
                                    </h2>

                                    {loading && stocks.length === 0 ? (
                                        <div className="text-center py-8">
                                            <div className="text-gray-200">Loading stocks...</div>
                                        </div>
                                    ) : watchlist.length === 0 ? (
                                        <div className="text-center py-12 bg-cyan-900/20 rounded-xl border-2 border-dashed border-cyan-500/40 animate-fade-in">
                                            <div className="text-6xl mb-3 opacity-50 animate-bounce"></div>
                                            <h3 className="text-xl font-bold text-white mb-2">No Stocks in Watchlist</h3>
                                            <p className="text-gray-200 text-sm mb-4">Add stocks to your watchlist to track them here</p>
                                            <div className="inline-flex items-center gap-2 bg-cyan-500/20 border border-gray-800 rounded-lg px-4 py-2 text-gray-300 text-sm font-semibold  transition-transform">
                                                <span></span>
                                                <span>Go to Trading tab to search and add stocks</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {filteredStocks.map((stock, index) => (
                                                <div
                                                    key={stock.symbol}
                                                    onClick={() => {
                                                        setSelectedStock(stock.symbol);
                                                        setTradeAnalysisData(null); // Clear trade analysis when switching stocks
                                                        setMainTab('trading');
                                                    }}
                                                    className={`p-4 rounded-xl cursor-pointer transition-all bg-gradient-to-br from-cyan-900/40 to-blue-950/40 backdrop-blur-xl border border-gray-800 hover:border-gray-700 hover:-translate-y-1 shadow-lg hover:shadow-xl will-change-transform gpu-accelerated animate-fade-in stagger-${Math.min(index + 1, 6)}`}
                                                    style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.1)'}}
                                                >
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <div className="font-bold text-xl text-white">{stock.symbol}</div>
                                                            <div className="text-xs text-gray-200 mt-0.5">{stock.name}</div>
                                                        </div>
                                                        <div className={`px-3 py-1 rounded-full font-bold text-sm transition-all ${
                                                            stock.change >= 0
                                                                ? 'bg-green-500/20 text-green-300 border border-green-500 animate-pulse-glow-green'
                                                                : 'bg-red-500/20 text-red-300 border border-red-500 animate-pulse-glow-red'
                                                        }`}>
                                                            {stock.change >= 0 ? '' : ''} {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}%
                                                        </div>
                                                    </div>
                                                    <div className="text-center pt-3 border-t border-cyan-600/30">
                                                        <div className="text-xs text-gray-300 mb-1">Current Price</div>
                                                        <div className="font-bold text-2xl text-white">${stock.price.toFixed(2)}</div>
                                                    </div>
                                                    <div className="mt-3 text-center">
                                                        <button className="w-full bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white py-2 rounded-lg font-bold text-xs transition-all shadow-lg hover:shadow-xl ">
                                                             Trade This Stock
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* News View */}
                        {mainTab === 'news' && (
                            <>
                                {/* Clean News Section - Robinhood Style */}
                                <div className="mb-4">
                                    {/* Animated shine effect */}
                                    <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-cyan-400/10 to-transparent pointer-events-none"></div>

                                    <div className="relative flex items-center justify-between mb-4 flex-wrap gap-3">
                                        <div>
                                            <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-400 to-cyan-300 flex items-center gap-2">
                                                 Market News
                                                <span className="ml-2 px-2 py-0.5 bg-green-500/20 text-green-300 border border-green-500/50 rounded-full text-xs font-bold" style={{boxShadow: '0 0 10px rgba(34, 197, 94, 0.2)'}}>
                                                     LIVE
                                                </span>
                                            </h2>
                                            {lastNewsUpdate && (
                                                <div className="text-xs text-cyan-400 mt-2 font-semibold">
                                                     Last updated: {lastNewsUpdate.toLocaleTimeString()}  Auto-refreshes every 2 min
                                                </div>
                                            )}
                                        </div>
                                        <button
                                            onClick={loadMarketNews}
                                            disabled={loadingMarketNews}
                                            className="group/btn relative bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-500 text-white px-5 py-3 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden shadow-lg"
                                            style={{boxShadow: '0 0 15px rgba(6, 182, 212, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-400 to-blue-500 opacity-0 group-hover/btn:opacity-100 transition-opacity"></div>
                                            <div className="absolute inset-0 -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                                            <span className="relative">{loadingMarketNews ? ' Loading...' : ' Refresh News'}</span>
                                        </button>
                                    </div>

                                    {loadingMarketNews ? (
                                        <div className="relative text-center py-12">
                                            <div className="inline-block animate-spin text-5xl mb-3"></div>
                                            <div className="text-gray-300 text-base font-semibold">Loading latest market news...</div>
                                        </div>
                                    ) : marketNews.length === 0 ? (
                                        <div className="relative text-center py-12 bg-black/30 backdrop-blur-xl rounded-xl border-2 border-dashed border-cyan-500/40 animate-fade-in">
                                            <div className="text-6xl mb-3 opacity-50 animate-bounce"></div>
                                            <h3 className="text-xl font-bold text-white mb-2">No News Available</h3>
                                            <p className="text-gray-300 text-sm mb-4 font-semibold">Click refresh to load the latest market news</p>
                                        </div>
                                    ) : (
                                        <div className="relative space-y-3">
                                            {marketNews.map((article, idx) => (
                                                <div
                                                    key={idx}
                                                    onClick={(e) => {
                                                        e.preventDefault();
                                                        setSelectedNewsArticle(article);
                                                        setShowNewsModal(true);
                                                        scrapeArticle(article);
                                                    }}
                                                    className={`group/news relative block bg-black/40 hover:bg-black/60 backdrop-blur-xl rounded-xl p-4 transition-all border border-gray-800 hover:border-gray-700 hover:-translate-y-1 cursor-pointer will-change-transform overflow-hidden animate-fade-in stagger-${Math.min(idx + 1, 6)}`}
                                                    style={{boxShadow: '0 0 15px rgba(6, 182, 212, 0.1)'}}
                                                >
                                                    {/* Shine effect for news cards */}
                                                    <div className="absolute inset-0 -translate-x-full group-hover/news:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-cyan-400/10 to-transparent"></div>

                                                    <div className="relative flex gap-3">
                                                        {article.image && (
                                                            <img
                                                                src={article.image}
                                                                alt=""
                                                                className="w-24 h-24 rounded-lg object-cover flex-shrink-0 border border-gray-800 group-hover/news:scale-105 transition-transform duration-300"
                                                                onError={(e) => e.target.style.display = 'none'}
                                                            />
                                                        )}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                                <span className={`px-3 py-1 rounded-full text-xs font-bold border-2 transition-all ${
                                                                    article.sentiment === 'positive' ? 'bg-green-500/20 text-green-300 border-green-500/50 animate-pulse-glow-green' :
                                                                    article.sentiment === 'negative' ? 'bg-red-500/20 text-red-300 border-red-500/50 animate-pulse-glow-red' :
                                                                    'bg-gray-500/20 text-gray-300 border-gray-500/50'
                                                                }`} style={{boxShadow: article.sentiment === 'positive' ? '0 0 10px rgba(34, 197, 94, 0.2)' : article.sentiment === 'negative' ? '0 0 10px rgba(239, 68, 68, 0.2)' : 'none'}}>
                                                                    {article.sentiment === 'positive' ? ' Bullish' :
                                                                     article.sentiment === 'negative' ? ' Bearish' :
                                                                     ' Neutral'}
                                                                </span>
                                                                <span className="text-xs text-cyan-400 font-semibold">
                                                                    {window.newsFeed.formatNewsDate(article.datetime)}
                                                                </span>
                                                                {article.category && (
                                                                    <span className="text-xs text-gray-300 bg-cyan-500/10 border border-gray-800 px-2 py-1 rounded-full font-semibold">
                                                                        {article.category}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <h4 className="text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-300 font-black text-base mb-1.5 line-clamp-2 group-hover/news:from-cyan-300 group-hover/news:to-blue-400 transition-all">
                                                                {article.headline}
                                                            </h4>
                                                            <p className="text-xs text-gray-400 line-clamp-2 mb-2 leading-relaxed font-medium">
                                                                {article.summary}
                                                            </p>
                                                            <div className="flex items-center justify-between">
                                                                <div className="text-xs text-cyan-400 font-semibold flex items-center gap-1">
                                                                    <span></span>
                                                                    <span>{article.source}</span>
                                                                </div>
                                                                <div className="text-xs text-gray-300 font-bold flex items-center gap-1 group-hover/news:translate-x-1 transition-transform">
                                                                    <span>Click to read in app</span>
                                                                    <span></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Top Gainers section removed - use dedicated Market Movers tab to avoid API rate limiting */}
                                <div className="bg-gradient-to-br from-blue-900/60 to-indigo-950/60 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 shadow-2xl">
                                    <div className="text-center py-8">
                                        <h3 className="text-xl font-black text-white mb-4"> Market Movers</h3>
                                        <p className="text-blue-300 mb-6">View real-time top gainers and losers in the Market Movers tab</p>
                                        <button
                                            onClick={() => setMainTab('movers')}
                                            className="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-400 hover:to-red-400 text-white px-8 py-3 rounded-xl font-black text-lg transition-all shadow-lg hover:shadow-xl  active-press"
                                        >
                                             Go to Trading
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}

                        {/* AI Analysis View */}
                        {mainTab === 'ai-analysis' && (
                            <>
                                {/* ULTRA-PREMIUM HERO SECTION */}
                                <div className="bg-[#1C1C1C] rounded-xl p-8 md:p-12 border border-[#2C2C2C] mb-8">

                                    <div className="text-center mb-8">
                                        {/* Premium AI Brain Icon */}
                                        <div className="inline-flex items-center justify-center mb-8">
                                            <div className="flex items-center justify-center w-28 h-28 bg-[#00C805] rounded-full">
                                                <span className="text-6xl"></span>
                                            </div>
                                        </div>

                                        {/* UltraThink AI Badge */}
                                        <div className="inline-flex items-center gap-3 bg-[#1C1C1C] border border-[#2C2C2C] rounded-full px-8 py-4 mb-6">
                                            <span className="text-3xl"></span>
                                            <span className="text-white font-semibold text-2xl tracking-wider">
                                                ULTRATHINK AI
                                            </span>
                                            <span className="flex h-3 w-3">
                                                <span className="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-[#00C805] opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-3 w-3 bg-[#00C805]"></span>
                                            </span>
                                        </div>

                                        {/* Main Title */}
                                        <h2 className="text-4xl md:text-5xl font-semibold mb-4 leading-tight text-white">
                                            AI Stock Analysis
                                        </h2>
                                        <p className="text-xl text-[#A0A0A0] mb-8 max-w-3xl mx-auto font-normal">
                                            Deep neural reasoning & institutional-grade market intelligence for any stock
                                        </p>

                                        {/* Feature Pills */}
                                        <div className="flex flex-wrap gap-3 justify-center max-w-3xl mx-auto">
                                            {[
                                                {icon: '', text: '15+ Advanced Indicators'},
                                                {icon: '', text: 'Multi-Scenario Exit Plans'},
                                                {icon: '', text: 'DCF Intrinsic Value'},
                                                {icon: '', text: 'News Sentiment AI'},
                                                {icon: '', text: 'Real-Time Analysis'}
                                            ].map((feature, idx) => (
                                                <div key={idx} className="bg-[#1C1C1C] border border-[#2C2C2C] rounded-full px-4 py-2 transition-colors">
                                                    <span className="text-sm font-medium text-[#A0A0A0] flex items-center gap-2">
                                                        <span className="text-lg">{feature.icon}</span>
                                                        {feature.text}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* ENHANCED STOCK SEARCH */}
                                    <div className="relative max-w-3xl mx-auto mb-8">
                                        <label className="block text-white font-medium mb-4 text-sm flex items-center gap-2">
                                            <span className="text-xl"></span>
                                            <span>Select Stock to Analyze</span>
                                        </label>
                                        <div className="relative">
                                            {/* Search Icon */}
                                            <div className="absolute left-6 top-1/2 -translate-y-1/2 pointer-events-none">
                                                <span className="text-2xl"></span>
                                            </div>

                                            <input
                                                type="text"
                                                placeholder="Type any stock symbol or company name (e.g., AAPL, Tesla, Microsoft)..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full bg-[#1C1C1C] border border-[#2C2C2C] hover:border-[#3C3C3C] focus:border-[#00C805] rounded-xl pl-16 pr-16 py-5 text-white text-lg placeholder-gray-500 focus:outline-none transition-colors"
                                            />

                                            {/* Searching Indicator */}
                                            {searching && (
                                                <div className="absolute right-6 top-1/2 -translate-y-1/2">
                                                    <div className="w-6 h-6 border-4 border-[#2C2C2C] border-t-[#00C805] rounded-full animate-spin"></div>
                                                </div>
                                            )}

                                            {/* Search hints */}
                                            {!searchQuery && !searching && (
                                                <div className="absolute right-6 top-1/2 -translate-y-1/2 flex gap-2">
                                                    {['AAPL', 'TSLA', 'NVDA'].map((symbol) => (
                                                        <button
                                                            key={symbol}
                                                            onClick={() => setSearchQuery(symbol)}
                                                            className="px-3 py-1 bg-[#2C2C2C] hover:bg-[#3C3C3C] rounded-lg text-xs font-medium text-[#A0A0A0] hover:text-white transition-colors"
                                                        >
                                                            {symbol}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Search Results for AI Analysis */}
                                        {searchQuery && showSearchResults && (
                                            <div className="mt-4 bg-[#1C1C1C] border border-[#2C2C2C] rounded-xl overflow-hidden max-h-80 overflow-y-auto">

                                                {searching ? (
                                                    <div className="p-6 text-center">
                                                        <div className="text-[#A0A0A0] font-medium">Searching...</div>
                                                    </div>
                                                ) : searchResults.length > 0 ? (
                                                    searchResults.map((result) => (
                                                        <div
                                                            key={result.symbol}
                                                            onClick={async () => {
                                                                setSearching(true);
                                                                setError(null);
                                                                const stockData = await fetchSingleStock(result.symbol, result.name);
                                                                const existingIndex = stocks.findIndex(s => s.symbol === result.symbol);
                                                                if (existingIndex >= 0) {
                                                                    const updatedStocks = [...stocks];
                                                                    updatedStocks[existingIndex] = stockData;
                                                                    setStocks(updatedStocks);
                                                                } else {
                                                                    setStocks([...stocks, stockData]);
                                                                }
                                                                setSelectedStock(result.symbol);
                                                                setTradeAnalysisData(null); // Clear trade analysis when switching stocks
                                                                setSearchQuery('');
                                                                setShowSearchResults(false);
                                                                setSearching(false);
                                                                // Auto-load news for AI analysis
                                                                const news = await window.newsFeed.fetchStockNews(result.symbol, FINNHUB_API_KEY);
                                                                setStockNews(news);
                                                                // Clear previous AI analysis
                                                                setAiAnalysis(null);
                                                            }}
                                                            className="p-5 border-b border-[#2C2C2C] last:border-b-0 hover:bg-[#2C2C2C] cursor-pointer transition-colors"
                                                        >

                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="font-medium text-white text-xl">{result.symbol}</div>
                                                                        {result.owned && (
                                                                            <span className="bg-[#00C805]/20 text-[#00C805] text-xs font-medium px-2 py-0.5 rounded-full">OWNED</span>
                                                                        )}
                                                                    </div>
                                                                    <div className="text-sm text-[#A0A0A0] font-normal">{result.name}</div>
                                                                    <div className="text-xs text-[#A0A0A0] mt-1 font-normal">
                                                                        {result.region}  {result.currency}
                                                                    </div>
                                                                </div>
                                                                <div className="text-[#A0A0A0] text-3xl"></div>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : error ? (
                                                    <div className="p-6 text-center">
                                                        <div className="text-yellow-400 mb-2 text-2xl"></div>
                                                        <div className="text-yellow-300 text-sm font-medium">{error}</div>
                                                    </div>
                                                ) : (
                                                    <div className="p-6 text-center">
                                                        <div className="text-[#A0A0A0] mb-2 text-2xl"></div>
                                                        <div className="text-white font-medium">No results found for "{searchQuery}"</div>
                                                        <div className="text-xs text-[#A0A0A0] mt-2 font-normal">Try: AAPL, GOOGL, MSFT, TSLA, NVDA</div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Selected Stock Display */}
                                    {selectedStock && (
                                        <div className="max-w-4xl mx-auto">
                                            <div className="bg-[#1C1C1C] rounded-xl p-6 border border-[#2C2C2C] mb-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div>
                                                        <h3 className="text-3xl font-semibold text-white">{selectedStock}</h3>
                                                        <p className="text-[#A0A0A0] text-lg">{stocks.find(s => s.symbol === selectedStock)?.name || selectedStock}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-4xl font-semibold text-white mb-1">
                                                            ${(stocks.find(s => s.symbol === selectedStock)?.price || 0).toFixed(2)}
                                                        </div>
                                                        <div className={`text-lg font-medium ${
                                                            (stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0
                                                                ? 'text-[#00C805]'
                                                                : 'text-[#FF5252]'
                                                        }`}>
                                                            {(stocks.find(s => s.symbol === selectedStock)?.change || 0) >= 0 ? ' +' : ' '}
                                                            {(stocks.find(s => s.symbol === selectedStock)?.change || 0).toFixed(2)}%
                                                        </div>
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={generateAIAnalysis}
                                                    disabled={loadingAnalysis}
                                                    className="w-full bg-[#00C805] hover:bg-[#00B804] disabled:bg-[#2C2C2C] text-white py-4 rounded-xl font-medium text-xl transition-colors disabled:opacity-50 flex items-center justify-center gap-3"
                                                >
                                                    {loadingAnalysis ? (
                                                        <>
                                                            <span className="inline-block animate-spin text-2xl"></span>
                                                            <span>Analyzing with UltraThink...</span>
                                                        </>
                                                    ) : aiAnalysis ? (
                                                        <>
                                                            <span className="text-2xl"></span>
                                                            <span>Refresh Analysis</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span className="text-2xl animate-pulse"></span>
                                                            <span>Generate AI Analysis (Auto-generating...)</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>

                                            {/* ULTRA-PREMIUM AI ANALYSIS LOADING STATE */}
                                            {loadingAnalysis && (
                                                <div className="bg-[#1C1C1C] rounded-xl p-8 md:p-12 border border-[#2C2C2C]">

                                                    <div className="text-center space-y-8">
                                                        {/* Premium Loading Spinner */}
                                                        <div className="inline-flex items-center justify-center">
                                                            {/* Spinning Border */}
                                                            <div className="relative w-32 h-32">
                                                                <div className="absolute inset-0 rounded-full border-4 border-[#2C2C2C]"></div>
                                                                <div className="absolute inset-0 rounded-full border-4 border-transparent border-t-[#00C805] animate-spin" style={{animationDuration: '1s'}}></div>

                                                                {/* Center Icon */}
                                                                <div className="absolute inset-0 flex items-center justify-center">
                                                                    <span className="text-5xl animate-pulse" style={{animationDuration: '2s'}}></span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Processing Title */}
                                                        <div className="space-y-2">
                                                            <h3 className="text-3xl font-semibold text-white animate-pulse">
                                                                 ULTRATHINK AI Processing...
                                                            </h3>
                                                            <p className="text-lg text-[#A0A0A0] font-normal">
                                                                Running institutional-grade analysis
                                                            </p>
                                                        </div>

                                                        {/* Progress Steps */}
                                                        <div className="max-w-2xl mx-auto space-y-3">
                                                            {[
                                                                {icon: '', text: 'Computing RSI, MACD, Bollinger Bands', delay: '0s'},
                                                                {icon: '', text: 'Analyzing Ichimoku Cloud formation', delay: '0.2s'},
                                                                {icon: '', text: 'Calculating Fibonacci retracements', delay: '0.4s'},
                                                                {icon: '', text: 'Building Volume Profile & POC', delay: '0.6s'},
                                                                {icon: '', text: 'Measuring ADX trend strength', delay: '0.8s'},
                                                                {icon: '', text: 'Fetching fundamental metrics (P/E, EPS, margins)', delay: '1s'},
                                                                {icon: '', text: 'Computing DCF intrinsic value', delay: '1.2s'},
                                                                {icon: '', text: 'Processing news sentiment with FinBERT', delay: '1.4s'},
                                                                {icon: '', text: 'Integrating 15+ data sources', delay: '1.6s'},
                                                                {icon: '', text: 'Generating multi-scenario trade plan', delay: '1.8s'}
                                                            ].map((step, idx) => (
                                                                <div
                                                                    key={idx}
                                                                    className="bg-[#1C1C1C] border border-[#2C2C2C] rounded-xl p-4 text-left animate-pulse"
                                                                    style={{animationDelay: step.delay, animationDuration: '2s'}}
                                                                >
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-2xl">{step.icon}</span>
                                                                        <span className="text-white font-normal flex-1">{step.text}</span>
                                                                        <div className="w-5 h-5 border-2 border-[#2C2C2C] border-t-[#00C805] rounded-full animate-spin"></div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Status Bar */}
                                                        <div className="bg-[#1C1C1C] rounded-xl p-6 border border-[#2C2C2C]">
                                                            <div className="text-sm text-white mb-3 font-medium">Analysis Progress</div>
                                                            <div className="w-full bg-[#2C2C2C] rounded-full h-3 overflow-hidden">
                                                                <div className="h-full bg-[#00C805] rounded-full animate-pulse" style={{width: '100%'}}></div>
                                                            </div>
                                                            <div className="text-xs text-[#A0A0A0] mt-3 flex items-center justify-center gap-2">
                                                                <span className="inline-flex h-2 w-2">
                                                                    <span className="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-[#00C805] opacity-75"></span>
                                                                    <span className="relative inline-flex rounded-full h-2 w-2 bg-[#00C805]"></span>
                                                                </span>
                                                                <span className="font-normal">Processing typically takes 2-5 seconds...</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {!loadingAnalysis && aiAnalysis && (
                                                <div className="space-y-4 animate-fade-in">
                                                    {/* AI Disclaimer */}
                                                    <div className="bg-gradient-to-r from-red-900/40 to-orange-900/40 backdrop-blur-xl rounded-xl p-3 border-2 border-red-500/50">
                                                        <div className="flex items-start gap-2">
                                                            <span className="text-xl flex-shrink-0"></span>
                                                            <p className="text-red-100 text-xs leading-relaxed">
                                                                <strong>NOT Financial Advice:</strong> This AI analysis is for educational purposes only. These recommendations are simulated and should NOT be used for real trading decisions.
                                                            </p>
                                                        </div>
                                                    </div>

                                                    {/* ULTRA-COMPACT SUMMARY CARD */}
                                                    <div className={`bg-gradient-to-br ${
                                                        aiAnalysis.recommendation.color === 'green' ? 'from-green-900/60 to-emerald-900/60 border-green-500/60' :
                                                        aiAnalysis.recommendation.color === 'red' ? 'from-red-900/60 to-rose-900/60 border-red-500/60' :
                                                        'from-yellow-900/60 to-amber-900/60 border-yellow-500/60'
                                                    } backdrop-blur-xl rounded-2xl p-6 border-2 shadow-2xl`}>
                                                        <div className="flex items-center justify-between mb-4">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`text-4xl px-4 py-2 rounded-xl font-black ${
                                                                    aiAnalysis.recommendation.color === 'green' ? 'bg-green-500/90 text-white' :
                                                                    aiAnalysis.recommendation.color === 'red' ? 'bg-red-500/90 text-white' :
                                                                    'bg-yellow-500/90 text-gray-900'
                                                                }`}>
                                                                    {aiAnalysis.recommendation.action}
                                                                </div>
                                                                <div>
                                                                    <div className="text-white text-lg font-bold">Signal: {aiAnalysis.signalStrength}/100</div>
                                                                    <div className="text-white/80 text-sm">Confidence: {aiAnalysis.recommendation.confidence}%</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right text-xs text-white/60">
                                                                {aiAnalysis.timestamp}
                                                            </div>
                                                        </div>

                                                        {/* One-line summary */}
                                                        <p className="text-white text-base leading-relaxed font-medium mb-4">
                                                            {aiAnalysis.actionSummary}
                                                        </p>

                                                        {/* Quick metrics grid */}
                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                                            <div className="bg-black/30 rounded-lg p-3">
                                                                <div className="text-xs text-white/60 mb-1">Entry</div>
                                                                <div className="text-white font-bold text-lg">${aiAnalysis.recommendation.targets.entry}</div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3">
                                                                <div className="text-xs text-white/60 mb-1">Stop Loss</div>
                                                                <div className="text-red-300 font-bold text-lg">${aiAnalysis.recommendation.targets.stopLoss}</div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3">
                                                                <div className="text-xs text-white/60 mb-1">Target</div>
                                                                <div className="text-green-300 font-bold text-lg">${aiAnalysis.recommendation.targets.takeProfit}</div>
                                                            </div>
                                                            <div className="bg-black/30 rounded-lg p-3">
                                                                <div className="text-xs text-white/60 mb-1">Position</div>
                                                                <div className="text-white font-bold text-lg">{aiAnalysis.positionSizing.suggestedShares} shares</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* COLLAPSIBLE SECTIONS */}
                                                    <div className="space-y-3">
                                                        {/* Exit Strategy */}
                                                        <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                            <button
                                                                onClick={() => setExpandedSections(prev => ({...prev, exit: !prev.exit}))}
                                                                className="w-full px-5 py-4 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                            >
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-2xl"></span>
                                                                    <span className="text-white font-bold text-lg">Exit Strategy (4 Scenarios)</span>
                                                                </div>
                                                                <span className={`text-gray-300 text-xl transition-transform ${expandedSections.exit ? 'rotate-180' : ''}`}></span>
                                                            </button>
                                                            {expandedSections.exit && (
                                                                <div className="px-5 pb-5 space-y-3">
                                                                    <div className="bg-green-950/50 rounded-lg p-4 border border-green-500/40">
                                                                        <div className="flex items-center justify-between mb-2">
                                                                            <span className="text-green-300 font-bold"> BULL</span>
                                                                            <span className="text-green-300 font-bold">${aiAnalysis.exitPlan.bull.target} (+{aiAnalysis.exitPlan.bull.gain}%)</span>
                                                                        </div>
                                                                        <p className="text-green-100/80 text-sm">{aiAnalysis.exitPlan.bull.action}</p>
                                                                    </div>
                                                                    <div className="bg-blue-950/50 rounded-lg p-4 border border-blue-500/40">
                                                                        <div className="flex items-center justify-between mb-2">
                                                                            <span className="text-blue-300 font-bold"> BASE</span>
                                                                            <span className="text-blue-300 font-bold">${aiAnalysis.exitPlan.base.target} (+{aiAnalysis.exitPlan.base.gain}%)</span>
                                                                        </div>
                                                                        <p className="text-blue-100/80 text-sm">{aiAnalysis.exitPlan.base.action}</p>
                                                                    </div>
                                                                    <div className="bg-yellow-950/50 rounded-lg p-4 border border-yellow-500/40">
                                                                        <div className="flex items-center justify-between mb-2">
                                                                            <span className="text-yellow-300 font-bold"> BEAR</span>
                                                                            <span className="text-yellow-300 font-bold">${aiAnalysis.exitPlan.bear.target} ({aiAnalysis.exitPlan.bear.loss}%)</span>
                                                                        </div>
                                                                        <p className="text-yellow-100/80 text-sm">{aiAnalysis.exitPlan.bear.action}</p>
                                                                    </div>
                                                                    <div className="bg-red-950/50 rounded-lg p-4 border border-red-500/40">
                                                                        <div className="flex items-center justify-between mb-2">
                                                                            <span className="text-red-300 font-bold"> EMERGENCY</span>
                                                                            <span className="text-red-300 font-bold">${aiAnalysis.exitPlan.emergency.target} ({aiAnalysis.exitPlan.emergency.loss}%)</span>
                                                                        </div>
                                                                        <p className="text-red-100/80 text-sm font-bold">{aiAnalysis.exitPlan.emergency.action}</p>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* Pre-Trade Checklist */}
                                                        <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                            <button
                                                                onClick={() => setExpandedSections(prev => ({...prev, checklist: !prev.checklist}))}
                                                                className="w-full px-5 py-4 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                            >
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-2xl"></span>
                                                                    <span className="text-white font-bold text-lg">Pre-Trade Checklist ({aiAnalysis.checklist.length} items)</span>
                                                                </div>
                                                                <span className={`text-gray-300 text-xl transition-transform ${expandedSections.checklist ? 'rotate-180' : ''}`}></span>
                                                            </button>
                                                            {expandedSections.checklist && (
                                                                <div className="px-5 pb-5 space-y-2">
                                                                    {aiAnalysis.checklist.map((item, idx) => (
                                                                        <div key={idx} className="flex items-start gap-2 bg-black/20 rounded-lg p-3">
                                                                            <span className="text-cyan-400 mt-0.5"></span>
                                                                            <span className="text-white/80 text-sm flex-1">{item.task}</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* Event Catalysts */}
                                                        {aiAnalysis.catalysts && aiAnalysis.catalysts.length > 0 && (
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, catalysts: !prev.catalysts}))}
                                                                    className="w-full px-5 py-4 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-2xl"></span>
                                                                        <span className="text-white font-bold text-lg">Event Catalysts ({aiAnalysis.catalysts.length})</span>
                                                                    </div>
                                                                    <span className={`text-gray-300 text-xl transition-transform ${expandedSections.catalysts ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.catalysts && (
                                                                    <div className="px-5 pb-5 space-y-2">
                                                                        {aiAnalysis.catalysts.map((catalyst, idx) => (
                                                                            <div key={idx} className={`rounded-lg p-4 border ${
                                                                                catalyst.impact === 'high' ? 'bg-red-950/50 border-red-500/50' :
                                                                                catalyst.impact === 'medium' ? 'bg-yellow-950/50 border-yellow-500/50' :
                                                                                'bg-blue-950/50 border-blue-500/50'
                                                                            }`}>
                                                                                <div className="flex items-center gap-2 mb-2">
                                                                                    <span className={`font-bold text-sm ${
                                                                                        catalyst.impact === 'high' ? 'text-red-300' :
                                                                                        catalyst.impact === 'medium' ? 'text-yellow-300' :
                                                                                        'text-blue-300'
                                                                                    }`}>
                                                                                        {catalyst.title}
                                                                                    </span>
                                                                                    <span className="text-xs text-gray-400"> {catalyst.date}</span>
                                                                                </div>
                                                                                <p className="text-sm text-white/70">{catalyst.recommendation}</p>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                        {/* Advanced Technical Indicators */}
                                                        {(aiAnalysis.advancedIndicators?.ichimoku || aiAnalysis.advancedIndicators?.fibonacci ||
                                                          aiAnalysis.advancedIndicators?.volumeProfile || aiAnalysis.advancedIndicators?.adx) && (
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, advanced: !prev.advanced}))}
                                                                    className="w-full px-5 py-4 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-2xl"></span>
                                                                        <span className="text-white font-bold text-lg">Advanced Indicators</span>
                                                                        <span className="text-xs bg-cyan-500/30 px-2 py-1 rounded-full border border-cyan-400/50 text-gray-200">INSTITUTIONAL</span>
                                                                    </div>
                                                                    <span className={`text-gray-300 text-xl transition-transform ${expandedSections.advanced ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.advanced && (
                                                                    <div className="px-5 pb-5">
                                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                {/* Ichimoku Cloud */}
                                                                {aiAnalysis.advancedIndicators?.ichimoku && (
                                                                    <div className="bg-black/30 rounded-xl p-5 border border-gray-800 hover:border-gray-700/50 transition-all">
                                                                        <div className="flex items-center gap-2 mb-3">
                                                                            <span className="text-2xl"></span>
                                                                            <h4 className="text-lg font-black text-gray-300">Ichimoku Cloud</h4>
                                                                        </div>
                                                                        <div className="space-y-2 text-sm">
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Signal:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.ichimoku.signal.includes('strong_buy') ? 'text-green-400' :
                                                                                    aiAnalysis.advancedIndicators.ichimoku.signal.includes('buy') ? 'text-lime-400' :
                                                                                    aiAnalysis.advancedIndicators.ichimoku.signal.includes('sell') ? 'text-red-400' :
                                                                                    'text-gray-300'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.ichimoku.signal.replace('_', ' ').toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Cloud:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.ichimoku.cloudColor === 'bullish' ? 'text-green-400' : 'text-red-400'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.ichimoku.cloudColor.toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Price vs Cloud:</span>
                                                                                <span className="font-bold text-white">{aiAnalysis.advancedIndicators.ichimoku.priceVsCloud.toUpperCase()}</span>
                                                                            </div>
                                                                            <div className="mt-3 pt-3 border-t border-cyan-500/30">
                                                                                <p className="text-xs text-gray-200">{aiAnalysis.advancedIndicators.ichimoku.interpretation}</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* Fibonacci Levels */}
                                                                {aiAnalysis.advancedIndicators?.fibonacci && (
                                                                    <div className="bg-black/30 rounded-xl p-5 border-2 border-yellow-500/30 hover:border-yellow-400/50 transition-all">
                                                                        <div className="flex items-center gap-2 mb-3">
                                                                            <span className="text-2xl"></span>
                                                                            <h4 className="text-lg font-black text-yellow-300">Fibonacci Retracement</h4>
                                                                        </div>
                                                                        <div className="space-y-2 text-sm">
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Nearest Level:</span>
                                                                                <span className="font-bold text-white">{aiAnalysis.advancedIndicators.fibonacci.nearestLevel.label}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Type:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.fibonacci.nearestLevel.type === 'support' ? 'text-green-400' : 'text-red-400'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.fibonacci.nearestLevel.type.toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Price:</span>
                                                                                <span className="font-bold text-white">${aiAnalysis.advancedIndicators.fibonacci.nearestLevel.price}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Distance:</span>
                                                                                <span className="font-bold text-yellow-300">{aiAnalysis.advancedIndicators.fibonacci.nearestLevel.distance}%</span>
                                                                            </div>
                                                                            <div className="mt-3 pt-3 border-t border-yellow-500/30">
                                                                                <p className="text-xs text-yellow-200">{aiAnalysis.advancedIndicators.fibonacci.interpretation}</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* Volume Profile */}
                                                                {aiAnalysis.advancedIndicators?.volumeProfile && (
                                                                    <div className="bg-black/30 rounded-xl p-5 border border-gray-800 hover:border-gray-700/50 transition-all">
                                                                        <div className="flex items-center gap-2 mb-3">
                                                                            <span className="text-2xl"></span>
                                                                            <h4 className="text-lg font-black text-blue-300">Volume Profile</h4>
                                                                        </div>
                                                                        <div className="space-y-2 text-sm">
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">POC (Point of Control):</span>
                                                                                <span className="font-bold text-white">${aiAnalysis.advancedIndicators.volumeProfile.poc.price}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Value Area High:</span>
                                                                                <span className="font-bold text-green-400">${aiAnalysis.advancedIndicators.volumeProfile.valueArea.high}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Value Area Low:</span>
                                                                                <span className="font-bold text-red-400">${aiAnalysis.advancedIndicators.volumeProfile.valueArea.low}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Position:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.volumeProfile.relativeToVA === 'below' ? 'text-green-400' :
                                                                                    aiAnalysis.advancedIndicators.volumeProfile.relativeToVA === 'above' ? 'text-red-400' :
                                                                                    'text-gray-300'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.volumeProfile.relativeToVA.toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="mt-3 pt-3 border-t border-blue-500/30">
                                                                                <p className="text-xs text-gray-200">{aiAnalysis.advancedIndicators.volumeProfile.interpretation}</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* ADX Trend Strength */}
                                                                {aiAnalysis.advancedIndicators?.adx && (
                                                                    <div className="bg-black/30 rounded-xl p-5 border border-gray-800 hover:border-orange-400/50 transition-all">
                                                                        <div className="flex items-center gap-2 mb-3">
                                                                            <span className="text-2xl"></span>
                                                                            <h4 className="text-lg font-black text-orange-300">ADX Trend Strength</h4>
                                                                        </div>
                                                                        <div className="space-y-2 text-sm">
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">ADX Value:</span>
                                                                                <span className="font-bold text-white">{aiAnalysis.advancedIndicators.adx.adx}</span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Trend Strength:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.adx.trendStrength === 'very_strong' ? 'text-green-400' :
                                                                                    aiAnalysis.advancedIndicators.adx.trendStrength === 'strong' ? 'text-lime-400' :
                                                                                    aiAnalysis.advancedIndicators.adx.trendStrength === 'developing' ? 'text-yellow-400' :
                                                                                    'text-gray-400'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.adx.trendStrength.replace('_', ' ').toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="flex justify-between">
                                                                                <span className="text-gray-400">Direction:</span>
                                                                                <span className={`font-bold ${
                                                                                    aiAnalysis.advancedIndicators.adx.trendDirection === 'bullish' ? 'text-green-400' : 'text-red-400'
                                                                                }`}>
                                                                                    {aiAnalysis.advancedIndicators.adx.trendDirection.toUpperCase()}
                                                                                </span>
                                                                            </div>
                                                                            <div className="mt-3 pt-3 border-t border-orange-500/30">
                                                                                <p className="text-xs text-orange-200">{aiAnalysis.advancedIndicators.adx.interpretation}</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                        {/* Fundamental Analysis */}
                                                        {aiAnalysis.fundamentalAnalysis && (
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, fundamental: !prev.fundamental}))}
                                                                    className="w-full px-5 py-4 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-2xl"></span>
                                                                        <span className="text-white font-bold text-lg">Fundamental Analysis</span>
                                                                        <span className={`text-xs px-2 py-1 rounded-full border ${
                                                                            aiAnalysis.fundamentalAnalysis.rating === 'EXCELLENT' ? 'bg-green-500/30 border-green-400/50 text-green-200' :
                                                                            aiAnalysis.fundamentalAnalysis.rating === 'GOOD' ? 'bg-lime-500/30 border-lime-400/50 text-lime-200' :
                                                                            aiAnalysis.fundamentalAnalysis.rating === 'FAIR' ? 'bg-yellow-500/30 border-yellow-400/50 text-yellow-200' :
                                                                            aiAnalysis.fundamentalAnalysis.rating === 'AVERAGE' ? 'bg-orange-500/30 border-orange-400/50 text-orange-200' :
                                                                            'bg-red-500/30 border-red-400/50 text-red-200'
                                                                        }`}>
                                                                            {aiAnalysis.fundamentalAnalysis.rating}
                                                                        </span>
                                                                    </div>
                                                                    <span className={`text-gray-300 text-xl transition-transform ${expandedSections.fundamental ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.fundamental && (
                                                                    <div className="px-5 pb-5">
                                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                                {/* Quality Score */}
                                                                <div className="bg-black/30 rounded-xl p-5 border-2 border-emerald-500/30">
                                                                    <div className="text-center mb-3">
                                                                        <div className="text-sm text-emerald-300 mb-2">Quality Score</div>
                                                                        <div className={`text-5xl font-black ${
                                                                            aiAnalysis.fundamentalAnalysis.qualityScore >= 80 ? 'text-green-400' :
                                                                            aiAnalysis.fundamentalAnalysis.qualityScore >= 70 ? 'text-lime-400' :
                                                                            aiAnalysis.fundamentalAnalysis.qualityScore >= 60 ? 'text-yellow-400' :
                                                                            aiAnalysis.fundamentalAnalysis.qualityScore >= 50 ? 'text-orange-400' :
                                                                            'text-red-400'
                                                                        }`}>
                                                                            {aiAnalysis.fundamentalAnalysis.qualityScore}
                                                                        </div>
                                                                        <div className="text-xs text-gray-400 mt-1">out of 100</div>
                                                                    </div>
                                                                    <div className="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
                                                                        <div
                                                                            className={`h-full rounded-full ${
                                                                                aiAnalysis.fundamentalAnalysis.qualityScore >= 80 ? 'bg-emerald-500 hover:bg-emerald-400' :
                                                                                aiAnalysis.fundamentalAnalysis.qualityScore >= 70 ? 'bg-gradient-to-r from-lime-500 to-green-500' :
                                                                                aiAnalysis.fundamentalAnalysis.qualityScore >= 60 ? 'bg-gradient-to-r from-yellow-500 to-lime-500' :
                                                                                aiAnalysis.fundamentalAnalysis.qualityScore >= 50 ? 'bg-gradient-to-r from-orange-500 to-yellow-500' :
                                                                                'bg-gradient-to-r from-red-500 to-orange-500'
                                                                            }`}
                                                                            style={{width: `${aiAnalysis.fundamentalAnalysis.qualityScore}%`}}
                                                                        ></div>
                                                                    </div>
                                                                </div>

                                                                {/* DCF Intrinsic Value */}
                                                                {aiAnalysis.dcf && (
                                                                    <div className="bg-black/30 rounded-xl p-5 border-2 border-emerald-500/30">
                                                                        <div className="text-sm text-emerald-300 mb-2">DCF Intrinsic Value</div>
                                                                        <div className="text-3xl font-black text-white mb-1">${aiAnalysis.dcf.intrinsicValue}</div>
                                                                        <div className="text-xs text-gray-400 mb-3">Current: ${aiAnalysis.dcf.currentPrice}</div>
                                                                        <div className={`text-sm font-bold ${
                                                                            parseFloat(aiAnalysis.dcf.marginOfSafety) > 20 ? 'text-green-400' :
                                                                            parseFloat(aiAnalysis.dcf.marginOfSafety) > 0 ? 'text-lime-400' :
                                                                            parseFloat(aiAnalysis.dcf.marginOfSafety) > -20 ? 'text-orange-400' :
                                                                            'text-red-400'
                                                                        }`}>
                                                                            {parseFloat(aiAnalysis.dcf.marginOfSafety) > 0 ? ' ' : ' '}
                                                                            {aiAnalysis.dcf.recommendation}
                                                                        </div>
                                                                        <div className="text-xs text-emerald-200 mt-2">
                                                                            Margin of Safety: {aiAnalysis.dcf.marginOfSafety}%
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                                        {/* Key Signals */}
                                                                        <div className="space-y-2">
                                                                            {aiAnalysis.fundamentalAnalysis && aiAnalysis.fundamentalAnalysis.signals && aiAnalysis.fundamentalAnalysis.signals.map((signal, idx) => (
                                                                                <div key={idx} className="bg-black/20 rounded-lg p-2 text-sm text-emerald-100 flex items-center gap-2">
                                                                                    <span className="text-emerald-400"></span>
                                                                                    <span>{signal}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                    {/* Main Recommendation */}
                                                    <div className={`bg-gradient-to-br ${
                                                        aiAnalysis.recommendation.color === 'green' ? 'from-green-900/40 to-emerald-900/40 border-green-500 hover-glow-green' :
                                                        aiAnalysis.recommendation.color === 'red' ? 'from-red-900/40 to-rose-900/40 border-red-500 hover-glow-red' :
                                                        'from-yellow-900/40 to-amber-900/40 border-yellow-500 hover-glow-amber'
                                                    } border-2 rounded-2xl p-8 shadow-2xl transition-all hover:-translate-y-1 will-change-transform gpu-accelerated animate-scale-in`}>
                                                        <div className="text-center mb-6">
                                                            <div className={`inline-block px-6 py-3 rounded-full font-black text-2xl mb-3 ${
                                                                aiAnalysis.recommendation.color === 'green' ? 'bg-green-500 text-white animate-pulse-glow-green' :
                                                                aiAnalysis.recommendation.color === 'red' ? 'bg-red-500 text-white animate-pulse-glow-red' :
                                                                'bg-yellow-500 text-gray-900 animate-pulse-glow-amber'
                                                            }`}>
                                                                {aiAnalysis.recommendation.action}
                                                            </div>
                                                            <div className="text-lg text-white mt-2">
                                                                Confidence: <span className="font-black text-2xl">{aiAnalysis.recommendation.confidence}%</span>
                                                            </div>
                                                        </div>

                                                        {/* Reasoning */}
                                                        <div className="space-y-4 mb-6">
                                                            {aiAnalysis.recommendation.reasoning.map((reason, idx) => (
                                                                <div key={idx} className="bg-black/20 rounded-xl p-4 text-white">
                                                                    {reason}
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* Trade Targets */}
                                                        <div className="grid grid-cols-3 gap-4">
                                                            <div className="bg-blue-900/50 rounded-xl p-4 text-center border border-gray-800">
                                                                <div className="text-sm text-blue-300 mb-2">Entry Price</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.entry}</div>
                                                            </div>
                                                            <div className="bg-red-900/50 rounded-xl p-4 text-center border-2 border-red-500/30">
                                                                <div className="text-sm text-red-300 mb-2">Stop Loss</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.stopLoss}</div>
                                                            </div>
                                                            <div className="bg-green-900/50 rounded-xl p-4 text-center border border-gray-800">
                                                                <div className="text-sm text-green-300 mb-2">Take Profit</div>
                                                                <div className="text-white font-black text-2xl">${aiAnalysis.recommendation.targets.takeProfit}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                        {/* Technical/Sentiment/Risk - Compact Cards */}
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                            {/* Technical */}
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, technical: !prev.technical}))}
                                                                    className="w-full px-4 py-3 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-xl"></span>
                                                                        <span className="text-white font-bold">Technical</span>
                                                                    </div>
                                                                    <span className={`text-gray-300 transition-transform ${expandedSections.technical ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.technical && (
                                                                    <div className="px-4 pb-4 space-y-2">
                                                                        <div className="bg-black/20 rounded p-2">
                                                                            <div className="text-xs text-gray-400">Signal</div>
                                                                            <div className={`text-sm font-bold ${
                                                                                aiAnalysis.technical.signal.includes('Bullish') ? 'text-green-300' :
                                                                                aiAnalysis.technical.signal.includes('Bearish') ? 'text-red-300' :
                                                                                'text-yellow-300'
                                                                            }`}>{aiAnalysis.technical.signal}</div>
                                                                        </div>
                                                                        <div className="grid grid-cols-2 gap-2">
                                                                            <div className="bg-black/20 rounded p-2">
                                                                                <div className="text-xs text-gray-400">Support</div>
                                                                                <div className="text-sm font-bold text-white">${aiAnalysis.technical.support}</div>
                                                                            </div>
                                                                            <div className="bg-black/20 rounded p-2">
                                                                                <div className="text-xs text-gray-400">Resistance</div>
                                                                                <div className="text-sm font-bold text-white">${aiAnalysis.technical.resistance}</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Sentiment */}
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, sentiment: !prev.sentiment}))}
                                                                    className="w-full px-4 py-3 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-xl"></span>
                                                                        <span className="text-white font-bold">Sentiment</span>
                                                                    </div>
                                                                    <span className={`text-gray-300 transition-transform ${expandedSections.sentiment ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.sentiment && (
                                                                    <div className="px-4 pb-4 space-y-2">
                                                                        <div className="bg-black/20 rounded p-2">
                                                                            <div className="text-xs text-gray-400">Score</div>
                                                                            <div className={`text-sm font-bold ${
                                                                                parseFloat(aiAnalysis.sentiment.score) > 30 ? 'text-green-300' :
                                                                                parseFloat(aiAnalysis.sentiment.score) < -30 ? 'text-red-300' :
                                                                                'text-yellow-300'
                                                                            }`}>{aiAnalysis.sentiment.score}/100 ({aiAnalysis.sentiment.signal})</div>
                                                                        </div>
                                                                        <div className="grid grid-cols-2 gap-2">
                                                                            <div className="bg-black/20 rounded p-2">
                                                                                <div className="text-xs text-gray-400">Articles</div>
                                                                                <div className="text-sm font-bold text-white">{aiAnalysis.sentiment.articlesAnalyzed}</div>
                                                                            </div>
                                                                            <div className="bg-black/20 rounded p-2">
                                                                                <div className="text-xs text-gray-400">Interest</div>
                                                                                <div className="text-sm font-bold text-white">{aiAnalysis.sentiment.trending}</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Risk */}
                                                            <div className="bg-cyan-900/30 backdrop-blur-xl rounded-xl border border-gray-800 overflow-hidden">
                                                                <button
                                                                    onClick={() => setExpandedSections(prev => ({...prev, risk: !prev.risk}))}
                                                                    className="w-full px-4 py-3 flex items-center justify-between hover:bg-cyan-500/10 transition-all"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-xl"></span>
                                                                        <span className="text-white font-bold">Risk</span>
                                                                    </div>
                                                                    <span className={`text-gray-300 transition-transform ${expandedSections.risk ? 'rotate-180' : ''}`}></span>
                                                                </button>
                                                                {expandedSections.risk && (
                                                                    <div className="px-4 pb-4 space-y-2">
                                                                        <div className="bg-black/20 rounded p-2">
                                                                            <div className="text-xs text-gray-400">Level</div>
                                                                            <div className={`text-sm font-bold ${
                                                                                aiAnalysis.risk.level === 'High' ? 'text-red-300' :
                                                                                aiAnalysis.risk.level === 'Moderate' ? 'text-yellow-300' :
                                                                                'text-green-300'
                                                                            }`}>{aiAnalysis.risk.level} ({aiAnalysis.risk.rating}/10)</div>
                                                                        </div>
                                                                        <div className="space-y-1">
                                                                            {aiAnalysis.risk.factors.map((factor, idx) => (
                                                                                <div key={idx} className="bg-black/20 rounded p-2 text-xs text-white/70">
                                                                                    {factor}
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {!loadingAnalysis && !aiAnalysis && (
                                                <div className="bg-gradient-to-br from-purple-900/40 to-indigo-900/40 rounded-2xl p-16 border border-gray-800 text-center">
                                                    <div className="text-8xl mb-6"></div>
                                                    <h3 className="text-3xl font-bold text-white mb-4">Ready to Analyze {selectedStock}</h3>
                                                    <p className="text-xl text-gray-400 mb-8">Click the button above to generate comprehensive AI-powered insights</p>
                                                    <div className="flex items-center justify-center gap-3 text-gray-300">
                                                        <span className="text-lg">Powered by</span>
                                                        <span className="text-2xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">UltraThink AI</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {!selectedStock && (
                                        <div className="max-w-2xl mx-auto text-center py-16">
                                            <div className="text-9xl mb-6 opacity-70"></div>
                                            <h3 className="text-3xl font-bold text-white mb-4">Search for Any Stock</h3>
                                            <p className="text-xl text-gray-400">Use the search bar above to find and analyze any stock with AI-powered insights</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}


                        {/* Market Movers View */}
                        {mainTab === 'movers' && (
                            <>
                                {/* Simple Loading State */}
                                {loadingMovers ? (
                                    <div className="text-center py-12">
                                        <div className="text-4xl mb-4"></div>
                                        <div className="text-lg text-white font-semibold mb-2">Loading Market Movers...</div>
                                        <div className="text-sm text-gray-500">Scanning {moversProgress.current}/{moversProgress.total} stocks</div>
                                    </div>
                                ) : (
                                        <>
                                            {/* Top Gainers - Robinhood Style */}
                                            <div className="mb-8">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h2 className="text-lg font-semibold text-white">Top Movers</h2>
                                                    <span className="text-sm text-gray-500">Today</span>
                                                </div>

                                                {topGainers.length === 0 ? (
                                                    <div className="text-center py-8 text-gray-500">No gainers found</div>
                                                ) : (
                                                    <div className="space-y-1 mb-8">
                                                        {topGainers.map((stock, i) => (
                                                            <div
                                                                key={stock.symbol}
                                                                onClick={() => {
                                                                    addToWatchlist(stock.symbol);
                                                                    setMainTab('trading');
                                                                }}
                                                                className="flex items-center justify-between py-3 hover:bg-gray-900/50 rounded-lg px-2 cursor-pointer transition-colors"
                                                            >
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-gray-500 w-4 text-sm">{i + 1}</span>
                                                                    <div>
                                                                        <div className="font-semibold text-white">{stock.symbol}</div>
                                                                        <div className="text-sm text-gray-500 truncate max-w-[120px]">{stock.name}</div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="font-semibold text-white">${stock.price.toFixed(2)}</div>
                                                                    <div className="text-emerald-500">
                                                                        +{stock.change.toFixed(2)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                {/* Top Losers */}
                                                <div className="flex items-center justify-between mb-4 mt-8">
                                                    <h2 className="text-lg font-semibold text-white">Top Losers</h2>
                                                    <span className="text-sm text-gray-500">Today</span>
                                                </div>

                                                {topLosers.length === 0 ? (
                                                    <div className="text-center py-8 text-gray-500">No losers found</div>
                                                ) : (
                                                    <div className="space-y-1">
                                                        {topLosers.map((stock, i) => (
                                                            <div
                                                                key={stock.symbol}
                                                                onClick={() => {
                                                                    addToWatchlist(stock.symbol);
                                                                    setMainTab('trading');
                                                                }}
                                                                className="flex items-center justify-between py-3 hover:bg-gray-900/50 rounded-lg px-2 cursor-pointer transition-colors"
                                                            >
                                                                <div className="flex items-center gap-3">
                                                                    <span className="text-gray-500 w-4 text-sm">{i + 1}</span>
                                                                    <div>
                                                                        <div className="font-semibold text-white">{stock.symbol}</div>
                                                                        <div className="text-sm text-gray-500 truncate max-w-[120px]">{stock.name}</div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="font-semibold text-white">${stock.price.toFixed(2)}</div>
                                                                    <div className="text-red-500">
                                                                        {stock.change.toFixed(2)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>

                                            {/* Refresh Button */}
                                            <div className="mt-8 text-center">
                                                <button
                                                    onClick={fetchMarketMovers}
                                                    disabled={loadingMovers}
                                                    className="bg-emerald-500 hover:bg-emerald-400 disabled:bg-gray-700 text-white px-8 py-4 rounded-xl font-semibold text-lg transition-colors disabled:cursor-not-allowed disabled:opacity-50"
                                                >
                                                    {loadingMovers ? 'Refreshing...' : 'Refresh Market Data'}
                                                </button>
                                            </div>
                                        </>
                                    )}
                            </>
                        )}

                        {/* Learning Tab */}
                        {mainTab === 'learning' && (
                            <div className="space-y-6">
                                {/* Learning Disclaimer */}
                                <div className="bg-gradient-to-r from-red-900/40 to-orange-900/40 backdrop-blur-xl rounded-xl p-5 border-2 border-red-500/50">
                                    <div className="flex items-start gap-3">
                                        <span className="text-3xl flex-shrink-0"></span>
                                        <div>
                                            <h4 className="text-lg font-bold text-red-300 mb-2">Educational Content - Not Financial Advice</h4>
                                            <p className="text-red-100 text-sm leading-relaxed">
                                                All lessons, tips, strategies, and examples are for <strong>educational purposes only</strong> and do NOT constitute financial advice. FinClash is a virtual trading simulator using fake money. Trading real stocks carries significant risk. Always conduct your own research and consult a licensed financial advisor before making any investment decisions with real money.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Back Button (when viewing a topic) */}
                                {learningTopic && (
                                    <button
                                        onClick={() => {
                                            setLearningTopic(null);
                                            setLearningLesson(null);
                                        }}
                                        className="bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg flex items-center gap-2"
                                    >
                                         Back to All Topics
                                    </button>
                                )}

                                {/* Overview (when learningTopic is null) */}
                                {!learningTopic && (
                                <>
                                {/* Ultra-Premium Hero Section with UltraThink AI Branding */}
                                <div className="relative bg-gradient-to-br from-cyan-900/50 via-blue-900/50 to-cyan-900/50 backdrop-blur-2xl rounded-2xl p-8 md:p-12 border border-gray-800 shadow-2xl overflow-hidden" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                                    {/* Animated Background Pattern */}
                                    <div className="absolute inset-0 opacity-10">
                                        <div className="absolute inset-0" style={{
                                            backgroundImage: 'radial-gradient(circle at 20% 50%, rgba(6, 182, 212, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.3) 0%, transparent 50%)',
                                            animation: 'pulse 4s ease-in-out infinite'
                                        }}></div>
                                    </div>

                                    {/* Floating Glow Effect */}
                                    <div className="absolute top-10 left-20 w-64 h-64 bg-cyan-500/20 rounded-full blur-3xl animate-pulse"></div>
                                    <div className="absolute bottom-10 right-20 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>

                                    <div className="relative z-10 text-center">
                                        {/* UltraThink AI Badge */}
                                        <div className="inline-flex items-center gap-3 bg-black/40 backdrop-blur-xl border-2 border-cyan-400/50 rounded-full px-6 py-3 mb-6 shadow-2xl" style={{boxShadow: '0 0 30px rgba(6, 182, 212, 0.4)'}}>
                                            <div className="relative">
                                                <span className="text-3xl"></span>
                                                <div className="absolute inset-0 animate-ping">
                                                    <span className="text-3xl opacity-75"></span>
                                                </div>
                                            </div>
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-300 to-cyan-300 font-black text-lg">
                                                POWERED BY ULTRATHINK AI
                                            </span>
                                            <span className="flex h-2 w-2">
                                                <span className="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-green-400 opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                            </span>
                                        </div>

                                        {/* Main Hero Title */}
                                        <h2 className="text-4xl md:text-5xl font-black mb-4 leading-tight">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-300 to-cyan-300">
                                                Elite Trading Academy
                                            </span>
                                        </h2>
                                        <p className="text-xl text-cyan-100 mb-8 max-w-3xl mx-auto font-semibold">
                                            Master the markets with AI-powered lessons, interactive tools, and real-world strategies
                                        </p>

                                        {/* Premium Stats Grid */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                                            <div className="bg-black/40 backdrop-blur-xl rounded-2xl p-6 border-2 border-cyan-400/30 hover:border-gray-700 transition-all duration-300  hover:shadow-2xl" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.2)'}}>
                                                <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-2">50+</div>
                                                <div className="text-sm font-bold text-gray-200">Expert Lessons</div>
                                            </div>
                                            <div className="bg-black/40 backdrop-blur-xl rounded-2xl p-6 border-2 border-cyan-400/30 hover:border-gray-700 transition-all duration-300  hover:shadow-2xl" style={{boxShadow: '0 0 20px rgba(6, 182, 212, 0.2)'}}>
                                                <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-2">100%</div>
                                                <div className="text-sm font-bold text-gray-200">Free Forever</div>
                                            </div>
                                            <div className="bg-black/40 backdrop-blur-xl rounded-2xl p-6 border-2 border-green-400/30 hover:border-gray-700 transition-all duration-300  hover:shadow-2xl" style={{boxShadow: '0 0 20px rgba(34, 197, 94, 0.2)'}}>
                                                <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-300 mb-2">AI</div>
                                                <div className="text-sm font-bold text-green-200">Powered Tools</div>
                                            </div>
                                            <div className="bg-black/40 backdrop-blur-xl rounded-2xl p-6 border-2 border-orange-400/30 hover:border-orange-400 transition-all duration-300  hover:shadow-2xl" style={{boxShadow: '0 0 20px rgba(251, 146, 60, 0.2)'}}>
                                                <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-300 to-yellow-300 mb-2">24/7</div>
                                                <div className="text-sm font-bold text-orange-200">Instant Access</div>
                                            </div>
                                        </div>

                                        {/* CTA Badge */}
                                        <div className="mt-8 inline-flex items-center gap-2 bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-2 border-green-400/50 rounded-full px-6 py-3">
                                            <span className="text-2xl"></span>
                                            <span className="text-green-200 font-bold">Start learning below - No signup required!</span>
                                        </div>
                                    </div>
                                </div>

                                {/* AI-Powered Daily Trading Tip */}
                                <div className="relative bg-gradient-to-br from-cyan-900/50 via-blue-900/50 to-cyan-900/50 backdrop-blur-2xl rounded-2xl p-8 border border-gray-800 shadow-2xl overflow-hidden" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                                    {/* Glow Effect */}
                                    <div className="absolute top-0 right-0 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl"></div>

                                    <div className="flex items-start gap-6">
                                        <div className="relative flex-shrink-0">
                                            <div className="text-6xl"></div>
                                            <div className="absolute -bottom-2 -right-2 bg-gray-700 hover:bg-gray-600 rounded-full p-1">
                                                <span className="text-xs"></span>
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-4">
                                                <h3 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300">
                                                    AI Daily Wisdom
                                                </h3>
                                                <span className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-full font-black text-xs animate-pulse">
                                                    TODAY
                                                </span>
                                                <span className="bg-cyan-500/30 text-gray-200 px-3 py-1 rounded-full font-bold text-xs border border-cyan-400/50">
                                                    UltraThink AI
                                                </span>
                                            </div>
                                            <p className="text-lg text-cyan-100 font-semibold mb-2">
                                                {(() => {
                                                    const tips = [
                                                        "Always set a stop-loss before entering a trade. It's your safety net against unexpected losses.",
                                                        "The first hour of trading (9:30-10:30 AM ET) is the most volatile. Wait for price stability if you're new.",
                                                        "Volume confirms price moves. High volume breakouts are more reliable than low volume ones.",
                                                        "Never risk more than 1-2% of your account on a single trade. This ensures you survive losing streaks.",
                                                        "Target risk/reward ratios of 2:1 or better. If risking $100, aim to make $200+.",
                                                        "Don't chase FOMO trades. Stocks up 20%+ in a day often pullback. Wait for better entries.",
                                                        "Keep a trading journal. Document every trade: entry, exit, reasoning, and emotions.",
                                                        "Paper trade for at least 3 months before risking real money. Master the strategy first.",
                                                        "Support and resistance levels from higher timeframes (daily/weekly) are more significant.",
                                                        "When support breaks, it becomes resistance. When resistance breaks, it becomes support.",
                                                        "Cut losses quickly, let winners run. Most traders do the opposite and lose money.",
                                                        "Avoid trading immediately after major news events. Wait 15-30 minutes for volatility to settle.",
                                                        "The trend is your friend until it ends. Trade with the trend, not against it.",
                                                        "Your psychology is 80% of trading success. Control fear, greed, and FOMO to succeed.",
                                                        "Diversify your trades. Don't put all your capital into one stock or sector."
                                                    ];
                                                    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
                                                    return tips[dayOfYear % tips.length];
                                                })()}
                                            </p>
                                            <div className="flex items-center gap-2 text-sm text-gray-200/90">
                                                <span className="text-lg"></span>
                                                <span className="font-semibold italic">New AI-curated tip every day to sharpen your edge</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Enhanced Progress Dashboard */}
                                {learningProgress.completedLessons.length > 0 && (
                                    <div className="relative bg-gradient-to-br from-cyan-900/50 via-blue-900/50 to-cyan-900/50 backdrop-blur-2xl rounded-2xl p-8 border border-gray-800 shadow-2xl overflow-hidden" style={{boxShadow: '0 0 40px rgba(6, 182, 212, 0.2)'}}>
                                        {/* Animated Background */}
                                        <div className="absolute inset-0 opacity-20">
                                            <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/30 via-blue-500/30 to-cyan-500/30 animate-pulse"></div>
                                        </div>

                                        <div className="flex items-center justify-between mb-8">
                                            <div className="flex items-center gap-5">
                                                <div className="relative">
                                                    <div className="text-6xl"></div>
                                                    <div className="absolute -top-1 -right-1 bg-gradient-to-r from-cyan-400 to-blue-400 rounded-full w-6 h-6 flex items-center justify-center border-2 border-cyan-900 animate-bounce">
                                                        <span className="text-xs"></span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-1">
                                                        Your Journey
                                                    </h3>
                                                    <p className="text-lg text-gray-200 font-semibold">Keep crushing it and level up! </p>
                                                </div>
                                            </div>
                                            {/* Level Badge */}
                                            <div className="flex flex-col items-center">
                                                {(() => {
                                                    const level = Math.floor(learningProgress.totalXP / 100) + 1;
                                                    const xpForNextLevel = level * 100;
                                                    const xpProgress = ((learningProgress.totalXP % 100) / 100) * 100;
                                                    const levelTitles = {
                                                        1: 'Beginner',
                                                        2: 'Learner',
                                                        3: 'Student',
                                                        4: 'Trader',
                                                        5: 'Skilled',
                                                        6: 'Advanced',
                                                        7: 'Expert',
                                                        8: 'Master',
                                                        9: 'Elite',
                                                        10: 'Legend'
                                                    };
                                                    const levelColors = {
                                                        1: 'from-gray-500 to-gray-600',
                                                        2: 'from-green-500 to-green-600',
                                                        3: 'from-blue-500 to-blue-600',
                                                        4: 'from-purple-500 to-purple-600',
                                                        5: 'from-pink-500 to-pink-600',
                                                        6: 'from-orange-500 to-red-600',
                                                        7: 'from-yellow-500 to-orange-600',
                                                        8: 'from-cyan-500 to-blue-600',
                                                        9: 'from-purple-600 to-pink-600',
                                                        10: 'from-yellow-400 to-yellow-600'
                                                    };
                                                    return (
                                                        <div className="relative">
                                                            <div className={`bg-gradient-to-br ${levelColors[Math.min(level, 10)]} rounded-2xl p-4 border-4 border-yellow-400/50 shadow-2xl min-w-[120px] text-center`}>
                                                                <div className="text-xs font-bold text-yellow-200 mb-1">LEVEL</div>
                                                                <div className="text-4xl font-black text-white mb-1">{level}</div>
                                                                <div className="text-xs font-bold text-yellow-100">{levelTitles[Math.min(level, 10)] || 'Legend'}</div>
                                                            </div>
                                                            {level < 10 && (
                                                                <div className="mt-2">
                                                                    <div className="text-xs text-center text-gray-300 mb-1">{learningProgress.totalXP % 100} / 100 XP</div>
                                                                    <div className="w-full bg-black/60 rounded-full h-2 overflow-hidden border border-gray-800">
                                                                        <div
                                                                            className="bg-gradient-to-r from-cyan-400 to-blue-500 h-full rounded-full transition-all duration-500"
                                                                            style={{ width: `${xpProgress}%` }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>

                                        {/* Progress Stats Grid */}
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                            <div className="bg-black/40 rounded-xl p-4 border border-gray-800">
                                                <div className="text-sm text-gray-300 mb-1">Lessons Completed</div>
                                                <div className="text-3xl font-black text-cyan-400">
                                                    {learningProgress.completedLessons.length} / 6
                                                </div>
                                            </div>
                                            <div className="bg-black/40 rounded-xl p-4 border border-gray-800">
                                                <div className="text-sm text-green-300 mb-1">Total XP</div>
                                                <div className="text-3xl font-black text-green-400">
                                                    {learningProgress.totalXP}
                                                </div>
                                            </div>
                                            <div className="bg-black/40 rounded-xl p-4 border border-gray-800">
                                                <div className="text-sm text-gray-300 mb-1">Achievements</div>
                                                <div className="text-3xl font-black text-purple-400">
                                                    {learningProgress.achievements.length}
                                                </div>
                                            </div>
                                            <div className="bg-black/40 rounded-xl p-4 border border-gray-800">
                                                <div className="text-sm text-orange-300 mb-1">Current Streak</div>
                                                <div className="text-3xl font-black text-orange-400">
                                                    {learningProgress.streak} 
                                                </div>
                                            </div>
                                        </div>

                                        {/* Progress Bar */}
                                        <div className="mb-4">
                                            <div className="flex justify-between text-sm text-gray-400 mb-2">
                                                <span>Overall Progress</span>
                                                <span>{Math.round((learningProgress.completedLessons.length / 6) * 100)}%</span>
                                            </div>
                                            <div className="w-full bg-black/40 rounded-full h-4 overflow-hidden border border-gray-800">
                                                <div
                                                    className="bg-gradient-to-r from-purple-500 via-cyan-500 to-green-500 h-full rounded-full transition-all duration-500"
                                                    style={{ width: `${(learningProgress.completedLessons.length / 6) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>

                                        {/* Achievements */}
                                        {learningProgress.achievements.length > 0 && (
                                            <div className="bg-black/40 rounded-xl p-4 border-2 border-yellow-500/30">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <span className="text-2xl"></span>
                                                    <span className="text-lg font-bold text-yellow-300">Achievements Unlocked</span>
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    {learningProgress.achievements.includes('first_lesson') && (
                                                        <div className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 border-2 border-green-400 rounded-lg px-4 py-2">
                                                            <div className="text-2xl mb-1"></div>
                                                            <div className="text-xs font-bold text-green-300">First Lesson</div>
                                                        </div>
                                                    )}
                                                    {learningProgress.achievements.includes('perfect_score') && (
                                                        <div className="bg-gradient-to-br from-yellow-900/40 to-orange-900/40 border-2 border-yellow-400 rounded-lg px-4 py-2">
                                                            <div className="text-2xl mb-1"></div>
                                                            <div className="text-xs font-bold text-yellow-300">Perfect Score</div>
                                                        </div>
                                                    )}
                                                    {learningProgress.achievements.includes('all_complete') && (
                                                        <div className="bg-gradient-to-br from-purple-900/40 to-pink-900/40 border-2 border-purple-400 rounded-lg px-4 py-2">
                                                            <div className="text-2xl mb-1"></div>
                                                            <div className="text-xs font-bold text-gray-300">All Complete</div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                        {/* Certificate Button - Only shown when all 6 lessons complete */}
                                        {learningProgress.completedLessons.length === 6 && (
                                            <div className="mt-6">
                                                <button
                                                    onClick={() => setShowCertificate(true)}
                                                    className="w-full bg-gradient-to-r from-yellow-500 via-yellow-400 to-yellow-600 hover:from-yellow-600 hover:via-yellow-500 hover:to-yellow-700 text-black font-black text-xl py-6 px-8 rounded-xl shadow-2xl transform  transition-all border-4 border-yellow-300"
                                                >
                                                    <div className="flex items-center justify-center gap-3">
                                                        <span className="text-4xl"></span>
                                                        <span>Download Your Certificate</span>
                                                    </div>
                                                    <div className="text-sm font-semibold mt-2 opacity-90">
                                                        Congratulations on completing all lessons!
                                                    </div>
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Premium Learning Paths Grid */}
                                <div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <h3 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300">
                                            Learning Paths
                                        </h3>
                                        <div className="flex-1 h-1 bg-gradient-to-r from-cyan-500/50 to-transparent rounded-full"></div>
                                        <span className="bg-cyan-500/30 text-gray-200 px-4 py-1 rounded-full font-bold text-sm border border-cyan-400/50">
                                            6 Modules
                                        </span>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {/* Basics - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('basics')}
                                            className={`group relative bg-gradient-to-br from-green-900/60 to-emerald-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('basics')
                                                    ? 'border-green-400 shadow-2xl'
                                                    : 'border-green-500/40 hover:border-gray-700 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('basics') ? '0 0 40px rgba(34, 197, 94, 0.4)' : '0 0 20px rgba(34, 197, 94, 0.2)'}}
                                        >
                                            {/* Shine Effect */}
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {/* Completion Badge */}
                                            {learningProgress.completedLessons.includes('basics') && (
                                                <div className="absolute top-4 right-4 bg-emerald-500 hover:bg-emerald-400 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-green-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            {/* Module Number Badge */}
                                            <div className="absolute top-4 left-4 bg-green-500/30 text-green-200 px-3 py-1 rounded-full font-black text-xs border border-green-400/50">
                                                MODULE 1
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-300 mb-3">
                                                    Trading Basics
                                                </h3>
                                                <p className="text-green-100 mb-5 leading-relaxed">Learn stock fundamentals, market hours, order types, and chart reading essentials.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-green-200">
                                                        <span className="text-green-400"></span>
                                                        <span>What are stocks?</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-green-200">
                                                        <span className="text-green-400"></span>
                                                        <span>Market hours & order types</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-green-200">
                                                        <span className="text-green-400"></span>
                                                        <span>Reading candlestick charts</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-green-200">
                                                        <span className="text-green-400"></span>
                                                        <span>Bids, asks, and spreads</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('basics') ? (
                                                    <div className="bg-green-500/20 rounded-xl p-3 border border-green-400/50">
                                                        <div className="flex items-center gap-2 text-green-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.basics && (
                                                            <div className="text-sm text-green-200">
                                                                Quiz Score: {learningProgress.quizScores.basics}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-green-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>

                                        {/* Strategies - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('strategies')}
                                            className={`group relative bg-gradient-to-br from-cyan-900/60 to-blue-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('strategies')
                                                    ? 'border-cyan-400 shadow-2xl'
                                                    : 'border-cyan-500/40 hover:border-gray-700 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('strategies') ? '0 0 40px rgba(6, 182, 212, 0.4)' : '0 0 20px rgba(6, 182, 212, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {learningProgress.completedLessons.includes('strategies') && (
                                                <div className="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-cyan-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            <div className="absolute top-4 left-4 bg-cyan-500/30 text-gray-200 px-3 py-1 rounded-full font-black text-xs border border-cyan-400/50">
                                                MODULE 2
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-300 mb-3">
                                                    Entry & Exit Strategies
                                                </h3>
                                                <p className="text-cyan-100 mb-5 leading-relaxed">Master when to buy and sell for maximum profit potential.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-gray-200">
                                                        <span className="text-cyan-400"></span>
                                                        <span>Breakout entries</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-gray-200">
                                                        <span className="text-cyan-400"></span>
                                                        <span>Profit targets & stop-losses</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-gray-200">
                                                        <span className="text-cyan-400"></span>
                                                        <span>Day trading vs swing trading</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-gray-200">
                                                        <span className="text-cyan-400"></span>
                                                        <span>Trend following techniques</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('strategies') ? (
                                                    <div className="bg-cyan-500/20 rounded-xl p-3 border border-cyan-400/50">
                                                        <div className="flex items-center gap-2 text-gray-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.strategies && (
                                                            <div className="text-sm text-gray-200">
                                                                Quiz Score: {learningProgress.quizScores.strategies}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-gray-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>

                                        {/* Risk Management - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('risk')}
                                            className={`group relative bg-gradient-to-br from-orange-900/60 to-red-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('risk')
                                                    ? 'border-orange-400 shadow-2xl'
                                                    : 'border-orange-500/40 hover:border-orange-400 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('risk') ? '0 0 40px rgba(251, 146, 60, 0.4)' : '0 0 20px rgba(251, 146, 60, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {learningProgress.completedLessons.includes('risk') && (
                                                <div className="absolute top-4 right-4 bg-gradient-to-r from-orange-500 to-red-500 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-orange-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            <div className="absolute top-4 left-4 bg-orange-500/30 text-orange-200 px-3 py-1 rounded-full font-black text-xs border border-orange-400/50">
                                                MODULE 3
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-300 to-red-300 mb-3">
                                                    Risk Management
                                                </h3>
                                                <p className="text-orange-100 mb-5 leading-relaxed">Protect your capital with proper position sizing and risk controls.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-orange-200">
                                                        <span className="text-orange-400"></span>
                                                        <span>Risk 1-2% per trade rule</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-orange-200">
                                                        <span className="text-orange-400"></span>
                                                        <span>Position sizing formula</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-orange-200">
                                                        <span className="text-orange-400"></span>
                                                        <span>Stop-loss placement</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-orange-200">
                                                        <span className="text-orange-400"></span>
                                                        <span>Risk/reward ratios</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('risk') ? (
                                                    <div className="bg-orange-500/20 rounded-xl p-3 border border-orange-400/50">
                                                        <div className="flex items-center gap-2 text-orange-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.risk && (
                                                            <div className="text-sm text-orange-200">
                                                                Quiz Score: {learningProgress.quizScores.risk}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-orange-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>

                                        {/* Calculators - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('calculators')}
                                            className={`group relative bg-gradient-to-br from-teal-900/60 to-emerald-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('calculators')
                                                    ? 'border-teal-400 shadow-2xl'
                                                    : 'border-teal-500/40 hover:border-teal-400 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('calculators') ? '0 0 40px rgba(20, 184, 166, 0.4)' : '0 0 20px rgba(20, 184, 166, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {learningProgress.completedLessons.includes('calculators') && (
                                                <div className="absolute top-4 right-4 bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-teal-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            <div className="absolute top-4 left-4 bg-teal-500/30 text-teal-200 px-3 py-1 rounded-full font-black text-xs border border-teal-400/50">
                                                MODULE 4
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-emerald-300 mb-3">
                                                    Trading Calculators
                                                </h3>
                                                <p className="text-teal-100 mb-5 leading-relaxed">Essential tools to calculate position sizes, P&L, and risk metrics.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-teal-200">
                                                        <span className="text-teal-400"></span>
                                                        <span>Position size calculator</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-teal-200">
                                                        <span className="text-teal-400"></span>
                                                        <span>Profit/loss calculator</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-teal-200">
                                                        <span className="text-teal-400"></span>
                                                        <span>Risk/reward calculator</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-teal-200">
                                                        <span className="text-teal-400"></span>
                                                        <span>Interactive & instant results</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('calculators') ? (
                                                    <div className="bg-teal-500/20 rounded-xl p-3 border border-teal-400/50">
                                                        <div className="flex items-center gap-2 text-teal-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.calculators && (
                                                            <div className="text-sm text-teal-200">
                                                                Quiz Score: {learningProgress.quizScores.calculators}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-teal-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>

                                        {/* Chart Patterns - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('patterns')}
                                            className={`group relative bg-gradient-to-br from-indigo-900/60 to-purple-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('patterns')
                                                    ? 'border-indigo-400 shadow-2xl'
                                                    : 'border-indigo-500/40 hover:border-indigo-400 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('patterns') ? '0 0 40px rgba(99, 102, 241, 0.4)' : '0 0 20px rgba(99, 102, 241, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {learningProgress.completedLessons.includes('patterns') && (
                                                <div className="absolute top-4 right-4 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-indigo-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            <div className="absolute top-4 left-4 bg-indigo-500/30 text-indigo-200 px-3 py-1 rounded-full font-black text-xs border border-indigo-400/50">
                                                MODULE 5
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300 mb-3">
                                                    Chart Patterns
                                                </h3>
                                                <p className="text-indigo-100 mb-5 leading-relaxed">Identify bullish and bearish patterns to predict price movements.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-indigo-200">
                                                        <span className="text-indigo-400"></span>
                                                        <span>Bull & bear flags</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-indigo-200">
                                                        <span className="text-indigo-400"></span>
                                                        <span>Double tops & bottoms</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-indigo-200">
                                                        <span className="text-indigo-400"></span>
                                                        <span>Head & shoulders</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-indigo-200">
                                                        <span className="text-indigo-400"></span>
                                                        <span>Cup & handle patterns</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('patterns') ? (
                                                    <div className="bg-indigo-500/20 rounded-xl p-3 border border-indigo-400/50">
                                                        <div className="flex items-center gap-2 text-indigo-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.patterns && (
                                                            <div className="text-sm text-indigo-200">
                                                                Quiz Score: {learningProgress.quizScores.patterns}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-indigo-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>

                                        {/* Case Studies - Enhanced */}
                                        <button
                                            onClick={() => setLearningTopic('cases')}
                                            className={`group relative bg-gradient-to-br from-pink-900/60 to-rose-900/60 backdrop-blur-xl rounded-2xl p-7 border-2 transition-all duration-500  hover:-translate-y-2 text-left cursor-pointer overflow-hidden ${
                                                learningProgress.completedLessons.includes('cases')
                                                    ? 'border-pink-400 shadow-2xl'
                                                    : 'border-pink-500/40 hover:border-pink-400 hover:shadow-2xl'
                                            }`}
                                            style={{boxShadow: learningProgress.completedLessons.includes('cases') ? '0 0 40px rgba(236, 72, 153, 0.4)' : '0 0 20px rgba(236, 72, 153, 0.2)'}}
                                        >
                                            <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                                            {learningProgress.completedLessons.includes('cases') && (
                                                <div className="absolute top-4 right-4 bg-gradient-to-r from-pink-500 to-rose-500 rounded-full w-12 h-12 flex items-center justify-center shadow-2xl border-2 border-pink-300 animate-bounce">
                                                    <span className="text-2xl"></span>
                                                </div>
                                            )}

                                            <div className="absolute top-4 left-4 bg-pink-500/30 text-pink-200 px-3 py-1 rounded-full font-black text-xs border border-pink-400/50">
                                                MODULE 6
                                            </div>

                                            <div className="relative z-10 mt-8">
                                                <div className="text-5xl mb-5"></div>
                                                <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-rose-300 mb-3">
                                                    Real Case Studies
                                                </h3>
                                                <p className="text-pink-100 mb-5 leading-relaxed">Learn from real winning and losing trades with detailed analysis.</p>

                                                <div className="space-y-2 mb-6">
                                                    <div className="flex items-center gap-2 text-sm text-pink-200">
                                                        <span className="text-pink-400"></span>
                                                        <span>Tesla +42% success trade</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-pink-200">
                                                        <span className="text-pink-400"></span>
                                                        <span>FOMO mistakes to avoid</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-pink-200">
                                                        <span className="text-pink-400"></span>
                                                        <span>Disciplined stop-loss examples</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-pink-200">
                                                        <span className="text-pink-400"></span>
                                                        <span>Key lessons from each trade</span>
                                                    </div>
                                                </div>

                                                {learningProgress.completedLessons.includes('cases') ? (
                                                    <div className="bg-pink-500/20 rounded-xl p-3 border border-pink-400/50">
                                                        <div className="flex items-center gap-2 text-pink-300 font-bold mb-1">
                                                            <span className="text-xl"></span>
                                                            <span>Completed!</span>
                                                        </div>
                                                        {learningProgress.quizScores.cases && (
                                                            <div className="text-sm text-pink-200">
                                                                Quiz Score: {learningProgress.quizScores.cases}%
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 text-pink-300 font-bold group-hover:gap-3 transition-all">
                                                        <span>Start Learning</span>
                                                        <span className="text-xl"></span>
                                                    </div>
                                                )}
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                {/* Chart Pattern Preview */}
                                <div className="bg-gradient-to-br from-blue-900/60 via-indigo-900/60 to-purple-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                    <div className="text-center mb-6">
                                        <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mb-4 shadow-2xl">
                                            <span className="text-3xl"></span>
                                        </div>
                                        <h3 className="text-3xl font-black text-white mb-2">Master Chart Patterns</h3>
                                        <p className="text-gray-200">Learn to identify patterns and predict price movements with precision</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div className="bg-black/40 rounded-xl p-4 border border-gray-800 hover:border-gray-700 transition-all">
                                            <div className="text-3xl mb-2"></div>
                                            <div className="text-lg font-bold text-green-300 mb-1">Bull Flag</div>
                                            <div className="text-sm text-green-200">Continuation pattern signaling upward breakout</div>
                                        </div>
                                        <div className="bg-black/40 rounded-xl p-4 border-2 border-red-500/30 hover:border-red-400 transition-all">
                                            <div className="text-3xl mb-2"></div>
                                            <div className="text-lg font-bold text-red-300 mb-1">Head & Shoulders</div>
                                            <div className="text-sm text-red-200">Bearish reversal with neckline break</div>
                                        </div>
                                        <div className="bg-black/40 rounded-xl p-4 border border-gray-800 hover:border-gray-700 transition-all">
                                            <div className="text-3xl mb-2"></div>
                                            <div className="text-lg font-bold text-green-300 mb-1">Double Bottom</div>
                                            <div className="text-sm text-green-200">W-pattern indicating trend reversal</div>
                                        </div>
                                    </div>

                                    <button
                                        onClick={() => setLearningTopic('patterns')}
                                        className="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-400 hover:to-purple-400 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg text-lg flex items-center justify-center gap-2"
                                    >
                                        <span></span>
                                        <span>View All 6 Patterns with Interactive Charts</span>
                                        <span></span>
                                    </button>
                                </div>

                                {/* Key Lessons Card */}
                                <div className="bg-gradient-to-r from-purple-900/60 via-indigo-900/60 to-blue-900/60 backdrop-blur-xl rounded-xl p-8 border border-gray-800">
                                    <div className="flex items-start gap-4">
                                        <div className="text-5xl"></div>
                                        <div className="flex-1">
                                            <h3 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-cyan-300 mb-4">
                                                Golden Rules of Trading
                                            </h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">1</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Never Risk More Than 1-2%</div>
                                                        <div className="text-gray-400 text-sm">Per trade, of your total account. This ensures you survive losing streaks.</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">2</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Always Use Stop-Losses</div>
                                                        <div className="text-gray-400 text-sm">Define your max loss before entering. Cut losses quickly, let winners run.</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">3</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Target 2:1 or 3:1 Reward/Risk</div>
                                                        <div className="text-gray-400 text-sm">If risking $100, aim to make $200-300. Good risk/reward = consistent profits.</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">4</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Never Chase FOMO Trades</div>
                                                        <div className="text-gray-400 text-sm">Don't buy stocks up 50%+ in a day. Wait for pullbacks to better entry points.</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">5</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Keep a Trading Journal</div>
                                                        <div className="text-gray-400 text-sm">Document every trade: entry, exit, reasoning, emotions. Review and improve.</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-start gap-3">
                                                    <span className="text-2xl">6</span>
                                                    <div>
                                                        <div className="text-white font-bold mb-1">Manage Your Psychology</div>
                                                        <div className="text-gray-400 text-sm">Trading is 80% mental. Control fear, greed, and FOMO to succeed long-term.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Trading Glossary Button */}
                                <div className="bg-gradient-to-r from-cyan-900/60 via-blue-900/60 to-indigo-900/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-start gap-4">
                                            <div className="text-4xl"></div>
                                            <div>
                                                <h3 className="text-xl font-black text-gray-300 mb-2">Trading Glossary</h3>
                                                <p className="text-cyan-100 text-sm">Access our comprehensive dictionary of 45+ trading terms covering market concepts, order types, technical analysis, risk management, and trading psychology.</p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => setShowGlossary(true)}
                                            className="bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg hover:shadow-cyan-500/30 whitespace-nowrap"
                                        >
                                            Open Glossary
                                        </button>
                                    </div>
                                </div>

                                {/* Disclaimer */}
                                <div className="bg-red-900/20 backdrop-blur-xl rounded-xl p-6 border-2 border-red-500/30">
                                    <div className="flex items-start gap-3">
                                        <span className="text-3xl"></span>
                                        <div>
                                            <h4 className="text-lg font-bold text-red-300 mb-2">Important Disclaimer</h4>
                                            <p className="text-red-200 text-sm leading-relaxed">
                                                <strong>This educational content is NOT financial advice.</strong> Trading stocks carries significant risk, including potential loss of all invested capital. Most day traders lose money. The strategies and examples presented are for educational purposes only and do not guarantee profits. Past performance does not indicate future results. Always do your own research, consider your risk tolerance, and consult with a licensed financial advisor before making investment decisions. Never trade with money you cannot afford to lose.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                </>
                                )}

                                {/* LESSON CONTENT - Trading Basics */}
                                {learningTopic === 'basics' && (
                                    <div className="bg-gradient-to-br from-green-900/60 via-emerald-900/60 to-teal-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                        <div className="text-center mb-8">
                                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full mb-4 shadow-2xl">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h2 className="text-4xl font-black text-white mb-2">Trading Basics</h2>
                                            <p className="text-lg text-green-200">Master the fundamentals of stock trading</p>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Lesson 1: What Are Stocks? */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-green-400 mb-4"> What Are Stocks?</h3>
                                                <div className="space-y-4 text-green-100">
                                                    <p>A <strong className="text-green-300">stock</strong> (also called a "share" or "equity") represents fractional ownership in a company. When you buy a stock, you become a partial owner of that business.</p>

                                                    <div className="bg-green-900/20 p-4 rounded-lg border-l-4 border-green-400">
                                                        <p className="font-bold text-green-300 mb-2">Why Do Companies Issue Stocks?</p>
                                                        <p>Companies sell stocks to raise capital for growth, expansion, or operations instead of taking out loans.</p>
                                                    </div>

                                                    <p className="font-bold text-green-300">Why Do Stock Prices Change?</p>
                                                    <ul className="space-y-2 ml-4">
                                                        <li> <strong>Supply & Demand:</strong> More buyers = price goes up, more sellers = price goes down</li>
                                                        <li> <strong>Company Performance:</strong> Strong earnings reports drive prices higher</li>
                                                        <li> <strong>Market Sentiment:</strong> News, economic data, and investor psychology</li>
                                                        <li> <strong>External Factors:</strong> Interest rates, inflation, geopolitical events</li>
                                                    </ul>

                                                    <div className="bg-emerald-900/20 p-4 rounded-lg border-l-4 border-emerald-400 mt-4">
                                                        <p className="font-bold text-emerald-300"> Key Concept</p>
                                                        <p>The goal of trading is to <strong>buy low and sell high</strong>. However, timing the market perfectly is extremely difficult, which is why risk management is crucial.</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Lesson 2: Market Hours & Order Types */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-green-400 mb-4"> Market Hours & Order Types</h3>
                                                <div className="space-y-4 text-green-100">
                                                    <p className="font-bold text-green-300">Regular Market Hours (EST):</p>
                                                    <ul className="space-y-2 ml-4">
                                                        <li> <strong>Pre-Market:</strong> 4:00 AM - 9:30 AM</li>
                                                        <li> <strong>Regular Hours:</strong> 9:30 AM - 4:00 PM</li>
                                                        <li> <strong>After-Hours:</strong> 4:00 PM - 8:00 PM</li>
                                                    </ul>

                                                    <p className="font-bold text-green-300 mt-6">Order Types:</p>
                                                    <div className="space-y-3">
                                                        <div className="bg-cyan-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-gray-300">Market Order</p>
                                                            <p>Executes immediately at the best available price. Guarantees execution but not price.</p>
                                                        </div>
                                                        <div className="bg-blue-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-blue-300">Limit Order</p>
                                                            <p>Executes only at your specified price or better. Guarantees price but not execution.</p>
                                                        </div>
                                                        <div className="bg-purple-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-gray-300">Stop-Loss Order</p>
                                                            <p>Automatically sells when price drops to a specified level, limiting your loss.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Lesson 3: Reading Charts */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-green-400 mb-4"> Reading Stock Charts</h3>
                                                <div className="space-y-4 text-green-100">
                                                    <p><strong className="text-green-300">Candlestick charts</strong> are the most popular way to visualize stock prices. Each candle shows:</p>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="bg-green-900/20 p-4 rounded-lg border-2 border-green-400">
                                                            <p className="font-bold text-green-300 mb-2"> Green Candle (Bullish)</p>
                                                            <ul className="space-y-1 text-sm">
                                                                <li> Opened low, closed high</li>
                                                                <li> Price went UP during period</li>
                                                                <li> Buyers won the battle</li>
                                                            </ul>
                                                        </div>
                                                        <div className="bg-red-900/20 p-4 rounded-lg border-2 border-red-400">
                                                            <p className="font-bold text-red-300 mb-2"> Red Candle (Bearish)</p>
                                                            <ul className="space-y-1 text-sm">
                                                                <li> Opened high, closed low</li>
                                                                <li> Price went DOWN during period</li>
                                                                <li> Sellers won the battle</li>
                                                            </ul>
                                                        </div>
                                                    </div>

                                                    <div className="bg-blue-900/20 p-4 rounded-lg border-l-4 border-blue-400 mt-4">
                                                        <p className="font-bold text-blue-300">Volume Matters!</p>
                                                        <p>High volume confirms strong moves. Low volume suggests weak moves that may reverse.</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Lesson 4: Support & Resistance */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-green-400 mb-4"> Support & Resistance Levels</h3>
                                                <div className="space-y-4 text-green-100">
                                                    <p><strong className="text-green-300">Support</strong> and <strong className="text-green-300">Resistance</strong> are key price levels where stock prices tend to bounce or reverse.</p>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="bg-green-900/20 p-4 rounded-lg border-2 border-green-400">
                                                            <p className="font-bold text-green-300 mb-2"> Support Level</p>
                                                            <p className="text-sm mb-2">Price level where buying pressure prevents further downward movement.</p>
                                                            <p className="text-sm text-green-200">Think of it as a "floor" - price bounces up from support.</p>
                                                            <p className="text-xs text-green-300 mt-2">Example: Stock repeatedly bounces at $50  $50 is support</p>
                                                        </div>
                                                        <div className="bg-red-900/20 p-4 rounded-lg border-2 border-red-400">
                                                            <p className="font-bold text-red-300 mb-2"> Resistance Level</p>
                                                            <p className="text-sm mb-2">Price level where selling pressure prevents further upward movement.</p>
                                                            <p className="text-sm text-red-200">Think of it as a "ceiling" - price gets rejected at resistance.</p>
                                                            <p className="text-xs text-red-300 mt-2">Example: Stock repeatedly fails at $60  $60 is resistance</p>
                                                        </div>
                                                    </div>

                                                    <div className="bg-purple-900/20 p-4 rounded-lg border-l-4 border-purple-400 mt-4">
                                                        <p className="font-bold text-gray-300 mb-2"> Role Reversal</p>
                                                        <p className="text-sm">When support breaks, it becomes resistance. When resistance breaks, it becomes support!</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Live Stock Example */}
                                            <div className="bg-gradient-to-br from-orange-900/60 via-red-900/60 to-pink-900/60 rounded-xl p-6 border border-gray-800">
                                                <div className="flex items-center gap-3 mb-4">
                                                    <span className="text-4xl"></span>
                                                    <div>
                                                        <h3 className="text-2xl font-black text-orange-300">Live Stock Example</h3>
                                                        <p className="text-orange-200 text-sm">See these concepts in action with real market data</p>
                                                    </div>
                                                </div>

                                                {!liveExampleStock ? (
                                                    <button
                                                        onClick={async () => {
                                                            try {
                                                                setLoadingLiveExample(true);
                                                                // Fetch a popular stock (AAPL) for example
                                                                const corsProxy = 'https://corsproxy.io/?';
                                                                const symbol = 'AAPL';
                                                                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=5d`;
                                                                const response = await fetch(corsProxy + encodeURIComponent(url));
                                                                const data = await response.json();

                                                                const result = data.chart.result[0];
                                                                const quote = result.indicators.quote[0];
                                                                const lastIndex = quote.close.length - 1;

                                                                const currentPrice = quote.close[lastIndex];
                                                                const high = Math.max(...quote.high.filter(v => v !== null));
                                                                const low = Math.min(...quote.low.filter(v => v !== null));
                                                                const volume = quote.volume[lastIndex];
                                                                const avgVolume = quote.volume.reduce((a, b) => a + b, 0) / quote.volume.length;

                                                                setLiveExampleStock({
                                                                    symbol,
                                                                    price: currentPrice,
                                                                    high,
                                                                    low,
                                                                    volume,
                                                                    avgVolume,
                                                                    open: quote.open[lastIndex],
                                                                    close: quote.close[lastIndex - 1]
                                                                });
                                                                setLoadingLiveExample(false);
                                                            } catch (error) {
                                                                console.error('Error fetching live example:', error);
                                                                setLoadingLiveExample(false);
                                                                alert('Could not load live stock data. Please try again.');
                                                            }
                                                        }}
                                                        className="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-400 hover:to-red-400 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg"
                                                    >
                                                        {loadingLiveExample ? ' Loading Real Stock Data...' : ' Load Live Example'}
                                                    </button>
                                                ) : (
                                                    <div className="space-y-4">
                                                        <div className="bg-black/60 rounded-xl p-6 border-2 border-orange-400">
                                                            <div className="flex justify-between items-center mb-4">
                                                                <div>
                                                                    <div className="text-3xl font-black text-white">{liveExampleStock.symbol}</div>
                                                                    <div className="text-sm text-orange-300">Real-time market data</div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-4xl font-black text-orange-400">${liveExampleStock.price.toFixed(2)}</div>
                                                                </div>
                                                            </div>

                                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                                <div className="bg-green-900/20 p-3 rounded-lg border border-gray-800">
                                                                    <div className="text-xs text-green-300 mb-1">5-Day High</div>
                                                                    <div className="text-2xl font-bold text-green-400">${liveExampleStock.high.toFixed(2)}</div>
                                                                    <div className="text-xs text-green-200 mt-1">Resistance Level</div>
                                                                </div>
                                                                <div className="bg-red-900/20 p-3 rounded-lg border border-red-500/30">
                                                                    <div className="text-xs text-red-300 mb-1">5-Day Low</div>
                                                                    <div className="text-2xl font-bold text-red-400">${liveExampleStock.low.toFixed(2)}</div>
                                                                    <div className="text-xs text-red-200 mt-1">Support Level</div>
                                                                </div>
                                                            </div>

                                                            <div className="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30 mb-4">
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <div className="text-xs text-blue-300">Today's Candlestick</div>
                                                                        <div className={`text-lg font-bold ${liveExampleStock.close > liveExampleStock.open ? 'text-green-400' : 'text-red-400'}`}>
                                                                            {liveExampleStock.close > liveExampleStock.open ? ' Bullish (Green)' : ' Bearish (Red)'}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-xs text-blue-300">Open  Close</div>
                                                                        <div className="text-sm text-white font-mono">
                                                                            ${liveExampleStock.open.toFixed(2)}  ${liveExampleStock.close.toFixed(2)}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className="bg-purple-900/20 p-3 rounded-lg border border-gray-800">
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <div className="text-xs text-gray-300">Volume Analysis</div>
                                                                        <div className="text-lg font-bold text-purple-400">
                                                                            {liveExampleStock.volume > liveExampleStock.avgVolume ? ' High Volume' : ' Low Volume'}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-xs text-gray-300">Current: {(liveExampleStock.volume / 1000000).toFixed(1)}M</div>
                                                                        <div className="text-xs text-gray-400">Avg: {(liveExampleStock.avgVolume / 1000000).toFixed(1)}M</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <button
                                                            onClick={() => setLiveExampleStock(null)}
                                                            className="w-full bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-4 py-3 rounded-xl font-bold transition-all"
                                                        >
                                                            Load Different Stock
                                                        </button>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Quiz Section - ENHANCED VERSION */}
                                            <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                                <style>{`
                                                    @keyframes confetti {
                                                        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                                                        100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
                                                    }
                                                    @keyframes pulse-glow {
                                                        0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
                                                        50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
                                                    }
                                                    @keyframes slide-in {
                                                        from { opacity: 0; transform: translateY(20px); }
                                                        to { opacity: 1; transform: translateY(0); }
                                                    }
                                                    @keyframes bounce-in {
                                                        0% { transform: scale(0.3); opacity: 0; }
                                                        50% { transform: scale(1.05); }
                                                        70% { transform: scale(0.9); }
                                                        100% { transform: scale(1); opacity: 1; }
                                                    }
                                                    .quiz-option-hover {
                                                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                                    }
                                                    .quiz-option-hover:hover:not(:disabled) {
                                                        transform: translateX(8px);
                                                        box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
                                                    }
                                                    .quiz-option-selected {
                                                        animation: pulse-glow 1s ease-in-out;
                                                    }
                                                    .quiz-question-enter {
                                                        animation: slide-in 0.5s ease-out;
                                                    }
                                                    .confetti-piece {
                                                        position: fixed;
                                                        width: 10px;
                                                        height: 10px;
                                                        background: var(--color);
                                                        animation: confetti 3s ease-out forwards;
                                                        z-index: 9999;
                                                    }
                                                    .score-animation {
                                                        animation: bounce-in 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                                                    }
                                                    .grade-badge {
                                                        display: inline-block;
                                                        padding: 8px 24px;
                                                        border-radius: 50px;
                                                        font-size: 2rem;
                                                        font-weight: 900;
                                                        animation: bounce-in 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s backwards;
                                                    }
                                                `}</style>

                                                <div className="text-center mb-6">
                                                    <div className="text-5xl mb-4"></div>
                                                    <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                    <p className="text-gray-400">Complete this quiz to check your understanding of Trading Basics</p>
                                                </div>

                                                {!quizSubmitted.basics && (
                                                    <>
                                                        {/* Progress Indicator */}
                                                        <div className="mb-8 bg-black/40 rounded-xl p-6 border-2 border-purple-400/30">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <span className="text-white font-bold text-lg">Quiz Progress</span>
                                                                <span className="text-gray-300 font-mono">
                                                                    {Object.keys(quizAnswers.basics || {}).length} / 4 answered
                                                                </span>
                                                            </div>

                                                            {/* Progress Bar */}
                                                            <div className="relative w-full h-4 bg-gray-800 rounded-full overflow-hidden mb-4">
                                                                <div
                                                                    className="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500 ease-out"
                                                                    style={{width: `${(Object.keys(quizAnswers.basics || {}).length / 4) * 100}%`}}
                                                                />
                                                                <div className="absolute inset-0 flex items-center justify-center">
                                                                    <span className="text-xs font-bold text-white drop-shadow-lg">
                                                                        {Math.round((Object.keys(quizAnswers.basics || {}).length / 4) * 100)}%
                                                                    </span>
                                                                </div>
                                                            </div>

                                                            {/* Question Status Dots */}
                                                            <div className="flex gap-3 justify-center">
                                                                {[1, 2, 3, 4].map(num => (
                                                                    <div key={num} className="flex flex-col items-center gap-2">
                                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 ${
                                                                            quizAnswers.basics?.[`q${num}`] !== undefined
                                                                                ? 'bg-gradient-to-br from-purple-500 to-blue-500 text-white scale-110 shadow-lg'
                                                                                : 'bg-gray-700 text-gray-400'
                                                                        }`}>
                                                                            {quizAnswers.basics?.[`q${num}`] !== undefined ? '' : num}
                                                                        </div>
                                                                        <span className="text-xs text-gray-400">Q{num}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        <div className="space-y-6">
                                                            {/* Question 1 */}
                                                            <div className="bg-black/40 rounded-xl p-6 border-2 border-purple-400/30 quiz-question-enter">
                                                                <div className="flex items-start gap-3 mb-4">
                                                                    <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-black text-white">
                                                                        1
                                                                    </div>
                                                                    <p className="text-xl font-bold text-white flex-1">What does owning a stock mean?</p>
                                                                </div>
                                                                <div className="space-y-3">
                                                                    {['You own a loan to the company', 'You own a fractional share of the company', 'You are lending money to investors', 'You have no ownership rights'].map((option, idx) => (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                setQuizAnswers({...quizAnswers, basics: {...(quizAnswers.basics || {}), q1: idx}});
                                                                            }}
                                                                            className={`quiz-option-hover w-full text-left p-4 rounded-lg transition-all ${
                                                                                quizAnswers.basics?.q1 === idx
                                                                                    ? 'bg-purple-900/60 border-2 border-purple-400 text-white quiz-option-selected'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className="flex items-center gap-3">
                                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                                                                    quizAnswers.basics?.q1 === idx
                                                                                        ? 'border-purple-400 bg-purple-500'
                                                                                        : 'border-gray-500'
                                                                                }`}>
                                                                                    {quizAnswers.basics?.q1 === idx && <div className="w-3 h-3 bg-white rounded-full"></div>}
                                                                                </div>
                                                                                <span>{option}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* Question 2 */}
                                                            <div className="bg-black/40 rounded-xl p-6 border-2 border-purple-400/30 quiz-question-enter" style={{animationDelay: '0.1s'}}>
                                                                <div className="flex items-start gap-3 mb-4">
                                                                    <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center font-black text-white">
                                                                        2
                                                                    </div>
                                                                    <p className="text-xl font-bold text-white flex-1">What type of order guarantees execution but not price?</p>
                                                                </div>
                                                                <div className="space-y-3">
                                                                    {['Limit Order', 'Market Order', 'Stop-Loss Order', 'Trailing Stop'].map((option, idx) => (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                setQuizAnswers({...quizAnswers, basics: {...(quizAnswers.basics || {}), q2: idx}});
                                                                            }}
                                                                            className={`quiz-option-hover w-full text-left p-4 rounded-lg transition-all ${
                                                                                quizAnswers.basics?.q2 === idx
                                                                                    ? 'bg-purple-900/60 border-2 border-purple-400 text-white quiz-option-selected'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className="flex items-center gap-3">
                                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                                                                    quizAnswers.basics?.q2 === idx
                                                                                        ? 'border-purple-400 bg-purple-500'
                                                                                        : 'border-gray-500'
                                                                                }`}>
                                                                                    {quizAnswers.basics?.q2 === idx && <div className="w-3 h-3 bg-white rounded-full"></div>}
                                                                                </div>
                                                                                <span>{option}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* Question 3 */}
                                                            <div className="bg-black/40 rounded-xl p-6 border-2 border-purple-400/30 quiz-question-enter" style={{animationDelay: '0.2s'}}>
                                                                <div className="flex items-start gap-3 mb-4">
                                                                    <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center font-black text-white">
                                                                        3
                                                                    </div>
                                                                    <p className="text-xl font-bold text-white flex-1">A green candlestick means:</p>
                                                                </div>
                                                                <div className="space-y-3">
                                                                    {['Price closed lower than it opened', 'Price closed higher than it opened', 'Volume was high', 'The stock is a good buy'].map((option, idx) => (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                setQuizAnswers({...quizAnswers, basics: {...(quizAnswers.basics || {}), q3: idx}});
                                                                            }}
                                                                            className={`quiz-option-hover w-full text-left p-4 rounded-lg transition-all ${
                                                                                quizAnswers.basics?.q3 === idx
                                                                                    ? 'bg-purple-900/60 border-2 border-purple-400 text-white quiz-option-selected'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className="flex items-center gap-3">
                                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                                                                    quizAnswers.basics?.q3 === idx
                                                                                        ? 'border-purple-400 bg-purple-500'
                                                                                        : 'border-gray-500'
                                                                                }`}>
                                                                                    {quizAnswers.basics?.q3 === idx && <div className="w-3 h-3 bg-white rounded-full"></div>}
                                                                                </div>
                                                                                <span>{option}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* Question 4 */}
                                                            <div className="bg-black/40 rounded-xl p-6 border-2 border-purple-400/30 quiz-question-enter" style={{animationDelay: '0.3s'}}>
                                                                <div className="flex items-start gap-3 mb-4">
                                                                    <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center font-black text-white">
                                                                        4
                                                                    </div>
                                                                    <p className="text-xl font-bold text-white flex-1">What happens when a support level breaks?</p>
                                                                </div>
                                                                <div className="space-y-3">
                                                                    {['It disappears completely', 'It becomes a new resistance level', 'Price always bounces back immediately', 'Volume decreases'].map((option, idx) => (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                setQuizAnswers({...quizAnswers, basics: {...(quizAnswers.basics || {}), q4: idx}});
                                                                            }}
                                                                            className={`quiz-option-hover w-full text-left p-4 rounded-lg transition-all ${
                                                                                quizAnswers.basics?.q4 === idx
                                                                                    ? 'bg-purple-900/60 border-2 border-purple-400 text-white quiz-option-selected'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className="flex items-center gap-3">
                                                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                                                                    quizAnswers.basics?.q4 === idx
                                                                                        ? 'border-purple-400 bg-purple-500'
                                                                                        : 'border-gray-500'
                                                                                }`}>
                                                                                    {quizAnswers.basics?.q4 === idx && <div className="w-3 h-3 bg-white rounded-full"></div>}
                                                                                </div>
                                                                                <span>{option}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Enhanced Submit Button */}
                                                        <div className="mt-8">
                                                            {(() => {
                                                                const allAnswered = (quizAnswers.basics?.q1 !== undefined) &&
                                                                    (quizAnswers.basics?.q2 !== undefined) &&
                                                                    (quizAnswers.basics?.q3 !== undefined) &&
                                                                    (quizAnswers.basics?.q4 !== undefined);

                                                                return (
                                                                    <button
                                                                        onClick={() => {
                                                                            if (allAnswered) {
                                                                                // Create confetti effect
                                                                                const colors = ['#a855f7', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                                                                                for (let i = 0; i < 50; i++) {
                                                                                    setTimeout(() => {
                                                                                        const confetti = document.createElement('div');
                                                                                        confetti.className = 'confetti-piece';
                                                                                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                                                                                        confetti.style.top = '0px';
                                                                                        confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                                                                                        document.body.appendChild(confetti);
                                                                                        setTimeout(() => confetti.remove(), 3000);
                                                                                    }, i * 30);
                                                                                }

                                                                                setQuizSubmitted({...quizSubmitted, basics: true});
                                                                                const score = [
                                                                                    quizAnswers.basics?.q1 === 1,
                                                                                    quizAnswers.basics?.q2 === 1,
                                                                                    quizAnswers.basics?.q3 === 1,
                                                                                    quizAnswers.basics?.q4 === 1
                                                                                ].filter(Boolean).length;
                                                                                const percentage = Math.round((score / 4) * 100);
                                                                                completeLesson('basics', percentage);
                                                                            } else {
                                                                                alert('Please answer all questions before submitting!');
                                                                            }
                                                                        }}
                                                                        disabled={!allAnswered}
                                                                        className={`w-full px-8 py-5 rounded-xl font-bold transition-all shadow-lg text-lg ${
                                                                            allAnswered
                                                                                ? 'bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white cursor-pointer transform  hover:shadow-2xl'
                                                                                : 'bg-gray-700 text-gray-400 cursor-not-allowed opacity-50'
                                                                        }`}
                                                                    >
                                                                        {allAnswered ? ' Submit Quiz' : ' Answer all questions to submit'}
                                                                    </button>
                                                                );
                                                            })()}
                                                        </div>
                                                    </>
                                                )}

                                                {/* Enhanced Results */}
                                                {quizSubmitted.basics && (() => {
                                                    const score = [
                                                        quizAnswers.basics?.q1 === 1,
                                                        quizAnswers.basics?.q2 === 1,
                                                        quizAnswers.basics?.q3 === 1,
                                                        quizAnswers.basics?.q4 === 1
                                                    ].filter(Boolean).length;
                                                    const percentage = (score / 4) * 100;
                                                    let grade = 'F';
                                                    let gradeColor = 'from-red-500 to-red-600';

                                                    if (percentage === 100) { grade = 'A+'; gradeColor = 'from-yellow-400 to-yellow-500'; }
                                                    else if (percentage >= 90) { grade = 'A'; gradeColor = 'from-green-400 to-green-500'; }
                                                    else if (percentage >= 80) { grade = 'B'; gradeColor = 'from-blue-400 to-blue-500'; }
                                                    else if (percentage >= 70) { grade = 'C'; gradeColor = 'from-purple-400 to-purple-500'; }
                                                    else if (percentage >= 60) { grade = 'D'; gradeColor = 'from-orange-400 to-orange-500'; }

                                                    return (
                                                        <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-8 text-center">
                                                            <div className="text-7xl mb-6 score-animation">
                                                                {score === 4 ? '' : score >= 3 ? '' : score >= 2 ? '' : ''}
                                                            </div>

                                                            <h4 className="text-3xl font-black text-white mb-4 score-animation">Quiz Complete!</h4>

                                                            {/* Grade Badge */}
                                                            <div className={`grade-badge bg-gradient-to-r ${gradeColor} text-white mb-6 shadow-2xl`}>
                                                                {grade}
                                                            </div>

                                                            {/* Animated Score Counter */}
                                                            <div className="mb-6">
                                                                <div className="text-6xl font-black text-white mb-2 score-animation">
                                                                    {score} / 4
                                                                </div>
                                                                <div className="text-2xl font-bold text-green-300 score-animation" style={{animationDelay: '0.2s'}}>
                                                                    {percentage}% Correct
                                                                </div>
                                                            </div>

                                                            {/* Performance Visual */}
                                                            <div className="mb-6 bg-black/40 rounded-xl p-6">
                                                                <div className="grid grid-cols-4 gap-2 mb-4">
                                                                    {[1, 2, 3, 4].map(num => {
                                                                        const isCorrect = quizAnswers.basics?.[`q${num}`] === 1;
                                                                        return (
                                                                            <div key={num} className="text-center">
                                                                                <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center text-2xl mb-2 ${
                                                                                    isCorrect ? 'bg-green-500' : 'bg-red-500'
                                                                                }`} style={{animation: `bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) ${num * 0.1}s backwards`}}>
                                                                                    {isCorrect ? '' : ''}
                                                                                </div>
                                                                                <div className="text-xs text-gray-400">Q{num}</div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>

                                                            {/* Motivational Message */}
                                                            <div className="bg-purple-900/40 border-2 border-purple-400/50 rounded-xl p-6 mb-6">
                                                                <p className="text-xl font-bold text-white mb-2">
                                                                    {score === 4 && ' Perfect Score! You\'re a Trading Master!'}
                                                                    {score === 3 && ' Excellent Work! You\'ve got this!'}
                                                                    {score === 2 && ' Good Progress! Keep studying!'}
                                                                    {score < 2 && ' Keep Learning! Practice makes perfect!'}
                                                                </p>
                                                                <p className="text-gray-400">
                                                                    {score === 4 && 'You have mastered the basics of trading. Ready for advanced topics!'}
                                                                    {score === 3 && 'You understand the fundamentals well. Review the missed question and you\'ll be perfect!'}
                                                                    {score === 2 && 'You\'re on the right track. Review the lessons and try again for a higher score.'}
                                                                    {score < 2 && 'Trading takes time to master. Review the material carefully and retake the quiz.'}
                                                                </p>
                                                            </div>

                                                            {/* Explanations */}
                                                            <div className="mt-6 space-y-4 text-left">
                                                                <div className="text-lg font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                                {quizData.basics.questions.map((q, idx) => {
                                                                    const userAnswer = quizAnswers.basics?.[`q${idx + 1}`];
                                                                    const isCorrect = userAnswer === q.correct;
                                                                    return (
                                                                        <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                            isCorrect
                                                                                ? 'bg-green-900/20 border-green-400/50'
                                                                                : 'bg-red-900/20 border-red-400/50'
                                                                        }`} style={{animation: `slide-in 0.5s ease-out ${idx * 0.1}s backwards`}}>
                                                                            <div className="flex items-start gap-2 mb-2">
                                                                                <span className="text-2xl">{isCorrect ? '' : ''}</span>
                                                                                <div className="flex-1">
                                                                                    <div className="font-bold text-white mb-1 text-lg">Question {idx + 1}</div>
                                                                                    <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                        {isCorrect ? ' Correct!' : ` Your answer: ${q.options[userAnswer]}`}
                                                                                    </div>
                                                                                    {!isCorrect && (
                                                                                        <div className="text-sm text-green-300 mt-1 font-semibold">
                                                                                             Correct answer: {q.options[q.correct]}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-300 ml-9 italic bg-black/30 p-3 rounded">
                                                                                {q.explanation}
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>

                                                            <button
                                                                onClick={() => {
                                                                    setQuizSubmitted({...quizSubmitted, basics: false});
                                                                    setQuizAnswers({...quizAnswers, basics: {}});
                                                                }}
                                                                className="mt-6 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white px-8 py-4 rounded-xl font-bold transition-all transform  shadow-lg"
                                                            >
                                                                 Retake Quiz
                                                            </button>
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* LESSON CONTENT - Strategies */}
                                {learningTopic === 'strategies' && (
                                    <div className="bg-gradient-to-br from-emerald-900/60 via-teal-900/60 to-cyan-900/60 rounded-2xl p-8 border-2 border-emerald-500/50 shadow-2xl">
                                        <div className="text-center mb-8">
                                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full mb-4 shadow-2xl">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h2 className="text-4xl font-black text-white mb-2">Entry & Exit Strategies</h2>
                                            <p className="text-lg text-emerald-200">Master timing your trades for maximum profit</p>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Entry Strategies */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-emerald-500/30">
                                                <h3 className="text-2xl font-black text-emerald-400 mb-4"> When to Enter (Buy)</h3>
                                                <div className="space-y-4 text-emerald-100">
                                                    <div className="space-y-3">
                                                        <div className="bg-green-900/20 p-4 rounded-lg border-l-4 border-green-400">
                                                            <p className="font-bold text-green-300 mb-2">1. Breakout Entry</p>
                                                            <p>Buy when price breaks above resistance with strong volume. Signals continuation of uptrend.</p>
                                                        </div>
                                                        <div className="bg-cyan-900/20 p-4 rounded-lg border-l-4 border-cyan-400">
                                                            <p className="font-bold text-gray-300 mb-2">2. Pullback Entry</p>
                                                            <p>Wait for price to dip in an uptrend, then buy near support. Better risk/reward than chasing.</p>
                                                        </div>
                                                        <div className="bg-blue-900/20 p-4 rounded-lg border-l-4 border-blue-400">
                                                            <p className="font-bold text-blue-300 mb-2">3. Support Bounce</p>
                                                            <p>Buy when price bounces off a key support level with bullish candlesticks.</p>
                                                        </div>
                                                    </div>

                                                    <div className="bg-red-900/20 p-4 rounded-lg border-l-4 border-red-400 mt-4">
                                                        <p className="font-bold text-red-300"> Never Chase!</p>
                                                        <p>Don't buy stocks already up 20-30% in a day. Wait for consolidation or pullback to a better entry.</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Exit Strategies */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-emerald-500/30">
                                                <h3 className="text-2xl font-black text-teal-400 mb-4"> When to Exit (Sell)</h3>
                                                <div className="space-y-4 text-emerald-100">
                                                    <p>Knowing when to sell is just as important as knowing when to buy.</p>

                                                    <div className="space-y-3">
                                                        <div className="bg-purple-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-gray-300 mb-2">Profit Target Exit</p>
                                                            <p>Set a predetermined price target based on technical levels. Exit when hit.</p>
                                                            <p className="text-sm mt-2 text-gray-400">Example: Buy at $100, target $110 (10% gain)</p>
                                                        </div>
                                                        <div className="bg-red-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-red-300 mb-2">Stop-Loss Exit</p>
                                                            <p>Automatically exit if price drops to your stop level. Limits losses.</p>
                                                            <p className="text-sm mt-2 text-red-200">Example: Buy at $100, stop at $97 (3% max loss)</p>
                                                        </div>
                                                        <div className="bg-green-900/20 p-4 rounded-lg">
                                                            <p className="font-bold text-green-300 mb-2">Trailing Stop</p>
                                                            <p>Stop-loss that moves up with price, locking in profits while allowing upside.</p>
                                                        </div>
                                                    </div>

                                                    <div className="bg-yellow-900/20 p-4 rounded-lg border-l-4 border-yellow-400 mt-4">
                                                        <p className="font-bold text-yellow-300"> Pro Tip</p>
                                                        <p>Cut losses quickly, let winners run. Most traders do the opposite and lose money.</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Day vs Swing Trading */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-emerald-500/30">
                                                <h3 className="text-2xl font-black text-cyan-400 mb-4"> Day Trading vs Swing Trading</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="bg-orange-900/20 p-4 rounded-lg border-2 border-orange-400">
                                                        <p className="font-bold text-orange-300 mb-3 text-xl"> Day Trading</p>
                                                        <ul className="space-y-2 text-sm text-orange-100">
                                                            <li> Enter and exit same day</li>
                                                            <li> Requires constant monitoring</li>
                                                            <li> Higher stress, more trades</li>
                                                            <li> Small profits per trade</li>
                                                            <li> Need $25k+ (PDT rule)</li>
                                                        </ul>
                                                    </div>
                                                    <div className="bg-blue-900/20 p-4 rounded-lg border-2 border-blue-400">
                                                        <p className="font-bold text-blue-300 mb-3 text-xl"> Swing Trading</p>
                                                        <ul className="space-y-2 text-sm text-blue-100">
                                                            <li> Hold for days/weeks</li>
                                                            <li> Less time intensive</li>
                                                            <li> Lower stress, fewer trades</li>
                                                            <li> Larger profits per trade</li>
                                                            <li> No minimum balance required</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Quiz Section */}
                                            <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                                <div className="text-center mb-6">
                                                    <div className="text-5xl mb-4"></div>
                                                    <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                    <p className="text-gray-400">Complete this quiz to check your understanding of Entry & Exit Strategies</p>
                                                </div>

                                                <div className="space-y-6">
                                                    {quizData.strategies.questions.map((q, qIdx) => (
                                                        <div key={qIdx} className="bg-black/40 rounded-xl p-6">
                                                            <p className="text-xl font-bold text-white mb-4">{qIdx + 1}. {q.question}</p>
                                                            <div className="space-y-3">
                                                                {q.options.map((option, idx) => (
                                                                    <button
                                                                        key={idx}
                                                                        onClick={() => {
                                                                            setQuizAnswers({...quizAnswers, strategies: {...(quizAnswers.strategies || {}), [`q${qIdx + 1}`]: idx}});
                                                                        }}
                                                                        disabled={quizSubmitted.strategies}
                                                                        className={`w-full text-left p-4 rounded-lg transition-all ${
                                                                            quizSubmitted.strategies
                                                                                ? idx === q.correct
                                                                                    ? 'bg-green-900/40 border-2 border-green-400 text-green-100'
                                                                                    : quizAnswers.strategies?.[`q${qIdx + 1}`] === idx
                                                                                        ? 'bg-red-900/40 border-2 border-red-400 text-red-100'
                                                                                        : 'bg-gray-800/40 border-2 border-gray-600 text-gray-400'
                                                                                : quizAnswers.strategies?.[`q${qIdx + 1}`] === idx
                                                                                    ? 'bg-purple-900/40 border-2 border-purple-400 text-white'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                        }`}
                                                                    >
                                                                        {option}
                                                                        {quizSubmitted.strategies && idx === q.correct && <span className="ml-2"></span>}
                                                                        {quizSubmitted.strategies && quizAnswers.strategies?.[`q${qIdx + 1}`] === idx && idx !== q.correct && <span className="ml-2"></span>}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}

                                                    {/* Submit Button */}
                                                    {!quizSubmitted.strategies && (
                                                        <button
                                                            onClick={() => {
                                                                const allAnswered = quizData.strategies.questions.every((_, idx) =>
                                                                    quizAnswers.strategies?.[`q${idx + 1}`] !== undefined
                                                                );
                                                                if (allAnswered) {
                                                                    setQuizSubmitted({...quizSubmitted, strategies: true});
                                                                    const score = quizData.strategies.questions.filter((q, idx) =>
                                                                        quizAnswers.strategies?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const percentage = Math.round((score / quizData.strategies.questions.length) * 100);
                                                                    completeLesson('strategies', percentage);
                                                                } else {
                                                                    alert('Please answer all questions before submitting!');
                                                                }
                                                            }}
                                                            className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg text-lg"
                                                        >
                                                            Submit Quiz
                                                        </button>
                                                    )}

                                                    {/* Results */}
                                                    {quizSubmitted.strategies && (
                                                        <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-6 text-center">
                                                            <div className="text-5xl mb-4">
                                                                {(() => {
                                                                    const score = quizData.strategies.questions.filter((q, idx) =>
                                                                        quizAnswers.strategies?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const total = quizData.strategies.questions.length;
                                                                    return score === total ? '' : score >= total * 0.75 ? '' : score >= total * 0.5 ? '' : '';
                                                                })()}
                                                            </div>
                                                            <h4 className="text-2xl font-black text-white mb-2">Quiz Complete!</h4>
                                                            <p className="text-xl text-green-200 mb-4">
                                                                Score: {quizData.strategies.questions.filter((q, idx) =>
                                                                    quizAnswers.strategies?.[`q${idx + 1}`] === q.correct
                                                                ).length} / {quizData.strategies.questions.length}
                                                            </p>
                                                            <p className="text-green-100">
                                                                {(() => {
                                                                    const score = quizData.strategies.questions.filter((q, idx) =>
                                                                        quizAnswers.strategies?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const total = quizData.strategies.questions.length;
                                                                    if (score === total) return 'Perfect! You have mastered entry & exit strategies! ';
                                                                    if (score >= total * 0.75) return 'Great job! You understand trading strategies well!';
                                                                    if (score >= total * 0.5) return 'Good start! Review the lessons and try again.';
                                                                    return 'Keep learning! Review the material and practice more.';
                                                                })()}
                                                            </p>

                                                            {/* Explanations */}
                                                            <div className="mt-6 space-y-4 text-left">
                                                                <div className="text-sm font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                                {quizData.strategies.questions.map((q, idx) => {
                                                                    const userAnswer = quizAnswers.strategies?.[`q${idx + 1}`];
                                                                    const isCorrect = userAnswer === q.correct;
                                                                    return (
                                                                        <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                            isCorrect
                                                                                ? 'bg-green-900/20 border-green-400/50'
                                                                                : 'bg-red-900/20 border-red-400/50'
                                                                        }`}>
                                                                            <div className="flex items-start gap-2 mb-2">
                                                                                <span className="text-lg">{isCorrect ? '' : ''}</span>
                                                                                <div className="flex-1">
                                                                                    <div className="font-bold text-white mb-1">Question {idx + 1}</div>
                                                                                    <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                        {isCorrect ? 'Correct!' : `Your answer: ${q.options[userAnswer]}`}
                                                                                    </div>
                                                                                    {!isCorrect && (
                                                                                        <div className="text-sm text-green-300 mt-1">
                                                                                            Correct answer: {q.options[q.correct]}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-300 ml-7 italic">
                                                                                {q.explanation}
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>

                                                            <button
                                                                onClick={() => {
                                                                    setQuizSubmitted({...quizSubmitted, strategies: false});
                                                                    setQuizAnswers({...quizAnswers, strategies: {}});
                                                                }}
                                                                className="mt-6 bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                            >
                                                                Retake Quiz
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* LESSON CONTENT - Risk Management */}
                                {learningTopic === 'risk' && (
                                    <div className="bg-gradient-to-br from-teal-900/60 via-cyan-900/60 to-blue-900/60 rounded-2xl p-8 border-2 border-teal-500/50 shadow-2xl">
                                        <div className="text-center mb-8">
                                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-full mb-4 shadow-2xl">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h2 className="text-4xl font-black text-white mb-2">Risk Management</h2>
                                            <p className="text-lg text-teal-200">Protect your capital and survive long-term</p>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Golden Rule */}
                                            <div className="bg-gradient-to-r from-yellow-900/40 to-orange-900/40 backdrop-blur-xl rounded-xl p-6 border-2 border-yellow-500/50">
                                                <h3 className="text-2xl font-black text-yellow-300 mb-4"> The Golden Rule</h3>
                                                <p className="text-2xl font-bold text-white mb-4">Never Risk More Than 1-2% Per Trade</p>
                                                <p className="text-yellow-100 mb-4">This is the MOST IMPORTANT rule in trading. If you risk 1% per trade, you can survive 100 losing trades in a row before your account hits zero.</p>

                                                <div className="bg-black/40 p-4 rounded-lg">
                                                    <p className="font-bold text-yellow-200 mb-2">Example:</p>
                                                    <p className="text-yellow-100">$10,000 account  1% risk = $100 max loss per trade</p>
                                                    <p className="text-yellow-100 mt-2">This means if your stop-loss is $2 away from entry, you can buy 50 shares ($100  $2).</p>
                                                </div>
                                            </div>

                                            {/* Position Sizing Formula */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-teal-500/30">
                                                <h3 className="text-2xl font-black text-teal-400 mb-4"> Position Sizing Formula</h3>
                                                <div className="bg-teal-900/20 p-6 rounded-lg border-2 border-teal-400 text-center">
                                                    <p className="text-sm text-teal-200 mb-2">Shares to Buy =</p>
                                                    <p className="text-2xl font-bold text-white mb-4">(Account Size  Risk %)  (Entry Price - Stop Loss)</p>
                                                    <div className="bg-black/40 p-4 rounded-lg mt-4 text-left">
                                                        <p className="font-bold text-teal-300 mb-2">Example Calculation:</p>
                                                        <p className="text-teal-100"> Account: $10,000</p>
                                                        <p className="text-teal-100"> Risk: 1% = $100</p>
                                                        <p className="text-teal-100"> Entry: $50</p>
                                                        <p className="text-teal-100"> Stop: $48</p>
                                                        <p className="text-teal-100"> Risk per share: $2</p>
                                                        <p className="font-bold text-green-300 mt-2"> Shares: $100  $2 = 50 shares</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Risk/Reward Ratio */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-cyan-400 mb-4"> Risk/Reward Ratio</h3>
                                                <p className="text-cyan-100 mb-4">Always target at least <strong className="text-gray-300">2:1 or 3:1 reward vs risk</strong>. This means if you risk $100, aim to make $200-300.</p>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="bg-red-900/20 p-4 rounded-lg border-l-4 border-red-400">
                                                        <p className="font-bold text-red-300 mb-2"> Bad Trade (1:1)</p>
                                                        <p className="text-red-100">Risk: $100 | Reward: $100</p>
                                                        <p className="text-sm text-red-200 mt-2">You need to win 50%+ to profit</p>
                                                    </div>
                                                    <div className="bg-green-900/20 p-4 rounded-lg border-l-4 border-green-400">
                                                        <p className="font-bold text-green-300 mb-2"> Good Trade (3:1)</p>
                                                        <p className="text-green-100">Risk: $100 | Reward: $300</p>
                                                        <p className="text-sm text-green-200 mt-2">You only need to win 25%+ to profit</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Common Mistakes */}
                                            <div className="bg-red-900/20 backdrop-blur-xl rounded-xl p-6 border-2 border-red-500/50">
                                                <h3 className="text-2xl font-black text-red-300 mb-4"> Mistakes That Blow Up Accounts</h3>
                                                <ul className="space-y-3 text-red-100">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-2xl"></span>
                                                        <div>
                                                            <strong className="text-red-200">Risking 10-20% per trade</strong>
                                                            <p className="text-sm">One bad streak and your account is destroyed</p>
                                                        </div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-2xl"></span>
                                                        <div>
                                                            <strong className="text-red-200">No stop-losses, just "hoping"</strong>
                                                            <p className="text-sm">Hope is not a strategy. Cut losses quickly.</p>
                                                        </div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-2xl"></span>
                                                        <div>
                                                            <strong className="text-red-200">Revenge trading after losses</strong>
                                                            <p className="text-sm">Trying to "make it back quickly" leads to bigger losses</p>
                                                        </div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-2xl"></span>
                                                        <div>
                                                            <strong className="text-red-200">Averaging down on losers</strong>
                                                            <p className="text-sm">Throwing good money after bad. Just cut the loss.</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>

                                            {/* Quiz Section */}
                                            <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                                <div className="text-center mb-6">
                                                    <div className="text-5xl mb-4"></div>
                                                    <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                    <p className="text-gray-400">Complete this quiz to check your understanding of Risk Management</p>
                                                </div>

                                                <div className="space-y-6">
                                                    {quizData.risk.questions.map((q, qIdx) => (
                                                        <div key={qIdx} className="bg-black/40 rounded-xl p-6">
                                                            <p className="text-xl font-bold text-white mb-4">{qIdx + 1}. {q.question}</p>
                                                            <div className="space-y-3">
                                                                {q.options.map((option, idx) => (
                                                                    <button
                                                                        key={idx}
                                                                        onClick={() => {
                                                                            setQuizAnswers({...quizAnswers, risk: {...(quizAnswers.risk || {}), [`q${qIdx + 1}`]: idx}});
                                                                        }}
                                                                        disabled={quizSubmitted.risk}
                                                                        className={`w-full text-left p-4 rounded-lg transition-all ${
                                                                            quizSubmitted.risk
                                                                                ? idx === q.correct
                                                                                    ? 'bg-green-900/40 border-2 border-green-400 text-green-100'
                                                                                    : quizAnswers.risk?.[`q${qIdx + 1}`] === idx
                                                                                        ? 'bg-red-900/40 border-2 border-red-400 text-red-100'
                                                                                        : 'bg-gray-800/40 border-2 border-gray-600 text-gray-400'
                                                                                : quizAnswers.risk?.[`q${qIdx + 1}`] === idx
                                                                                    ? 'bg-purple-900/40 border-2 border-purple-400 text-white'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                        }`}
                                                                    >
                                                                        {option}
                                                                        {quizSubmitted.risk && idx === q.correct && <span className="ml-2"></span>}
                                                                        {quizSubmitted.risk && quizAnswers.risk?.[`q${qIdx + 1}`] === idx && idx !== q.correct && <span className="ml-2"></span>}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}

                                                    {/* Submit Button */}
                                                    {!quizSubmitted.risk && (
                                                        <button
                                                            onClick={() => {
                                                                const allAnswered = quizData.risk.questions.every((_, idx) =>
                                                                    quizAnswers.risk?.[`q${idx + 1}`] !== undefined
                                                                );
                                                                if (allAnswered) {
                                                                    setQuizSubmitted({...quizSubmitted, risk: true});
                                                                    const score = quizData.risk.questions.filter((q, idx) =>
                                                                        quizAnswers.risk?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const percentage = Math.round((score / quizData.risk.questions.length) * 100);
                                                                    completeLesson('risk', percentage);
                                                                } else {
                                                                    alert('Please answer all questions before submitting!');
                                                                }
                                                            }}
                                                            className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg text-lg"
                                                        >
                                                            Submit Quiz
                                                        </button>
                                                    )}

                                                    {/* Results */}
                                                    {quizSubmitted.risk && (
                                                        <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-6 text-center">
                                                            <div className="text-5xl mb-4">
                                                                {(() => {
                                                                    const score = quizData.risk.questions.filter((q, idx) =>
                                                                        quizAnswers.risk?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const total = quizData.risk.questions.length;
                                                                    return score === total ? '' : score >= total * 0.75 ? '' : score >= total * 0.5 ? '' : '';
                                                                })()}
                                                            </div>
                                                            <h4 className="text-2xl font-black text-white mb-2">Quiz Complete!</h4>
                                                            <p className="text-xl text-green-200 mb-4">
                                                                Score: {quizData.risk.questions.filter((q, idx) =>
                                                                    quizAnswers.risk?.[`q${idx + 1}`] === q.correct
                                                                ).length} / {quizData.risk.questions.length}
                                                            </p>
                                                            <p className="text-green-100">
                                                                {(() => {
                                                                    const score = quizData.risk.questions.filter((q, idx) =>
                                                                        quizAnswers.risk?.[`q${idx + 1}`] === q.correct
                                                                    ).length;
                                                                    const total = quizData.risk.questions.length;
                                                                    if (score === total) return 'Perfect! You have mastered risk management! ';
                                                                    if (score >= total * 0.75) return 'Great job! You understand risk management well!';
                                                                    if (score >= total * 0.5) return 'Good start! Review the lessons and try again.';
                                                                    return 'Keep learning! Review the material and practice more.';
                                                                })()}
                                                            </p>

                                                            {/* Explanations */}
                                                            <div className="mt-6 space-y-4 text-left">
                                                                <div className="text-sm font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                                {quizData.risk.questions.map((q, idx) => {
                                                                    const userAnswer = quizAnswers.risk?.[`q${idx + 1}`];
                                                                    const isCorrect = userAnswer === q.correct;
                                                                    return (
                                                                        <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                            isCorrect
                                                                                ? 'bg-green-900/20 border-green-400/50'
                                                                                : 'bg-red-900/20 border-red-400/50'
                                                                        }`}>
                                                                            <div className="flex items-start gap-2 mb-2">
                                                                                <span className="text-lg">{isCorrect ? '' : ''}</span>
                                                                                <div className="flex-1">
                                                                                    <div className="font-bold text-white mb-1">Question {idx + 1}</div>
                                                                                    <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                        {isCorrect ? 'Correct!' : `Your answer: ${q.options[userAnswer]}`}
                                                                                    </div>
                                                                                    {!isCorrect && (
                                                                                        <div className="text-sm text-green-300 mt-1">
                                                                                            Correct answer: {q.options[q.correct]}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-300 ml-7 italic">
                                                                                {q.explanation}
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>

                                                            <button
                                                                onClick={() => {
                                                                    setQuizSubmitted({...quizSubmitted, risk: false});
                                                                    setQuizAnswers({...quizAnswers, risk: {}});
                                                                }}
                                                                className="mt-6 bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                            >
                                                                Retake Quiz
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* LESSON CONTENT - Calculators */}
                                {learningTopic === 'calculators' && (
                                    <div className="bg-gradient-to-br from-cyan-900/60 via-blue-900/60 to-indigo-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                        <div className="text-center mb-8">
                                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full mb-4 shadow-2xl">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h2 className="text-4xl font-black text-white mb-2">Trading Calculators</h2>
                                            <p className="text-lg text-gray-200">Essential tools for calculating position sizes, P&L, and risk metrics</p>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Position Size Calculator */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-cyan-400 mb-4"> Position Size Calculator</h3>
                                                <p className="text-cyan-100 mb-6">Calculate how many shares to buy based on your risk tolerance and stop-loss distance.</p>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Account Size ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pos-account"
                                                            defaultValue="10000"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-cyan-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Risk Per Trade (%)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pos-risk"
                                                            defaultValue="1"
                                                            step="0.1"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-cyan-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Entry Price ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pos-entry"
                                                            defaultValue="100"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-cyan-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Stop Loss ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pos-stop"
                                                            defaultValue="98"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-cyan-400 focus:outline-none"
                                                        />
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        const account = parseFloat(document.getElementById('calc-pos-account').value);
                                                        const risk = parseFloat(document.getElementById('calc-pos-risk').value);
                                                        const entry = parseFloat(document.getElementById('calc-pos-entry').value);
                                                        const stop = parseFloat(document.getElementById('calc-pos-stop').value);
                                                        const riskAmount = account * (risk / 100);
                                                        const priceRisk = Math.abs(entry - stop);
                                                        const shares = Math.floor(riskAmount / priceRisk);
                                                        const investment = shares * entry;
                                                        document.getElementById('calc-pos-result').innerHTML = `
                                                            <div class="text-center">
                                                                <div class="text-sm text-gray-300 mb-2">Shares to Buy:</div>
                                                                <div class="text-5xl font-black text-cyan-400 mb-4">${shares}</div>
                                                                <div class="grid grid-cols-2 gap-4 text-left bg-black/40 p-4 rounded-lg">
                                                                    <div><span class="text-gray-300">Risk Amount:</span> <span class="text-white font-bold">$${riskAmount.toFixed(2)}</span></div>
                                                                    <div><span class="text-gray-300">Price Risk:</span> <span class="text-white font-bold">$${priceRisk.toFixed(2)}</span></div>
                                                                    <div><span class="text-gray-300">Total Investment:</span> <span class="text-white font-bold">$${investment.toFixed(2)}</span></div>
                                                                    <div><span class="text-gray-300">% of Account:</span> <span class="text-white font-bold">${((investment/account)*100).toFixed(1)}%</span></div>
                                                                </div>
                                                            </div>
                                                        `;
                                                        document.getElementById('calc-pos-result').style.display = 'block';
                                                    }}
                                                    className="w-full mt-4 bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg"
                                                >
                                                    Calculate Position Size
                                                </button>

                                                <div id="calc-pos-result" className="mt-4 bg-cyan-900/20 border-2 border-cyan-400 rounded-xl p-6 hidden"></div>
                                            </div>

                                            {/* P&L Calculator */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-blue-400 mb-4"> Profit/Loss Calculator</h3>
                                                <p className="text-blue-100 mb-6">Calculate your profit or loss and percentage return on a trade.</p>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-blue-300 mb-2">Shares</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pnl-shares"
                                                            defaultValue="100"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-blue-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-blue-300 mb-2">Entry Price ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pnl-entry"
                                                            defaultValue="100"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-blue-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-blue-300 mb-2">Exit Price ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-pnl-exit"
                                                            defaultValue="105"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-blue-400 focus:outline-none"
                                                        />
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        const shares = parseFloat(document.getElementById('calc-pnl-shares').value);
                                                        const entry = parseFloat(document.getElementById('calc-pnl-entry').value);
                                                        const exit = parseFloat(document.getElementById('calc-pnl-exit').value);
                                                        const pnl = (exit - entry) * shares;
                                                        const returnPct = ((exit - entry) / entry) * 100;
                                                        const color = pnl >= 0 ? 'green' : 'red';
                                                        const emoji = pnl >= 0 ? '' : '';
                                                        document.getElementById('calc-pnl-result').innerHTML = `
                                                            <div class="text-center">
                                                                <div class="text-6xl mb-4">${emoji}</div>
                                                                <div class="text-sm text-${color}-300 mb-2">Profit/Loss:</div>
                                                                <div class="text-5xl font-black text-${color}-400 mb-2">$${pnl.toFixed(2)}</div>
                                                                <div class="text-2xl font-bold text-${color}-300">${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%</div>
                                                            </div>
                                                        `;
                                                        document.getElementById('calc-pnl-result').style.display = 'block';
                                                    }}
                                                    className="w-full mt-4 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-400 hover:to-indigo-400 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg"
                                                >
                                                    Calculate P&L
                                                </button>

                                                <div id="calc-pnl-result" className="mt-4 bg-blue-900/20 border-2 border-blue-400 rounded-xl p-6 hidden"></div>
                                            </div>

                                            {/* Risk/Reward Calculator */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-purple-400 mb-4"> Risk/Reward Calculator</h3>
                                                <p className="text-purple-100 mb-6">Calculate your risk/reward ratio to ensure good trade setups (aim for 2:1 or better).</p>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Entry Price ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-rr-entry"
                                                            defaultValue="100"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-purple-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Stop Loss ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-rr-stop"
                                                            defaultValue="98"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-purple-400 focus:outline-none"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-300 mb-2">Target Price ($)</label>
                                                        <input
                                                            type="number"
                                                            id="calc-rr-target"
                                                            defaultValue="106"
                                                            step="0.01"
                                                            className="w-full bg-gray-900/60 border border-gray-800 rounded-lg px-4 py-3 text-white font-mono focus:border-purple-400 focus:outline-none"
                                                        />
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        const entry = parseFloat(document.getElementById('calc-rr-entry').value);
                                                        const stop = parseFloat(document.getElementById('calc-rr-stop').value);
                                                        const target = parseFloat(document.getElementById('calc-rr-target').value);
                                                        const risk = Math.abs(entry - stop);
                                                        const reward = Math.abs(target - entry);
                                                        const ratio = (reward / risk).toFixed(2);
                                                        const isGood = ratio >= 2;
                                                        const color = isGood ? 'green' : 'red';
                                                        const message = isGood ? ' Good Trade Setup!' : ' Poor Risk/Reward - Aim for 2:1 or better';
                                                        document.getElementById('calc-rr-result').innerHTML = `
                                                            <div class="text-center">
                                                                <div class="grid grid-cols-2 gap-4 mb-6">
                                                                    <div class="bg-red-900/20 p-4 rounded-lg border-2 border-red-400">
                                                                        <div class="text-sm text-red-300 mb-1">Risk</div>
                                                                        <div class="text-3xl font-black text-red-400">$${risk.toFixed(2)}</div>
                                                                    </div>
                                                                    <div class="bg-green-900/20 p-4 rounded-lg border-2 border-green-400">
                                                                        <div class="text-sm text-green-300 mb-1">Reward</div>
                                                                        <div class="text-3xl font-black text-green-400">$${reward.toFixed(2)}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="text-sm text-${color}-300 mb-2">Risk/Reward Ratio:</div>
                                                                <div class="text-5xl font-black text-${color}-400 mb-4">1:${ratio}</div>
                                                                <div class="text-lg font-bold text-${color}-300">${message}</div>
                                                            </div>
                                                        `;
                                                        document.getElementById('calc-rr-result').style.display = 'block';
                                                    }}
                                                    className="w-full mt-4 bg-gray-700 hover:bg-gray-600 hover:from-purple-400 hover:to-pink-400 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg"
                                                >
                                                    Calculate Risk/Reward
                                                </button>

                                                <div id="calc-rr-result" className="mt-4 bg-purple-900/20 border-2 border-purple-400 rounded-xl p-6 hidden"></div>
                                            </div>
                                        </div>

                                        {/* Quiz Section */}
                                        <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                            <div className="text-center mb-6">
                                                <div className="text-5xl mb-4"></div>
                                                <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                <p className="text-gray-400">Complete this quiz to check your understanding of Trading Calculators</p>
                                            </div>

                                            <div className="space-y-6">
                                                {quizData.calculators.questions.map((q, qIdx) => (
                                                    <div key={qIdx} className="bg-black/40 rounded-xl p-6">
                                                        <p className="text-xl font-bold text-white mb-4">{qIdx + 1}. {q.question}</p>
                                                        <div className="space-y-3">
                                                            {q.options.map((option, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => {
                                                                        setQuizAnswers({...quizAnswers, calculators: {...(quizAnswers.calculators || {}), [`q${qIdx + 1}`]: idx}});
                                                                    }}
                                                                    disabled={quizSubmitted.calculators}
                                                                    className={`w-full text-left p-4 rounded-lg transition-all ${
                                                                        quizSubmitted.calculators
                                                                            ? idx === q.correct
                                                                                ? 'bg-green-900/40 border-2 border-green-400 text-green-100'
                                                                                : quizAnswers.calculators?.[`q${qIdx + 1}`] === idx
                                                                                    ? 'bg-red-900/40 border-2 border-red-400 text-red-100'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 text-gray-400'
                                                                            : quizAnswers.calculators?.[`q${qIdx + 1}`] === idx
                                                                                ? 'bg-purple-900/40 border-2 border-purple-400 text-white'
                                                                                : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                    }`}
                                                                >
                                                                    {option}
                                                                    {quizSubmitted.calculators && idx === q.correct && <span className="ml-2"></span>}
                                                                    {quizSubmitted.calculators && quizAnswers.calculators?.[`q${qIdx + 1}`] === idx && idx !== q.correct && <span className="ml-2"></span>}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}

                                                {/* Submit Button */}
                                                {!quizSubmitted.calculators && (
                                                    <button
                                                        onClick={() => {
                                                            const allAnswered = quizData.calculators.questions.every((_, idx) =>
                                                                quizAnswers.calculators?.[`q${idx + 1}`] !== undefined
                                                            );
                                                            if (allAnswered) {
                                                                setQuizSubmitted({...quizSubmitted, calculators: true});
                                                                const score = quizData.calculators.questions.filter((q, idx) =>
                                                                    quizAnswers.calculators?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const percentage = Math.round((score / quizData.calculators.questions.length) * 100);
                                                                completeLesson('calculators', percentage);
                                                            } else {
                                                                alert('Please answer all questions before submitting!');
                                                            }
                                                        }}
                                                        className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg text-lg"
                                                    >
                                                        Submit Quiz
                                                    </button>
                                                )}

                                                {/* Results */}
                                                {quizSubmitted.calculators && (
                                                    <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-6 text-center">
                                                        <div className="text-5xl mb-4">
                                                            {(() => {
                                                                const score = quizData.calculators.questions.filter((q, idx) =>
                                                                    quizAnswers.calculators?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.calculators.questions.length;
                                                                return score === total ? '' : score >= total * 0.75 ? '' : score >= total * 0.5 ? '' : '';
                                                            })()}
                                                        </div>
                                                        <h4 className="text-2xl font-black text-white mb-2">Quiz Complete!</h4>
                                                        <p className="text-xl text-green-200 mb-4">
                                                            Score: {quizData.calculators.questions.filter((q, idx) =>
                                                                quizAnswers.calculators?.[`q${idx + 1}`] === q.correct
                                                            ).length} / {quizData.calculators.questions.length}
                                                        </p>
                                                        <p className="text-green-100">
                                                            {(() => {
                                                                const score = quizData.calculators.questions.filter((q, idx) =>
                                                                    quizAnswers.calculators?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.calculators.questions.length;
                                                                if (score === total) return 'Perfect! You have mastered trading calculators! ';
                                                                if (score >= total * 0.75) return 'Great job! You understand position sizing well!';
                                                                if (score >= total * 0.5) return 'Good start! Review the lessons and try again.';
                                                                return 'Keep learning! Review the material and practice more.';
                                                            })()}
                                                        </p>

                                                        {/* Explanations */}
                                                        <div className="mt-6 space-y-4 text-left">
                                                            <div className="text-sm font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                            {quizData.calculators.questions.map((q, idx) => {
                                                                const userAnswer = quizAnswers.calculators?.[`q${idx + 1}`];
                                                                const isCorrect = userAnswer === q.correct;
                                                                return (
                                                                    <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                        isCorrect
                                                                            ? 'bg-green-900/20 border-green-400/50'
                                                                            : 'bg-red-900/20 border-red-400/50'
                                                                    }`}>
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="text-lg">{isCorrect ? '' : ''}</span>
                                                                            <div className="flex-1">
                                                                                <div className="font-bold text-white mb-1">Question {idx + 1}</div>
                                                                                <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                    {isCorrect ? 'Correct!' : `Your answer: ${q.options[userAnswer]}`}
                                                                                </div>
                                                                                {!isCorrect && (
                                                                                    <div className="text-sm text-green-300 mt-1">
                                                                                        Correct answer: {q.options[q.correct]}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <div className="text-sm text-gray-300 ml-7 italic">
                                                                            {q.explanation}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        <button
                                                            onClick={() => {
                                                                setQuizSubmitted({...quizSubmitted, calculators: false});
                                                                setQuizAnswers({...quizAnswers, calculators: {}});
                                                            }}
                                                            className="mt-6 bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                        >
                                                            Retake Quiz
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* LESSON CONTENT - Chart Patterns */}
                                {learningTopic === 'patterns' && (
                                    <div className="bg-gradient-to-br from-blue-900/60 via-indigo-900/60 to-purple-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                        <div className="text-center mb-8">
                                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mb-4 shadow-2xl">
                                                <span className="text-4xl"></span>
                                            </div>
                                            <h2 className="text-4xl font-black text-white mb-2">Chart Patterns Guide</h2>
                                            <p className="text-lg text-gray-200">Recognize patterns to predict price movements</p>
                                        </div>

                                        {/* Interactive Chart Pattern Visualizations */}
                                        <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-6 border border-gray-800 mb-8">
                                            <div className="text-center mb-6">
                                                <div className="text-4xl mb-3"></div>
                                                <h3 className="text-2xl font-black text-white mb-2">Interactive Pattern Charts</h3>
                                                <p className="text-gray-400">Real examples showing exact entry/exit points</p>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Bull Flag Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Bull Flag Pattern
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-bull-flag" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                            <span className="text-green-300">BUY: Breakout above flag at $122</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $135 (+10.7%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">STOP-LOSS: $117 (-4.1%)</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Head and Shoulders Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border-2 border-red-500/30">
                                                    <h4 className="text-xl font-bold text-red-300 mb-4 flex items-center gap-2">
                                                        <span></span> Head & Shoulders
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-head-shoulders" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">SELL: Break below neckline at $145</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $130 (-10.3%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
                                                            <span className="text-orange-300">STOP-LOSS: $152 (+4.8%)</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Double Bottom Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Double Bottom
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-double-bottom" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                            <span className="text-green-300">BUY: Break above $108 neckline</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $118 (+9.3%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">STOP-LOSS: $96 (-11.1%)</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Ascending Triangle Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Ascending Triangle
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-ascending-triangle" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                            <span className="text-green-300">BUY: Breakout above $88 resistance</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $98 (+11.4%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">STOP-LOSS: $83 (-5.7%)</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Cup and Handle Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Cup and Handle
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-cup-handle" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                            <span className="text-green-300">BUY: Break above handle at $195</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $220 (+12.8%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">STOP-LOSS: $188 (-3.6%)</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Bear Flag Pattern */}
                                                <div className="bg-black/60 rounded-xl p-6 border-2 border-red-500/30">
                                                    <h4 className="text-xl font-bold text-red-300 mb-4 flex items-center gap-2">
                                                        <span></span> Bear Flag Pattern
                                                    </h4>
                                                    <div style={{height: '200px', maxHeight: '200px'}}>
                                                        <canvas id="chart-bear-flag" className="mb-4"></canvas>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                            <span className="text-red-300">SELL: Break below flag at $76</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                            <span className="text-blue-300">TARGET: $62 (-18.4%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
                                                            <span className="text-orange-300">STOP-LOSS: $82 (+7.9%)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-6">
                                            {/* Bullish Patterns */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-green-400 mb-6"> Bullish Patterns (Expect Price to Rise)</h3>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {/* Bull Flag */}
                                                    <div className="bg-green-900/20 rounded-lg p-5 border-2 border-green-400/50 hover:border-gray-700 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-green-300">Bull Flag</h4>
                                                        </div>
                                                        <p className="text-green-100 text-sm mb-3">Strong upward move followed by tight consolidation (flag). Signals continuation upward.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-green-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-green-200"> Enter on breakout above flag</div>
                                                            <div className="text-green-200"> Target: Add flag height to breakout</div>
                                                        </div>
                                                    </div>

                                                    {/* Ascending Triangle */}
                                                    <div className="bg-green-900/20 rounded-lg p-5 border-2 border-green-400/50 hover:border-gray-700 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-green-300">Ascending Triangle</h4>
                                                        </div>
                                                        <p className="text-green-100 text-sm mb-3">Flat resistance with higher lows. Buyers gaining control before breakout.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-green-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-green-200"> Enter on breakout above resistance</div>
                                                            <div className="text-green-200"> High probability of success</div>
                                                        </div>
                                                    </div>

                                                    {/* Double Bottom */}
                                                    <div className="bg-green-900/20 rounded-lg p-5 border-2 border-green-400/50 hover:border-gray-700 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-green-300">Double Bottom (W)</h4>
                                                        </div>
                                                        <p className="text-green-100 text-sm mb-3">Two lows at similar price forming "W" shape. Reversal from downtrend to uptrend.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-green-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-green-200"> Enter after breakout above neckline</div>
                                                            <div className="text-green-200"> Strong reversal signal</div>
                                                        </div>
                                                    </div>

                                                    {/* Cup & Handle */}
                                                    <div className="bg-green-900/20 rounded-lg p-5 border-2 border-green-400/50 hover:border-gray-700 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-green-300">Cup & Handle</h4>
                                                        </div>
                                                        <p className="text-green-100 text-sm mb-3">Rounded bottom (cup) with small consolidation (handle). Very bullish continuation.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-green-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-green-200"> Enter on handle breakout</div>
                                                            <div className="text-green-200"> One of the strongest patterns</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bearish Patterns */}
                                            <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-red-500/30">
                                                <h3 className="text-2xl font-black text-red-400 mb-6"> Bearish Patterns (Expect Price to Fall)</h3>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {/* Bear Flag */}
                                                    <div className="bg-red-900/20 rounded-lg p-5 border-2 border-red-400/50 hover:border-red-400 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-red-300">Bear Flag</h4>
                                                        </div>
                                                        <p className="text-red-100 text-sm mb-3">Sharp decline followed by consolidation. Signals continuation downward.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-red-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-red-200"> Short on breakdown below flag</div>
                                                            <div className="text-red-200"> Or avoid buying (wait for bottom)</div>
                                                        </div>
                                                    </div>

                                                    {/* Descending Triangle */}
                                                    <div className="bg-red-900/20 rounded-lg p-5 border-2 border-red-400/50 hover:border-red-400 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-red-300">Descending Triangle</h4>
                                                        </div>
                                                        <p className="text-red-100 text-sm mb-3">Flat support with lower highs. Sellers building pressure before breakdown.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-red-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-red-200"> Breakdown = strong sell signal</div>
                                                            <div className="text-red-200"> Stay away until reverses</div>
                                                        </div>
                                                    </div>

                                                    {/* Double Top */}
                                                    <div className="bg-red-900/20 rounded-lg p-5 border-2 border-red-400/50 hover:border-red-400 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-red-300">Double Top (M)</h4>
                                                        </div>
                                                        <p className="text-red-100 text-sm mb-3">Two peaks at similar price forming "M" shape. Reversal from uptrend to downtrend.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-red-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-red-200"> Exit longs on neckline break</div>
                                                            <div className="text-red-200"> Reliable reversal pattern</div>
                                                        </div>
                                                    </div>

                                                    {/* Head & Shoulders */}
                                                    <div className="bg-red-900/20 rounded-lg p-5 border-2 border-red-400/50 hover:border-red-400 transition-all">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="text-4xl"></span>
                                                            <h4 className="text-xl font-bold text-red-300">Head & Shoulders</h4>
                                                        </div>
                                                        <p className="text-red-100 text-sm mb-3">Three peaks with middle one highest. Very reliable bearish reversal.</p>
                                                        <div className="bg-black/40 p-3 rounded text-xs">
                                                            <div className="text-red-300 font-bold mb-1">How to Trade:</div>
                                                            <div className="text-red-200"> Sell when neckline breaks</div>
                                                            <div className="text-red-200"> Classic top formation</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Key Takeaways */}
                                            <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                                <h3 className="text-2xl font-black text-gray-300 mb-4"> Pattern Trading Tips</h3>
                                                <ul className="space-y-3 text-purple-100">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-xl"></span>
                                                        <div><strong className="text-gray-400">Wait for Confirmation:</strong> Don't trade the pattern until breakout/breakdown happens</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-xl"></span>
                                                        <div><strong className="text-gray-400">Volume Matters:</strong> Breakouts with high volume are more reliable</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-xl"></span>
                                                        <div><strong className="text-gray-400">Use Stop-Losses:</strong> Place stops below support (bullish) or above resistance (bearish)</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-xl"></span>
                                                        <div><strong className="text-gray-400">Combine with Trend:</strong> Patterns work best when aligned with overall trend</div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Quiz Section */}
                                        <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                            <div className="text-center mb-6">
                                                <div className="text-5xl mb-4"></div>
                                                <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                <p className="text-gray-400">Complete this quiz to check your understanding of Chart Patterns</p>
                                            </div>

                                            <div className="space-y-6">
                                                {quizData.patterns.questions.map((q, qIdx) => (
                                                    <div key={qIdx} className="bg-black/40 rounded-xl p-6">
                                                        <p className="text-xl font-bold text-white mb-4">{qIdx + 1}. {q.question}</p>
                                                        <div className="space-y-3">
                                                            {q.options.map((option, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => {
                                                                        setQuizAnswers({...quizAnswers, patterns: {...(quizAnswers.patterns || {}), [`q${qIdx + 1}`]: idx}});
                                                                    }}
                                                                    disabled={quizSubmitted.patterns}
                                                                    className={`w-full text-left p-4 rounded-lg transition-all ${
                                                                        quizSubmitted.patterns
                                                                            ? idx === q.correct
                                                                                ? 'bg-green-900/40 border-2 border-green-400 text-green-100'
                                                                                : quizAnswers.patterns?.[`q${qIdx + 1}`] === idx
                                                                                    ? 'bg-red-900/40 border-2 border-red-400 text-red-100'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 text-gray-400'
                                                                            : quizAnswers.patterns?.[`q${qIdx + 1}`] === idx
                                                                                ? 'bg-purple-900/40 border-2 border-purple-400 text-white'
                                                                                : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                    }`}
                                                                >
                                                                    {option}
                                                                    {quizSubmitted.patterns && idx === q.correct && <span className="ml-2"></span>}
                                                                    {quizSubmitted.patterns && quizAnswers.patterns?.[`q${qIdx + 1}`] === idx && idx !== q.correct && <span className="ml-2"></span>}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}

                                                {/* Submit Button */}
                                                {!quizSubmitted.patterns && (
                                                    <button
                                                        onClick={() => {
                                                            const allAnswered = quizData.patterns.questions.every((_, idx) =>
                                                                quizAnswers.patterns?.[`q${idx + 1}`] !== undefined
                                                            );
                                                            if (allAnswered) {
                                                                setQuizSubmitted({...quizSubmitted, patterns: true});
                                                                const score = quizData.patterns.questions.filter((q, idx) =>
                                                                    quizAnswers.patterns?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const percentage = Math.round((score / quizData.patterns.questions.length) * 100);
                                                                completeLesson('patterns', percentage);
                                                            } else {
                                                                alert('Please answer all questions before submitting!');
                                                            }
                                                        }}
                                                        className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg text-lg"
                                                    >
                                                        Submit Quiz
                                                    </button>
                                                )}

                                                {/* Results */}
                                                {quizSubmitted.patterns && (
                                                    <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-6 text-center">
                                                        <div className="text-5xl mb-4">
                                                            {(() => {
                                                                const score = quizData.patterns.questions.filter((q, idx) =>
                                                                    quizAnswers.patterns?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.patterns.questions.length;
                                                                return score === total ? '' : score >= total * 0.75 ? '' : score >= total * 0.5 ? '' : '';
                                                            })()}
                                                        </div>
                                                        <h4 className="text-2xl font-black text-white mb-2">Quiz Complete!</h4>
                                                        <p className="text-xl text-green-200 mb-4">
                                                            Score: {quizData.patterns.questions.filter((q, idx) =>
                                                                quizAnswers.patterns?.[`q${idx + 1}`] === q.correct
                                                            ).length} / {quizData.patterns.questions.length}
                                                        </p>
                                                        <p className="text-green-100">
                                                            {(() => {
                                                                const score = quizData.patterns.questions.filter((q, idx) =>
                                                                    quizAnswers.patterns?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.patterns.questions.length;
                                                                if (score === total) return 'Perfect! You have mastered chart patterns! ';
                                                                if (score >= total * 0.75) return 'Great job! You can recognize key patterns well!';
                                                                if (score >= total * 0.5) return 'Good start! Review the lessons and try again.';
                                                                return 'Keep learning! Review the material and practice more.';
                                                            })()}
                                                        </p>

                                                        {/* Explanations */}
                                                        <div className="mt-6 space-y-4 text-left">
                                                            <div className="text-sm font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                            {quizData.patterns.questions.map((q, idx) => {
                                                                const userAnswer = quizAnswers.patterns?.[`q${idx + 1}`];
                                                                const isCorrect = userAnswer === q.correct;
                                                                return (
                                                                    <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                        isCorrect
                                                                            ? 'bg-green-900/20 border-green-400/50'
                                                                            : 'bg-red-900/20 border-red-400/50'
                                                                    }`}>
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="text-lg">{isCorrect ? '' : ''}</span>
                                                                            <div className="flex-1">
                                                                                <div className="font-bold text-white mb-1">Question {idx + 1}</div>
                                                                                <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                    {isCorrect ? 'Correct!' : `Your answer: ${q.options[userAnswer]}`}
                                                                                </div>
                                                                                {!isCorrect && (
                                                                                    <div className="text-sm text-green-300 mt-1">
                                                                                        Correct answer: {q.options[q.correct]}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <div className="text-sm text-gray-300 ml-7 italic">
                                                                            {q.explanation}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        <button
                                                            onClick={() => {
                                                                setQuizSubmitted({...quizSubmitted, patterns: false});
                                                                setQuizAnswers({...quizAnswers, patterns: {}});
                                                            }}
                                                            className="mt-6 bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                        >
                                                            Retake Quiz
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {learningTopic === 'cases' && (
                                    <div>
                                        {/* Header */}
                                        <div className="text-center mb-8">
                                            <div className="text-6xl mb-4"></div>
                                            <h2 className="text-4xl font-black text-white mb-3">Real Case Studies</h2>
                                            <p className="text-xl text-gray-400">Learn from real winning and losing trades - see what worked and what didn't</p>
                                        </div>

                                        {/* Case Study 1: Tesla Success */}
                                        <div className="bg-gradient-to-br from-green-900/60 via-emerald-900/60 to-teal-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl mb-6">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="text-5xl"></div>
                                                <div>
                                                    <h3 className="text-3xl font-black text-white">Case Study #1: Tesla Breakout</h3>
                                                    <div className="text-green-300 font-bold text-lg"> WINNING TRADE - +42% Profit</div>
                                                </div>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                <div className="bg-black/40 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Trade Details
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-green-200">Stock:</strong> Tesla (TSLA)</div>
                                                        <div><strong className="text-green-200">Entry:</strong> $180.00</div>
                                                        <div><strong className="text-green-200">Stop-Loss:</strong> $172.00 (-4.4%)</div>
                                                        <div><strong className="text-green-200">Target:</strong> $240.00 (+33%)</div>
                                                        <div><strong className="text-green-200">Exit:</strong> $255.60 (+42%)</div>
                                                        <div><strong className="text-green-200">Position Size:</strong> 100 shares</div>
                                                        <div><strong className="text-green-200">Profit:</strong> $7,560 </div>
                                                    </div>
                                                </div>

                                                <div className="bg-black/40 rounded-xl p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                        <span></span> Setup
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-green-200">Pattern:</strong> Bull Flag after earnings beat</div>
                                                        <div><strong className="text-green-200">Volume:</strong> 2x average on breakout</div>
                                                        <div><strong className="text-green-200">Trend:</strong> Strong uptrend on daily chart</div>
                                                        <div><strong className="text-green-200">Catalyst:</strong> Q3 earnings exceeded estimates</div>
                                                        <div><strong className="text-green-200">Confirmation:</strong> Broke above $178 resistance with volume</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-black/40 rounded-xl p-6 border border-gray-800">
                                                <h4 className="text-xl font-bold text-green-300 mb-4 flex items-center gap-2">
                                                    <span></span> What Went Right
                                                </h4>
                                                <ul className="space-y-3 text-white">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <div><strong>Waited for Confirmation:</strong> Didn't buy before the breakout - waited for price to close above $178 resistance</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <div><strong>Volume Confirmation:</strong> Entry coincided with 2x average volume spike - smart money was buying</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <div><strong>Risk Management:</strong> Stop-loss at $172 risked only $800 (1% of $80k account) for potential $6,000+ gain</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <div><strong>Trailed Profits:</strong> Moved stop-loss to breakeven at +10%, locked in profits at +25%, let winners run</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-green-400 text-xl"></span>
                                                        <div><strong>Took Partial Profits:</strong> Sold 50% at target ($240), let remaining 50% ride to $255.60</div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Case Study 2: AMC FOMO Mistake */}
                                        <div className="bg-gradient-to-br from-red-900/60 via-rose-900/60 to-pink-900/60 rounded-2xl p-8 border-2 border-red-500/50 shadow-2xl mb-6">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="text-5xl"></div>
                                                <div>
                                                    <h3 className="text-3xl font-black text-white">Case Study #2: AMC FOMO</h3>
                                                    <div className="text-red-300 font-bold text-lg"> LOSING TRADE - -18% Loss</div>
                                                </div>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                <div className="bg-black/40 rounded-xl p-6 border border-red-500/30">
                                                    <h4 className="text-xl font-bold text-red-300 mb-4 flex items-center gap-2">
                                                        <span></span> Trade Details
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-red-200">Stock:</strong> AMC Entertainment (AMC)</div>
                                                        <div><strong className="text-red-200">Entry:</strong> $52.00</div>
                                                        <div><strong className="text-red-200">Stop-Loss:</strong> None set </div>
                                                        <div><strong className="text-red-200">Target:</strong> $100.00 (unrealistic)</div>
                                                        <div><strong className="text-red-200">Exit:</strong> $42.50 (-18%)</div>
                                                        <div><strong className="text-red-200">Position Size:</strong> 200 shares (too large)</div>
                                                        <div><strong className="text-red-200">Loss:</strong> -$1,900 </div>
                                                    </div>
                                                </div>

                                                <div className="bg-black/40 rounded-xl p-6 border border-red-500/30">
                                                    <h4 className="text-xl font-bold text-red-300 mb-4 flex items-center gap-2">
                                                        <span></span> Red Flags Ignored
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-red-200">Entry Point:</strong> Bought at all-time high during parabolic move</div>
                                                        <div><strong className="text-red-200">Volume:</strong> Decreasing volume = exhaustion</div>
                                                        <div><strong className="text-red-200">RSI:</strong> 87 (extremely overbought)</div>
                                                        <div><strong className="text-red-200">Motivation:</strong> Social media hype, not technical analysis</div>
                                                        <div><strong className="text-red-200">Fundamentals:</strong> Company losing money, no real catalyst</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-black/40 rounded-xl p-6 border border-red-500/30">
                                                <h4 className="text-xl font-bold text-red-300 mb-4 flex items-center gap-2">
                                                    <span></span> What Went Wrong
                                                </h4>
                                                <ul className="space-y-3 text-white">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-red-400 text-xl"></span>
                                                        <div><strong>FOMO Entry:</strong> Bought at the top because "everyone was talking about it" - emotion-driven, not strategy-driven</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-red-400 text-xl"></span>
                                                        <div><strong>No Stop-Loss:</strong> Hoped it would "come back" instead of cutting losses - broke the #1 rule of risk management</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-red-400 text-xl"></span>
                                                        <div><strong>Oversized Position:</strong> Risked 13% of account ($10k) on one meme stock - way too much exposure</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-red-400 text-xl"></span>
                                                        <div><strong>Ignored Technicals:</strong> RSI at 87 screamed "overbought" - should have waited for pullback or avoided entirely</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-red-400 text-xl"></span>
                                                        <div><strong>No Exit Plan:</strong> Had vague target of $100 with no basis - should have had realistic profit target and stop-loss</div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Case Study 3: Disciplined Stop-Loss */}
                                        <div className="bg-gradient-to-br from-blue-900/60 via-indigo-900/60 to-purple-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="text-5xl"></div>
                                                <div>
                                                    <h3 className="text-3xl font-black text-white">Case Study #3: Apple Stop-Loss Save</h3>
                                                    <div className="text-blue-300 font-bold text-lg"> PROTECTED CAPITAL - Small -3% Loss Avoided -22% Crash</div>
                                                </div>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6 mb-6">
                                                <div className="bg-black/40 rounded-xl p-6 border border-blue-500/30">
                                                    <h4 className="text-xl font-bold text-blue-300 mb-4 flex items-center gap-2">
                                                        <span></span> Trade Details
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-gray-200">Stock:</strong> Apple (AAPL)</div>
                                                        <div><strong className="text-gray-200">Entry:</strong> $185.00</div>
                                                        <div><strong className="text-gray-200">Stop-Loss:</strong> $179.50 (-3%)</div>
                                                        <div><strong className="text-gray-200">Target:</strong> $200.00 (+8%)</div>
                                                        <div><strong className="text-gray-200">Stopped Out:</strong> $179.50 (-3%)</div>
                                                        <div><strong className="text-gray-200">Stock Fell To:</strong> $144.00 (-22% from entry)</div>
                                                        <div><strong className="text-gray-200">Loss Taken:</strong> -$275 (instead of -$2,050)</div>
                                                    </div>
                                                </div>

                                                <div className="bg-black/40 rounded-xl p-6 border border-blue-500/30">
                                                    <h4 className="text-xl font-bold text-blue-300 mb-4 flex items-center gap-2">
                                                        <span></span> What Happened
                                                    </h4>
                                                    <div className="space-y-3 text-white">
                                                        <div><strong className="text-gray-200">Setup:</strong> Bought breakout above $183 resistance</div>
                                                        <div><strong className="text-gray-200">Initial Move:</strong> Rose to $187 (+1%) within 2 days</div>
                                                        <div><strong className="text-gray-200">Reversal:</strong> Market-wide selloff on Fed news</div>
                                                        <div><strong className="text-gray-200">Stop Triggered:</strong> Hit $179.50, order executed automatically</div>
                                                        <div><strong className="text-gray-200">Aftermath:</strong> Stock crashed to $144 over next 3 weeks</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-black/40 rounded-xl p-6 border border-blue-500/30">
                                                <h4 className="text-xl font-bold text-blue-300 mb-4 flex items-center gap-2">
                                                    <span></span> Key Lessons
                                                </h4>
                                                <ul className="space-y-3 text-white">
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-blue-400 text-xl"></span>
                                                        <div><strong>Stop-Losses Work:</strong> Lost only $275 instead of $2,050 - that's $1,775 saved for future trades</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-blue-400 text-xl"></span>
                                                        <div><strong>Emotion-Free Exit:</strong> Stop-loss order executed automatically - no hesitation, no "should I wait?"</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-blue-400 text-xl"></span>
                                                        <div><strong>Protected Capital:</strong> Small losses are acceptable - they keep you in the game for winning trades</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-blue-400 text-xl"></span>
                                                        <div><strong>No Regrets:</strong> Could have re-entered at $144 with $1,775 extra capital - being stopped out isn't "losing"</div>
                                                    </li>
                                                    <li className="flex items-start gap-3">
                                                        <span className="text-blue-400 text-xl"></span>
                                                        <div><strong>Set and Forget:</strong> Having a plan before entering = no stress, no panic, no hoping</div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Key Takeaways */}
                                        <div className="bg-gradient-to-r from-purple-900/60 to-pink-900/60 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                            <div className="text-center mb-6">
                                                <div className="text-5xl mb-4"></div>
                                                <h3 className="text-3xl font-black text-white mb-2">Universal Lessons from These Trades</h3>
                                            </div>

                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div className="bg-black/40 rounded-lg p-6 border border-gray-800">
                                                    <h4 className="text-xl font-bold text-green-300 mb-4"> Do This</h4>
                                                    <ul className="space-y-3 text-white">
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>Wait for volume confirmation before entering</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>ALWAYS set stop-losses before buying</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>Risk 1-2% max per trade</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>Trail stop-losses as profits grow</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>Take partial profits at targets</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-green-400"></span>
                                                            <span>Trade based on technicals, not hype</span>
                                                        </li>
                                                    </ul>
                                                </div>

                                                <div className="bg-black/40 rounded-lg p-6 border border-red-500/30">
                                                    <h4 className="text-xl font-bold text-red-300 mb-4"> Avoid This</h4>
                                                    <ul className="space-y-3 text-white">
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Chasing stocks after huge moves (FOMO)</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Trading without stop-losses</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Oversized positions (&gt;5% of account)</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Buying when RSI &gt; 70 without pullback</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Hoping losing trades will "come back"</span>
                                                        </li>
                                                        <li className="flex items-start gap-2">
                                                            <span className="text-red-400"></span>
                                                            <span>Trading based on social media hype</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Interactive Practice Scenario */}
                                        <div className="bg-gradient-to-br from-cyan-900/60 via-blue-900/60 to-indigo-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl mt-6">
                                            <div className="text-center mb-6">
                                                <div className="text-5xl mb-4"></div>
                                                <h3 className="text-3xl font-black text-white mb-2">Practice Trading Scenario</h3>
                                                <p className="text-gray-200 text-lg">Make decisions and see the outcomes - learn without risking real money</p>
                                            </div>

                                            {!scenarioDifficulty ? (
                                                <div className="text-center">
                                                    <p className="text-white text-lg mb-6">Choose your difficulty level and test your trading knowledge!</p>

                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                                                        {/* Easy Button */}
                                                        <button
                                                            onClick={() => setScenarioDifficulty('Easy')}
                                                            className="bg-gradient-to-br from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white p-8 rounded-2xl border-2 border-green-400 transition-all  shadow-xl"
                                                        >
                                                            <div className="text-5xl mb-3"></div>
                                                            <div className="text-2xl font-black mb-2">EASY</div>
                                                            <div className="text-green-100 text-sm mb-4">Basic trading concepts</div>
                                                            <div className="text-xs text-green-200">
                                                                 Clear right answers<br/>
                                                                 Fundamental concepts<br/>
                                                                 4 scenarios available<br/>
                                                                 Completed: {scenariosCompleted.Easy}
                                                            </div>
                                                        </button>

                                                        {/* Medium Button */}
                                                        <button
                                                            onClick={() => setScenarioDifficulty('Medium')}
                                                            className="bg-gradient-to-br from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white p-8 rounded-2xl border-2 border-yellow-400 transition-all  shadow-xl"
                                                        >
                                                            <div className="text-5xl mb-3"></div>
                                                            <div className="text-2xl font-black mb-2">MEDIUM</div>
                                                            <div className="text-yellow-100 text-sm mb-4">Moderate complexity</div>
                                                            <div className="text-xs text-yellow-200">
                                                                 Multiple valid strategies<br/>
                                                                 Real-world scenarios<br/>
                                                                 4 scenarios available<br/>
                                                                 Completed: {scenariosCompleted.Medium}
                                                            </div>
                                                        </button>

                                                        {/* Hard Button */}
                                                        <button
                                                            onClick={() => setScenarioDifficulty('Hard')}
                                                            className="bg-gradient-to-br from-red-600 to-purple-700 hover:from-red-500 hover:to-purple-600 text-white p-8 rounded-2xl border-2 border-red-400 transition-all  shadow-xl"
                                                        >
                                                            <div className="text-5xl mb-3"></div>
                                                            <div className="text-2xl font-black mb-2">HARD</div>
                                                            <div className="text-red-100 text-sm mb-4">Advanced trading</div>
                                                            <div className="text-xs text-red-200">
                                                                 Complex situations<br/>
                                                                 Subtle differences<br/>
                                                                 4 scenarios available<br/>
                                                                 Completed: {scenariosCompleted.Hard}
                                                            </div>
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : !practiceScenario ? (
                                                <div className="text-center">
                                                    <div className="flex items-center justify-center gap-3 mb-6">
                                                        <button
                                                            onClick={() => {
                                                                setScenarioDifficulty(null);
                                                                setPracticeScenario(null);
                                                                setPracticeChoice(null);
                                                            }}
                                                            className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all"
                                                        >
                                                             Change Difficulty
                                                        </button>
                                                        <div className={`px-6 py-3 rounded-xl font-bold text-lg ${
                                                            scenarioDifficulty === 'Easy' ? 'bg-green-600 text-white border-2 border-green-400' :
                                                            scenarioDifficulty === 'Medium' ? 'bg-yellow-600 text-white border-2 border-yellow-400' :
                                                            'bg-red-600 text-white border-2 border-red-400'
                                                        }`}>
                                                            {scenarioDifficulty === 'Easy' ? '' : scenarioDifficulty === 'Medium' ? '' : ''} {scenarioDifficulty} Level
                                                        </div>
                                                    </div>
                                                    <p className="text-white text-lg mb-6">Ready to test your skills? Click below to start a random {scenarioDifficulty.toLowerCase()} scenario!</p>
                                                    <button
                                                        onClick={() => {
                                                            const allScenarios = [
                                                                // EASY SCENARIOS (4 total)
                                                                {
                                                                    id: 1,
                                                                    difficulty: 'Easy',
                                                                    stock: 'NVDA',
                                                                    price: 485,
                                                                    situation: 'NVIDIA just broke above $480 resistance after strong earnings. Volume is 3x average. RSI is at 68. The stock has been consolidating for 2 weeks in a bull flag pattern.',
                                                                    question: 'What do you do?',
                                                                    tip: 'Volume confirmation is key when entering breakout trades. Always use stop-losses.',
                                                                    options: [
                                                                        { text: 'Buy immediately at market price', correct: false, outcome: 'Stock pulled back to $470 the next day (-3%). You should wait for confirmation or use limit orders.', profit: -15 },
                                                                        { text: 'Buy with stop-loss at $475', correct: true, outcome: 'Great choice! Stock rallied to $515 (+6%). Your risk management protected you.', profit: 30 },
                                                                        { text: 'Wait for pullback to $470', correct: true, outcome: 'Smart! You got a better entry. Stock rallied to $515 (+9%).', profit: 45 },
                                                                        { text: 'Ignore - RSI too high', correct: false, outcome: 'Missed opportunity. Stock rallied 15% in 2 weeks. RSI at 68 is not extreme.', profit: 0 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 2,
                                                                    difficulty: 'Easy',
                                                                    stock: 'SPY',
                                                                    price: 450,
                                                                    situation: 'S&P 500 ETF just hit all-time high. Market has rallied 8 days straight. Volume declining each day. Your friend says "it only goes up!"',
                                                                    question: 'What do you do?',
                                                                    tip: 'Declining volume on rallies signals exhaustion. Wait for pullbacks to support levels.',
                                                                    options: [
                                                                        { text: 'Buy now - ride the trend!', correct: false, outcome: 'Market corrected 5% the next week. Declining volume = exhaustion. Lost $22.50/share.', profit: -22.50 },
                                                                        { text: 'Wait for pullback to support', correct: true, outcome: 'Excellent! Market pulled back to $440, you bought there and rode it to $465.', profit: 25 },
                                                                        { text: 'Short it - it\'s overextended', correct: false, outcome: 'Dangerous! Never short strong trends. It rallied another 2% before correcting.', profit: -9 },
                                                                        { text: 'Stay in cash until clearer setup', correct: true, outcome: 'Safe choice. Avoiding bad setups is as important as finding good ones. No loss.', profit: 0 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 3,
                                                                    difficulty: 'Easy',
                                                                    stock: 'TSLA',
                                                                    price: 180,
                                                                    situation: 'You bought Tesla at $180. It dropped to $172. Your stop-loss is at $172. Stock is testing support. You\'re down $800.',
                                                                    question: 'What do you do?',
                                                                    tip: 'Never move stop-losses down. Accept small losses to prevent large ones.',
                                                                    options: [
                                                                        { text: 'Move stop-loss lower to $165', correct: false, outcome: 'Bad idea! Stock fell to $160. Lost $2,000 instead of $800. Never move stops down.', profit: -20 },
                                                                        { text: 'Let stop-loss trigger at $172', correct: true, outcome: 'Disciplined! You took -$800 loss. Stock fell to $165 before recovering. Protected capital.', profit: -8 },
                                                                        { text: 'Average down - buy more at $172', correct: false, outcome: 'Risky! Stock fell to $165. Now you lost $1,500 on larger position. Don\'t average down losers.', profit: -15 },
                                                                        { text: 'Hold and hope it bounces', correct: false, outcome: 'Hope is not a strategy. Stock fell to $160 (-$2,000 loss) before recovering weeks later.', profit: -20 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 4,
                                                                    difficulty: 'Easy',
                                                                    stock: 'AAPL',
                                                                    price: 175,
                                                                    situation: 'Apple announces a dividend of $0.50/share (ex-dividend date tomorrow). Stock is trading at $175. Your research shows the stock typically drops by the dividend amount on ex-div date.',
                                                                    question: 'What\'s your dividend capture strategy?',
                                                                    tip: 'Dividend capture requires buying before ex-date, but stocks often drop by the dividend amount.',
                                                                    options: [
                                                                        { text: 'Buy today, sell after dividend', correct: true, outcome: 'Good! Collected $0.50 dividend. Stock dropped to $174.60, but you netted $0.10/share profit.', profit: 0.10 },
                                                                        { text: 'Wait and buy after ex-date drop', correct: true, outcome: 'Smart! Stock dropped to $174.50, you bought and rode recovery to $176.', profit: 1.50 },
                                                                        { text: 'Ignore - dividends are too small', correct: false, outcome: 'Missed opportunity. Dividend strategies can provide steady income with proper execution.', profit: 0 },
                                                                        { text: 'Short before ex-date', correct: false, outcome: 'Risky! Stock rallied before ex-date on dividend buyers. Lost $1/share.', profit: -1 }
                                                                    ]
                                                                },
                                                                // MEDIUM SCENARIOS (4 total)
                                                                {
                                                                    id: 5,
                                                                    difficulty: 'Medium',
                                                                    stock: 'AMZN',
                                                                    price: 145,
                                                                    situation: 'Amazon reports earnings after market close today. Stock at $145. Analysts expect EPS of $1.20, revenue $140B. Options implied volatility is elevated (IV at 60%). Stock has been range-bound $140-$150 for 3 weeks.',
                                                                    question: 'How do you play this earnings event?',
                                                                    tip: 'High IV means expensive options. Earnings can move either direction. Consider risk/reward.',
                                                                    options: [
                                                                        { text: 'Buy stock before earnings', correct: false, outcome: 'Stock beat estimates but only moved to $147 (+1.4%). Could have been worse with a miss.', profit: 2 },
                                                                        { text: 'Buy after earnings reaction settles', correct: true, outcome: 'Excellent! Stock beat, gapped to $152, then pulled back to $148. You bought the dip and rode to $155.', profit: 7 },
                                                                        { text: 'Sell put options before earnings', correct: false, outcome: 'Stock beat but IV crushed your premium gains. Only made $0.50/share on risky position.', profit: 0.50 },
                                                                        { text: 'Stay out - too much uncertainty', correct: true, outcome: 'Safe choice. Earnings plays are risky. Protecting capital is always smart.', profit: 0 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 6,
                                                                    difficulty: 'Medium',
                                                                    stock: 'GME',
                                                                    price: 25,
                                                                    situation: 'GameStop gaps up from $20 to $25 on high volume at market open. No news. Social media showing increased chatter. Gap from $20 to $25 left no trading in between.',
                                                                    question: 'What\'s your gap fill strategy?',
                                                                    tip: 'Gaps often fill (price returns to pre-gap level), but meme stocks can be unpredictable.',
                                                                    options: [
                                                                        { text: 'Short at $25 expecting gap fill to $20', correct: false, outcome: 'Dangerous! Stock squeezed to $30 on retail buying. Lost $5/share. Never short meme stocks.', profit: -5 },
                                                                        { text: 'Buy the breakout at $25', correct: false, outcome: 'Stock faded back to $22 by noon. Gap fills are common. Lost $3/share.', profit: -3 },
                                                                        { text: 'Wait for gap to fill, then buy at $20-21', correct: true, outcome: 'Patient! Stock filled gap to $21, you bought and rode bounce to $24.', profit: 3 },
                                                                        { text: 'Stay away from meme stocks entirely', correct: true, outcome: 'Wise! Meme stocks are unpredictable and risky. Plenty of better setups available.', profit: 0 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 7,
                                                                    difficulty: 'Medium',
                                                                    stock: 'MSFT',
                                                                    price: 380,
                                                                    situation: 'Microsoft at $380, approaching resistance at $385 (tested 3 times in past month). You own 100 shares at $370 (+$1,000 unrealized profit). RSI at 72. Volume increasing.',
                                                                    question: 'How do you manage this winning position?',
                                                                    tip: 'Taking profits vs letting winners run is a key decision. Consider partial exits.',
                                                                    options: [
                                                                        { text: 'Sell all 100 shares at $380, lock in profit', correct: false, outcome: 'Stock broke through $385 resistance and ran to $400. Missed additional $2,000 profit.', profit: 10 },
                                                                        { text: 'Sell 50 shares, let 50 ride with trailing stop', correct: true, outcome: 'Perfect! Locked in $500 profit, remaining 50 shares ran to $395. Total profit $1,750.', profit: 17.50 },
                                                                        { text: 'Hold all shares - let winners run', correct: true, outcome: 'Gutsy! Stock broke to $395 before pulling back. You sold at $390. Great $2,000 profit!', profit: 20 },
                                                                        { text: 'Add more shares at $380 - breakout coming', correct: false, outcome: 'Stock rejected at $385 resistance, fell to $375. Added shares at $380 lost money.', profit: 5 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 8,
                                                                    difficulty: 'Medium',
                                                                    stock: 'AMD',
                                                                    price: 120,
                                                                    situation: 'AMD at $120. You want exposure but unsure of direction. Strong support at $115, resistance at $125. Planning $5,000 position (41 shares at $120).',
                                                                    question: 'How do you scale into this position?',
                                                                    tip: 'Scaling in reduces risk by averaging your entry price across multiple purchases.',
                                                                    options: [
                                                                        { text: 'Buy all 41 shares at once at $120', correct: false, outcome: 'Stock dropped to $116. Full position underwater. Down $164. Should have scaled in.', profit: -4 },
                                                                        { text: 'Buy 15 shares at $120, 13 at $118, 13 at $116', correct: true, outcome: 'Smart scaling! Average entry $118. Stock bounced to $125. Profit $287 vs $205 if bought at $120.', profit: 7 },
                                                                        { text: 'Wait for dip to $115 support, buy all there', correct: true, outcome: 'Patient! Got entire position at $115. Stock bounced to $125. Maximum profit $410!', profit: 10 },
                                                                        { text: 'Use market orders at open every day', correct: false, outcome: 'Bad fills at $121, $122, $120. Average entry $121. Stock at $123. Small profit $82.', profit: 2 }
                                                                    ]
                                                                },
                                                                // HARD SCENARIOS (4 total)
                                                                {
                                                                    id: 9,
                                                                    difficulty: 'Hard',
                                                                    stock: 'QQQ',
                                                                    price: 375,
                                                                    situation: 'QQQ testing major support at $375 (held 4 times). Market news: Fed meeting tomorrow, potential rate hike. VIX spiking to 25. Your analysis: if support breaks, next support is $360.',
                                                                    question: 'What\'s your strategy at this critical support level?',
                                                                    tip: 'Major support + high uncertainty = difficult decision. Risk/reward and timing are crucial.',
                                                                    options: [
                                                                        { text: 'Buy here - 4th test of support should hold', correct: false, outcome: 'Fed hiked rates 0.50%, support broke. QQQ fell to $362. Lost $13/share. Wait for confirmation at major events.', profit: -13 },
                                                                        { text: 'Short at $375 - expecting support break', correct: false, outcome: 'Support held! Fed paused hikes. QQQ rallied to $385. Lost $10/share. Don\'t short major support.', profit: -10 },
                                                                        { text: 'Wait for Fed decision, buy on break above $378', correct: true, outcome: 'Disciplined! Fed paused, QQQ broke to $380 on volume. You bought breakout and rode to $390.', profit: 10 },
                                                                        { text: 'Buy protective puts, take small long position', correct: true, outcome: 'Advanced! Bought shares at $375, puts protected downside. Support held, sold puts at small loss but stock rallied to $385. Net profit $8/share.', profit: 8 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 10,
                                                                    difficulty: 'Hard',
                                                                    stock: 'NFLX',
                                                                    price: 425,
                                                                    situation: 'Netflix at $425 forms a textbook cup & handle pattern. Handle shows low volume consolidation. Breakout level is $428. However, broader market (SPY) showing weakness, trending down.',
                                                                    question: 'How do you handle this conflicting setup?',
                                                                    tip: 'Individual stock setups vs market direction creates complexity. Market usually wins.',
                                                                    options: [
                                                                        { text: 'Buy the breakout at $428 - pattern is perfect', correct: false, outcome: 'Market sold off, dragging NFLX down despite good setup. Fell to $418. Lost $10/share. Market direction matters.', profit: -10 },
                                                                        { text: 'Wait for market to confirm strength first', correct: true, outcome: 'Excellent patience! Market bottomed 2 days later, then NFLX broke to $435. Better entry at $430.', profit: 5 },
                                                                        { text: 'Take smaller position, wider stop-loss', correct: true, outcome: 'Good risk management! Market dipped but NFLX held $423. Eventually broke to $438 after market recovered.', profit: 10 },
                                                                        { text: 'Short NFLX - market will drag it down', correct: false, outcome: 'Wrong! NFLX showed relative strength, only dipped to $422 while market fell 3%. Covered at loss.', profit: -3 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 11,
                                                                    difficulty: 'Hard',
                                                                    stock: 'BA',
                                                                    price: 185,
                                                                    situation: 'Boeing at $185. Suddenly breaks news: major aircraft order from Delta Airlines worth $10B. Stock halted, reopens at $195 (+5.4%). No positions yet. High volume, but some resistance at $200.',
                                                                    question: 'How do you react to this news catalyst?',
                                                                    tip: 'News reactions can overshoot or undershoot. Initial moves are often emotional.',
                                                                    options: [
                                                                        { text: 'Chase it - buy immediately at $195', correct: false, outcome: 'Classic FOMO! Initial excitement faded. Stock pulled back to $190 over next 2 days. Down $5/share.', profit: -5 },
                                                                        { text: 'Wait for pullback to $190, then buy', correct: true, outcome: 'Disciplined! Stock pulled back to $191 on profit-taking. You bought and rode to $202 over 2 weeks.', profit: 11 },
                                                                        { text: 'Sell at $195 if you owned it already', correct: false, outcome: 'Premature! News was genuinely positive. Stock grinded to $205 over next month. Missed $10/share.', profit: 0 },
                                                                        { text: 'Buy half position at $195, half on pullback', correct: true, outcome: 'Smart scaling! Half at $195, half at $191. Average $193. Stock reached $204. Profit $11/share.', profit: 11 }
                                                                    ]
                                                                },
                                                                {
                                                                    id: 12,
                                                                    difficulty: 'Hard',
                                                                    stock: 'XYZ',
                                                                    price: 45,
                                                                    situation: 'You sold 2 put options on XYZ stock at $45 strike (expiring tomorrow) and collected $200 premium. Stock now at $42. Options are in-the-money. You\'ll be assigned 200 shares at $45 = $9,000 commitment.',
                                                                    question: 'How do you handle this options assignment risk?',
                                                                    tip: 'Options assignment means obligation to buy shares. Consider your capital, outlook, and alternatives.',
                                                                    options: [
                                                                        { text: 'Let assignment happen, hold 200 shares at $45', correct: false, outcome: 'Stock continued falling to $40. Unrealized loss $1,000 (offset by $200 premium). Total loss $800.', profit: -4 },
                                                                        { text: 'Buy back puts at loss, close position', correct: true, outcome: 'Smart risk management! Bought back puts for $600 loss ($400 net loss after premium). Stock fell to $40, avoided additional $1,000 loss.', profit: -2 },
                                                                        { text: 'Take assignment, immediately sell covered calls', correct: true, outcome: 'Advanced! Accepted 200 shares at $45, sold $47 calls for $100. Stock recovered to $46. Sold shares at $47 on assignment. Net profit $300.', profit: 1.50 },
                                                                        { text: 'Roll puts to next month, lower strike', correct: true, outcome: 'Sophisticated! Rolled $45 puts to next month $43 puts for $150 credit. Stock recovered to $44, puts expired worthless. Total profit $350.', profit: 1.75 }
                                                                    ]
                                                                }
                                                            ];

                                                            // Filter scenarios by selected difficulty
                                                            const filteredScenarios = allScenarios.filter(s => s.difficulty === scenarioDifficulty);
                                                            const randomScenario = filteredScenarios[Math.floor(Math.random() * filteredScenarios.length)];
                                                            setPracticeScenario(randomScenario);
                                                            setPracticeChoice(null);
                                                        }}
                                                        className="bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all shadow-lg "
                                                    >
                                                         Start Practice Scenario
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="space-y-6">
                                                    {/* Difficulty Badge and Counter */}
                                                    <div className="flex items-center justify-between flex-wrap gap-4 mb-4">
                                                        <div className={`px-4 py-2 rounded-lg font-bold ${
                                                            practiceScenario.difficulty === 'Easy' ? 'bg-green-600 text-white' :
                                                            practiceScenario.difficulty === 'Medium' ? 'bg-yellow-600 text-white' :
                                                            'bg-red-600 text-white'
                                                        }`}>
                                                            {practiceScenario.difficulty === 'Easy' ? '' : practiceScenario.difficulty === 'Medium' ? '' : ''} {practiceScenario.difficulty} Level
                                                        </div>
                                                        <div className="text-gray-300 font-bold">
                                                            Scenario #{practiceScenario.id} of 12
                                                        </div>
                                                    </div>

                                                    {/* Scenario Setup */}
                                                    <div className="bg-black/60 rounded-xl p-6 border-2 border-cyan-400">
                                                        <div className="flex items-center gap-3 mb-4">
                                                            <div className="text-4xl"></div>
                                                            <div>
                                                                <div className="text-2xl font-black text-white">{practiceScenario.stock}</div>
                                                                <div className="text-gray-300">Current Price: ${practiceScenario.price}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-white text-lg leading-relaxed bg-blue-900/20 p-4 rounded-lg">
                                                            {practiceScenario.situation}
                                                        </div>
                                                    </div>

                                                    {/* Question and Choices */}
                                                    {practiceChoice === null ? (
                                                        <div>
                                                            <h4 className="text-2xl font-bold text-white mb-4">{practiceScenario.question}</h4>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                {practiceScenario.options.map((option, idx) => (
                                                                    <button
                                                                        key={idx}
                                                                        onClick={() => setPracticeChoice(idx)}
                                                                        className="bg-gray-800/60 hover:bg-cyan-900/40 border-2 border-gray-600 hover:border-gray-700 text-white p-6 rounded-xl text-left transition-all "
                                                                    >
                                                                        <div className="font-bold text-lg mb-2">{String.fromCharCode(65 + idx)}. {option.text}</div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className={`p-6 rounded-xl border-2 ${
                                                            practiceScenario.options[practiceChoice].correct
                                                                ? 'bg-green-900/40 border-green-400'
                                                                : 'bg-red-900/40 border-red-400'
                                                        }`}>
                                                            <div className="text-center mb-4">
                                                                <div className="text-6xl mb-3">
                                                                    {practiceScenario.options[practiceChoice].profit > 0 ? '' : practiceScenario.options[practiceChoice].profit < 0 ? '' : ''}
                                                                </div>
                                                                <div className={`text-3xl font-black ${
                                                                    practiceScenario.options[practiceChoice].profit > 0 ? 'text-green-400' :
                                                                    practiceScenario.options[practiceChoice].profit < 0 ? 'text-red-400' : 'text-gray-400'
                                                                }`}>
                                                                    {practiceScenario.options[practiceChoice].profit > 0 ? '+' : ''}
                                                                    ${practiceScenario.options[practiceChoice].profit.toFixed(2)} per share
                                                                </div>
                                                            </div>
                                                            <div className="text-white text-lg bg-black/40 p-4 rounded-lg mb-4">
                                                                {practiceScenario.options[practiceChoice].outcome}
                                                            </div>

                                                            {/* Difficulty-Specific Tip */}
                                                            {practiceScenario.tip && (
                                                                <div className={`p-4 rounded-lg mb-4 border-2 ${
                                                                    practiceScenario.difficulty === 'Easy' ? 'bg-green-900/30 border-green-500/50' :
                                                                    practiceScenario.difficulty === 'Medium' ? 'bg-yellow-900/30 border-yellow-500/50' :
                                                                    'bg-red-900/30 border-red-500/50'
                                                                }`}>
                                                                    <div className="flex items-start gap-3">
                                                                        <div className="text-2xl"></div>
                                                                        <div>
                                                                            <div className="font-bold text-white mb-1">Key Takeaway:</div>
                                                                            <div className="text-gray-200">{practiceScenario.tip}</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="flex gap-4 justify-center flex-wrap">
                                                                <button
                                                                    onClick={() => {
                                                                        // Update completed scenarios count
                                                                        const newCompleted = {
                                                                            ...scenariosCompleted,
                                                                            [practiceScenario.difficulty]: scenariosCompleted[practiceScenario.difficulty] + 1
                                                                        };
                                                                        setScenariosCompleted(newCompleted);
                                                                        localStorage.setItem('scenariosCompleted', JSON.stringify(newCompleted));

                                                                        setPracticeScenario(null);
                                                                        setPracticeChoice(null);
                                                                    }}
                                                                    className="bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                                >
                                                                    Try Another Scenario
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        // Update completed scenarios count
                                                                        const newCompleted = {
                                                                            ...scenariosCompleted,
                                                                            [practiceScenario.difficulty]: scenariosCompleted[practiceScenario.difficulty] + 1
                                                                        };
                                                                        setScenariosCompleted(newCompleted);
                                                                        localStorage.setItem('scenariosCompleted', JSON.stringify(newCompleted));

                                                                        setScenarioDifficulty(null);
                                                                        setPracticeScenario(null);
                                                                        setPracticeChoice(null);
                                                                    }}
                                                                    className="bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                                >
                                                                    Change Difficulty
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                        {/* Quiz Section */}
                                        <div className="bg-gray-900/80 backdrop-blur-xl rounded-xl p-8 border border-gray-800 mt-8">
                                            <div className="text-center mb-6">
                                                <div className="text-5xl mb-4"></div>
                                                <h3 className="text-3xl font-black text-white mb-2">Test Your Knowledge</h3>
                                                <p className="text-gray-400">Complete this quiz to check your understanding of Case Studies</p>
                                            </div>

                                            <div className="space-y-6">
                                                {quizData.cases.questions.map((q, qIdx) => (
                                                    <div key={qIdx} className="bg-black/40 rounded-xl p-6">
                                                        <p className="text-xl font-bold text-white mb-4">{qIdx + 1}. {q.question}</p>
                                                        <div className="space-y-3">
                                                            {q.options.map((option, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => {
                                                                        setQuizAnswers({...quizAnswers, cases: {...(quizAnswers.cases || {}), [`q${qIdx + 1}`]: idx}});
                                                                    }}
                                                                    disabled={quizSubmitted.cases}
                                                                    className={`w-full text-left p-4 rounded-lg transition-all ${
                                                                        quizSubmitted.cases
                                                                            ? idx === q.correct
                                                                                ? 'bg-green-900/40 border-2 border-green-400 text-green-100'
                                                                                : quizAnswers.cases?.[`q${qIdx + 1}`] === idx
                                                                                    ? 'bg-red-900/40 border-2 border-red-400 text-red-100'
                                                                                    : 'bg-gray-800/40 border-2 border-gray-600 text-gray-400'
                                                                            : quizAnswers.cases?.[`q${qIdx + 1}`] === idx
                                                                                ? 'bg-purple-900/40 border-2 border-purple-400 text-white'
                                                                                : 'bg-gray-800/40 border-2 border-gray-600 hover:border-gray-700 text-gray-200'
                                                                    }`}
                                                                >
                                                                    {option}
                                                                    {quizSubmitted.cases && idx === q.correct && <span className="ml-2"></span>}
                                                                    {quizSubmitted.cases && quizAnswers.cases?.[`q${qIdx + 1}`] === idx && idx !== q.correct && <span className="ml-2"></span>}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}

                                                {/* Submit Button */}
                                                {!quizSubmitted.cases && (
                                                    <button
                                                        onClick={() => {
                                                            const allAnswered = quizData.cases.questions.every((_, idx) =>
                                                                quizAnswers.cases?.[`q${idx + 1}`] !== undefined
                                                            );
                                                            if (allAnswered) {
                                                                setQuizSubmitted({...quizSubmitted, cases: true});
                                                                const score = quizData.cases.questions.filter((q, idx) =>
                                                                    quizAnswers.cases?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const percentage = Math.round((score / quizData.cases.questions.length) * 100);
                                                                completeLesson('cases', percentage);
                                                            } else {
                                                                alert('Please answer all questions before submitting!');
                                                            }
                                                        }}
                                                        className="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-400 hover:to-blue-400 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-lg text-lg"
                                                    >
                                                        Submit Quiz
                                                    </button>
                                                )}

                                                {/* Results */}
                                                {quizSubmitted.cases && (
                                                    <div className="bg-gray-900/80 border-2 border-green-400 rounded-xl p-6 text-center">
                                                        <div className="text-5xl mb-4">
                                                            {(() => {
                                                                const score = quizData.cases.questions.filter((q, idx) =>
                                                                    quizAnswers.cases?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.cases.questions.length;
                                                                return score === total ? '' : score >= total * 0.75 ? '' : score >= total * 0.5 ? '' : '';
                                                            })()}
                                                        </div>
                                                        <h4 className="text-2xl font-black text-white mb-2">Quiz Complete!</h4>
                                                        <p className="text-xl text-green-200 mb-4">
                                                            Score: {quizData.cases.questions.filter((q, idx) =>
                                                                quizAnswers.cases?.[`q${idx + 1}`] === q.correct
                                                            ).length} / {quizData.cases.questions.length}
                                                        </p>
                                                        <p className="text-green-100">
                                                            {(() => {
                                                                const score = quizData.cases.questions.filter((q, idx) =>
                                                                    quizAnswers.cases?.[`q${idx + 1}`] === q.correct
                                                                ).length;
                                                                const total = quizData.cases.questions.length;
                                                                if (score === total) return 'Perfect! You have learned from real case studies! ';
                                                                if (score >= total * 0.75) return 'Great job! You understand trading psychology well!';
                                                                if (score >= total * 0.5) return 'Good start! Review the lessons and try again.';
                                                                return 'Keep learning! Review the material and practice more.';
                                                            })()}
                                                        </p>

                                                        {/* Explanations */}
                                                        <div className="mt-6 space-y-4 text-left">
                                                            <div className="text-sm font-bold text-gray-300 mb-3"> Answer Explanations:</div>

                                                            {quizData.cases.questions.map((q, idx) => {
                                                                const userAnswer = quizAnswers.cases?.[`q${idx + 1}`];
                                                                const isCorrect = userAnswer === q.correct;
                                                                return (
                                                                    <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                                        isCorrect
                                                                            ? 'bg-green-900/20 border-green-400/50'
                                                                            : 'bg-red-900/20 border-red-400/50'
                                                                    }`}>
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="text-lg">{isCorrect ? '' : ''}</span>
                                                                            <div className="flex-1">
                                                                                <div className="font-bold text-white mb-1">Question {idx + 1}</div>
                                                                                <div className={`text-sm ${isCorrect ? 'text-green-200' : 'text-red-200'}`}>
                                                                                    {isCorrect ? 'Correct!' : `Your answer: ${q.options[userAnswer]}`}
                                                                                </div>
                                                                                {!isCorrect && (
                                                                                    <div className="text-sm text-green-300 mt-1">
                                                                                        Correct answer: {q.options[q.correct]}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <div className="text-sm text-gray-300 ml-7 italic">
                                                                            {q.explanation}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>

                                                        <button
                                                            onClick={() => {
                                                                setQuizSubmitted({...quizSubmitted, cases: false});
                                                                setQuizAnswers({...quizAnswers, cases: {}});
                                                            }}
                                                            className="mt-6 bg-gradient-to-r from-gray-600 to-gray-500 hover:from-gray-500 hover:to-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all"
                                                        >
                                                            Retake Quiz
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Account Tab */}
                        {mainTab === 'account' && (
                            <div className="bg-gradient-to-br from-cyan-900/60 via-blue-900/60 to-indigo-900/60 rounded-2xl p-8 border border-gray-800 shadow-2xl">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full mb-6 shadow-2xl">
                                        <span className="text-5xl"></span>
                                    </div>
                                    <h2 className="text-4xl font-black text-white mb-3">Account Settings</h2>
                                    <p className="text-xl text-gray-200">Manage your account and preferences</p>
                                </div>

                                {/* Account Information */}
                                <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800 mb-6">
                                    <h3 className="text-2xl font-black text-white mb-6 flex items-center gap-2">
                                        <span className="text-3xl"></span>
                                        Account Information
                                    </h3>
                                    <div className="space-y-4">
                                        {/* Name - Editable */}
                                        <div className="flex justify-between items-center py-3 border-b border-cyan-500/20 group/field">
                                            <span className="text-gray-300 font-semibold">Name</span>
                                            <div className="flex items-center gap-3">
                                                <span className="text-white font-bold">{userName}</span>
                                                <button
                                                    onClick={async () => {
                                                        const newName = prompt('Enter your new name:', userName);
                                                        if (newName && newName.trim() && newName !== userName) {
                                                            try {
                                                                setLoading(true);
                                                                const response = await fetchWithTimeout(`${API_BASE_URL}/api/accounts/update-name`, {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({
                                                                        email: userEmail,
                                                                        name: newName.trim()
                                                                    })
                                                                }, 30000);

                                                                const data = await response.json();

                                                                if (!response.ok) {
                                                                    throw new Error(data.error || 'Failed to update name');
                                                                }

                                                                setUserName(newName.trim());
                                                                const newCompetition = { ...competition };
                                                                newCompetition.members[0].name = newName.trim();
                                                                setCompetition(newCompetition);
                                                                showToast(' Name updated successfully!', 'success');
                                                            } catch (error) {
                                                                alert(` ${error.message}`);
                                                            } finally {
                                                                setLoading(false);
                                                            }
                                                        }
                                                    }}
                                                    className="opacity-0 group-hover/field:opacity-100 transition-opacity duration-200 bg-cyan-600/50 hover:bg-cyan-500 text-white px-3 py-1 rounded-lg text-sm font-bold"
                                                >
                                                     Edit
                                                </button>
                                            </div>
                                        </div>

                                        {/* Email - Read Only */}
                                        <div className="flex justify-between items-center py-3 border-b border-cyan-500/20">
                                            <span className="text-gray-300 font-semibold">Email</span>
                                            <span className="text-white font-bold">{userEmail}</span>
                                        </div>

                                        {/* Account Code - Read Only */}
                                        <div className="flex justify-between items-center py-3 border-b border-cyan-500/20">
                                            <span className="text-gray-300 font-semibold">Account Code</span>
                                            <span className="text-white font-bold font-mono">{competitionCode}</span>
                                        </div>

                                        {/* Plan - Read Only */}
                                        <div className="flex justify-between items-center py-3">
                                            <span className="text-gray-300 font-semibold">Plan</span>
                                            <span className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-1 rounded-full font-bold text-sm">Personal</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Account Actions */}
                                <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border-2 border-yellow-500/30 mb-6">
                                    <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-6 flex items-center gap-2">
                                        <span className="text-3xl"></span>
                                        Account Actions
                                    </h3>
                                    <div className="space-y-4">
                                        <button
                                            onClick={async () => {
                                                // Step 1: Confirm action
                                                const confirmed = confirm(' RESET YOUR ACCOUNT?\n\nThis will permanently:\n\n Delete ALL your stock positions\n Delete ALL your trading history\n Reset your cash to $100,000\n Clear your watchlist\n\n Your email and password will remain the same\n You can only reset your account ONCE\n\nAre you absolutely sure?');

                                                if (!confirmed) {
                                                    return;
                                                }

                                                // Step 2: Password verification
                                                const password = prompt(' Password Required\n\nTo confirm this action, please enter your password:');

                                                if (!password) {
                                                    return;
                                                }

                                                // Step 3: Final confirmation
                                                const finalConfirm = confirm(' FINAL WARNING\n\nThis is your ONE-TIME account reset.\n\nAfter this reset, you will NEVER be able to reset your account again.\n\nAll your trading data will be PERMANENTLY DELETED and cannot be recovered.\n\nProceed with reset?');

                                                if (!finalConfirm) {
                                                    return;
                                                }

                                                try {
                                                    setLoading(true);
                                                    const response = await fetchWithTimeout(`${API_BASE_URL}/api/accounts/reset`, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({
                                                            email: userEmail,
                                                            password: password
                                                        })
                                                    }, 30000);

                                                    const data = await response.json();

                                                    if (!response.ok) {
                                                        throw new Error(data.error || data.message || 'Failed to reset account');
                                                    }

                                                    // Update local state
                                                    const newCompetition = { ...competition };
                                                    newCompetition.members[0].portfolio = data.portfolio;
                                                    setCompetition(newCompetition);

                                                    showToast(' Account reset successful! All trading data cleared.', 'success');

                                                    // Show one-time warning
                                                    setTimeout(() => {
                                                        alert(' ' + data.warning);
                                                        window.location.reload();
                                                    }, 1000);
                                                } catch (error) {
                                                    alert(` ${error.message}`);
                                                } finally {
                                                    setLoading(false);
                                                }
                                            }}
                                            className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-6 py-4 rounded-xl font-bold transition-all duration-300 flex items-center justify-center gap-3 shadow-xl hover:shadow-2xl "
                                        >
                                            <span className="text-2xl"></span>
                                            <span>Reset Account (One-Time Only)</span>
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (confirm('Are you sure you want to sign out?')) {
                                                    setCompetition(null);
                                                    setCompetitionCode('');
                                                    setCurrentUserId(null);
                                                    setUserName('');
                                                    setUserEmail('');
                                                    setView('plan-select');
                                                    showToast('Signed out successfully', 'success');
                                                }
                                            }}
                                            className="w-full bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white px-6 py-4 rounded-xl font-bold transition-all duration-300 flex items-center justify-center gap-3 shadow-xl hover:shadow-2xl "
                                        >
                                            <span className="text-2xl"></span>
                                            <span>Sign Out</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Portfolio Summary */}
                                <div className="bg-black/60 backdrop-blur-xl rounded-xl p-6 border border-gray-800">
                                    <h3 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400 mb-6 flex items-center gap-2">
                                        <span className="text-3xl"></span>
                                        Portfolio Summary
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 rounded-xl p-4 border border-gray-800">
                                            <div className="text-green-300 text-sm font-semibold mb-2">Total Value</div>
                                            <div className="text-white font-black text-2xl">${portfolioValue.toLocaleString()}</div>
                                        </div>
                                        <div className="bg-gradient-to-br from-cyan-900/40 to-blue-900/40 rounded-xl p-4 border border-gray-800">
                                            <div className="text-gray-300 text-sm font-semibold mb-2">Cash Balance</div>
                                            <div className="text-white font-black text-2xl">${portfolio.cash.toLocaleString()}</div>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-900/40 to-indigo-900/40 rounded-xl p-4 border border-gray-800">
                                            <div className="text-gray-300 text-sm font-semibold mb-2">Total Trades</div>
                                            <div className="text-white font-black text-2xl">{portfolio.history?.length || 0}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* News Article Modal with Embedded Content */}
                {showNewsModal && selectedNewsArticle && (
                    <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[9999] flex items-center justify-center p-4 animate-fade-in">
                        <div className="relative w-full max-w-6xl h-[90vh] bg-black/90 backdrop-blur-2xl rounded-3xl border border-gray-800 overflow-hidden shadow-2xl" style={{boxShadow: '0 0 60px rgba(6, 182, 212, 0.4)'}}>
                            {/* Modal Header */}
                            <div className="relative bg-gradient-to-r from-cyan-900/60 to-blue-900/60 backdrop-blur-xl p-6 border-b-2 border-cyan-500/30">
                                <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-500/10"></div>
                                <div className="relative flex items-start justify-between gap-4">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-3 flex-wrap">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold border-2 ${
                                                selectedNewsArticle.sentiment === 'positive' ? 'bg-green-500/20 text-green-300 border-green-500/50' :
                                                selectedNewsArticle.sentiment === 'negative' ? 'bg-red-500/20 text-red-300 border-red-500/50' :
                                                'bg-gray-500/20 text-gray-300 border-gray-500/50'
                                            }`}>
                                                {selectedNewsArticle.sentiment === 'positive' ? ' Bullish' :
                                                 selectedNewsArticle.sentiment === 'negative' ? ' Bearish' :
                                                 ' Neutral'}
                                            </span>
                                            <span className="text-sm text-cyan-400 font-semibold">
                                                {window.newsFeed.formatNewsDate(selectedNewsArticle.datetime)}
                                            </span>
                                            {selectedNewsArticle.category && (
                                                <span className="text-sm text-gray-300 bg-cyan-500/10 border border-gray-800 px-3 py-1 rounded-full font-semibold">
                                                    {selectedNewsArticle.category}
                                                </span>
                                            )}
                                            <span className="text-sm text-gray-400 font-semibold flex items-center gap-2">
                                                <span></span>
                                                <span>{selectedNewsArticle.source}</span>
                                            </span>
                                        </div>
                                        <h2 className="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-cyan-200 to-white leading-tight">
                                            {selectedNewsArticle.headline}
                                        </h2>
                                        {selectedNewsArticle.summary && (
                                            <p className="mt-3 text-gray-300 text-sm leading-relaxed">
                                                {selectedNewsArticle.summary}
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => {
                                            setShowNewsModal(false);
                                            setSelectedNewsArticle(null);
                                            setScrapedArticle(null);
                                            setScrapingError(null);
                                            setScrapingArticle(false);
                                        }}
                                        className="flex-shrink-0 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-400 hover:to-red-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-black text-2xl transition-all shadow-lg hover:shadow-xl hover:scale-110"
                                        title="Close article"
                                    >
                                        
                                    </button>
                                </div>
                                <div className="relative mt-4 flex items-center gap-3 flex-wrap">
                                    <a
                                        href={selectedNewsArticle.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-xl flex items-center gap-2"
                                    >
                                        <span></span>
                                        <span>View Original Source</span>
                                    </a>
                                    {scrapedArticle && !scrapingArticle && !scrapingError && (
                                        <span className="text-xs text-green-400 font-bold flex items-center gap-1">
                                            <span></span>
                                            <span>ARTICLE LOADED</span>
                                        </span>
                                    )}
                                    {scrapingArticle && (
                                        <span className="text-xs text-cyan-400 font-bold flex items-center gap-1 animate-pulse">
                                            <span></span>
                                            <span>LOADING...</span>
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Embedded Article Content */}
                            <div className="relative w-full h-[calc(100%-200px)] bg-gradient-to-b from-gray-900 to-black overflow-y-auto">
                                {scrapingArticle && (
                                    <div className="flex flex-col items-center justify-center h-full gap-6">
                                        <div className="relative w-20 h-20">
                                            <div className="absolute inset-0 border-4 border-cyan-500/30 rounded-full"></div>
                                            <div className="absolute inset-0 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-black text-white mb-2">
                                                Loading Article...
                                            </div>
                                            <div className="text-gray-400 text-sm">
                                                Scraping content from source
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {!scrapingArticle && scrapingError && (
                                    <div className="flex flex-col items-center justify-center h-full gap-6 p-8">
                                        <div className="text-6xl"></div>
                                        <div className="text-center max-w-md">
                                            <div className="text-2xl font-black text-red-400 mb-4">
                                                Unable to Load Article
                                            </div>
                                            <div className="text-gray-300 mb-6 leading-relaxed">
                                                {scrapingError}
                                            </div>
                                            <a
                                                href={selectedNewsArticle.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 hover:from-cyan-400 hover:to-blue-400 text-white px-6 py-3 rounded-lg font-bold transition-all shadow-lg hover:shadow-xl"
                                            >
                                                <span></span>
                                                <span>Read on Original Site</span>
                                            </a>
                                        </div>
                                    </div>
                                )}

                                {!scrapingArticle && !scrapingError && scrapedArticle && (
                                    <div className="max-w-4xl mx-auto p-8 pb-16">
                                        <article className="prose prose-invert prose-lg max-w-none">
                                            {scrapedArticle.author && (
                                                <div className="text-cyan-400 font-semibold mb-2 not-prose">
                                                    By {scrapedArticle.author}
                                                </div>
                                            )}
                                            {scrapedArticle.publishDate && (
                                                <div className="text-gray-400 text-sm mb-6 not-prose">
                                                    {new Date(scrapedArticle.publishDate).toLocaleDateString('en-US', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    })}
                                                </div>
                                            )}
                                            <div className="text-gray-200 leading-relaxed space-y-6" style={{
                                                fontSize: '18px',
                                                lineHeight: '1.8'
                                            }}>
                                                {scrapedArticle.text.split('\n\n').map((paragraph, idx) => (
                                                    <p key={idx} className="mb-4">
                                                        {paragraph}
                                                    </p>
                                                ))}
                                            </div>
                                            <div className="mt-12 pt-8 border-t border-cyan-500/30 not-prose">
                                                <a
                                                    href={scrapedArticle.url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center gap-2 text-cyan-400 hover:text-gray-300 font-semibold transition-colors"
                                                >
                                                    <span></span>
                                                    <span>Read full article on {selectedNewsArticle.source}</span>
                                                    <span></span>
                                                </a>
                                            </div>
                                        </article>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* Trading Glossary Modal */}
                {showGlossary && (
                    <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[9999] flex items-center justify-center p-4 animate-fade-in">
                        <div className="relative w-full max-w-7xl h-[90vh] bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 rounded-3xl border border-gray-800 overflow-hidden shadow-2xl" style={{boxShadow: '0 0 60px rgba(6, 182, 212, 0.4)'}}>
                            {/* Modal Header */}
                            <div className="relative bg-gradient-to-r from-cyan-900/80 via-blue-900/80 to-indigo-900/80 backdrop-blur-xl p-6 border-b-2 border-cyan-500/50">
                                <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-500/10"></div>
                                <div className="relative flex items-center justify-between gap-4">
                                    <div className="flex items-center gap-4">
                                        <span className="text-5xl"></span>
                                        <div>
                                            <h2 className="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-blue-300 to-indigo-300">
                                                Trading Glossary
                                            </h2>
                                            <p className="text-gray-200 text-sm mt-1">
                                                {glossaryTerms.length} essential trading terms to master
                                            </p>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            setShowGlossary(false);
                                            setGlossarySearch('');
                                        }}
                                        className="text-white hover:text-red-400 transition-colors p-2 hover:bg-red-500/20 rounded-xl"
                                    >
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>

                                {/* Search Bar */}
                                <div className="relative mt-6">
                                    <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                        <svg className="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Search terms or definitions..."
                                        value={glossarySearch}
                                        onChange={(e) => setGlossarySearch(e.target.value)}
                                        className="w-full pl-12 pr-4 py-3 bg-black/50 border border-gray-800 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-cyan-500 transition-colors"
                                    />
                                    {glossarySearch && (
                                        <button
                                            onClick={() => setGlossarySearch('')}
                                            className="absolute inset-y-0 right-4 flex items-center text-gray-400 hover:text-white"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Modal Content - Scrollable Terms */}
                            <div className="overflow-y-auto h-[calc(90vh-200px)] p-6">
                                {(() => {
                                    // Filter terms based on search
                                    const searchLower = glossarySearch.toLowerCase();
                                    const filteredTerms = glossarySearch
                                        ? glossaryTerms.filter(term =>
                                            term.term.toLowerCase().includes(searchLower) ||
                                            term.definition.toLowerCase().includes(searchLower)
                                        )
                                        : glossaryTerms;

                                    // Group filtered terms by category
                                    const groupedTerms = filteredTerms.reduce((acc, term) => {
                                        if (!acc[term.category]) {
                                            acc[term.category] = [];
                                        }
                                        acc[term.category].push(term);
                                        return acc;
                                    }, {});

                                    const categories = Object.keys(groupedTerms).sort();

                                    if (filteredTerms.length === 0) {
                                        return (
                                            <div className="flex flex-col items-center justify-center h-full text-center py-20">
                                                <svg className="w-20 h-20 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <p className="text-gray-400 text-xl font-bold mb-2">No terms found</p>
                                                <p className="text-gray-500">Try a different search term</p>
                                            </div>
                                        );
                                    }

                                    return categories.map(category => (
                                        <div key={category} className="mb-8">
                                            {/* Category Header */}
                                            <div className="flex items-center gap-3 mb-4">
                                                <span className={`px-4 py-2 rounded-xl font-black text-sm border-2 ${
                                                    category === 'Market' ? 'bg-green-500/20 text-green-300 border-green-500/50' :
                                                    category === 'Orders' ? 'bg-blue-500/20 text-blue-300 border-blue-500/50' :
                                                    category === 'Technical' ? 'bg-purple-500/20 text-gray-300 border-purple-500/50' :
                                                    category === 'Risk' ? 'bg-orange-500/20 text-orange-300 border-orange-500/50' :
                                                    'bg-pink-500/20 text-pink-300 border-pink-500/50'
                                                }`}>
                                                    {category === 'Market' ? '' : category === 'Orders' ? '' : category === 'Technical' ? '' : category === 'Risk' ? '' : ''} {category}
                                                </span>
                                                <div className="flex-1 h-px bg-gradient-to-r from-cyan-500/50 to-transparent"></div>
                                            </div>

                                            {/* Terms Grid */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {groupedTerms[category].map((term, idx) => (
                                                    <div
                                                        key={idx}
                                                        className={`group relative bg-gradient-to-br backdrop-blur-xl rounded-xl p-5 border-2 transition-all  hover:shadow-2xl ${
                                                            category === 'Market' ? 'from-green-900/40 to-emerald-900/40 border-green-500/30 hover:border-gray-700/60 hover:shadow-green-500/20' :
                                                            category === 'Orders' ? 'from-blue-900/40 to-cyan-900/40 border-blue-500/30 hover:border-gray-700/60 hover:shadow-blue-500/20' :
                                                            category === 'Technical' ? 'from-purple-900/40 to-indigo-900/40 border-purple-500/30 hover:border-gray-700/60 hover:shadow-purple-500/20' :
                                                            category === 'Risk' ? 'from-orange-900/40 to-red-900/40 border-orange-500/30 hover:border-orange-500/60 hover:shadow-orange-500/20' :
                                                            'from-pink-900/40 to-rose-900/40 border-pink-500/30 hover:border-pink-500/60 hover:shadow-pink-500/20'
                                                        }`}
                                                    >
                                                        {/* Glossy overlay effect */}
                                                        <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"></div>

                                                        <div className="relative">
                                                            <h3 className={`font-black text-lg mb-3 ${
                                                                category === 'Market' ? 'text-green-300' :
                                                                category === 'Orders' ? 'text-blue-300' :
                                                                category === 'Technical' ? 'text-gray-300' :
                                                                category === 'Risk' ? 'text-orange-300' :
                                                                'text-pink-300'
                                                            }`}>
                                                                {term.term}
                                                            </h3>
                                                            <p className="text-gray-300 text-sm leading-relaxed">
                                                                {term.definition}
                                                            </p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ));
                                })()}
                            </div>
                        </div>
                    </div>
                )}

                {/* Footer - appears on all views */}
                <footer className="group/footer relative bg-black/90 backdrop-blur-2xl border-t-2 border-cyan-500/30 mt-auto overflow-hidden" style={{boxShadow: '0 -10px 40px rgba(6, 182, 212, 0.1)'}}>
                    {/* Animated background gradient */}
                    <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-blue-600/5 to-purple-600/5 opacity-50"></div>

                    {/* Shine effect */}
                    <div className="absolute inset-0 -translate-x-full group-hover/footer:translate-x-full transition-transform duration-[2000ms] bg-gradient-to-r from-transparent via-cyan-400/5 to-transparent"></div>

                    <div className="relative max-w-7xl mx-auto px-4 py-12">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                            {/* About Section */}
                            <div className="group/section">
                                <h3 className="text-white font-black text-xl mb-4 flex items-center gap-2">
                                    <span className="text-2xl"></span>
                                    FinClash
                                </h3>
                                <p className="text-gray-400 text-sm leading-relaxed font-medium">
                                    Virtual stock trading simulator for educational purposes. Practice trading with $100,000 in virtual currency.
                                </p>
                            </div>

                            {/* Legal Links */}
                            <div className="group/section">
                                <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400 font-black text-xl mb-4 flex items-center gap-2">
                                    <span className="text-2xl"></span>
                                    Legal
                                </h3>
                                <ul className="space-y-3">
                                    <li>
                                        <a href="privacy-policy.html" target="_blank" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                            <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                            <span>Privacy Policy</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="terms-of-service.html" target="_blank" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                            <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                            <span>Terms of Service</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="trust-safety.html" target="_blank" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                            <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                            <span>Trust & Safety</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            {/* Company Links */}
                            <div className="group/section">
                                <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-400 font-black text-xl mb-4 flex items-center gap-2">
                                    <span className="text-2xl"></span>
                                    Company
                                </h3>
                                <ul className="space-y-3">
                                    <li>
                                        <a href="about-us.html" target="_blank" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                            <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                            <span>About Us</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="contact.html" target="_blank" className="group/link relative text-gray-400 hover:text-gray-300 text-sm transition-all font-semibold flex items-center gap-2">
                                            <span className="text-cyan-500/50 group-hover/link:text-cyan-400 transition-colors"></span>
                                            <span>Contact & Support</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            {/* Disclaimer */}
                            <div className="group/section">
                                <h3 className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 font-black text-xl mb-4 flex items-center gap-2">
                                    <span className="text-2xl"></span>
                                    Disclaimer
                                </h3>
                                <p className="text-gray-400 text-sm leading-relaxed font-medium">
                                    FinClash is for educational purposes only. All trading uses virtual currency. Not real money. Not financial advice.
                                </p>
                            </div>
                        </div>

                        {/* Bottom Bar */}
                        <div className="border-t-2 border-cyan-500/20 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                            <p className="text-gray-500 text-sm font-semibold">
                                 2025 <span className="text-white font-black">FinClash</span>. All rights reserved.
                            </p>
                            <p className="text-gray-500 text-sm font-semibold">
                                Created by <span className="text-white font-black">Reid Coleman</span> & <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-500 font-black">Cameron Dietzel</span>
                            </p>
                        </div>
                    </div>
                </footer>

                {/* Certificate Modal */}
                {showCertificate && (
                    <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fadeIn">
                        <div className="bg-gradient-to-br from-gray-900 via-black to-gray-900 rounded-3xl shadow-2xl max-w-4xl w-full border-4 border-yellow-500 overflow-hidden animate-scaleIn max-h-[95vh] overflow-y-auto">
                            {/* Modal Header */}
                            <div className="bg-gradient-to-r from-yellow-600 via-yellow-500 to-yellow-600 p-6 relative">
                                <button
                                    onClick={() => setShowCertificate(false)}
                                    className="absolute top-4 right-4 text-black hover:text-gray-800 text-4xl font-bold transition-colors"
                                >
                                    
                                </button>
                                <h2 className="text-4xl font-black text-black mb-2 text-center">Certificate of Completion</h2>
                                <p className="text-yellow-900 text-center font-semibold">Congratulations on completing your trading education!</p>
                            </div>

                            {/* Certificate Content */}
                            <div id="certificate-content" className="p-12 bg-gradient-to-br from-gray-900 via-black to-gray-900">
                                {/* Decorative Border */}
                                <div className="border-8 border-double border-yellow-500 rounded-2xl p-12 bg-gradient-to-br from-gray-900/50 to-black/50">
                                    {/* Certificate Header */}
                                    <div className="text-center mb-8">
                                        <div className="text-6xl mb-4"></div>
                                        <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-500 mb-4">
                                            Certificate of Completion
                                        </h1>
                                        <div className="w-32 h-1 bg-gradient-to-r from-yellow-500 to-yellow-300 mx-auto rounded-full"></div>
                                    </div>

                                    {/* Certificate Body */}
                                    <div className="text-center mb-8">
                                        <p className="text-2xl text-gray-300 mb-6 font-serif">
                                            This certifies that
                                        </p>
                                        <p className="text-4xl font-black text-white mb-8">
                                            {userName || 'Certified Trader'}
                                        </p>
                                        <p className="text-xl text-gray-300 mb-8 font-serif leading-relaxed">
                                            has successfully completed all six comprehensive trading education topics,
                                            demonstrating excellence in understanding stock market fundamentals,
                                            trading strategies, and risk management principles.
                                        </p>
                                    </div>

                                    {/* Topics Completed */}
                                    <div className="mb-8">
                                        <h3 className="text-2xl font-bold text-yellow-400 text-center mb-6">Topics Mastered</h3>
                                        <div className="grid grid-cols-2 gap-4 max-w-2xl mx-auto">
                                            <div className="bg-green-900/30 border-2 border-green-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-green-300 font-semibold">Trading Basics</span>
                                            </div>
                                            <div className="bg-emerald-900/30 border-2 border-emerald-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-emerald-300 font-semibold">Entry & Exit Strategies</span>
                                            </div>
                                            <div className="bg-blue-900/30 border-2 border-blue-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-blue-300 font-semibold">Risk Management</span>
                                            </div>
                                            <div className="bg-cyan-900/30 border-2 border-cyan-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-gray-300 font-semibold">Technical Analysis</span>
                                            </div>
                                            <div className="bg-purple-900/30 border-2 border-purple-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-gray-300 font-semibold">Market Psychology</span>
                                            </div>
                                            <div className="bg-pink-900/30 border-2 border-pink-500 rounded-lg p-3 flex items-center gap-3">
                                                <span className="text-2xl"></span>
                                                <span className="text-pink-300 font-semibold">Advanced Strategies</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Achievement Stats */}
                                    <div className="grid grid-cols-3 gap-6 max-w-2xl mx-auto mb-8">
                                        <div className="text-center">
                                            <div className="text-4xl font-black text-green-400 mb-2">{learningProgress.totalXP}</div>
                                            <div className="text-sm text-gray-400 font-semibold">Total XP Earned</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-4xl font-black text-purple-400 mb-2">
                                                {(() => {
                                                    const level = Math.floor(learningProgress.totalXP / 100) + 1;
                                                    return Math.min(level, 10);
                                                })()}
                                            </div>
                                            <div className="text-sm text-gray-400 font-semibold">Level Achieved</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-4xl font-black text-yellow-400 mb-2">
                                                {(() => {
                                                    const scores = Object.values(learningProgress.quizScores);
                                                    if (scores.length === 0) return '0';
                                                    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                                                    return Math.round(avg);
                                                })()}%
                                            </div>
                                            <div className="text-sm text-gray-400 font-semibold">Avg Quiz Score</div>
                                        </div>
                                    </div>

                                    {/* Completion Date & Seal */}
                                    <div className="flex justify-between items-end mt-12 pt-8 border-t-2 border-yellow-500/30">
                                        <div className="text-left">
                                            <p className="text-gray-400 text-sm mb-2">Completion Date</p>
                                            <p className="text-yellow-300 font-bold text-xl">
                                                {new Date().toLocaleDateString('en-US', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric'
                                                })}
                                            </p>
                                        </div>
                                        <div className="text-center">
                                            <div className="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-600 border-4 border-yellow-400 flex items-center justify-center shadow-2xl">
                                                <div className="text-center">
                                                    <div className="text-3xl"></div>
                                                    <div className="text-xs font-black text-black">CERTIFIED</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-gray-400 text-sm mb-2">Certified By</p>
                                            <p className="text-white font-black text-xl">
                                                FinClash
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div className="bg-gradient-to-r from-gray-900 to-black p-6 border-t-2 border-yellow-500/30">
                                <div className="flex gap-4 justify-center">
                                    <button
                                        onClick={downloadCertificate}
                                        className="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold text-lg py-4 px-8 rounded-xl shadow-lg transition-all transform "
                                    >
                                        <div className="flex items-center gap-2">
                                            <span></span>
                                            <span>Download Certificate</span>
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => setShowCertificate(false)}
                                        className="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white font-bold text-lg py-4 px-8 rounded-xl shadow-lg transition-all transform "
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        };

export default TradingSimulator;
